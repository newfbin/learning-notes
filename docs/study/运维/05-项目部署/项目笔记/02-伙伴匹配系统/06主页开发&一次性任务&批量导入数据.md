# 06 ä¸»é¡µå¼€å‘+ ä¸€æ¬¡æ€§ä»»åŠ¡+æ‰¹é‡å¯¼å…¥æ•°æ®

åœ¨çº¿å›æ”¾ï¼š[https://meeting.tencent.com/v2/cloud-record/share?...](https://meeting.tencent.com/v2/cloud-record/share?id=65c1d5f7-8465-4c70-99bb-eb3e148ceb0c&from=3)ï¼ˆè®¿é—®å¯†ç ï¼šwr5Mï¼‰

# é±¼çš®ç¬”è®°

### 1.å¼€å‘ä¸»é¡µï¼ˆé»˜è®¤æ¨èå’Œè‡ªå·±å…´è¶£ç›¸å½“çš„ç”¨æˆ·ï¼‰


### 2.ä¼˜åŒ–ä¸»é¡µçš„æ€§èƒ½ï¼ˆç¼“å­˜ + å®šæ—¶ä»»åŠ¡ + åˆ†å¸ƒå¼é”ï¼‰


# å¼€å‘ä¸»é¡µ


æœ€ç®€å•ï¼šç›´æ¥ list åˆ—è¡¨  
æ¨¡æ‹Ÿ 1000 ä¸‡ä¸ªç”¨æˆ·ï¼Œå†å»æŸ¥è¯¢



#### å¯¼å…¥æ•°æ®


1. ç”¨å¯è§†åŒ–ç•Œé¢ï¼šé€‚åˆä¸€æ¬¡æ€§å¯¼å…¥ã€æ•°æ®é‡å¯æ§
2. å†™ç¨‹åºï¼šfor å¾ªç¯ï¼Œå»ºè®®åˆ†æ‰¹ï¼Œä¸è¦ä¸€æŠŠæ¢­å“ˆï¼ˆå¯ä»¥ç”¨æ¥å£æ¥æ§åˆ¶ï¼‰**è¦ä¿è¯å¯æ§ã€å¹‚ç­‰ï¼Œæ³¨æ„çº¿ä¸Šç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒæ˜¯æœ‰åŒºåˆ«çš„**å¯¼å…¥ 1000 ä¸‡æ¡ï¼Œfor i 1000w
3. æ‰§è¡Œ SQL è¯­å¥ï¼šé€‚ç”¨äºå°æ•°æ®é‡



#### ç¼–å†™ä¸€æ¬¡æ€§ä»»åŠ¡


for å¾ªç¯æ’å…¥æ•°æ®çš„é—®é¢˜ï¼š



1. å»ºç«‹å’Œé‡Šæ”¾æ•°æ®åº“é“¾æ¥ï¼ˆæ‰¹é‡æŸ¥è¯¢è§£å†³ï¼‰
2. for å¾ªç¯æ˜¯ç»å¯¹çº¿æ€§çš„ï¼ˆå¹¶å‘ï¼‰



å¹¶å‘è¦æ³¨æ„æ‰§è¡Œçš„å…ˆåé¡ºåºæ— æ‰€è°“ï¼Œä¸è¦ç”¨åˆ°éå¹¶å‘ç±»çš„é›†åˆ  
Â  Â private ExecutorService executorService = new ThreadPoolExecutor(16, 1000, 10000, TimeUnit.MINUTES, new ArrayBlockingQueue<>(10000));



```plain
// CPU å¯†é›†å‹ï¼šåˆ†é…çš„æ ¸å¿ƒçº¿ç¨‹æ•° = CPU - 1
// IO å¯†é›†å‹ï¼šåˆ†é…çš„æ ¸å¿ƒçº¿ç¨‹æ•°å¯ä»¥å¤§äº CPU æ ¸æ•°
```



æ•°æ®åº“æ…¢ï¼Ÿé¢„å…ˆæŠŠæ•°æ®æŸ¥å‡ºæ¥ï¼Œæ”¾åˆ°ä¸€ä¸ªæ›´å¿«è¯»å–çš„åœ°æ–¹ï¼Œä¸ç”¨å†æŸ¥æ•°æ®åº“äº†ã€‚ï¼ˆç¼“å­˜ï¼‰  
é¢„åŠ è½½ç¼“å­˜ï¼Œå®šæ—¶æ›´æ–°ç¼“å­˜ã€‚ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰  
å¤šä¸ªæœºå™¨éƒ½è¦æ‰§è¡Œä»»åŠ¡ä¹ˆï¼Ÿï¼ˆåˆ†å¸ƒå¼é”ï¼šæ§åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€å°æœºå™¨å»æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œå…¶ä»–æœºå™¨ä¸ç”¨é‡å¤æ‰§è¡Œäº†ï¼‰



# å¼€å‘é¡µé¢


### 1.å¯åŠ¨å‰åç«¯é¡¹ç›®


è¿›å…¥æœç´¢é¡µé¢é€‰æ‹©æ•°æ®åº“é‡Œå­˜åœ¨çš„æ ‡ç­¾æœç´¢ï¼Œå‘ç°æœç´¢ä¸ºç©ºï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å–äº†ä¸¤æ¬¡å“åº”çš„dataï¼Œè‡ªç„¶æœä¸åˆ°ï¼Œ`SearchResultPage.vue`ä¿®æ”¹å¦‚ä¸‹ä»£ç ï¼š



![1668738968719-4a6c0be3-3f63-4e85-ba2e-c0f740048223.png](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/1668738968719-4a6c0be3-3f63-4e85-ba2e-c0f740048223-619197.png)



åˆ·æ–°é¡µé¢ï¼ŒæˆåŠŸå±•ç°æ•°æ®åº“é‡Œè¢«ç­›é€‰çš„æ•°æ®



### 2.ç¼–å†™ä¸»é¡µï¼ˆç›´æ¥liståˆ—è¡¨ï¼‰


åœ¨åç«¯controllerå±‚ç¼–å†™æ¥å£å»å®ç°æ˜¾ç¤ºæ¨èé¡µé¢çš„åŠŸèƒ½



```java
    /**
     * æ¨èé¡µé¢
     * @param request
     * @return
     */
    @GetMapping("/recommend")
    public BaseResponse<List<User>> recommendUsers(HttpServletRequest request){
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        List<User> userList = userService.list(queryWrapper);
        List<User> list = userList.stream().map(user -> userService.getSafetyUser(user)).collect(Collectors.toList());
        return ResultUtils.success(list);
    }
```



> é‡å¯åç«¯



å‰ç«¯å°±å…ˆå¤åˆ¶æœç´¢ç»“æœçš„ä»£ç ï¼Œåœ¨ä¿®æ”¹ä¸€ä¸ªä¸€äº›ä¸éœ€è¦çš„å³å¯



```vue
<!--
User:Shier
CreateTime:14:47
-->
<template>
  <van-card
      v-for="user in userList"
      :desc="user.profile"
      :title="`${user.username} (${user.planetCode})`"
      :thumb="user.avatarUrl"
  >
    <template #tags>
      <van-tag plain type="danger" v-for="tag in tags" style="margin-right: 8px; margin-top: 8px">
        {{ tag }}
      </van-tag>
    </template>
    <template #footer>
      <van-button size="mini">è”ç³»æˆ‘</van-button>
    </template>
  </van-card>
  <van-empty v-if="!userList || userList.length < 1" image="search" description="æ•°æ®ä¸ºç©º"/>
</template>

<script setup>
  import {onMounted, ref} from "vue";
  import {useRoute} from "vue-router";
  import {showFailToast, showSuccessToast} from "vant/lib/vant.es";
  import myAxios from "../plugins/myAxios.ts";

  import qs from 'qs'

  const route = useRoute();
  const {tags} = route.query;

  const userList = ref([]); //ç”¨æˆ·åˆ—è¡¨

  onMounted(async () => {
    // ä¸ºç»™å®š ID çš„ user åˆ›å»ºè¯·æ±‚
    const userListData = await myAxios.get('/user/recommend', {
      withCredentials: false,
      params: {},
    })
        .then(function (response) {
          console.log('/user/recommend succeed', response);
          showSuccessToast('è¯·æ±‚æˆåŠŸ');
          return response?.data;
        })
        .catch(function (error) {
          console.log('/user/recommend error', error);
          showFailToast('è¯·æ±‚å¤±è´¥')
        });
    if (userListData) {
      userListData.forEach(user => {
        if (user.tags) {
          user.tags = JSON.parse(user.tags);
        }
      })
      userList.value = userListData;
    }
  })

</script>

<style scoped>

</style>
```



åˆ·æ–°é¡µé¢ï¼ŒæˆåŠŸæ˜¾ç¤º

![918d9da8-5c09-49f7-9f31-7b4534be6e86](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/918d9da8-5c09-49f7-9f31-7b4534be6e86.png)
ä½†æ˜¯é¡µé¢æ˜¾ç¤ºè¿˜æœ‰ä¸€å®šé—®é¢˜ï¼Œä¸‹é¢æœ‰ä¸€å—ä¸æ˜¾ç¤ºï¼Œåœ¨å‰ç«¯ä¿®æ”¹æ ·å¼  
`basicLayout.vue`é‡Œé¢æ·»åŠ ä»¥ä¸‹æ ·å¼



![1668760815017-90c5eb81-056a-417f-9b34-bef6fe62e09e.png](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/1668760815017-90c5eb81-056a-417f-9b34-bef6fe62e09e-385405.png)



æˆ‘ä»¬å‘ç°æœ‰å‡ ä¸ªé¡µé¢éƒ½ç”¨åˆ°äº†åˆ—è¡¨ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æå–å‡ºå…¬å…±ç»„ä»¶ï¼Œæ¥å‡å°‘ä»£ç çš„ç¼–å†™  
åœ¨å…¬å…±ç»„ä»¶åŒ…é‡Œæ·»åŠ `UserCardList`ï¼Œå¹¶å¤åˆ¶ä¸»é¡µé‡Œé¢çš„æ¨¡æ¿ä¿®æ”¹ä¸ºå¦‚ä¸‹



```vue
<template>
  <van-card
      v-for="user in userList"
      :desc="user.profile"
      :title="`${user.username} (${user.planetCode})`"
      :thumb="user.avatarUrl"
  >
    <template #tags>
      <van-tag plain type="danger" v-for="tag in user.tags" style="margin-right: 8px; margin-top: 8px" >
        {{ tag }}
      </van-tag>
    </template>
    <template #footer>
      <van-button size="mini">è”ç³»æˆ‘</van-button>
    </template>
  </van-card>
</template>

<script setup lang="ts">
import {UserType} from "../models/user";

interface UserCardListProps{
  userList: UserType[];
}
// ç»™çˆ¶ç»„ä»¶è®¾ç½®é»˜è®¤å€¼ï¼Œä¿è¯æ•°æ®ä¸ä¸ºç©º
const props= withDefaults(defineProps<UserCardListProps>(),{
  //@ts-ignore
  userList: [] as UserType[]
});

</script>
<style scoped>
  /* æ ‡ç­¾é¢œè‰²*/
  .van-tag--danger.van-tag--plain {
    color: #002fff;
  }
</style>
```



ç„¶ååœ¨`Index`ã€`SearchResultPage`å¼•å…¥`UserCardList`



![c1c02de7-7046-41b8-aed7-646e83fe7822](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/c1c02de7-7046-41b8-aed7-646e83fe7822.png)



> æµ‹è¯•ä¸€ä¸‹ï¼Œä¸»é¡µå’Œç”¨æˆ·ç»“æœé¡µé¢åº”è¯¥æ˜¾ç¤ºæ­£å¸¸



### 3.æ¨¡æ‹Ÿ1000ä¸‡ç”¨æˆ·ï¼Œå†æ¬¡è¿›è¡ŒæŸ¥è¯¢

æˆ‘ä»¬éœ€è¦æ’å…¥æ•°æ®ï¼Œæœ‰ä»¥ä¸‹æ–¹æ³•ï¼š  
1.ç”¨å¯è§†åŒ–ç•Œé¢ï¼šé€‚åˆä¸€æ¬¡æ€§å¯¼å…¥ã€æ•°æ®é‡å¯æ§  
ç”±äºç¼–ç ï¼Œä¸»é”®ä»¥åŠæŸäº›å­—æ®µçš„é—®é¢˜ï¼ˆidï¼Œcreatetimeç­‰ï¼‰ï¼Œæ¼”ç¤ºæ’å…¥å¤±è´¥ï¼Œè¿™é‡Œä¸æ¨è  
![image-20241026000706385](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/image-20241026000706385.png)



2.å†™ç¨‹åºï¼šfor å¾ªç¯ï¼Œå»ºè®®åˆ†æ‰¹ï¼Œä¸è¦ä¸€æŠŠæ¢­å“ˆ,è¿™é‡Œæ¼”ç¤ºäº†ä¸¤ç§æ’å…¥æ•°æ®çš„æ–¹æ³•  
é¦–å…ˆåˆ›å»ºæµ‹è¯•æ–¹æ³•æ–‡ä»¶InsertUsersTestï¼Œç¼–å†™æ‰¹é‡æŸ¥è¯¢è§£å†³

> å¹¶å‘æ‰§è¡Œï¼Œè¿™é‡Œçš„çº¿ç¨‹å¯è‡ªå®šä¹‰æˆ–è€…ç”¨ideaé»˜è®¤çš„ï¼Œä¸¤ç§æ–¹æ³•çš„åŒºåˆ«æ˜¯ï¼Œè‡ªå®šä¹‰å¯ä»¥è·‘æ»¡çº¿ç¨‹ï¼Œè€Œé»˜è®¤çš„åªèƒ½è·‘CPUæ ¸æ•°-1ï¼Œä»£ç åŒºåˆ«ï¼šå°±æ˜¯åœ¨å¼‚æ­¥æ‰§è¡Œå¤„åŠ ä¸Šè‡ªå®šä¹‰çš„çº¿ç¨‹å

```java
@SpringBootTest
public class InsertUserTest {
    @Resource
    private UserService userService;

    //çº¿ç¨‹è®¾ç½®
    private ExecutorService executorService = new ThreadPoolExecutor(16, 1000, 10000, TimeUnit.MINUTES, new ArrayBlockingQueue<>(10000));

    /**
     * å¾ªç¯æ’å…¥ç”¨æˆ·  è€—æ—¶ï¼š7260ms
     * æ‰¹é‡æ’å…¥ç”¨æˆ·   1000  è€—æ—¶ï¼š 4751ms
     */
    //@Test
    public void doInsertUser() {
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        final int INSERT_NUM = 1000;
        List<User> userList = new ArrayList<>();
        for (int i = 0; i < INSERT_NUM; i++) {
            User user = new User();
            user.setUserName("å‡æ•°æ®");
            user.setUserAccount("FakeAccount");
            user.setUserAvatar("https://i.ytimg.com/vi/ucPl4gJuev0/maxresdefault.jpg");
            user.setUserPassword("12345678");
            user.setUserRole("user");
            user.setTags("[]");
            userList.add(user);
        }
        userService.saveBatch(userList, 100);
        stopWatch.stop();
        System.out.println(stopWatch.getLastTaskTimeMillis());

    }

    /**
     * å¹¶å‘æ‰¹é‡æ’å…¥ç”¨æˆ·   100000  è€—æ—¶ï¼š 26830ms
     */
    //@Test
    public void doConcurrencyInsertUser() {
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        final int INSERT_NUM = 100000;
        // åˆ†åç»„
        int j = 0;
        //æ‰¹é‡æ’å…¥æ•°æ®çš„å¤§å°
        int batchSize = 5000;
        List<CompletableFuture<Void>> futureList = new ArrayList<>();
        // i è¦æ ¹æ®æ•°æ®é‡å’Œæ’å…¥æ‰¹é‡æ¥è®¡ç®—éœ€è¦å¾ªç¯çš„æ¬¡æ•°ã€‚ï¼ˆé±¼çš®è¿™é‡Œç›´æ¥å–äº†ä¸ªå€¼ï¼Œä¼šæœ‰é—®é¢˜,æˆ‘è¿™é‡Œéšä¾¿å†™çš„ï¼‰
        for (int i = 0; i < INSERT_NUM / batchSize; i++) {
            List<User> userList = new ArrayList<>();
            //ç¡®å®šæ¯ä¸ªçº¿ç¨‹è¦å¤„ç†çš„åˆ—è¡¨
            while (true) {
                j++;
                User user = new User();
                user.setUserName("å‡æ•°æ®");
                user.setUserAccount("FakeAccount");
                user.setUserAvatar("https://i.ytimg.com/vi/ucPl4gJuev0/maxresdefault.jpg");
                user.setUserPassword("12345678");
                user.setUserRole("user");
                user.setTags("[]");
                userList.add(user);
                if (j % batchSize == 0) {
                    break;
                }
            }
            //å¼‚æ­¥æ‰§è¡Œ ä½¿ç”¨CompletableFutureå¼€å¯å¼‚æ­¥ä»»åŠ¡
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                System.out.println("ThreadNameï¼š" + Thread.currentThread().getName());
                userService.saveBatch(userList, batchSize);
                //executorServiceæ˜¯ç”¨äºæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚
            }, executorService);
            futureList.add(future);
        }
        //allOfæ–¹æ³•ç”¨äºç­‰å¾…å¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„å®Œæˆ
        //join() æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡éƒ½å®Œæˆã€‚å¦‚æœä»»åŠ¡æœ‰å¼‚å¸¸ï¼Œå®ƒä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
        CompletableFuture.allOf(futureList.toArray(new CompletableFuture[]{})).join();

        stopWatch.stop();
        System.out.println(stopWatch.getLastTaskTimeMillis());
    }
}


```



è‹¥ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼Œåˆ å»

![1668824801021-a016018a-7fe1-411f-9875-45736e2d5ff6.png](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/1668824801021-a016018a-7fe1-411f-9875-45736e2d5ff6-048269.png)

ç°åœ¨å¯åŠ¨å‰åç«¯ï¼ŒæŸ¥çœ‹ä¸»é¡µï¼Œå‘ç°æœæŸ¥ä¸å‡ºï¼Œè¿™æ˜¯å› ä¸ºæ•°æ®å¤ªå¤šéœ€è¦åˆ†é¡µï¼Œä¿®æ”¹åç«¯æ¥å£æ–¹æ³•

```java
    /**
     * æ¨èé¡µé¢
     * @param request
     * @return
     */
    @GetMapping("/recommend")
    public BaseResponse<Page<User>> recommendUsers(long pageSize,long pageNum, HttpServletRequest request){
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        Page<User> userList = userService.page(new Page<>(pageNum, pageSize), queryWrapper);
        return ResultUtils.success(userList);
    }
```

> åŒæ—¶è¿˜è¦å¼•å…¥mybatisçš„åˆ†é¡µæ’ä»¶é…ç½®ï¼Œç›´æ¥å¤åˆ¶æ–‡æ¡£åˆ°configç›®å½•
>
> ä¸»è¦ä¸è¦å¿˜äº†æŠŠæ‰«åŒ…çš„è·¯å¾„æ”¹ä¸ºè‡ªå·±çš„

```java
package com.yupi.usercenter.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.yupi.usercenter.mapper")
public class MybatisPlusConfig {

    /**
     * æ–°çš„åˆ†é¡µæ’ä»¶,ä¸€ç¼“å’ŒäºŒç¼“éµå¾ªmybatisçš„è§„åˆ™,éœ€è¦è®¾ç½® MybatisConfiguration#useDeprecatedExecutor = false é¿å…ç¼“å­˜å‡ºç°é—®é¢˜(è¯¥å±æ€§ä¼šåœ¨æ—§æ’ä»¶ç§»é™¤åä¸€åŒç§»é™¤)
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.H2));
        return interceptor;
    }
}
```



ç°åœ¨å»ä¿®æ”¹å‰ç«¯ä¸»é¡µ

![1668825050904-cc8e9500-542f-4420-9c30-5c442eda729c.png](./assets/06ä¸»é¡µå¼€å‘&ä¸€æ¬¡æ€§ä»»åŠ¡&æ‰¹é‡å¯¼å…¥æ•°æ®/1668825050904-cc8e9500-542f-4420-9c30-5c442eda729c-876066.png)



åˆ·æ–°é¡µé¢ï¼ŒæˆåŠŸå±•ç°8æ¡æ•°æ®



## ç¬¬å…­æœŸå®Œç»“ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰


> æ›´æ–°: 2023-02-10 10:04:36  
> åŸæ–‡: <https://www.yuque.com/shierkcs/catstudy/cquggn9uqxqrs249>