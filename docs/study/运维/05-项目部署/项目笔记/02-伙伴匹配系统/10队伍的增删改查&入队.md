# 10 é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥+å…¥é˜Ÿ

åœ¨çº¿å›æ”¾ï¼š[https://meeting.tencent.com/v2/cloud-record/share?...](https://meeting.tencent.com/v2/cloud-record/share?id=83a15e95-1284-42a6-aa06-f7a710fc38bd&from=3)ï¼ˆè®¿é—®å¯†ç ï¼šaehQï¼‰

## é±¼çš®ç¬”è®°


##### 1ã€ æŸ¥è¯¢é˜Ÿä¼åˆ—è¡¨


åˆ†é¡µå±•ç¤ºé˜Ÿä¼åˆ—è¡¨ï¼Œæ ¹æ®åç§°ã€æœ€å¤§äººæ•°ç­‰æœç´¢é˜Ÿä¼ P0ï¼Œä¿¡æ¯æµä¸­ä¸å±•ç¤ºå·²è¿‡æœŸçš„é˜Ÿä¼



1. ä»è¯·æ±‚å‚æ•°ä¸­å–å‡ºé˜Ÿä¼åç§°ç­‰æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚æœå­˜åœ¨åˆ™ä½œä¸ºæŸ¥è¯¢æ¡ä»¶
2. ä¸å±•ç¤ºå·²è¿‡æœŸçš„é˜Ÿä¼ï¼ˆæ ¹æ®è¿‡æœŸæ—¶é—´ç­›é€‰ï¼‰
3. å¯ä»¥é€šè¿‡æŸä¸ª**å…³é”®è¯**åŒæ—¶å¯¹åç§°å’Œæè¿°æŸ¥è¯¢
4. **åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æŸ¥çœ‹åŠ å¯†è¿˜æœ‰éå…¬å¼€çš„æˆ¿é—´**
5. å…³è”æŸ¥è¯¢å·²åŠ å…¥é˜Ÿä¼çš„ç”¨æˆ·ä¿¡æ¯
6. **å…³è”æŸ¥è¯¢å·²åŠ å…¥é˜Ÿä¼çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯èƒ½ä¼šå¾ˆè€—è´¹æ€§èƒ½ï¼Œå»ºè®®å¤§å®¶ç”¨è‡ªå·±å†™ SQL çš„æ–¹å¼å®ç°ï¼‰**



**å®ç°æ–¹å¼**  
è‡ªå·±å†™ SQL



```plain
// 1. è‡ªå·±å†™ SQL
// æŸ¥è¯¢é˜Ÿä¼å’Œåˆ›å»ºäººçš„ä¿¡æ¯
// select * from team t left join user u on t.userId = u.id
// æŸ¥è¯¢é˜Ÿä¼å’Œå·²åŠ å…¥é˜Ÿä¼æˆå‘˜çš„ä¿¡æ¯
// select *
// from team t
// Â  Â  Â  Â  left join user_team ut on t.id = ut.teamId
// Â  Â  Â  Â  left join user u on ut.userId = u.id;
```



##### 2ã€ ä¿®æ”¹é˜Ÿä¼ä¿¡æ¯


1. åˆ¤æ–­è¯·æ±‚å‚æ•°æ˜¯å¦ä¸ºç©º
2. æŸ¥è¯¢é˜Ÿä¼æ˜¯å¦å­˜åœ¨
3. åªæœ‰ç®¡ç†å‘˜æˆ–è€…é˜Ÿä¼çš„åˆ›å»ºè€…å¯ä»¥ä¿®æ”¹
4. å¦‚æœç”¨æˆ·ä¼ å…¥çš„æ–°å€¼å’Œè€å€¼ä¸€è‡´ï¼Œå°±ä¸ç”¨ update äº†ï¼ˆå¯è‡ªè¡Œå®ç°ï¼Œé™ä½æ•°æ®åº“ä½¿ç”¨æ¬¡æ•°ï¼‰
5. **å¦‚æœé˜Ÿä¼çŠ¶æ€æ”¹ä¸ºåŠ å¯†ï¼Œå¿…é¡»è¦æœ‰å¯†ç **
6. æ›´æ–°æˆåŠŸ



##### 3ã€ ç”¨æˆ·å¯ä»¥åŠ å…¥é˜Ÿä¼


å…¶ä»–äººã€æœªæ»¡ã€æœªè¿‡æœŸï¼Œå…è®¸åŠ å…¥å¤šä¸ªé˜Ÿä¼ï¼Œä½†æ˜¯è¦æœ‰ä¸ªä¸Šé™ P0



1. ç”¨æˆ·æœ€å¤šåŠ å…¥ 5 ä¸ªé˜Ÿä¼
2. é˜Ÿä¼å¿…é¡»å­˜åœ¨ï¼Œåªèƒ½åŠ å…¥æœªæ»¡ã€æœªè¿‡æœŸçš„é˜Ÿä¼
3. ä¸èƒ½åŠ å…¥è‡ªå·±çš„é˜Ÿä¼ï¼Œä¸èƒ½é‡å¤åŠ å…¥å·²åŠ å…¥çš„é˜Ÿä¼ï¼ˆå¹‚ç­‰æ€§ï¼‰
4. ç¦æ­¢åŠ å…¥ç§æœ‰çš„é˜Ÿä¼
5. å¦‚æœåŠ å…¥çš„é˜Ÿä¼æ˜¯åŠ å¯†çš„ï¼Œå¿…é¡»å¯†ç åŒ¹é…æ‰å¯ä»¥
6. æ–°å¢é˜Ÿä¼ - ç”¨æˆ·å…³è”ä¿¡æ¯



**æ³¨æ„ï¼Œä¸€å®šè¦åŠ ä¸Šäº‹åŠ¡æ³¨è§£ï¼ï¼ï¼ï¼**



## å®Œå–„æŸ¥è¯¢ï¼Œæ›´æ–°ï¼ŒåŠ å…¥é˜Ÿä¼æ¥å£


### 1.ä¸ºäº†ä¿æŠ¤æ•°æ®ä¸è¢«æš´éœ²ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ–°å»ºå°è£…ç±»

åœ¨modelåŒ…æ–°å»ºvoåŒ…ï¼Œå¹¶åˆ›å»ºTeamUserVOï¼ˆé˜Ÿä¼å’Œç”¨æˆ·ä¿¡æ¯å°è£…ç±»ï¼‰ï¼ŒUserVOç±»ï¼ˆç”¨æˆ·å°è£…ç±»ï¼‰ï¼Œè¿™ä¸¤ä¸ªç±»æ˜¯è¿”å›ç»™å‰ç«¯çœ‹



```java
/**
 * é˜Ÿä¼å’Œç”¨æˆ·ä¿¡æ¯å°è£…ç±»ï¼ˆè„±æ•ï¼‰
 *
 * @author yupi
 */
@Data
public class TeamUserVO implements Serializable {

    private static final long serialVersionUID = 163478861968488713L;
    /**
     * id
     */
    private Long id;

    /**
     * é˜Ÿä¼åç§°
     */
    private String name;

    /**
     * æè¿°
     */
    private String description;

    /**
     * æœ€å¤§äººæ•°
     */
    private Integer maxNum;

    /**
     * è¿‡æœŸæ—¶é—´
     */
    private Date expireTime;

    /**
     * ç”¨æˆ·id
     */
    private Long userId;

    /**
     * 0 - å…¬å¼€ï¼Œ1 - ç§æœ‰ï¼Œ2 - åŠ å¯†
     */
    private Integer status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * åˆ›å»ºäººç”¨æˆ·ä¿¡æ¯
     */
    private UserVO createUser;

    /**
     * å·²åŠ å…¥çš„ç”¨æˆ·æ•°
     */
    private Integer hasJoinNum;

    /**
     * æ˜¯å¦å·²åŠ å…¥é˜Ÿä¼
     */
    private boolean hasJoin = false;
}
```



```java
/**
 * ç”¨æˆ·åŒ…è£…ç±»ï¼ˆè„±æ•ï¼‰
 */
@Data
public class UserVO implements Serializable {
    
    /**
     * id
     */
    private long id;

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String username;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * ç”¨æˆ·å¤´åƒ
     */
    private String avatarUrl;

    /**
     * æ€§åˆ«
     */
    private Integer gender;

    /**
     * ç”µè¯
     */
    private String phone;

    /**
     * é‚®ç®±
     */
    private String email;

    /**
     * æ ‡ç­¾åˆ—è¡¨ json
     */
    private String tags;

    /**
     * çŠ¶æ€ 0 - æ­£å¸¸
     */
    private Integer userStatus;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * 
     */
    private Date updateTime;

    /**
     * ç”¨æˆ·è§’è‰² 0 - æ™®é€šç”¨æˆ· 1 - ç®¡ç†å‘˜
     */
    private Integer userRole;

    /**
     * æ˜Ÿçƒç¼–å·
     */
    private String planetCode;

    private static final long serialVersionUID = 1L;
}
```



**æˆ‘è¿™è¾¹å«Œéº»çƒ¦å°±ç›´æ¥æ ¹æ®ååºç›´æ’­å†…å®¹æŠŠæ‰€è¦æ·»åŠ çš„å‚æ•°å…¨éƒ¨å†™å…¥äº†ï¼ˆä½ ä¹Ÿå¯ä»¥æ ¹æ®ç›´æ’­é¡ºåºä¸€æ­¥æ­¥æ·»åŠ ï¼‰**



### 2.åœ¨TeamServiceé‡Œç¼–å†™æŸ¥è¯¢é˜Ÿä¼æ–¹æ³•å¹¶åœ¨TeamServiceImplé‡Œå®ç°

åœ¨ç¼–å†™çš„è¿‡ç¨‹ä¸­å‘ç°TeamQueryä¸­ç¼ºå°‘ä¸€ä¸ªå­—æ®µï¼Œç°åœ¨è¡¥ä¸Š  
![1669124113442-fc9e044f-ada5-4884-9e25-2b28dca2c0b4.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669124113442-fc9e044f-ada5-4884-9e25-2b28dca2c0b4-134909-1731311693314-25.png)



#### 1.é¦–å…ˆåœ¨TeamServiceé‡Œé¢å®ç°listTeamsæ–¹æ³•å¹¶å®ç°


![1669124268161-47fd2ea5-6e30-4d6a-b263-85fadc7160ef.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669124268161-47fd2ea5-6e30-4d6a-b263-85fadc7160ef-246646-1731311693313-24.png)



#### 2.ç¼–å†™ä¸šåŠ¡å±‚ï¼Œå…¶ä¸­åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æŸ¥çœ‹åŠ å¯†è¿˜æœ‰éå…¬å¼€çš„æˆ¿é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»è¯·æ±‚ä¸­è·å¾—æ˜¯å¦ä¸ºç®¡ç†å‘˜

æ‰€ä»¥æˆ‘ä»¬è¿™è¾¹æå‰ä¿®æ”¹listTeamsæ–¹æ³•ï¼ˆé±¼çš®æ˜¯åœ¨å†™çš„è¿‡ç¨‹ä¸­å‘ç°è¦è·å¾—æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œæ‰å»ä¿®æ”¹ï¼‰  
![1669124514978-0ef72f54-9087-401a-b72f-ebc62a90709b.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669124514978-0ef72f54-9087-401a-b72f-ebc62a90709b-882906-1731311693313-23.png)  
å®Œæ•´çš„ç¼–å†™è¿‡ç¨‹è¿™é‡Œå°±ä¸ä¸€ä¸€å±•ç°äº†ï¼ˆå¤§å®¶å¯ä»¥è§‚çœ‹ç›´æ’­äº†è§£å…·ä½“è¿‡ç¨‹ï¼Œåœ¨ç¼–å†™è¿‡ç¨‹ä¸­ä¼šå‘ç°é—®é¢˜ï¼Œç„¶åæ·»åŠ å‚æ•°å’Œç±»ç­‰ç­‰ï¼‰ï¼Œè¿™é‡Œè¦æ”¹çš„åœ°æ–¹æœ‰ç‚¹å¤šï¼ˆä¸­é—´è¿‡ç¨‹ä¹Ÿæ²¡æœ‰æµ‹è¯•ï¼‰æ‰€ä»¥ä¸å†™è¿‡ç¨‹äº†ã€‚æŸ¥è¯¢é˜Ÿä¼imlpæ•´ç†å¦‚ä¸‹ï¼š



```java
    @Override
    public List<TeamUserVO> listTeams(TeamQuery teamQuery, boolean isAdmin) {
        QueryWrapper<Team> queryWrapper = new QueryWrapper<>();
        //ç»„åˆæŸ¥è¯¢æ¡ä»¶
        if (teamQuery != null) {
            Long id = teamQuery.getId();
            if (id != null && id > 0) {
                queryWrapper.eq("id", id);
            }
            String searchText = teamQuery.getSearchText();
            if (StringUtils.isNotBlank(searchText)) {
                queryWrapper.and(qw -> qw.like("name", searchText).or().like("expireTime", searchText));
            }
            String name = teamQuery.getName();
            if (StringUtils.isNotBlank(name)) {
                queryWrapper.like("name", name);
            }
            String description = teamQuery.getDescription();
            if (StringUtils.isNotBlank(description)) {
                queryWrapper.like("description", description);
            }
            Integer maxNum = teamQuery.getMaxNum();
            //æŸ¥è¯¢æœ€å¤§äººæ•°ç›¸ç­‰
            if (maxNum != null && maxNum > 0) {
                queryWrapper.eq("maxMum", maxNum);
            }
            Long userId = teamQuery.getUserId();
            //æ ¹æ®åˆ›å»ºäººæ¥æŸ¥è¯¢
            if (userId != null && userId > 0) {
                queryWrapper.eq("userId", userId);
            }
            //æ ¹æ®çŠ¶æ€æ¥æŸ¥è¯¢
            Integer status = teamQuery.getStatus();
            TeamStatusEnum statusEnum = TeamStatusEnum.getEnumByValue(status);
            if (statusEnum == null) {
                statusEnum = TeamStatusEnum.PUBLIC;
            }
            if (!isAdmin && !statusEnum.equals(TeamStatusEnum.PUBLIC)) {
                throw new BusinessException(ErrorCode.NO_AUTH);
            }
            queryWrapper.eq("status", statusEnum.getValue());
        }

        //ä¸å±•ç¤ºå·²è¿‡æœŸçš„é˜Ÿä¼
        //expireTime is null or expireTime > now()
        queryWrapper.and(qw -> qw.gt("expireTime", new Date()).or().isNull("expireTime"));

        List<Team> teamList = this.list(queryWrapper);
        if (CollectionUtils.isEmpty(teamList)) {
                return new ArrayList<>();
        }
        List<TeamUserVO> teamUserVOList = new ArrayList<>();
        //å…³è”æŸ¥è¯¢åˆ›å»ºäººçš„ç”¨æˆ·ä¿¡æ¯
        for (Team team : teamList) {
            Long userId = team.getUserId();
            if (userId == null) {
                continue;
            }
            User user = userService.getById(userId);
            TeamUserVO teamUserVO = new TeamUserVO();
            BeanUtils.copyProperties(team, teamUserVO);
            //è„±æ•ç”¨æˆ·ä¿¡æ¯
            if (user!=null){
                UserVO userVO = new UserVO();
                BeanUtils.copyProperties(user, userVO);
                teamUserVO.setCreateUser(userVO);
            }
            teamUserVOList.add(teamUserVO);
        }
        return teamUserVOList;
    }
```



è¯·æ±‚æ¥å£ä¿®æ”¹æ•´ç†ä¸ºï¼š



```java
    @GetMapping("/list")
    public BaseResponse<List<TeamUserVO>> listTeams(TeamQuery teamQuery,HttpServletRequest request){
        if (teamQuery == null){
            throw new BusinessException(ErrorCode.PARAMS_ERROR); 
        }
        boolean isAdmin = userService.isAdmin(request);
        List<TeamUserVO> teamList = teamService.listTeams(teamQuery,isAdmin);
        return ResultUtils.success(teamList);
    }
```



#### 3.æµ‹è¯•ï¼Œæ‰“å¼€knife4jæ¥å£ï¼Œç›´æ¥ä¸å¸¦å‚æ•°å‘é€ï¼ˆç­‰äºæŸ¥è¯¢å…¨éƒ¨ï¼‰

![image-20241113160902995](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/image-20241113160902995.png)  
ä¿®æ”¹ç”¨æˆ·è¿‡æœŸæ—¶é—´å†æ¬¡æµ‹è¯•ï¼Œè§‚å¯Ÿæ˜¯å¦æŸ¥è¯¢ä¸åˆ°æ­¤é˜Ÿä¼ï¼ˆæˆ‘è¿™é‡Œä¿®æ”¹äº†ç¼–å·ä¸º30çš„é˜Ÿä¼)  
![image-20241113161139792](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/image-20241113161139792.png)  
ç»“æœæ­£ç¡®ï¼Œè¿‡æœŸçš„30ç»„é˜Ÿä¼æœªè¢«æŸ¥è¯¢å‡ºï¼  
æŸ¥è¯¢é˜Ÿä¼åŠŸèƒ½å®Œæˆ



### 3.åœ¨TeamServiceé‡Œç¼–å†™ä¿®æ”¹é˜Ÿä¼ä¿¡æ¯æ–¹æ³•å¹¶åœ¨TeamServiceImplé‡Œå®ç°


#### 1.åŒæ ·åœ¨è¯·æ±‚åŒ…é‡Œå°è£…ä¸€ä¸ªç”¨æˆ·ç™»å½•è¯·æ±‚ä½“


```java
/**
 * ç”¨æˆ·ç™»å½•è¯·æ±‚ä½“
 *
 * @author shaosao
 */
@Data
public class TeamUpdateRequest implements Serializable {

    private static final long serialVersionUID = -6043915331807008592L;

    /**
     * id
     */
    private Long id;

    /**
     * é˜Ÿä¼åç§°
     */
    private String name;

    /**
     * æè¿°
     */
    private String description;

    /**
     * è¿‡æœŸæ—¶é—´
     */
    private Date expireTime;

    /**
     * 0 - å…¬å¼€ï¼Œ1 - ç§æœ‰ï¼Œ2 - åŠ å¯†
     */
    private Integer status;

    /**
     * å¯†ç 
     */
    private String password;
}
```



#### 2.åœ¨TeamServiceé‡Œé¢å®ç°updateTeamæ–¹æ³•å¹¶å®ç°

![1669126761687-cb982357-058b-4c5a-8e6d-d005c72dedd0.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669126761687-cb982357-058b-4c5a-8e6d-d005c72dedd0-617773-1731311693314-28.png)  
ä¿®æ”¹æ¥å£æ›´æ”¹ä¸º

```java
    @PostMapping("/update")
    public BaseResponse<Boolean> updateTeam(@RequestBody TeamUpdateRequest teamUpdateRequest,HttpServletRequest request) {
        if (teamUpdateRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        User loginUser = userService.getLoginUser(request);
        boolean result = teamService.updateTeam(teamUpdateRequest,loginUser);
        if (!result) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ›´æ–°å¤±è´¥");
        }
        return ResultUtils.success(true);
    }
```



#### 3.æœ€åç¼–å†™å®ç°ç±»


```java
    @Override
    public boolean updateTeam(TeamUpdateRequest teamUpdateRequest, User loginUser) {
        //1. åˆ¤æ–­è¯·æ±‚å‚æ•°æ˜¯å¦ä¸ºç©º
        if(teamUpdateRequest == null){
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        //2. æŸ¥è¯¢é˜Ÿä¼æ˜¯å¦å­˜åœ¨
        Long id = teamUpdateRequest.getId();
        if(id == null || id <= 0){
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "é˜Ÿä¼idé”™è¯¯");
        }
        Team team = getById(id);
        if(team == null){
            throw new BusinessException(ErrorCode.PARAMS_ERROR,"é˜Ÿä¼ä¸å­˜åœ¨");
        }

        //3. åªæœ‰ç®¡ç†å‘˜æˆ–è€…é˜Ÿä¼çš„åˆ›å»ºè€…å¯ä»¥ä¿®æ”¹
        if(!teamUpdateRequest.getId().equals(loginUser.getId()) && !StringUtils.equals(loginUser.getUserRole(), "admin")){
            System.out.println("" + !teamUpdateRequest.getId().equals(loginUser.getId()) + !StringUtils.equals(loginUser.getUserRole(), "admin"));
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }

        //4. å¦‚æœç”¨æˆ·ä¼ å…¥çš„æ–°å€¼å’Œè€å€¼ä¸€è‡´ï¼Œå°±ä¸ç”¨ update äº†ï¼ˆå¯è‡ªè¡Œå®ç°ï¼Œé™ä½æ•°æ®åº“ä½¿ç”¨æ¬¡æ•°ï¼‰
        //5. å¦‚æœé˜Ÿä¼çŠ¶æ€æ”¹ä¸ºåŠ å¯†ï¼Œå¿…é¡»è¦æœ‰å¯†ç 
        TeamStatusEnum statusEnum = TeamStatusEnum.getTeamStatusByValue(teamUpdateRequest.getStatus());
        if(statusEnum.equals(TeamStatusEnum.SECRET)){
            if(StringUtils.isBlank(teamUpdateRequest.getPassword())){
                throw new BusinessException(ErrorCode.PARAMS_ERROR,"åŠ å¯†æˆ¿é—´å¿…é¡»è®¾ç½®å¯†ç ");
            }
        }

        //6. æ›´æ–°æˆåŠŸ
        Team updateTeam = new Team();
        BeanUtils.copyProperties(teamUpdateRequest, updateTeam);
        boolean result = updateById(updateTeam);

        return result;
    }
```



#### 4.æµ‹è¯•ï¼Œæˆ‘è¿™é‡Œæ›´æ–°äº†ç¬¬30ç»„çš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ ¸éªŒæ˜¯å¦ä¿®æ”¹æˆåŠŸ

![image-20241114103146667](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/image-20241114103146667.png)  

æ›´æ–°æˆåŠŸ

![image-20241114103053973](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/image-20241114103053973.png)



### 4.åœ¨TeamServiceé‡Œç¼–å†™ç”¨æˆ·åŠ å…¥é˜Ÿä¼æ–¹æ³•å¹¶åœ¨TeamServiceImplé‡Œå®ç°


#### 1.åŒæ ·åœ¨è¯·æ±‚åŒ…é‡Œå°è£…ä¸€ä¸ªç”¨æˆ·åŠ å…¥é˜Ÿä¼è¯·æ±‚ä½“


```java
/**
 * ç”¨æˆ·åŠ å…¥é˜Ÿä¼è¯·æ±‚ä½“
 *
 * @author shaosao
 */
@Data
public class TeamJoinRequest implements Serializable {

    private static final long serialVersionUID = -24663018187059425L;

    /**
     * id
     */
    private Long teamId;

    /**
     * å¯†ç 
     */
    private String password;
}
```



#### 2.åœ¨TeamServiceé‡Œé¢å®ç°joinTeamæ–¹æ³•å¹¶å®ç°


![1669130254163-4ffa504a-b1f9-4513-9402-68b870836525.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669130254163-4ffa504a-b1f9-4513-9402-68b870836525-276844-1731311693314-32.png)



#### 3.ç¼–å†™ç”¨æˆ·åŠ å…¥é˜Ÿä¼æ¥å£


```java
    @PostMapping("/join")
    public BaseResponse<Boolean> joinTeam(@RequestBody TeamJoinRequest teamJoinRequest,HttpServletRequest request){
        if (teamJoinRequest==null){
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        User loginUser = userService.getLoginUser(request);
        boolean result = teamService.joinTeam(teamJoinRequest, loginUser);
        return ResultUtils.success(result);
    }
```



```java
 @Override
    public boolean joinTeam(TeamJoinRequest teamJoinRequest, User loginUser) {
        if (teamJoinRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        Long teamId = teamJoinRequest.getTeamId();
        if (teamId == null || teamId <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        Team team = this.getById(teamId);
        if (team == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "é˜Ÿä¼ä¸å­˜åœ¨");
        }
        Date expireTime = team.getExpireTime();
        if (expireTime != null && expireTime.before(new Date())) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "é˜Ÿä¼å·²è¿‡æœŸ");
        }
        Integer status = team.getStatus();
        TeamStatusEnum teamStatusEnum = TeamStatusEnum.getEnumByValue(status);
        if (teamStatusEnum.PRIVATE.equals(teamStatusEnum)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç¦æ­¢åŠ å…¥ç§æœ‰é˜Ÿä¼");
        }
        String password = teamJoinRequest.getPassword();
        if (teamStatusEnum.SECRET.equals(teamStatusEnum)) {
            if (StringUtils.isBlank(password) || !password.equals(team.getPassword())) {
                throw new BusinessException(ErrorCode.PARAMS_ERROR, "å¯†ç é”™è¯¯");
            }
        }
        //è¯¥ç”¨æˆ·å·²åŠ å…¥çš„é˜Ÿä¼æ•°é‡ æ•°æ®åº“æŸ¥è¯¢æ‰€ä»¥æ”¾åˆ°ä¸‹é¢ï¼Œå‡å°‘æŸ¥è¯¢æ—¶é—´
        Long userId = loginUser.getId();
        QueryWrapper<UserTeam> userTeamQueryWrapper = new QueryWrapper<>();
        userTeamQueryWrapper.eq("userId", userId);
        long hasJoinNum = userTeamService.count(userTeamQueryWrapper);
        if (hasJoinNum > 5) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "æœ€å¤šåˆ›å»ºå’ŒåŠ å…¥5ä¸ªé˜Ÿä¼");
        }
        //ä¸èƒ½é‡å¤åŠ å…¥å·²åŠ å…¥çš„é˜Ÿä¼
        userTeamQueryWrapper = new QueryWrapper<>();
        userTeamQueryWrapper.eq("userId", userId);
        userTeamQueryWrapper.eq("teamId", teamId);
        long hasUserJoinTeam = userTeamService.count(userTeamQueryWrapper);
        if (hasUserJoinTeam > 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·å·²åŠ å…¥è¯¥é˜Ÿä¼");
        }
        //å·²åŠ å…¥é˜Ÿä¼çš„äººæ•°
        userTeamQueryWrapper = new QueryWrapper<>();
        userTeamQueryWrapper.eq("teamId", teamId);
        long teamHasJoinNum = userTeamService.count(userTeamQueryWrapper);
        if (teamHasJoinNum >= team.getMaxNum()) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "é˜Ÿä¼å·²æ»¡");
        }
        //ä¿®æ”¹é˜Ÿä¼ä¿¡æ¯
        UserTeam userTeam = new UserTeam();
        userTeam.setUserId(userId);
        userTeam.setTeamId(teamId);
        userTeam.setJoinTime(new Date());
        return userTeamService.save(userTeam);
    }
```



PSï¼šä¸‹é¢çº¢æ¡†ä»£ç å°½é‡æ”¾åœ¨ä¸‹é¢ï¼Œå› ä¸ºå®ƒæ˜¯sqlæŸ¥è¯¢ï¼Œä¼šæµªè´¹å¤§é‡æ—¶é—´ï¼Œæ”¾åœ¨ä¸‹é¢å¯ä»¥åœ¨é€šè¿‡ä¸Šé¢çš„æ ¡éªŒå†æŸ¥è¯¢ï¼Œå°½å¯èƒ½çš„å‡å°‘æŸ¥è¯¢æ¬¡æ•°![1669163277446-d9575112-c7d6-42b1-af30-77c6deb0a196.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669163277446-d9575112-c7d6-42b1-af30-77c6deb0a196-151123-1731311693314-33.png)



#### 4.æµ‹è¯•ï¼šå¼€ä¸¤ä¸ªknife4jåå°


**è¸©å‘å¤„ï¼šæˆ‘è¿™é‡Œå«Œéº»çƒ¦ç›´æ¥æ–°ç™»å½•äº†ä¸€ä¸ªåŸæ¥æ³¨å†Œçš„ç”¨æˆ·ï¼Œç»“æœå®ƒæ˜¯ç®¡ç†å‘˜ï¼Œåé¢æµ‹è¯•æ›´æ–°çš„æ—¶å€™ï¼Œä¿®æ”¹æˆåŠŸï¼ˆè¿˜ä»¥æ˜¯bugï¼ŒæŸ¥bugå¥½ä¹…ã€‚ã€‚ã€‚ã€‚ï¼‰,æ‰€ä»¥æœ€å¥½æ–°å»ºä¸€ä¸ªç”¨æˆ·**  
åœ¨å®Œæˆæ³¨å†Œå’Œç™»å½•ä¹‹åï¼Œå…ˆåŠ ä¸€ä¸ªç§æœ‰é˜Ÿä¼ï¼ŒæˆåŠŸæ˜¾ç¤ºæŠ¥é”™ï¼ˆç¦æ­¢åŠ å…¥ç§æœ‰é˜Ÿä¼ï¼‰  
![1669133262822-ffe64f8f-4428-4ace-af4b-59edceb9923e.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669133262822-ffe64f8f-4428-4ace-af4b-59edceb9923e-675456-1731311693314-34.png)  
åŠ å…¥ä¸€ä¸ªå…¬å¼€é˜Ÿä¼ï¼ŒæˆåŠŸï¼  
![1669133330534-06edad87-d933-477c-9d4a-a5ba86485fe7.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669133330534-06edad87-d933-477c-9d4a-a5ba86485fe7-121798-1731311693314-35.png)  
æ•°æ®åº“é‡Œçš„ç”¨æˆ·é˜Ÿä¼å…³ç³»è¡¨ä¹Ÿæ›´æ–°æˆåŠŸ  
![1669133373585-92147ed7-79ff-4d4b-9fb7-4f9572f6b226.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669133373585-92147ed7-79ff-4d4b-9fb7-4f9572f6b226-478760-1731311693314-36.png)  
æµ‹è¯•ä¿®æ”¹é˜Ÿä¼åŠŸèƒ½ï¼Œå…ˆä½¿ç”¨æ–°æ³¨å†Œçš„ç”¨æˆ·ï¼Œç»“æœæ­£å¸¸æ˜¾ç¤ºæ— æƒé™  
![1669161731375-a5e750d7-cc92-4fe4-9d40-b02aa5c4bcb1.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669161731375-a5e750d7-cc92-4fe4-9d40-b02aa5c4bcb1-840420-1731311693314-37.png)  
æ¢åˆ›å»ºç”¨æˆ·çš„æ›´æ–°  
![1669161773187-f8204d39-d2b5-4be3-a190-ac4c29e359c0.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669161773187-f8204d39-d2b5-4be3-a190-ac4c29e359c0-814084-1731311693314-38.png)



æˆåŠŸä¿®æ”¹ï¼Œæ•°æ®åº“ä¹Ÿæ›´æ–°  
![1669161794404-85e64dc9-e360-4314-8d99-7aa1f896bf40.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669161794404-85e64dc9-e360-4314-8d99-7aa1f896bf40-235769-1731311693314-39.png)  
**ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªbugï¼Œå¦‚æœä¸å¸¦å‚æ•°ï¼Œå°±ä¼šæ˜¾ç¤ºä¸ºç©ºï¼Œå³æˆ‘ä»¬ä¸èƒ½å®ç°é€‰æ‹©æ›´æ–°ï¼Œå°±æ˜¯è¯´ä¸èƒ½å•ç‹¬ä¿®æ”¹ä¸€å¤„ï¼ˆåªèƒ½è·Ÿå‰ç«¯ç»Ÿä¸€è¦æ±‚)æˆ–è€…å»ä¿®æ”¹è¿™ä¸ªbug**



æ›´æ¢åŠ å…¥é˜Ÿä¼çš„ç”¨æˆ·ï¼Œå†æ¬¡åŠ å…¥ï¼ˆä¸å¸¦å¯†ç ï¼‰ï¼Œæ­£å¸¸æ˜¾ç¤ºå¯†ç é”™è¯¯  
![1669162404515-651a6172-662d-41e5-81a6-4c498488af86.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669162404515-651a6172-662d-41e5-81a6-4c498488af86-860643-1731311693314-40.png)



å¸¦å¯†ç åŠ å…¥ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åŠ å…¥ï¼Œæ˜¾ç¤ºä¸èƒ½é‡å¤åŠ å…¥å·²åŠ å…¥çš„é˜Ÿä¼  
![1669162454078-ff420ca2-201e-44cd-8207-9bfcaa02a9ce.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669162454078-ff420ca2-201e-44cd-8207-9bfcaa02a9ce-646271-1731311693314-41.png)  
ä¸ºäº†æµ‹è¯•åŠ å¯†é˜Ÿä¼åŠŸèƒ½æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å®ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ›å»ºè´¦æˆ·æ›´æ–°å¦ä¸€ä¸ªé˜Ÿä¼ï¼ˆè¿™é‡Œæˆ‘æ˜¯13ï¼‰ï¼Œéœ€è¦æ–°è´¦æˆ·ä¸ºåŠ å…¥çš„ï¼Œæ›´æ”¹ä¸ºéœ€è¦å¯†ç åŠ å…¥  
æ›´æ¢ä¸ºæ–°æ³¨å†Œç”¨æˆ·ï¼Œä¸å¸¦å¯†ç åŠ å…¥ï¼ŒæŠ¥é”™æ­£å¸¸  
![1669162559537-4fc490f7-f826-44bd-bc9b-c547003b20e8.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669162559537-4fc490f7-f826-44bd-bc9b-c547003b20e8-777988-1731311693314-42.png)  
å¸¦å…¥å¯†ç åŠ å…¥ï¼ŒæˆåŠŸåŠ å…¥  
![1669162608591-27529d96-3c9f-4264-9a60-e3962aa756e8.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669162608591-27529d96-3c9f-4264-9a60-e3962aa756e8-282094-1731311693314-43.png)  
æ•°æ®åº“é‡Œçš„ç”¨æˆ·é˜Ÿä¼å…³ç³»è¡¨ä¹Ÿæ›´æ–°æˆåŠŸ  
![1669162641731-1df36185-505d-4a3c-b29e-ab9ae71bba9e.png](./assets/10é˜Ÿä¼çš„å¢åˆ æ”¹æŸ¥&å…¥é˜Ÿ/1669162641731-1df36185-505d-4a3c-b29e-ab9ae71bba9e-993288-1731311693314-44.png)



## ç¬¬åæœŸå®Œç»“ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰


> æ›´æ–°: 2023-02-10 10:06:37  
> åŸæ–‡: <https://www.yuque.com/shierkcs/catstudy/qxidpwdpzncd1fw1>