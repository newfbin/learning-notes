# 04 æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•

ç›´æ’­å›è®¿ï¼š[ä» 0 åˆ° 1 å¼€å‘æ‰¾ä¼™ä¼´ç³»ç»Ÿï¼ˆ4ï¼‰](https://t.zsxq.com/03Eu3VNJ2)ï¼ˆé¡µé¢å¼€å‘å’Œåˆ†å¸ƒå¼ï¼‰

## ä¼™ä¼´åŒ¹é…ç³»ç»Ÿç¬¬å››æœŸ

### æœ¬æœŸç›®æ ‡è®¡åˆ’


1. é¡µé¢å’ŒåŠŸèƒ½å¼€å‘ 
   1. æœç´¢é¡µé¢ âˆš
   2. ç”¨æˆ·ä¿¡æ¯
   3. ç”¨æˆ·ä¿®æ”¹é¡µé¢
2. æ”¹é€ ç”¨æˆ·ä¸­å¿ƒï¼ŒæŠŠå•æœºç™»å½•æ”¹ä¸ºåˆ†å¸ƒå¼ session ç™»å½• âˆš
3. æ ‡ç­¾çš„æ•´ç†ã€ç»†èŠ‚çš„ä¼˜åŒ–



### 2.å‰ç«¯é¡µé¢è·³è½¬ä¼ å€¼


1. query => url searchParamsï¼Œurl åé™„åŠ å‚æ•°ï¼Œä¼ é€’çš„å€¼é•¿åº¦æœ‰é™
2. vuexï¼ˆå…¨å±€çŠ¶æ€ç®¡ç†ï¼‰ï¼Œæœç´¢é¡µå°†å…³é”®è¯å¡åˆ°çŠ¶æ€ä¸­ï¼Œæœç´¢ç»“æœé¡µä»çŠ¶æ€å–å€¼



### 3.todo å¾…ä¼˜åŒ–


å‰ç«¯ï¼šåŠ¨æ€å±•ç¤ºé¡µé¢æ ‡é¢˜ã€å¾®è°ƒæ ¼å¼



## ä¸€ã€é¡µé¢å’ŒåŠŸèƒ½å¼€å‘


### 1.æœç´¢é¡µé¢


#### ï¼ˆ1ï¼‰æ–°å»ºUserResultPage.vueï¼Œåˆ›å»ºé¡µé¢ï¼ŒåŒæ—¶åˆ«å¿˜äº†åœ¨è·¯ç”±é‡Œå¼•å…¥è¿™ä¸ªé¡µé¢


#### ï¼ˆ2ï¼‰ä¼˜åŒ–SearchPageé¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªæœç´¢æŒ‰é’®ï¼Œæ¥å®ç°ç‚¹å‡»æäº¤é€‰ä¸­çš„æ ‡ç­¾åˆ°UserResultPageé¡µé¢


```javascript
  <div style="padding: 16px">
    <van-button block type="primary" @click="doSearchResult">æœç´¢</van-button>
  </div>

import {useRouter} from 'vue-router';
const router = useRouter();

const doSearchResult = () => {
  router.push({
    path: '/user/list',
    query: {
      tags: activeIds.value
    }
  })
}
```



> psï¼šåƒä¸‡åˆ«å¿˜äº†å¼•å…¥useRouterå’Œå®šä¹‰routerå¸¸é‡ï¼Œæˆ‘è¿™è¾¹æ²¡å¼•å…¥ä½†æ˜¯ä¸æŠ¥é”™ï¼ˆæ¯”è¾ƒè¿·æƒ‘äººï¼‰



æ˜¾ç¤ºå¦‚ä¸‹ï¼š  
![1668527384277-6d1cd076-01a0-4155-b86b-5681c6542efd.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668527384277-6d1cd076-01a0-4155-b86b-5681c6542efd-779456-1729072412821-42.png)



ç‚¹å‡»æœç´¢æŒ‰é’®ï¼Œå¯è§‚å¯Ÿåˆ°è·¯å¾„è·³è½¬ä¼šå¸¦æœ‰å‚æ•°



![1668527762370-9f88b11a-97d4-44d7-aefb-1f02a7f9419a.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668527762370-9f88b11a-97d4-44d7-aefb-1f02a7f9419a-091367-1729072412822-43.png)



#### ï¼ˆ3ï¼‰å®Œå–„UserResultPageé¡µé¢ï¼Œæ¥æ˜¾ç¤ºç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¾æ—§ä»vantçš„ç»„ä»¶åº“å¯»æ‰¾åˆé€‚çš„ç»„ä»¶


å› ä¸ºç”¨æˆ·ä¿¡æ¯ä¸­è¦åŒ…æ‹¬ä¸ªäººç®€ä»‹ï¼Œè€Œæˆ‘ä»¬ç”¨æˆ·ä¸­å¿ƒçš„æ•°æ®ä¸­å¹¶æœªåŒ…å«è¿™ä¸€å­—æ®µï¼Œç°åœ¨å»æ·»åŠ   
å…·ä½“æ“ä½œå°±ä¸æ¼”ç¤ºäº†ï¼Œä¿®æ”¹è¡¨ä¹‹åDDLè¯­å¥æ”¹å˜å¦‚ä¸‹  
![1668528970611-7df3101f-14ef-45f2-9320-5f3edaeb0f5a.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668528970611-7df3101f-14ef-45f2-9320-5f3edaeb0f5a-036897.png)  
ä¿®æ”¹æ•°æ®åº“ä¹‹åè¿˜å¹¶æœªå¯¹åç«¯å¯¹åº”æ•°æ®åº“çš„å†…å®¹åšç›¸åº”çš„å¢åŠ ã€‚å·ä¸ªæ‡’ï¼Œç­‰ä¸‹æ¬¡ä¿®æ”¹åç«¯æ—¶å†ä¿®æ”¹  
è¿›å…¥å‰ç«¯çš„ç”¨æˆ·å¯¹è±¡çš„è§„èŒƒï¼Œä¹Ÿæ·»åŠ è¿™ä¸€å­—æ®µ  
![1668529389803-2ca25748-0660-4f42-a46f-498fa79625fc.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668529389803-2ca25748-0660-4f42-a46f-498fa79625fc-186340.png)  
ç°åœ¨æ­£å¼è¿›å…¥ä¿®æ”¹é¡µé¢ç¯èŠ‚ï¼Œåœ¨vantæ–‡æ¡£ä¸­å¤åˆ¶å•†å“å¡ç‰‡ç»„ä»¶  
![1668529280804-43ff525c-1d42-4ebe-9bc0-310f9a248180.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668529280804-43ff525c-1d42-4ebe-9bc0-310f9a248180-935811-1729072412822-44.png)



å¤åˆ¶åˆ°UserResultPageé¡µé¢å¹¶ä¿®æ”¹å¦‚ä¸‹ï¼š



```vue
<!--
User:Shier
CreateTime:10:10
-->

<template>
  <van-card
      v-for="user in userList"
      :desc="`ä¸ªäººç®€ä»‹ï¼š${user.profile}`"
      :title="`${user.username} (${user.planetCode})`"
      :thumb="user.avatarUrl"
  >
    <template #tags>
      <van-tag plain type="danger" v-for="tag in tags" style="margin-right: 8px; margin-top: 10px" >
        {{tag}}
      </van-tag>
    </template>
    <template #footer>
      <van-button size="mini">è”ç³»æˆ‘</van-button>
    </template>
  </van-card>
</template>

<script setup >
  import {ref} from "vue";
  import {useRoute} from "vue-router";

  const route = useRoute();
  const {tags} = route.query;

  const mockUser = {
    id: 2767,
    username: 'çŒ«åäºŒæ‡¿',
    userAccount: 'shier',
    avatarUrl: 'https://img1.baidu.com/it/u=467212011,1034521901&fm=253&fmt=auto&app=120&f=JPEG?w=500&h=500',
    gender: 0,
    profile: 'åƒé‡Œä¸è¾è¡Œè·¯è¿œã€‚ä¸ªäººå¯¹ä¸€äº›çŒ«æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå–œæ¬¢æ’¸çŒ«ğŸ˜',
    phone: '121311313',
    email: '23432@qq.com',
    planetCode: '2767',
    userRole: 'ç®¡ç†å‘˜',
    createTime: new Date(),
    tags: ['java', 'å‰ç«¯', 'å®ä¹ ', 'åç«¯', 'å¼€å­¦'],
  };

  const userList = ref({mockUser});

</script>

<style scoped>

</style>
```



å¯åŠ¨ï¼Œåœ¨searchè·¯å¾„ä¸‹é€‰æ‹©æ ‡ç­¾ç‚¹å‡»æœç´¢ï¼ŒæˆåŠŸè·³è½¬åˆ°UserResultPageé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š

![abd37fd9-26ab-45be-aa2c-bd7a234c65b1](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/abd37fd9-26ab-45be-aa2c-bd7a234c65b1.png)



#### (4).å‰ç«¯é¡µé¢å·²å¼€å‘å®Œæˆï¼Œç°åœ¨å¼€å‘åç«¯ï¼Œå’Œå‰ç«¯è¿›è¡Œå¯¹æ¥


å¯¹æ¥åç«¯æ¥å£ï¼Œåœ¨controllerå±‚ç¼–å†™ä»£ç 



```java
    //æ ¹æ®æ ‡ç­¾æŸ¥è¯¢ç”¨æˆ·
    @GetMapping("/search/tags")
    public BaseResponse<List<User>> searchUsersByTags(@RequestParam(required = false) List<String> tagNameList){
        if (CollectionUtils.isEmpty(tagNameList)){
            return ResultUtils.error(ErrorCode.PARAMS_ERROR);
        }
        List<User> userList = userService.searchUsersByTags(tagNameList);
        return ResultUtils.success(userList);
    }
```



debugå¯åŠ¨é¡¹ç›®ï¼Œå»knife4jæ¥å£æ“ä½œï¼Œç¡®ä¿å·²ç»ç™»å½•ï¼Œä¼ ä¸¤ä¸ªå‚æ•°ï¼Œå›åç«¯çœ‹çœ‹æ˜¯å¦è·å–å‚æ•°  
![1668563177356-0867425f-a1a7-44f2-a4af-537445ff27e1.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668563177356-0867425f-a1a7-44f2-a4af-537445ff27e1-439214.png)



> banner.txt ä¿®æ”¹é¡¹ç›®å…¶ä¸­æ—¶çš„ä¿¡æ¯ [é€‰æ‹©ä¸€äº›å¥½çœ‹çš„å›¾æ¡ˆ](https://www.bootschool.net/ascii-art)
>
> ![a0eacca2-3b32-4bde-85a3-d586520773a9](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/a0eacca2-3b32-4bde-85a3-d586520773a9.png)



> æ¥å£æ–‡æ¡£é“¾æ¥ï¼š [http://localhost:8080/api/doc.html#/home](http://localhost:8080/api/doc.html#/home)



![1668563232321-98e9e874-f9b0-4bb7-8b40-8180eb5eae53.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668563232321-98e9e874-f9b0-4bb7-8b40-8180eb5eae53-416770-1729072412822-45.png)  
å¸¦ç©ºå‚æ•°è¯·æ±‚  
![1668563267528-aa791095-3302-4bb5-b853-85c06aae0b15.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668563267528-aa791095-3302-4bb5-b853-85c06aae0b15-531822-1729072412822-46.png)



> æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„æŠ¥é”™ï¼ˆè¯·æ±‚å‚æ•°é”™è¯¯)æˆåŠŸï¼ç°åœ¨å›å‰ç«¯å¯¹æ¥åç«¯



#### (5)å¼€å‘å‰ç«¯æ¥å£


é¦–å…ˆè¦åœ¨å‰ç«¯å¼•å…¥[axios](http://www.axios-js.com/) ç»ˆç«¯è¾“å…¥



```plain
ä½¿ç”¨ npm:
 npm install axios
     
ä½¿ç”¨ bower:
 bower install axios

ä½¿ç”¨ yarn
    yarn add axios
```



åœ¨srcç›®å½•ä¸‹æ–°å»ºpluginsåŒ…å’ŒmyAxios.tsï¼Œå¤åˆ¶axiosæ–‡æ¡£ä¸­å¦‚ä¸‹ä»£ç ï¼Œå¹¶ä¿®æ”¹æ•´ç†å¦‚ä¸‹ï¼š  
![1668576274662-2c463ed5-cffb-408d-b668-eee37359231b.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668576274662-2c463ed5-cffb-408d-b668-eee37359231b-475394.png)![1668576314350-ceaa1fb0-a269-44cd-b44f-8a608a2a65c8.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668576314350-ceaa1fb0-a269-44cd-b44f-8a608a2a65c8-890880-1729072412822-47.png)



```javascript
import axios from "axios";

// Set config defaults when creating the instance
const myAxios = axios.create({
    baseURL: 'http://localhost:8080/api',
});

// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
myAxios.interceptors.request.use(function (config) {
    console.log("æˆ‘è¦å‘é€è¯·æ±‚äº†,",config)
    return config;
}, function (error) {
    // å¯¹è¯·æ±‚é”™è¯¯åšäº›ä»€ä¹ˆ
    return Promise.reject(error);
});

// æ·»åŠ å“åº”æ‹¦æˆªå™¨
myAxios.interceptors.response.use(function (response) {
    // å¯¹å“åº”æ•°æ®åšç‚¹ä»€ä¹ˆ
    console.log("æˆ‘æ”¶åˆ°ä½ çš„å“åº”äº†,",response)
    return response;
}, function (error) {
    // å¯¹å“åº”é”™è¯¯åšç‚¹ä»€ä¹ˆ
    return Promise.reject(error);
});

export default myAxios;
```



åœ¨userSearchPageé¡µé¢æ–°å¢å¦‚ä¸‹ä»£ç ç”¨æ¥é¡µé¢æŒ‚è½½ onMounted é’©å­



```javascript
onMounted(() => {
    // è¯·æ±‚çš„urlã€å‚æ•°
    myAxios.get('/user/search/tags',{
        params: {
            tagNameList: tags
        }
    })
    .then(function (response) {
        console.log('/user/search/tags succeed',response);
        Toast.success('è¯·æ±‚æˆåŠŸ');
    })
    .catch(function (error) {
        console.error('/user/search/tags error',error);
        Toast.fail('è¯·æ±‚å¤±è´¥');
    })
})
```



![1668581872554-195f0e5f-cb46-472c-a675-0c1825088ed0.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668581872554-195f0e5f-cb46-472c-a675-0c1825088ed0-496723-1729072412822-48.png)  
è·¨åŸŸäº†ï¼Œæˆ‘ä»¬åœ¨åç«¯è§£å†³è¿™ä¸ªé—®é¢˜  
![1668589980510-9d6a538a-4fb2-4ec7-bbcc-481b27ca5ae2.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668589980510-9d6a538a-4fb2-4ec7-bbcc-481b27ca5ae2-409560-1729072412822-49.png)



**è¸©å‘å¤„ï¼šè¿™è¾¹ä¸€å¼€å§‹ä¸è¦å¸¦æœ‰å‚æ•°è¯·æ±‚ï¼Œä¸ç„¶ä¼šä¸€ç›´æ˜¾ç¤ºè·¨åŸŸï¼ˆä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› é€ æˆçš„ï¼Œå¸Œæœ›æœ‰å¤§ä½¬è§£ç­”ï¼‰**  
å†æ¬¡è¿è¡Œï¼ˆåˆ·æ–°ï¼‰  
å‘ç°è·¯å¾„åé¢å¸¦æœ‰çš„å‚æ•°ä¸åˆè§„èŒƒï¼Œå¸¦æœ‰[]ã€‚æˆ‘ä»¬è¿™è¾¹å¯ä»¥å¼•å…¥qså»ç”¨äºå‚æ•°åºåˆ—åŒ–,å¤„ç†å‘é€è¯·æ±‚çš„å‚æ•°  
![1668587022001-89042a4d-0bfd-4530-aafa-9b639701b11a.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668587022001-89042a4d-0bfd-4530-aafa-9b639701b11a-663335-1729072412822-50.png)  
![1668590138022-45bfdf2a-9b64-4aa8-877e-15a14179267f.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668590138022-45bfdf2a-9b64-4aa8-877e-15a14179267f-911219.png)



> **è¸©å‘å¤„ï¼šè¿™è¾¹åˆè¸©äº†å¤§å‘ï¼Œå¯èƒ½ç”±äºaxiosçš„ç‰ˆæœ¬é—®é¢˜ï¼ŒæŒ‰ç…§é±¼çš®çš„å†™ï¼Œä¼šæŠ¥é”™ï¼šUncaught (in promise) **  
> **{message: 'options must be an object', name: 'AxiosError', code: 'ERR_BAD_OPTION_VALUE', stack: 'AxiosError: options must be an object\n at Objecâ€¦ji.com/static/js/chunk-libs.c096185b.js:42:41367)'}.............**



axiosç‰ˆæœ¬å¦‚æœæ˜¯æ¯”è¾ƒæ–°çš„ï¼Œè¦æŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºå†™ï¼Œå†æ¬¡åˆ·æ–°æˆåŠŸè·å–  
![1668589780102-30c16958-00cb-47bf-a157-5970a553206d.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668589780102-30c16958-00cb-47bf-a157-5970a553206d-240691-1729072412822-51.png)



debugå¯åŠ¨ï¼Œæ‰“ä¸ªæ–­ç‚¹ï¼Œå†æ¬¡åˆ·æ–°ï¼Œå¯ä»¥åœ¨åç«¯è§‚å¯Ÿåˆ°æˆåŠŸè·å–å‰ç«¯çš„å‚æ•°



![1668589892378-d7d05348-2854-4639-aef4-bfd2b4692156.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668589892378-d7d05348-2854-4639-aef4-bfd2b4692156-307357-1729072412822-52.png)  
ç°åœ¨è¦å°†æ•°æ®åº“å¯¹æ¥ä¸Šï¼Œä¸å†ä½¿ç”¨å‡æ•°æ®ï¼Œé¦–å…ˆå¾€æ•°æ®åº“é‡Œæ·»åŠ å‡æ•°æ®ï¼ˆå°½é‡è¯¦ç»†)



![1668603593826-61c4974e-542a-432f-bc73-1cb6c42bccae.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668603593826-61c4974e-542a-432f-bc73-1cb6c42bccae-957157-1729072412822-53.png)



> forEachå‡½æ•°ä¼šæ˜¾ç¤ºæ²¡æœ‰è¿™ä¸ªå‡½æ•°ï¼Œå†™æˆuserListData?.data.forEachç¼–è¯‘ä¸ä¼šæŠ¥é”™ä½†è¿è¡Œä¼šæŠ¥é”™ï¼Œæ‰€ä»¥ä¸è¦ç®¡ç¼–è¯‘æŠ¥é”™ï¼Œç…§ç€é±¼çš®çš„å†™ã€‚  
> è¸©å‘å¤„ï¼šæ³¨æ„æ•°æ®åº“é‡Œçš„é€»è¾‘åˆ é™¤æ˜¯ä¸æ˜¯1ï¼ˆæ‰€ä»¥æ•°æ®å°½é‡å¤šå†™ç‚¹)ï¼Œæˆ‘è¿™è¾¹ç”±äºæ²¡ä»”ç»†çœ‹ï¼Œâ€œç”·â€æ ‡ç­¾å°±ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯è¢«é€»è¾‘åˆ é™¤äº†ï¼Œç»“æœåªæ˜¾ç¤ºä¸€ä¸ªï¼Œè¿˜ä»¥ä¸ºå¾ªç¯å‡ºé”™ï¼ŒæŸ¥äº†å¥½ä¹…ã€‚ã€‚ã€‚



`SearchResultPage.vue` å®Œæ•´ä»£ç å¦‚ä¸‹

> æˆ‘æ²¡æœ‰ä½¿ç”¨ Toast.successã€‚ã€‚ã€‚ ä¸ç„¶ä¼šæŠ¥é”™è¯´Toast is not defined çš„

```vue
<!--
User:Shier
CreateTime:10:10
-->
<template>
  <van-card
      v-for="user in userList"
      :desc="user.profile"
      :title="`${user.username} (${user.planetCode})`"
      :thumb="user.avatarUrl"
  >
    <template #tags>
      <van-tag plain type="danger" v-for="tag in tags" style="margin-right: 8px; margin-top: 8px">
        {{ tag }}
      </van-tag>
    </template>
    <template #footer>
      <van-button size="mini">è”ç³»æˆ‘</van-button>
    </template>
  </van-card>
  <van-empty v-if="!userList || userList.length < 1" description="æœç´¢ç»“æœä¸ºç©º"/>
</template>

<script setup>
  import {onMounted, ref} from "vue";
  import {useRoute} from "vue-router";
  import {Toast} from "vant";

  import myAxios from "../plugins/myAxios.js";

  import qs from 'qs'

  const route = useRoute();
  const {tags} = route.query;
    
  const userList = ref([]);//å­˜æ”¾ç”¨æˆ·åˆ—è¡¨
    // ä½¿ç”¨é’©å­å‡½æ•°
  onMounted(async () => {//å¼‚æ­¥è°ƒç”¨
    // ä¸ºç»™å®š ID çš„ user åˆ›å»ºè¯·æ±‚
    const userListData = await myAxios.get('/user/search/tags', {
      withCredentials: false,
      params: {
        tagNameList: tags
      },
      //åºåˆ—åŒ–
      paramsSerializer: {
        serialize: params => qs.stringify(params, {indices: false}),
      },
    })
        .then(function (response) {
          console.log('/user/search/tags succeed', response);
          return response.data?.data; //è¿”å›æ•°æ®  ?.å¯é€‰é“¾æ“ä½œç¬¦ï¼Œé¿å…æ•°æ®ä¸ºnullæˆ–undefinedæ—¶æŠ¥é”™
        })
        .catch(function (error) {
          console.log('/user/search/tags error', error);
          Toast.fail('è¯·æ±‚å¤±è´¥');
        });
    if (userListData) {
      userListData.forEach(user => {
        if (user.tags) {
          user.tags = JSON.parse(user.tags);
        }
      })
      userList.value = userListData;
    }
  })
</script>

<style scoped>

</style>
```



æ˜¾ç¤ºå¦‚ä¸‹ï¼š

![431011d8-a19f-4453-bff0-9fcf1b843464](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/431011d8-a19f-4453-bff0-9fcf1b843464.png)

![dd2989b4-1ba1-4df6-87cc-a8484e8b143a](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/dd2989b4-1ba1-4df6-87cc-a8484e8b143a.png)



## äºŒã€æ”¹é€ ç”¨æˆ·ä¸­å¿ƒï¼ŒæŠŠå•æœºç™»å½•æ”¹ä¸ºåˆ†å¸ƒå¼ session ç™»å½•

### ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ï¼Ÿ

> AI è¯´ï¼š  
> **åˆ†å¸ƒå¼ï¼ˆDistributedï¼‰æ˜¯æŒ‡å°†è®¡ç®—ã€å­˜å‚¨å’Œå¤„ç†ä»»åŠ¡åˆ†æ•£åˆ°å¤šå°è®¡ç®—æœºæˆ–æœåŠ¡å™¨ä¸Šè¿›è¡Œå®Œæˆçš„ä¸€ç§è®¡ç®—æ¨¡å¼**ã€‚ä¼ ç»Ÿçš„é›†ä¸­å¼ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„è®¡ç®—å’Œæ•°æ®å¤„ç†éƒ½ä¾èµ–äºä¸­å¤®æœåŠ¡å™¨ï¼Œè€Œåˆ†å¸ƒå¼ç³»ç»Ÿåˆ™å°†ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œå¹¶å°†å…¶åˆ†é…ç»™ä¸åŒçš„è®¡ç®—æœºèŠ‚ç‚¹æ¥å¹¶è¡Œå¤„ç†ã€‚
>
> åˆ†å¸ƒå¼è®¡ç®—æœ‰ä»¥ä¸‹å‡ ä¸ªä¸»è¦çš„ä½œç”¨ï¼š
>
> 1. æé«˜æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ï¼šé€šè¿‡å°†ä»»åŠ¡åˆ†å¸ƒåˆ°å¤šä¸ªè®¡ç®—æœºä¸Šæ‰§è¡Œï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤Ÿå……åˆ†åˆ©ç”¨è®¡ç®—èµ„æºï¼Œæé«˜ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å’Œæ€§èƒ½ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€æ‰©å±•ç³»ç»Ÿè§„æ¨¡ã€‚
> 2. æé«˜å¯é æ€§å’Œå®¹é”™æ€§ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿé€šè¿‡æ•°æ®å†—ä½™å’Œä»»åŠ¡å¤åˆ¶ç­‰æ–¹å¼ï¼Œå¯ä»¥åœ¨ä¸ªåˆ«è®¡ç®—æœºèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ç»§ç»­æ­£å¸¸è¿è¡Œï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå®¹é”™æ€§ã€‚
> 3. å®ç°å…±äº«èµ„æºï¼šåˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤Ÿå°†å¤šä¸ªè®¡ç®—æœºèŠ‚ç‚¹çš„èµ„æºè¿›è¡Œæ•´åˆå’Œå…±äº«ï¼ŒåŒ…æ‹¬è®¡ç®—èƒ½åŠ›ã€å­˜å‚¨ç©ºé—´ã€ç½‘ç»œå¸¦å®½ç­‰ï¼Œä»è€Œæä¾›æ›´å¤šçš„æœåŠ¡å’ŒåŠŸèƒ½ã€‚
>
> åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰å¹¿æ³›çš„åº”ç”¨é¢†åŸŸï¼Œå…¶ä¸­ä¸€äº›å¸¸è§çš„åˆ†å¸ƒå¼åº”ç”¨åŒ…æ‹¬ï¼š
>
> 1. **åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿï¼š**å°†æ•°æ®å­˜å‚¨åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå®ç°æ•°æ®çš„åˆ†å¸ƒå¼å­˜å‚¨ã€ç®¡ç†å’ŒæŸ¥è¯¢ï¼Œæé«˜äº†æ•°æ®åº“çš„æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ã€‚
> 2. **åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼š**å°†æ–‡ä»¶åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œè®¿é—®å’Œå…±äº«ï¼Œæä¾›é«˜æ€§èƒ½å’Œå¯é çš„æ–‡ä»¶å­˜å‚¨æœåŠ¡ã€‚
> 3. **åˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿï¼š**å°†è®¡ç®—ä»»åŠ¡åˆ†é…ç»™å¤šå°è®¡ç®—æœºèŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚äº‘è®¡ç®—å¹³å°ã€å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ç­‰ã€‚
> 4. **åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿï¼š**å°†æ•°æ®ç¼“å­˜åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼ŒåŠ å¿«æ•°æ®çš„è¯»å–é€Ÿåº¦ï¼Œé™ä½ç½‘ç»œè´Ÿè½½ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚
> 5. **åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼š**é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°ä¸åŒè®¡ç®—èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å’Œåè°ƒï¼Œæé«˜ç³»ç»Ÿçš„ååé‡å’Œå“åº”æ€§èƒ½ã€‚
> 6. **åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼š**å°†ç´¢å¼•å’Œæœç´¢ä»»åŠ¡åˆ†å¸ƒåˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œæä¾›å¿«é€Ÿçš„æœç´¢å’Œæ£€ç´¢åŠŸèƒ½ã€‚

**åˆ†å¸ƒå¼ç™»å½•ï¼šå°±æ¯”å¦‚æ˜¯æœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œåœ¨è¿™ä¸¤å°æœåŠ¡å™¨éƒ¨ç½²äº†ä¸€æ ·çš„æœåŠ¡ï¼Œç„¶åå‰ç«¯è¯·æ±‚æ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡è¿›è¡Œè¯·æ±‚æœåŠ¡ï¼Œè¿™æ—¶ä½ æ˜¯ä¸çŸ¥é“è¯·æ±‚ä¼šè½åˆ°é‚£ä¸ªæœåŠ¡å™¨ä¸Šï¼Œ æ‰€ä»¥ä½ å°±ä¸èƒ½åœ¨ Seesion æ¥åšå­˜ä¿¡æ¯ï¼ˆä¸èƒ½åªä¿å­˜åˆ°æœ¬åœ°ä¸Šï¼‰ã€‚å¦‚æœä½ è¯·æ±‚äº†æœåŠ¡å™¨Aï¼Œç„¶åç™»é™†ä¿¡æ¯æ”¾åœ¨äº†æœåŠ¡å™¨Aï¼Œä¸‹ä¸€æ¬¡ä½ çš„è¯·æ±‚å¦‚æœåˆ°äº†æœåŠ¡å™¨Bï¼Œé‚£æ­¤æ—¶æœåŠ¡å™¨Bå°±æ²¡æœ‰ä½ ä¸Šä¸€æ¬¡çš„ç™»å½•ä¿¡æ¯äº†ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ä¸­é—´ä»¶ï¼Œä¹Ÿå°±æ˜¯redisï¼ˆRedission Javaå®¢æˆ·ç«¯ï¼‰åšè¿™ä¸ªåˆ†å¸ƒå¼ç™»å½•ï¼Œè¿™æ ·ä¸ç®¡ä½ è¯·æ±‚é‚£ä¸ªæœåŠ¡å™¨éƒ½ä¼šæœ‰ä½ çš„ç™»å½•ä¿¡æ¯ã€‚**

### Session å…±äº«

ç§ session çš„æ—¶å€™æ³¨æ„èŒƒå›´ï¼Œcookie.domain  
æ¯”å¦‚ä¸¤ä¸ªåŸŸåï¼š  
aaa.yupi.com  
bbb.yupi.com  
å¦‚æœè¦å…±äº« cookieï¼Œå¯ä»¥ç§ä¸€ä¸ªæ›´é«˜å±‚çš„å…¬å…±åŸŸåï¼Œæ¯”å¦‚ yupi.com

### ä¸ºä»€ä¹ˆæœåŠ¡å™¨ A ç™»å½•åï¼Œè¯·æ±‚å‘åˆ°æœåŠ¡å™¨ Bï¼Œä¸è®¤è¯†è¯¥ç”¨æˆ·ï¼Ÿ

ç”¨æˆ·åœ¨ A ç™»å½•ï¼Œæ‰€ä»¥ sessionï¼ˆç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼‰å­˜åœ¨äº† A ä¸Š  
ç»“æœè¯·æ±‚ B æ—¶ï¼ŒB æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸è®¤è¯†ã€‚  
![1668525160193-9dd27f40-5c5f-4738-9972-15d4629ab6ff.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668525160193-9dd27f40-5c5f-4738-9972-15d4629ab6ff-340866.png)



> è§£å†³æ–¹æ¡ˆï¼š**å…±äº«å­˜å‚¨** ï¼Œè€Œä¸æ˜¯æŠŠæ•°æ®æ”¾åˆ°å•å°æœåŠ¡å™¨çš„å†…å­˜ä¸­



![1668525160243-e6864277-b56d-4dff-9b38-670cb7f6ab6b.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668525160243-e6864277-b56d-4dff-9b38-670cb7f6ab6b-846471.png)



å¦‚ä½•å…±äº«å­˜å‚¨ï¼Ÿ



1. Redisï¼ˆåŸºäºå†…å­˜çš„ K / V æ•°æ®åº“ï¼‰æ­¤å¤„é€‰æ‹© Redisï¼Œå› ä¸ºç”¨æˆ·ä¿¡æ¯è¯»å– / æ˜¯å¦ç™»å½•çš„åˆ¤æ–­æå…¶**é¢‘ç¹** ï¼ŒRedis åŸºäºå†…å­˜ï¼Œè¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œç®€å•çš„æ•°æ®å•æœº qps 5w - 10w
2. MySQL
3. æ–‡ä»¶æœåŠ¡å™¨ ceph



### å®‰è£…rediså’Œç®¡ç†å·¥å…·quickredis

Redis 5.0.14 ä¸‹è½½ï¼š  
é“¾æ¥ï¼š[https://pan.baidu.com/s/1XcsAIrdeesQAyQU2lE3cOg](https://pan.baidu.com/s/1XcsAIrdeesQAyQU2lE3cOg)  
æå–ç ï¼švkoi  
redis ç®¡ç†å·¥å…· quick redisï¼š[https://quick123.net/](https://quick123.net/)



### åœ¨springbooté‡Œå¼•å…¥redisï¼Œèƒ½å¤Ÿæ“ä½œredis


```xml
<!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
    <version>2.6.4</version>
</dependency>
```

### å¼•å…¥ spring-session å’Œ redis çš„æ•´åˆï¼Œä½¿å¾—è‡ªåŠ¨å°† session å­˜å‚¨åˆ° redis ä¸­ï¼š


```xml
<!-- https://mvnrepository.com/artifact/org.springframework.session/spring-session-data-redis -->
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
    <version>2.6.3</version>
</dependency>
```



> ä¿®æ”¹ spring-session å­˜å‚¨é…ç½® `spring.session.store-type` é»˜è®¤æ˜¯ noneï¼Œè¡¨ç¤ºå­˜å‚¨åœ¨å•å°æœåŠ¡å™¨  
> store-type: redisï¼Œè¡¨ç¤ºä» redis è¯»å†™ session ,



JWT çš„ä¼˜ç¼ºç‚¹ï¼š[https://zhuanlan.zhihu.com/p/108999941](https://zhuanlan.zhihu.com/p/108999941)



é…ç½®å¦‚ä¸‹ï¼š  
![1668615101163-c7e031e0-eb25-40ef-9baa-cd5a2fce576e.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668615101163-c7e031e0-eb25-40ef-9baa-cd5a2fce576e-010356.png)



### æµ‹è¯•sessionå…±äº«

ä¸ºäº†æ¨¡æ‹Ÿå¤šæœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦æ‰“åŒ…é¡¹ç›®ï¼Œåœ¨å¦ä¸€ä¸ªç«¯å£å¯åŠ¨ï¼Œè¿™é‡Œæ˜¯8081  
å…ˆæ‰“åŒ…ï¼Œååœ¨**targetç›®å½•**ä¸‹æ‰“å¼€ç»ˆç«¯è¿è¡Œä¸‹é¢çš„ä»£ç 



```plain
 java -jar .\user-center-backend-0.0.1-SNAPSHOT.jar --server.port=8081
```



è¿è¡Œï¼ŒæˆåŠŸå¯åŠ¨8080å’Œ8081ç«¯å£çš„knife4jæ¥å£è¿›è¡Œæ“ä½œ



å…ˆåœ¨8080ç«¯å£ç™»å½•å¹¶è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯



[http://localhost:8080/api/doc.html#/home](http://localhost:8080/api/doc.html#/home)



![1668615783109-fe8514de-6847-46a9-ba07-ba0828c1e3e9.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668615783109-fe8514de-6847-46a9-ba07-ba0828c1e3e9-881675.png)



åœ¨8081ç«¯å£æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œä¹Ÿèƒ½æŸ¥è¯¢åˆ°



[http://localhost:8081/api/doc.html#/home](http://localhost:8081/api/doc.html#/home)



![1668615841601-67f5fd76-561e-42bc-908d-4ec8ffe8abe5.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668615841601-67f5fd76-561e-42bc-908d-4ec8ffe8abe5-809972.png)



ä½¿ç”¨QuickRedisæŸ¥çœ‹sessionæ˜¯å¦å­˜å…¥redisä¸­  
![1668615923718-f8017472-a9df-422c-b649-c9773101a09e.png](./assets/04æœç´¢ç•Œé¢+åˆ†å¸ƒå¼ç™»å½•/1668615923718-f8017472-a9df-422c-b649-c9773101a09e-721800-1729072412822-54.png)



# æ‹“å±•

## Spring Session Data Redisä½¿ç”¨

### ä¸€. spring sessionç®€ä»‹

#### 1. ä»€ä¹ˆæ˜¯Spring Session

 spring-sessionæ˜¯springå¤§å®¶åº­ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå¥¹çš„å‡ºç°æ˜¯ä¸ºäº†é›†ä¸­ç®¡ç†sessionä¼šè¯ï¼Œè§£å†³å¤šåº”ç”¨ç¯å¢ƒä¸‹çš„sessionå…±äº«é—®é¢˜ï¼Œè™½ç„¶å¥¹æ˜¯springæ¡†æ¶ä¸‹çš„å­é¡¹ç›®ï¼Œä½†æ˜¯spring-sessionä¸ä¾èµ–äºspringæ¡†æ¶ï¼Œå¯ä»¥å°†spring-sessionç”¨äºå…¶ä»–æ¡†æ¶ä¸‹æä¾›sessionç®¡ç†èƒ½åŠ›ã€‚

#### 2. ä¸»è¦ä½œç”¨(è§£å†³ä»€ä¹ˆé—®é¢˜)

 Spring Session æä¾›äº†ç”¨äºç®¡ç†ç”¨æˆ·ä¼šè¯ä¿¡æ¯çš„ API å’Œå®ç°

#### 3. ç‰¹å¾

 Spring Session ä½¿å¾—æ”¯æŒé›†ç¾¤ä¼šè¯å˜å¾—å¾®ä¸è¶³é“ï¼Œè€Œæ— éœ€ç»‘å®šåˆ°åº”ç”¨ç¨‹åºå®¹å™¨ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆã€‚å®ƒè¿˜æä¾›ä¸ä»¥ä¸‹å†…å®¹çš„é€æ˜é›†æˆ

-  HttpSession å…è®¸ä»¥ä¸­ç«‹æ–¹å¼æ›¿æ¢åº”ç”¨ç¨‹åºå®¹å™¨ï¼ˆå³ Tomcatï¼‰ä¸­çš„ HttpSessionï¼Œæ”¯æŒåœ¨æ ‡å¤´ä¸­æä¾›ä¼šè¯ ID ä»¥ä½¿ç”¨ RESTful API
-  WebSocket æä¾›åœ¨æ¥æ”¶ WebSocket æ¶ˆæ¯æ—¶ä¿æŒ HttpSession æ´»åŠ¨çš„èƒ½åŠ›
-  WebSession å…è®¸ä»¥åº”ç”¨ç¨‹åºå®¹å™¨ä¸­ç«‹çš„æ–¹å¼æ›¿æ¢ Spring WebFlux çš„ WebSession

#### 4. åŒ…å«æ¨¡å—

- Spring Session Core - æä¾›æ ¸å¿ƒ Spring Session åŠŸèƒ½å’Œ API
- Spring Session Data Redis - æä¾›ç”± Redis å’Œé…ç½®æ”¯æŒæ”¯æŒçš„ SessionRepository å’Œ ReactiveSessionRepository å®ç°
- Spring Session JDBC - æä¾›ç”±å…³ç³»æ•°æ®åº“å’Œé…ç½®æ”¯æŒæ”¯æŒçš„ SessionRepository å®ç°
- Spring Session Hazelcast - æä¾›ç”± Hazelcast å’Œé…ç½®æ”¯æŒæ”¯æŒçš„ SessionRepository å®ç°

#### 5. ä½¿ç”¨

 mavenå¼•å…¥å¯¹åº”çš„æ¨¡å—(ä»¥Spring Session Data Redisä¸ºä¾‹)

```
 <dependency>
     <groupId>org.springframework.session</groupId>
     <artifactId>spring-session-data-redis</artifactId>
 </dependency>
```

### äºŒ. Spring Session Data Redis

æ–‡æ¡£åœ°å€ https://docs.spring.io/spring-session/reference/samples.html

#### 1. ä½¿ç”¨redisçš„HttpsSessionä»£æ›¿åŸæœ¬çš„Spring Session

##### 1. æ›´æ–°ä¾èµ–

```
 <dependency>
     <groupId>org.springframework.session</groupId>
     <artifactId>spring-session-data-redis</artifactId>
 </dependency>
```

##### 2.ä¿®æ”¹spring sessioné…ç½®

```
#src/main/resources/application.properties
spring.session.store-type=redis # Session store type.
```

åœ¨åº•å±‚ï¼ŒSpring Boot åº”ç”¨çš„é…ç½®ç›¸å½“äºæ‰‹åŠ¨æ·»åŠ `@EnableRedisHttpSession`æ³¨è§£ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸º`springSessionRepositoryFilter`implementsçš„ Spring bean `Filter`ã€‚è¿‡æ»¤å™¨è´Ÿè´£æ›¿æ¢`HttpSession`Spring Session æ”¯æŒçš„å®ç°ã€‚

ä½¿ç”¨ å¯ä»¥è¿›ä¸€æ­¥å®šåˆ¶`application.properties`ï¼Œå¦‚ä»¥ä¸‹æ¸…å•æ‰€ç¤ºï¼š

```
server.servlet.session.timeout = ï¼ƒä¼šè¯è¶…æ—¶ã€‚å¦‚æœæœªæŒ‡å®šæŒç»­æ—¶é—´åç¼€ï¼Œåˆ™ä½¿ç”¨ç§’ã€‚
spring.session.redis.flush-mode=on_save # ä¼šè¯åˆ·æ–°æ¨¡å¼ã€‚
spring.session.redis.namespace=spring:session # ç”¨äºå­˜å‚¨ä¼šè¯çš„é”®çš„å‘½åç©ºé—´ã€‚
```

##### 3. é…ç½®redisé“¾æ¥

```
spring.redis.host=localhost #Redis æœåŠ¡å™¨ä¸»æœºã€‚
spring.redis.password= #redisæœåŠ¡å™¨çš„ç™»å½•å¯†ç ã€‚
spring.redis.port=6379 # Redis æœåŠ¡å™¨ç«¯å£ã€‚
```

#### 2. ä¿®æ”¹é»˜è®¤çš„JdkSerializationRedisSerializeråºåˆ—åŒ–å™¨

##### 1.å®˜æ–¹æ–‡æ¡£ä»‹ç»10.8 https://docs.spring.io/spring-data/data-redis/docs/2.6.2/reference/html/#reference

```
ä»æ¡†æ¶çš„è§’åº¦æ¥çœ‹ï¼ŒRedis ä¸­å­˜å‚¨çš„æ•°æ®åªæ˜¯å­—èŠ‚ã€‚è™½ç„¶ Redis æœ¬èº«æ”¯æŒå„ç§ç±»å‹ï¼Œä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›ç±»å‹æŒ‡çš„æ˜¯æ•°æ®çš„å­˜å‚¨æ–¹å¼ï¼Œè€Œä¸æ˜¯å®ƒæ‰€ä»£è¡¨çš„å†…å®¹ã€‚ç”±ç”¨æˆ·å†³å®šæ˜¯å¦å°†ä¿¡æ¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»»ä½•å…¶ä»–å¯¹è±¡ã€‚

åœ¨ Spring Data ä¸­ï¼Œç”¨æˆ·ï¼ˆè‡ªå®šä¹‰ï¼‰ç±»å‹å’ŒåŸå§‹æ•°æ®ï¼ˆåä¹‹äº¦ç„¶ï¼‰ä¹‹é—´çš„è½¬æ¢ç”±org.springframework.data.redis.serializeråŒ…ä¸­çš„ Redis å¤„ç†ã€‚

è¿™ä¸ªåŒ…åŒ…å«ä¸¤ç§ç±»å‹çš„åºåˆ—åŒ–å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä»¬è´Ÿè´£åºåˆ—åŒ–è¿‡ç¨‹ï¼š

åŸºäºRedisSerializer.

RedisElementReaderä½¿ç”¨å’Œçš„å…ƒç´ è¯»å–å™¨å’Œå†™å…¥å™¨RedisElementWriterã€‚

è¿™äº›å˜ä½“ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºRedisSerializerä¸»è¦åºåˆ—åŒ–åˆ°byte[]è€Œè¯»è€…å’Œä½œè€…ä½¿ç”¨ByteBuffer.

æœ‰å¤šç§å®ç°å¯ç”¨ï¼ˆåŒ…æ‹¬æœ¬æ–‡æ¡£ä¸­å·²ç»æåˆ°çš„ä¸¤ç§ï¼‰ï¼š

JdkSerializationRedisSerializer, é»˜è®¤æƒ…å†µä¸‹ç”¨äºRedisCacheå’ŒRedisTemplateã€‚

StringRedisSerializer. _

ä½†æ˜¯ï¼Œå¯ä»¥OxmSerializeré€šè¿‡ Spring OXMæ”¯æŒç”¨äºå¯¹è±¡/XML æ˜ å°„ï¼ŒJackson2JsonRedisSerializeræˆ–è€…GenericJackson2JsonRedisSerializerä»¥JSONæ ¼å¼å­˜å‚¨æ•°æ®ã€‚

è¯·æ³¨æ„ï¼Œå­˜å‚¨æ ¼å¼ä¸ä»…é™äºå€¼ã€‚å®ƒå¯ä»¥ç”¨äºé”®ã€å€¼æˆ–æ•£åˆ—ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚
```

##### 2. è‡ªå®šä¹‰åºåˆ—åŒ–å™¨é…ç½®

```
githubå‚è€ƒåœ°å€ https://github.com/spring-projects/spring-session/blob/main/spring-session-samples/spring-session-sample-boot-redis-json/src/main/java/sample/config/SessionConfig.java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializer;
import org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession;

@Configuration
@EnableRedisHttpSession
public class SpringSessionRedisConfig {

    /**
     * remark:jsonåºåˆ—åŒ–
     */
    @Bean
    public RedisSerializer springSessionDefaultRedisSerializer() {
        return new GenericJackson2JsonRedisSerializer();
    }


}
```

##### 3. è‡ªå®šä¹‰cookieé…ç½®

###### 1. æ–‡æ¡£åœ°å€ https://docs.spring.io/spring-session/reference/guides/java-custom-cookie.html#page-title

###### 2. ä»‹ç»åŠä½¿ç”¨

è®¾ç½® Spring Session åï¼Œæ‚¨å¯ä»¥é€šè¿‡å®šåˆ¶`CookieSerializer`ä¸º Spring bean æ¥è‡ªå®šä¹‰ä¼šè¯ cookie çš„ç¼–å†™æ–¹å¼ã€‚Spring Session é™„å¸¦`DefaultCookieSerializer`. å½“`DefaultCookieSerializer`æ‚¨ä½¿ç”¨è¯¸å¦‚`@EnableRedisHttpSession`. ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•è‡ªå®šä¹‰ Spring Session çš„ cookie

```
    //è¿™ä¸ªbeanæ”¾åˆ°SpringSessionRedisConfigé…ç½®ä¸­ã€‚
    @Bean
    public CookieSerializer cookieSerializer() {
        DefaultCookieSerializer serializer = new DefaultCookieSerializer();
        serializer.setCookieName("JSESSIONID"); 
        serializer.setCookiePath("/"); 
        serializer.setDomainNamePattern("^.+?\\.(\\w+\\.[a-z]+)$"); 
        return serializer;
    }
```

1. å°† cookie çš„åç§°è‡ªå®šä¹‰ä¸º`JSESSIONID`.
2. å°† cookie çš„è·¯å¾„è‡ªå®šä¹‰ä¸º`/`ï¼ˆè€Œä¸æ˜¯ä¸Šä¸‹æ–‡æ ¹çš„é»˜è®¤è·¯å¾„ï¼‰ã€‚
3. æˆ‘ä»¬å°†åŸŸåæ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰è‡ªå®šä¹‰ä¸º`^.+?\\.(\\w+\\.[a-z]+)$`. è¿™å…è®¸è·¨åŸŸå’Œåº”ç”¨ç¨‹åºå…±äº«ä¼šè¯ã€‚å¦‚æœæ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…ï¼Œåˆ™ä¸è®¾ç½®åŸŸå¹¶ä½¿ç”¨ç°æœ‰åŸŸã€‚å¦‚æœæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œåˆ™å°†ç¬¬ä¸€ä¸ª[åˆ†ç»„](https://docs.oracle.com/javase/tutorial/essential/regex/groups.html)ç”¨ä½œåŸŸã€‚è¿™æ„å‘³ç€å¯¹[https://child.example.com](https://child.example.com/)çš„è¯·æ±‚ä¼šå°†åŸŸè®¾ç½®ä¸º`example.com`. [ä½†æ˜¯ï¼Œå¯¹http://localhost:8080/](http://localhost:8080/)æˆ–https://192.168.1.100:8080/çš„è¯·æ±‚ä¼šä½¿ cookie æœªè®¾ç½®ï¼Œå› æ­¤ä»å¯åœ¨å¼€å‘ä¸­å·¥ä½œï¼Œè€Œæ— éœ€å¯¹ç”Ÿäº§è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚

###### 3.å¯é€‰é…ç½®é€‰é¡¹

- `cookieName`: è¦ä½¿ç”¨çš„ cookie çš„åç§°ã€‚é»˜è®¤å€¼ï¼š`SESSION`.
- `useSecureCookie`ï¼šæŒ‡å®šæ˜¯å¦åº”ä½¿ç”¨å®‰å…¨ cookieã€‚é»˜è®¤å€¼ï¼šä½¿ç”¨`HttpServletRequest.isSecure()`åˆ›å»ºæ—¶çš„å€¼ã€‚
- `cookiePath`: cookie çš„è·¯å¾„ã€‚é»˜è®¤å€¼ï¼šä¸Šä¸‹æ–‡æ ¹ã€‚
- `cookieMaxAge`ï¼šæŒ‡å®šåœ¨åˆ›å»ºä¼šè¯æ—¶è¦è®¾ç½®çš„ cookie çš„æœ€å¤§å¹´é¾„ã€‚é»˜è®¤å€¼ï¼š`-1`ï¼Œè¡¨ç¤ºå…³é—­æµè§ˆå™¨æ—¶åº”åˆ é™¤ cookieã€‚
- `jvmRoute`ï¼šæŒ‡å®šè¦é™„åŠ åˆ°ä¼šè¯ ID å¹¶åŒ…å«åœ¨ cookie ä¸­çš„åç¼€ã€‚ç”¨äºæ ‡è¯†è¦è·¯ç”±åˆ°å“ªä¸ª JVM ä»¥å®ç°ä¼šè¯äº²å’Œæ€§ã€‚å¯¹äºæŸäº›å®ç°ï¼ˆå³ Redisï¼‰ï¼Œæ­¤é€‰é¡¹ä¸ä¼šæä¾›ä»»ä½•æ€§èƒ½ä¼˜åŠ¿ã€‚ä½†æ˜¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©è·Ÿè¸ªç‰¹å®šç”¨æˆ·çš„æ—¥å¿—ã€‚
- `domainName`ï¼šå…è®¸æŒ‡å®šç”¨äº cookie çš„ç‰¹å®šåŸŸåã€‚æ­¤é€‰é¡¹æ˜“äºç†è§£ï¼Œä½†é€šå¸¸éœ€è¦åœ¨å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¹‹é—´è¿›è¡Œä¸åŒçš„é…ç½®ã€‚å°†å…¶`domainNamePattern`è§†ä¸ºæ›¿ä»£æ–¹æ¡ˆã€‚
- `domainNamePattern`: ä¸€ç§ä¸åŒºåˆ†å¤§å°å†™çš„æ¨¡å¼ï¼Œç”¨äºä»`HttpServletRequest#getServerName()`. è¯¥æ¨¡å¼åº”æä¾›ç”¨äºæå– cookie åŸŸå€¼çš„å•ä¸ªåˆ†ç»„ã€‚å¦‚æœæ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…ï¼Œåˆ™ä¸è®¾ç½®åŸŸå¹¶ä½¿ç”¨ç°æœ‰åŸŸã€‚å¦‚æœæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œåˆ™å°†ç¬¬ä¸€ä¸ª[åˆ†ç»„](https://docs.oracle.com/javase/tutorial/essential/regex/groups.html)ç”¨ä½œåŸŸã€‚
- `sameSite`: `SameSite`cookie æŒ‡ä»¤çš„å€¼ã€‚è¦ç¦ç”¨`SameSite`cookie æŒ‡ä»¤çš„åºåˆ—åŒ–ï¼Œæ‚¨å¯ä»¥å°†æ­¤å€¼è®¾ç½®ä¸º`null`ã€‚é»˜è®¤ï¼š`Lax`