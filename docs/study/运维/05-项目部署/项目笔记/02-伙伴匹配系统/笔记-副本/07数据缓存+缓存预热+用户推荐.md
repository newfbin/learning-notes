# 07 æ•°æ®ç¼“å­˜+ç¼“å­˜é¢„çƒ­+ç”¨æˆ·æ¨è

<font style="color:rgb(51, 51, 51);">åœ¨çº¿å›æ”¾ï¼š</font>[https://meeting.tencent.com/v2/cloud-record/share?...](https://meeting.tencent.com/v2/cloud-record/share?id=cbf47b3d-7215-4d4c-9808-8b832a0b1521&from=3)<font style="color:rgb(51, 51, 51);">ï¼ˆè®¿é—®å¯†ç ï¼š4x4zï¼‰</font>

## é±¼çš®ç¬”è®°
### 1.æ•°æ®æŸ¥è¯¢æ…¢æ€ä¹ˆåŠï¼Ÿ


ç”¨ç¼“å­˜ï¼šæå‰æŠŠæ•°æ®å–å‡ºæ¥ä¿å­˜å¥½ï¼ˆé€šå¸¸ä¿å­˜åˆ°è¯»å†™æ›´å¿«çš„ä»‹è´¨ï¼Œæ¯”å¦‚å†…å­˜ï¼‰ï¼Œå°±å¯ä»¥æ›´å¿«åœ°è¯»å†™ã€‚



### 2.ç¼“å­˜çš„å®ç°


+ Redisï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼‰
+ memcachedï¼ˆåˆ†å¸ƒå¼ï¼‰
+ Etcdï¼ˆäº‘åŸç”Ÿæ¶æ„çš„ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ï¼Œ**å­˜å‚¨é…ç½®**ï¼Œæ‰©å®¹èƒ½åŠ›ï¼‰

---

+ ehcacheï¼ˆå•æœºï¼‰
+ æœ¬åœ°ç¼“å­˜ï¼ˆJava å†…å­˜ Mapï¼‰
+ Caffeineï¼ˆJava å†…å­˜ç¼“å­˜ï¼Œé«˜æ€§èƒ½ï¼‰
+ Google Guava



#### Redis


> NoSQL æ•°æ®åº“  
key - value å­˜å‚¨ç³»ç»Ÿï¼ˆåŒºåˆ«äº MySQLï¼Œä»–å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹ï¼‰
>



#### Redis æ•°æ®ç»“æ„ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸï¼ˆé¢è¯•é«˜é¢‘è€ƒç‚¹ï¼‰


String å­—ç¬¦ä¸²ç±»å‹ï¼š name: "shier"  
List åˆ—è¡¨ï¼šnames: ["shier", "xiaoshier", "shier1"]ï¼Œé•¿åº¦å¯å˜  
Set é›†åˆï¼šnames: ["shier", "dogshier"]ï¼ˆå€¼ä¸èƒ½é‡å¤ï¼‰  
Hash å“ˆå¸Œï¼šnameAge: { "yupi": 1, "dogyupi": 2 }ï¼š  
Zset é›†åˆï¼šnames: { yupi - 9, dogyupi - 12 }ï¼ˆé€‚åˆåšæ’è¡Œæ¦œï¼‰Zsetå€¼ä¼šå…³è”åˆ†æ•°

---

bloomfilterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¸»è¦ä»å¤§é‡çš„æ•°æ®ä¸­å¿«é€Ÿè¿‡æ»¤å€¼ï¼Œæ¯”å¦‚é‚®ä»¶é»‘åå•æ‹¦æˆªï¼‰  
geoï¼ˆè®¡ç®—åœ°ç†ä½ç½®ï¼‰  
hyperloglogï¼ˆpv / uvï¼‰  
pub / subï¼ˆå‘å¸ƒè®¢é˜…ï¼Œç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—ï¼‰  
BitMap ï¼ˆ1001010101010101010101010101ï¼‰



### 3.è‡ªå®šä¹‰åºåˆ—åŒ–


```java
package com.yupi.yupao.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.RedisSerializer;

@Configuration
public class RedisTemplateConfig {

 Â  Â @Bean
 Â  Â public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
 Â  Â  Â  Â RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
 Â  Â  Â  Â redisTemplate.setConnectionFactory(connectionFactory);
 Â  Â  Â  Â redisTemplate.setKeySerializer(RedisSerializer.string());
 Â  Â  Â  Â return redisTemplate;
 Â   }
}
```



å¼•å…¥ä¸€ä¸ªåº“æ—¶ï¼Œå…ˆå†™æµ‹è¯•ç±»



### 4.Java é‡Œçš„å®ç°æ–¹å¼


#### Spring Data Redisï¼ˆæ¨èï¼‰


Spring Dataï¼šé€šç”¨çš„æ•°æ®è®¿é—®æ¡†æ¶ï¼Œå®šä¹‰äº†ä¸€ç»„ **å¢åˆ æ”¹æŸ¥** çš„æ¥å£  
mysqlã€redisã€jpa  
[spring-data-redis](https://mvnrepository.com/artifact/org.springframework.data/spring-data-redis)  
1ï¼‰å¼•å…¥



```xml
<dependency>
 Â  Â <groupId>org.springframework.boot</groupId>
 Â  Â <artifactId>spring-boot-starter-data-redis</artifactId>
 Â  Â <version>2.6.4</version>
</dependency>
```



2ï¼‰é…ç½® Redis åœ°å€



```yaml
spring:
 Â # redis é…ç½®
  redis:
 Â   port: 6379
 Â   host: localhost
 Â   database: 0
```



#### Jedis


ç‹¬ç«‹äº Spring æ“ä½œ Redis çš„ Java å®¢æˆ·ç«¯  
è¦é…åˆ Jedis Pool ä½¿ç”¨



#### Lettuce


**é«˜é˜¶** çš„æ“ä½œ Redis çš„ Java å®¢æˆ·ç«¯  
å¼‚æ­¥ã€è¿æ¥æ± 



#### Redisson


åˆ†å¸ƒå¼æ“ä½œ Redis çš„ Java å®¢æˆ·ç«¯ï¼Œè®©ä½ åƒåœ¨ä½¿ç”¨æœ¬åœ°çš„é›†åˆä¸€æ ·æ“ä½œ Redisï¼ˆåˆ†å¸ƒå¼ Redis æ•°æ®ç½‘æ ¼ï¼‰



#### JetCache


å¯¹æ¯”



1. å¦‚æœä½ ç”¨çš„æ˜¯ Springï¼Œå¹¶ä¸”æ²¡æœ‰è¿‡å¤šçš„å®šåˆ¶åŒ–è¦æ±‚ï¼Œå¯ä»¥ç”¨ Spring Data Redisï¼Œæœ€æ–¹ä¾¿
2. å¦‚æœä½ ç”¨çš„ä¸æ˜¯ SPringï¼Œå¹¶ä¸”è¿½æ±‚ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰è¿‡é«˜çš„æ€§èƒ½è¦æ±‚ï¼Œå¯ä»¥ç”¨ Jedis + Jedis Pool
3. å¦‚æœä½ çš„é¡¹ç›®ä¸æ˜¯ Springï¼Œå¹¶ä¸”è¿½æ±‚é«˜æ€§èƒ½ã€é«˜å®šåˆ¶åŒ–ï¼Œå¯ä»¥ç”¨ Lettuceï¼Œæ”¯æŒå¼‚æ­¥ã€è¿æ¥æ± 

---

+ å¦‚æœä½ çš„é¡¹ç›®æ˜¯åˆ†å¸ƒå¼çš„ï¼Œéœ€è¦ç”¨åˆ°ä¸€äº›åˆ†å¸ƒå¼çš„ç‰¹æ€§ï¼ˆæ¯”å¦‚åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼é›†åˆï¼‰ï¼Œæ¨èç”¨ redisson



### 5.è®¾è®¡ç¼“å­˜ key


ä¸åŒç”¨æˆ·çœ‹åˆ°çš„æ•°æ®ä¸åŒ  
systemId:moduleId:func:optionsï¼ˆä¸è¦å’Œåˆ«äººå†²çªï¼‰  
yupao:user:recommed:userId  
**redis å†…å­˜ä¸èƒ½æ— é™å¢åŠ ï¼Œä¸€å®šè¦è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ï¼ï¼**



### 6.ç¼“å­˜é¢„çƒ­


é—®é¢˜ï¼šç¬¬ä¸€ä¸ªç”¨æˆ·è®¿é—®è¿˜æ˜¯å¾ˆæ…¢ï¼ˆåŠ å…¥ç¬¬ä¸€ä¸ªè€æ¿ï¼‰ï¼Œä¹Ÿèƒ½ä¸€å®šç¨‹åº¦ä¸Šä¿æŠ¤æ•°æ®åº“  
ç¼“å­˜é¢„çƒ­çš„ä¼˜ç‚¹ï¼š



1. è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå¯ä»¥è®©ç”¨æˆ·å§‹ç»ˆè®¿é—®å¾ˆå¿«



ç¼ºç‚¹ï¼š



1. å¢åŠ å¼€å‘æˆæœ¬ï¼ˆä½ è¦é¢å¤–çš„å¼€å‘ã€è®¾è®¡ï¼‰
2. é¢„çƒ­çš„æ—¶æœºå’Œæ—¶é—´å¦‚æœé”™äº†ï¼Œæœ‰å¯èƒ½ä½ ç¼“å­˜çš„æ•°æ®ä¸å¯¹æˆ–è€…å¤ªè€
3. éœ€è¦å ç”¨é¢å¤–ç©ºé—´



#### æ€ä¹ˆç¼“å­˜é¢„çƒ­ï¼Ÿ


1. å®šæ—¶
2. æ¨¡æ‹Ÿè§¦å‘ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰



#### å®ç°


ç”¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©åˆ·æ–°æ‰€æœ‰ç”¨æˆ·çš„æ¨èåˆ—è¡¨  
æ³¨æ„ç‚¹ï¼š



1. ç¼“å­˜é¢„çƒ­çš„æ„ä¹‰ï¼ˆæ–°å¢å°‘ã€æ€»ç”¨æˆ·å¤šï¼‰
2. ç¼“å­˜çš„ç©ºé—´ä¸èƒ½å¤ªå¤§ï¼Œè¦é¢„ç•™ç»™å…¶ä»–ç¼“å­˜ç©ºé—´
3. ç¼“å­˜æ•°æ®çš„å‘¨æœŸï¼ˆæ­¤å¤„æ¯å¤©ä¸€æ¬¡ï¼‰



åˆ†æä¼˜ç¼ºç‚¹çš„æ—¶å€™ï¼Œè¦æ‰“å¼€æ€è·¯ï¼Œä»æ•´ä¸ªé¡¹ç›®ä» 0 åˆ° 1 çš„é“¾è·¯ä¸Šå»åˆ†æ



### 7.å®šæ—¶ä»»åŠ¡å®ç°


1. **Spring Schedulerï¼ˆspring boot é»˜è®¤æ•´åˆäº†ï¼‰**
2. Quartzï¼ˆç‹¬ç«‹äº Spring å­˜åœ¨çš„å®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼‰
3. XXL-Job ä¹‹ç±»çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼ˆç•Œé¢ + sdkï¼‰



ç¬¬ä¸€ç§æ–¹å¼ï¼š



1. ä¸»ç±»å¼€å¯ [@EnableScheduling ](/EnableScheduling ) 
2. ç»™è¦å®šæ—¶æ‰§è¡Œçš„æ–¹æ³•æ·»åŠ  [@Scheduling ](/Scheduling ) æ³¨è§£ï¼ŒæŒ‡å®š cron è¡¨è¾¾å¼æˆ–è€…æ‰§è¡Œé¢‘ç‡ 



ä¸è¦å»èƒŒ cron è¡¨è¾¾å¼ï¼ï¼ï¼ï¼ï¼



+ [https://cron.qqe2.com/](https://cron.qqe2.com/)
+ [https://www.matools.com/crontab/](https://www.matools.com/crontab/)



## ä¸€ã€æµ‹è¯•redis


å› ä¸ºjavaè‡ªå¸¦çš„redistemplateåªèƒ½æŸ¥è¯¢å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸å¤Ÿå…¨é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–ï¼Œåœ¨configåŒ…é‡Œåˆ›å»ºå¦‚ä¸‹é…ç½®ç±»



```java
package com.shier.usercenter.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializer;

/**
 * @author Shier
 * è‡ªå®šä¹‰Redisåºåˆ—åŒ–
 */
@Configuration
public class RedisTemplateConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        // åˆ›å»ºRedisTemplateå¯¹è±¡
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        //è®¾ç½®è¿æ¥å·¥å‚
        redisTemplate.setConnectionFactory(connectionFactory);
        //è®¾ç½®Keyçš„åºåˆ—åŒ–
        redisTemplate.setKeySerializer(RedisSerializer.string());

        //åˆ›å»ºJsonåºåˆ—åŒ–å·¥å…·
        GenericJackson2JsonRedisSerializer jsonRedisSerializer = new GenericJackson2JsonRedisSerializer();
        //è®¾ç½®Valueçš„åºåˆ—åŒ–
        redisTemplate.setValueSerializer(jsonRedisSerializer);

        return redisTemplate;
    }
}
```



åœ¨æµ‹è¯•åŒ…é‡Œåˆ›å»ºæµ‹è¯•ç±»RedisTestï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹



```java
@SpringBootTest
public class RedisTest {
    //
    @Resource
    private RedisTemplate redisTemplate;
    @Test
    void test(){
        ValueOperations valueOperations = redisTemplate.opsForValue();
        //å¢
        valueOperations.set("yupiString","dog");
        valueOperations.set("yupiInt",1);
        valueOperations.set("yupiDouble",2.0);
        User user = new User();
        user.setId(1L);
        user.setUsername("yupi");
        valueOperations.set("yupiUser",user);
        //æŸ¥
        Object yupi = valueOperations.get("yupiString");
        Assertions.assertTrue("dog".equals((String)yupi));
        yupi = valueOperations.get("yupiInt");
        Assertions.assertTrue(1==((Integer)yupi));
        yupi = valueOperations.get("yupiDouble");
        Assertions.assertTrue(2.0==((Double)yupi));
        System.out.println(valueOperations.get("yupiUser"));
//        valueOperations.set("yupiString","dog");
//        redisTemplate.delete("yupiString");
    }
}
```



redisä¸­å¯æŸ¥è¯¢åˆ°ç¼“å­˜çš„æ•°æ®  
![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230204155411518.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_26%2Ctext_U2hpZXI%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



## äºŒã€æ ¹æ®ç”¨æˆ·å¼€å‘ä¸ªæ€§æ¨èé¡µ


### 1.ä¿®æ”¹æ¨èé¡µé¢çš„æ¥å£ï¼Œæ•´ç†å¦‚ä¸‹ï¼š


```java
   /**
     * æ¨èé¡µé¢
     * @param request
     * @return
     */
    @GetMapping("/recommend")
    public BaseResponse<Page<User>> recommendUsers(long pageSize,long pageNum, HttpServletRequest request){
        User loginUser = userService.getLoginUser(request);
        String redisKey = String.format("partner:user:recommend:%s", loginUser.getId());
        ValueOperations<String,Object> valueOperations = redisTemplate.opsForValue();
        //å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥è¯»ç¼“å­˜
        Page<User> userPage= (Page<User>)valueOperations.get(redisKey);
        if (userPage!=null){
            return ResultUtils.success(userPage);
        }
        //æ— ç¼“å­˜ï¼ŒæŸ¥æ•°æ®åº“
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        userPage = userService.page(new Page<>(pageNum, pageSize), queryWrapper);
        //å†™ç¼“å­˜
        try {
          valueOperations.set(redisKey,userPage,30000, TimeUnit.MILLISECONDS);
        }catch (Exception e){
            log.error("redis set key error",e);
        }
        return ResultUtils.success(userPage);
    }
```



åˆ·æ–°é¡µé¢ï¼Œæœ‰äº†ç¼“å­˜ä¹‹åæŸ¥è¯¢é€Ÿåº¦å˜å¿«ï¼Œåªæœ‰20å¤šæ¯«ç§’



å¦‚æœé¡µé¢æ²¡æœ‰æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œåˆ™å–ä¿®æ”¹å‰ç«¯å¦‚å›¾æ‰€ç¤ºï¼Œæ”¹ä¸ºtrue



![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230204162108703.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_U2hpZXI%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



### 2.å®šæ—¶ä»»åŠ¡


> ä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šç¬¬ä¸€ä¸ªç”¨æˆ·è®¿é—®è¿˜æ˜¯å¾ˆæ…¢ï¼ˆåŠ å…¥ç¬¬ä¸€ä¸ªè€æ¿ï¼‰ï¼Œè¦å®ç°ç¼“å­˜é¢„çƒ­è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†å®šæ—¶çš„æ–¹æ³•
>



æ–°å»ºä¸€ä¸ªjobåŒ…ï¼Œå†™å…¥ä¸‹é¢ä»£ç å®ç°å®šæ—¶é¢„çƒ­ç¼“å­˜



```java
@Slf4j
@Component // åŠ è½½æˆbean
public class PreCacheJob {
    @Resource
    private UserService userService;

    @Resource
    private RedisTemplate<String,Object> redisTemplate;

    //é‡ç‚¹ç”¨æˆ·  
    private List<Long> mainUserList = Arrays.asList(1l);

    //æ¯å¤©æ‰§è¡Œï¼Œé¢„çƒ­æ¨èç”¨æˆ· ç§’-åˆ†-æ—¶-æ—¥-æœˆ-å¹´
    @Scheduled(cron = "0 24 18 * * *")
    public void doCacheRecommendUser(){
        for (Long userId: mainUserList){
            QueryWrapper<User> queryWrapper = new QueryWrapper<>();
            Page<User> userPage = userService.page(new Page<>(1, 20), queryWrapper);
            String redisKey = String.format("yupao:user:recommend:%s", userId);
            ValueOperations<String,Object> valueOperations = redisTemplate.opsForValue();
            //å†™ç¼“å­˜
            try {
                valueOperations.set(redisKey,userPage,30000, TimeUnit.MILLISECONDS);
            }catch (Exception e){
                log.error("redis set key error",e);
            }
        }
    }
}
```



æ³¨æ„:è¦åœ¨UserCenterApplicationæ·»åŠ @EnableSchedulingæ³¨è§£ï¼Œå…è®¸å®šæ—¶ä»»åŠ¡



![1668854073418-2fa9aaef-ad02-4bb6-b4cf-a4ca2e16e6af.png](./img/bWIs_s3uuvCEZqkB/1668854073418-2fa9aaef-ad02-4bb6-b4cf-a4ca2e16e6af-880360.png)



åˆ å»redisé‡Œçš„ç¼“å­˜ï¼Œè®¾å®šä¸€ä¸ªæ—¶é—´ï¼Œå¯åŠ¨é¡¹ç›®ï¼ˆå‰åç«¯ï¼‰ï¼Œç­‰å¾…æ—¶é—´åˆ°æ¥ï¼Œå‘ç°redisé‡Œé¢å·²ç»æœ‰äº†ç¼“å­˜



![1668853470684-c2b2837a-870d-43df-953f-dc853d97f97d.png](./img/bWIs_s3uuvCEZqkB/1668853470684-c2b2837a-870d-43df-953f-dc853d97f97d-768290.png)  
åˆ·æ–°é¡µé¢ä¾æ—§å¾ˆå¿«ï¼åªæœ‰20æ¯«ç§’



## ç¬¬ä¸ƒæœŸå®Œç»“ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰


> æ›´æ–°: 2023-02-10 10:05:16  
> åŸæ–‡: <https://www.yuque.com/shierkcs/catstudy/qpctxhy6civ4334q>