### é…ç½®ä¸­å¿ƒ

#### ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œåº”ç”¨çš„é…ç½®ç®¡ç†å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œç‰¹åˆ«æ˜¯å½“ç³»ç»Ÿè§„æ¨¡å’Œç»„ä»¶æ•°é‡å¢åŠ æ—¶ã€‚ä¼ ç»Ÿçš„æ‰‹åŠ¨é…ç½®ï¼ˆå†™å›ºå®šé…ç½®æ–‡ä»¶ï¼‰å¾€å¾€éš¾ä»¥åº”å¯¹è¿™äº›å¤æ‚çš„éœ€æ±‚ã€‚

è€Œé…ç½®ä¸­å¿ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é…ç½®çš„ **é›†ä¸­åŒ–ç®¡ç†ï¼Œ**è¿˜æä¾›åŠ¨æ€æ›´æ–°ã€é…ç½®åˆ†ç»„ã€ç‰ˆæœ¬æ§åˆ¶ã€ç°åº¦å‘å¸ƒã€å®‰å…¨ç®¡ç†ï¼Œç®€åŒ–äº†å¤šç¯å¢ƒå’Œå¤šå®ä¾‹çš„é…ç½®è¿ç»´ï¼Œç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§å’Œç¨³å®šæ€§ã€‚

ä¸€å¥è¯ï¼Œä¸“ä¸šçš„æŠ€æœ¯åšä¸“ä¸šçš„äº‹ã€‚

#### é…ç½®ä¸­å¿ƒæ”¯æŒçš„åŠŸèƒ½

1ï¼‰é›†ä¸­åŒ–é…ç½®ç®¡ç†ï¼šæ‰€æœ‰æœåŠ¡çš„é…ç½®å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­ç®¡ç†ï¼Œè¿ç»´äººå‘˜å’Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„æ¥å£ä¿®æ”¹å’Œè·å–é…ç½®ï¼Œé¿å…äº†åœ¨æ¯ä¸ªå®ä¾‹ä¸­é‡å¤é…ç½®ã€‚

2ï¼‰åŠ¨æ€é…ç½®ï¼šé…ç½®ä¸­å¿ƒå…è®¸åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹åŠ¨æ€æ›´æ–°é…ç½®ï¼Œåº”ç”¨å¯ä»¥å®æ—¶æ”¶åˆ°é…ç½®çš„ä¿®æ”¹ï¼Œè¿›è¡Œè¿è¡Œæ—¶çš„è°ƒæ•´ã€‚

3ï¼‰å¤šç¯å¢ƒé…ç½®ç®¡ç†ï¼šé…ç½®ä¸­å¿ƒï¼Œå¯ä»¥ä¸ºä¸åŒçš„ç¯å¢ƒé…ç½®ä¸åŒçš„é…ç½®é›†ï¼ŒæŒ‰éœ€åŠ è½½ç›¸åº”çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œé¿å…äº†ç¯å¢ƒé—´é…ç½®çš„æ··æ·†å’Œå‡ºé”™ã€‚

4ï¼‰é…ç½®çš„ç‰ˆæœ¬æ§åˆ¶ï¼šé…ç½®ä¸­å¿ƒä¸€èˆ¬éƒ½ä¼šæä¾›ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹å’Œå›æ»šåˆ°ä¹‹å‰çš„é…ç½®ç‰ˆæœ¬ï¼Œè¿™æé«˜äº†ç³»ç»Ÿçš„å®¹é”™æ€§å’Œå¯æ¢å¤æ€§ã€‚

5ï¼‰é…ç½®çš„å®‰å…¨ç®¡ç†ï¼šé…ç½®ä¸­å¿ƒä¸€èˆ¬ä¼šæä¾›åŠ å¯†å­˜å‚¨å’Œæƒé™æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥å¯¹æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç ã€API å¯†é’¥ç­‰ï¼‰è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œå¹¶é™åˆ¶è®¿é—®æƒé™ï¼Œç¡®ä¿æ•æ„Ÿé…ç½®ä¿¡æ¯çš„å®‰å…¨æ€§ã€‚

#### å¸¸è§çš„é…ç½®ä¸­å¿ƒ

1ï¼‰Spring Cloud Configï¼šSpring Cloud æä¾›çš„é…ç½®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒ Git ç­‰ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿå­˜å‚¨é…ç½®ï¼Œé€‚åˆä¸ Spring Cloud ç³»ç»Ÿé›†æˆä½¿ç”¨ã€‚

2ï¼‰Nacosï¼šé˜¿é‡Œå·´å·´å¼€æºçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œæ”¯æŒåŠ¨æ€é…ç½®ã€æœåŠ¡æ²»ç†ï¼Œé€‚åˆå¾®æœåŠ¡æ¶æ„å’Œ Dubboã€Spring Cloud çš„æ·±åº¦é›†æˆã€‚

3ï¼‰Apolloï¼šç”±æºç¨‹å¼€æºçš„é…ç½®ä¸­å¿ƒï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šé›†ç¾¤çš„é…ç½®ç®¡ç†ï¼Œé…ç½®å®æ—¶ç”Ÿæ•ˆä¸”å…·æœ‰æƒé™æ§åˆ¶ï¼Œé€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

4ï¼‰Consulï¼šç”± HashiCorp æä¾›çš„æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒï¼Œå…·æœ‰å¼ºä¸€è‡´æ€§å’Œå¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œé€‚ç”¨äºæœåŠ¡ç½‘æ ¼å’Œå®¹å™¨åŒ–åº”ç”¨ã€‚

ä¸€èˆ¬ä¸šåŠ¡ä¸Šï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©ä½¿ç”¨ Nacos æˆ– Apollo æ¥ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæä¾›äº†æ¯”è¾ƒä¸°å¯Œçš„æ§åˆ¶å°ç®¡ç†é¡µé¢ï¼Œä¾¿äºæˆ‘ä»¬ä¿®æ”¹ç»´æŠ¤é…ç½®ã€‚

**æœ¬é¡¹ç›®ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒçš„å®ç°ã€‚**

### Nacos å…¥é—¨

#### ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ

[Nacos](https://nacos.io/) æ˜¯ Dynamic Naming and Configuration Service çš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

å®ƒæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚

å®é™…ä¸Šï¼ŒNacos ä¸ä»…æ”¯æŒé…ç½®ç®¡ç†ï¼Œå®ƒè¿˜æ”¯æŒæœåŠ¡å‘ç°ï¼ˆä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼‰ï¼Œä»¥ä¸‹æ˜¯å®˜ç½‘æ€»ç»“çš„ Nacos åœ°å›¾ï¼š

![img](./assets/Nacos-é±¼çš®/NVwGzUD9yp1DcdcU.webp)

æˆ‘ä»¬å½“å‰çš„é¡¹ç›®ä¸»è¦ä½¿ç”¨å®ƒçš„é…ç½®ç®¡ç†åŠŸèƒ½ã€‚

#### Nacos é…ç½®ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µ

1ã€Namespaceï¼ˆå‘½åç©ºé—´ï¼‰

å‘½åç©ºé—´ç”¨äºéš”ç¦»ä¸åŒçš„é…ç½®é›†ã€‚å®ƒå…è®¸åœ¨åŒä¸€ä¸ª Nacos é›†ç¾¤ä¸­å°†ä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰æˆ–è€…ä¸åŒçš„ä¸šåŠ¡çº¿çš„é…ç½®è¿›è¡Œéš”ç¦»ã€‚ï¼ˆé»˜è®¤æä¾›äº†ä¸€ä¸ª public å‘½åç©ºé—´ï¼‰ ä½¿ç”¨åœºæ™¯ï¼šåœ¨å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­ï¼Œæˆ–è€…éœ€è¦åŒºåˆ†ä¸åŒçš„ç¯å¢ƒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®å’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®å®Œå…¨éš”ç¦»ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„å‘½åç©ºé—´æ¥ç®¡ç†ã€‚

2ã€Groupï¼ˆç»„ï¼‰

é…ç½®ç»„æ˜¯ç”¨äºå°†å¤šä¸ªç›¸å…³çš„é…ç½®é¡¹è¿›è¡Œåˆ†ç±»ç®¡ç†çš„é€»è¾‘åˆ†ç»„æœºåˆ¶ã€‚æ¯ä¸ªé…ç½®é¡¹å¯ä»¥å±äºä¸åŒçš„ç»„ï¼Œä»¥ä¾¿äºé…ç½®ç®¡ç†ã€‚ ä½¿ç”¨åœºæ™¯ï¼šå½“ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªæ¨¡å—ï¼Œä¸”ä¸åŒæ¨¡å—ä¹‹é—´å…±äº«éƒ¨åˆ†é…ç½®æ—¶ï¼Œå¯ä»¥ç”¨ç»„æ¥å¯¹è¿™äº›æ¨¡å—çš„é…ç½®è¿›è¡Œåˆ†ç±»å’Œç®¡ç†ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿä¸­çš„â€œæ”¯ä»˜æœåŠ¡â€å’Œâ€œè®¢å•æœåŠ¡â€å¯èƒ½éœ€è¦ç”¨ä¸åŒçš„ç»„æ¥å­˜å‚¨å„è‡ªçš„é…ç½®ã€‚

3ã€Data ID

Data ID æ˜¯ä¸€ä¸ªå”¯ä¸€çš„é…ç½®æ ‡è¯†ç¬¦ï¼Œé€šå¸¸ä¸å…·ä½“çš„åº”ç”¨ç¨‹åºç›¸å…³ã€‚é€šè¿‡ Data IDï¼ŒNacos çŸ¥é“å¦‚ä½•è·å–ç‰¹å®šåº”ç”¨çš„æŸä¸ªå…·ä½“é…ç½®ã€‚ ä½¿ç”¨åœºæ™¯ï¼šæ¯ä¸ªåº”ç”¨çš„é…ç½®éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ Data IDã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ”¯ä»˜ç³»ç»Ÿå¯èƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶å« `com.payment.pay-service.yaml`ï¼Œè¿™å°±æ˜¯å®ƒçš„ Data IDã€‚

4ã€Config Listenerï¼ˆé…ç½®ç›‘å¬å™¨ï¼‰

é…ç½®ç›‘å¬å™¨ç”¨äºè®©å®¢æˆ·ç«¯å®æ—¶ç›‘å¬ Nacos é…ç½®ä¸­å¿ƒä¸­çš„é…ç½®å˜åŒ–ï¼Œå¯ä»¥è‡ªåŠ¨æ„ŸçŸ¥é…ç½®çš„æ›´æ–°å¹¶åšå‡ºç›¸åº”çš„å¤„ç†ã€‚ ä½¿ç”¨åœºæ™¯ï¼šåœ¨éœ€è¦åŠ¨æ€è°ƒæ•´é…ç½®çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚è°ƒæ•´ç¼“å­˜å¤§å°ã€åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç«¯ç‚¹ç­‰ï¼Œåº”ç”¨å¯ä»¥é€šè¿‡ç›‘å¬å™¨åŠæ—¶æ„ŸçŸ¥è¿™äº›å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½®ã€‚

#### æ¨é€å’Œç›‘å¬

æ¨é€æ–¹æ³•ï¼š

1. Nacos æ§åˆ¶å°ï¼ˆæ¨èï¼‰
2. åº”ç”¨ç¨‹åº SDKã€‚Nacos æ”¯æŒå’Œ Spring Boot å¿«é€Ÿæ•´åˆï¼Œå¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/quick-start-spring-boot.html)
3. [Open API](https://nacos.io/zh-cn/docs/open-api.html)

ç›‘å¬æ–¹æ³•ï¼šä½¿ç”¨ SDK é…ç½® Config Listenerï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/sdk.html) ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
String serverAddr = "{serverAddr}";
String dataId = "{dataId}";
String group = "{group}";
Properties properties = new Properties();
properties.put("serverAddr", serverAddr);
ConfigService configService = NacosFactory.createConfigService(properties);
String content = configService.getConfig(dataId, group, 5000);
System.out.println(content);
configService.addListener(dataId, group, new Listener() {
	@Override
	public void receiveConfigInfo(String configInfo) {
		System.out.println("recieve1:" + configInfo);
	}
	@Override
	public Executor getExecutor() {
		return null;
	}
});

// æµ‹è¯•è®©ä¸»çº¿ç¨‹ä¸é€€å‡ºï¼Œå› ä¸ºè®¢é˜…é…ç½®æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹é€€å‡ºå®ˆæŠ¤çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚ æ­£å¼ä»£ç ä¸­æ— éœ€ä¸‹é¢ä»£ç 
while (true) {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

æˆ–è€…ç›´æ¥é€šè¿‡æ³¨è§£è¯»å– valueï¼Œèƒ½å¤Ÿå®æ—¶è·å–åˆ°æœ€æ–°çš„é…ç½®å€¼ï¼š

```java
@Controller
@RequestMapping("config")
public class ConfigController {

    @NacosValue(value = "${useLocalCache:false}", autoRefreshed = true)
    private boolean useLocalCache;

    @RequestMapping(value = "/get", method = GET)
    @ResponseBody
    public boolean get() {
        return useLocalCache;
    }
}
```

#### æ‰©å±•çŸ¥è¯† - Nacos æ€§èƒ½

åœ¨ä¼ä¸šä¸­ï¼ŒåšæŠ€æœ¯é€‰å‹æ—¶ï¼Œæ€§èƒ½æ˜¯å¿…ä¸å¯å°‘çš„è€ƒè™‘å› ç´ ã€‚

å¯ä»¥å‚è€ƒ Nacos çš„ [å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/nacos-config-benchmark.html) äº†è§£ã€‚

å†™æ€§èƒ½ï¼š

BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak=NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk=19lREw9lV3H3I+rK7vjxERQeWUOy0kwqtJjqK+R58cE=BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak=

| **å•æœº**wt4tVNmXm8QgLQdra6I0fKvSrV47aw99prVO/cGe5fU= | **3èŠ‚ç‚¹**NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk= | **10èŠ‚ç‚¹**Zd4vN1X+Mu+cpkGy31rZ96a82qN0fwdgpTBxAm0Vg+g=zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk= | **100èŠ‚ç‚¹**BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak= |
| ---------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------- |
| 1400                                                 | 4214                                                  | 6863Ob+rrfxihs8C6cKC1R8DHHHNAFb3lGV+4N1WAXF+guU=             | 8626                                                    |

è¯»æ€§èƒ½ï¼š

bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk=Zd4vN1X+Mu+cpkGy31rZ96a82qN0fwdgpTBxAm0Vg+g=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=

| **å•æœº**yXZ+wplD/Z/TIlcCXWQJ7meUSnldS+OOOCauQaPvvSE= | **3èŠ‚ç‚¹**NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk= | **10èŠ‚ç‚¹**zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0= | **100èŠ‚ç‚¹**19lREw9lV3H3I+rK7vjxERQeWUOy0kwqtJjqK+R58cE= |
| ---------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------- |
| 15000                                                | 23013                                                 | 45000zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk=            | 161099                                                  |

å¯¹ Nacos æœ‰åˆæ­¥äº†è§£åï¼Œä¸‹é¢æˆ‘ä»¬åŸºäº Nacos å®ç° IP é»‘åå•éœ€æ±‚ã€‚

### åç«¯å¼€å‘

#### 1ã€ä¸‹è½½ Nacos Server

å¯ä»¥åœ¨ Nacos å®˜ç½‘ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ Nacos åº”ç”¨åŒ…ï¼Œ**æ­¤å¤„ä½¿ç”¨å’Œ Sentinel å…¼å®¹çš„ 2.2.0 ç‰ˆæœ¬ï¼Œä¸€å®šä¸è¦ä½¿ç”¨å…¶ä»–ç‰ˆæœ¬ï¼å¦åˆ™é™¤äº†é—®é¢˜ä¸å¥½è§£å†³ï¼**

å¯ä»¥åœ¨å®˜æ–¹ä¸‹è½½ï¼šhttps://nacos.io/download/release-history/

æœ¬æ•™ç¨‹ä¸ºå¤§å®¶æä¾›äº†è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

#### 2ã€å¯åŠ¨ Nacos Server

è§£å‹ä¸‹è½½å¥½çš„å‹ç¼©åŒ…ï¼š

![img](./assets/Nacos-é±¼çš®/fy7GrQm3ZZRjMarT.webp)

Linux/Unix/Mac å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼ˆstandalone ä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼ï¼‰ï¼š

```bash
sh startup.sh -m standalone
```

Windows å¯åŠ¨å‘½ä»¤ï¼š

```bash
startup.cmd -m standalone
```

å¯åŠ¨æˆåŠŸï¼Œå¦‚å›¾ï¼š

![img](./assets/Nacos-é±¼çš®/3dmbtledduayOuhT.webp)

å¦‚æœæŠ¥æ‰¾ä¸åˆ° Javaï¼Œé‚£å°±é…ç½® JAVA_HOMEã€ç¯å¢ƒå˜é‡æˆ–è€…å®‰è£… Javaï¼šhttps://www.oracle.com/java/technologies/downloads/#java8

å¦‚ä½•ä½¿ç”¨ Nacos å‘¢ï¼Ÿå…¶å®æ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹æ•™ç¨‹å’Œç¤ºä¾‹ä»£ç ï¼Œæ‹¿æ¥å°±èƒ½ç”¨ï¼

- æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/quick-start.html
- æ•™ç¨‹ï¼šhttps://sca.aliyun.com/zh-cn/docs/2021.0.5.0/user-guide/nacos/quick-start
- ç¤ºä¾‹ä»£ç ï¼šhttps://github.com/alibaba/spring-cloud-alibaba/tree/2022.x/spring-cloud-alibaba-examples/nacos-example

#### 3ã€é€šè¿‡ Nacos æ§åˆ¶å°æ·»åŠ é…ç½®

1ï¼‰è®¿é—®ï¼šhttp://127.0.0.1:8848/nacos ï¼Œé»˜è®¤ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯ nacos

![img](./assets/Nacos-é±¼çš®/Bgvt2pvaV1YXAZxs.webp)

2ï¼‰ç‚¹å‡»åˆ›å»ºé…ç½®ï¼š

![img](./assets/Nacos-é±¼çš®/D6ZyREkDH6zKul78.webp)

å¡«å†™é…ç½®ï¼Œæ¨è yaml æ ¼å¼ï¼š

```yaml
blackIpList:
    - "1.1.1.1"
    - "2.2.2.2"
```

å¦‚å›¾ï¼š

![img](./assets/Nacos-é±¼çš®/rrgSNP2oj3Uh1Fob.webp)

#### 4ã€é¡¹ç›®å¼•å…¥ Nacos ä¾èµ–

å¯ä»¥ç›´æ¥ä½¿ç”¨ Spring Boot Starter å¿«é€Ÿå¼•å…¥ Nacosï¼Œ[å‚è€ƒæ–‡æ¡£](https://nacos.io/zh-cn/docs/quick-start-spring-boot.html)ã€‚

1ï¼‰åœ¨é¡¹ç›® pom.xml æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä»¥ä¸‹ä¾èµ–é…ç½®ï¼š

```xml
<dependency>
    <groupId>com.alibaba.boot</groupId>
    <artifactId>nacos-config-spring-boot-starter</artifactId>
    <version>0.2.12</version>
</dependency>
```

æ³¨æ„ï¼šç‰ˆæœ¬ 0.2.x.RELEASE å¯¹åº”çš„æ˜¯ Spring Boot 2.x ç‰ˆæœ¬ï¼Œç‰ˆæœ¬ 0.1.x.RELEASE å¯¹åº”çš„æ˜¯ Spring Boot 1.x ç‰ˆæœ¬ã€‚ï¼ˆç»æµ‹è¯•ï¼Œæœ¬é¡¹ç›®å¯ä½¿ç”¨ 0.2.12 ç‰ˆæœ¬ï¼‰

2ï¼‰ä¿®æ”¹ application.yml é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  Nacos Server åœ°å€ç­‰é…ç½®ï¼š

```yaml
# é…ç½®ä¸­å¿ƒ
nacos:
  config:
    server-addr: 127.0.0.1:8848  # nacos åœ°å€
    bootstrap:
      enable: true  # é¢„åŠ è½½
    data-id: mianshiya # æ§åˆ¶å°å¡«å†™çš„ Data ID
    group: DEFAULT_GROUP # æ§åˆ¶å°å¡«å†™çš„ group
    type: yaml  # é€‰æ‹©çš„æ–‡ä»¶æ ¼å¼
    auto-refresh: true # å¼€å¯è‡ªåŠ¨åˆ·æ–°
```

#### 5ã€åˆ›å»ºé»‘åå•è¿‡æ»¤å·¥å…·ç±»

æ–°å»º blackfilter åŒ…ï¼Œé»‘åå•è¿‡æ»¤ç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ°è¯¥åŒ…ä¸‹ï¼Œæ¨¡å—åŒ–ã€‚

å¯ä»¥ç”¨ Hutool æˆ– Guava åº“è‡ªå¸¦çš„ bloomfilterï¼Œ[å‚è€ƒæ–‡ç« ](https://blog.csdn.net/asd051377305/article/details/139684962)ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼ï¼Œè¿˜å¯ä»¥è€ƒè™‘ Redissonã€‚

æ­¤å¤„ç”±äºé¡¹ç›®å·²ç»ä½¿ç”¨äº† Hutool å·¥å…·åº“ï¼Œå°±ç”¨å…¶è‡ªå¸¦çš„ BitMapBloomFilter å³å¯ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class BlackIpUtils {

    private static BitMapBloomFilter bloomFilter;

    // åˆ¤æ–­ ip æ˜¯å¦åœ¨é»‘åå•å†…
    public static boolean isBlackIp(String ip) {
        return bloomFilter.contains(ip);
    }

    // é‡å»º ip é»‘åå•
    public static void rebuildBlackIp(String configInfo) {
        if (StrUtil.isBlank(configInfo)) {
            configInfo = "{}";
        }
        // è§£æ yaml æ–‡ä»¶
        Yaml yaml = new Yaml();
        Map map = yaml.loadAs(configInfo, Map.class);
        // è·å– ip é»‘åå•
        List<String> blackIpList = (List<String>) map.get("blackIpList");
        // åŠ é”é˜²æ­¢å¹¶å‘
        synchronized (BlackIpUtils.class) {
            if (CollectionUtil.isNotEmpty(blackIpList)) {
                // æ³¨æ„æ„é€ å‚æ•°çš„è®¾ç½®
                BitMapBloomFilter bitMapBloomFilter = new BitMapBloomFilter(958506);
                for (String ip : blackIpList) {
                    bitMapBloomFilter.add(ip);
                }
                bloomFilter = bitMapBloomFilter;
            } else {
                bloomFilter = new BitMapBloomFilter(100);
            }
        }
    }
}
```

æ³¨æ„ï¼ŒBitMapBloomFilter æ¥å—çš„å‚æ•°æ¯”è¾ƒç‰¹æ®Šï¼Œå…³äºå¦‚ä½•è®¡ç®— BloomFilter å‚æ•°å€¼ï¼Œé±¼çš®åœ¨ GitHub æ‰¾åˆ°äº†ä¸€ä¸ªè¯´æ³•ï¼Œå¯ä»¥è‡ªè¡Œæµ‹è¯•ï¼šhttps://github.com/dromara/hutool/issues/3356ã€‚

ğŸ’¡ æ³¨æ„ï¼Œå› ä¸º Nacos é…ç½®æ–‡ä»¶çš„ç›‘å¬çš„ç²’åº¦æ¯”è¾ƒç²—ï¼Œåªèƒ½çŸ¥æ™“é…ç½®æœ‰å˜æ›´ï¼Œæ— æ³•çŸ¥æ™“æ˜¯æ–°å¢ã€åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ï¼Œå› æ­¤ä¸è®ºæ˜¯é€‰æ‹©å¸ƒéš†è¿‡æ»¤å™¨è¿˜æ˜¯ HashSet æœ€æ–¹ä¾¿çš„å¤„ç†é€»è¾‘å°±æ˜¯é‡å»ºã€‚

#### 6ã€åˆ›å»º Nacos é…ç½®ç›‘å¬ç±»

å¯ä»¥ç›´æ¥é€šè¿‡ Nacos æ§åˆ¶å°è·å–ç¤ºä¾‹ä»£ç ï¼š

![img](./assets/Nacos-é±¼çš®/Klw11YF8zKoCSS02.webp)

åœ¨ blackfilter åŒ…ä¸­æ–°å¢ç›‘å¬å™¨ä»£ç ï¼Œè¿½æ±‚æ€§èƒ½çš„è¯å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š

```java
@Slf4j
@Component
public class NacosListener implements InitializingBean {

    @NacosInjected
    private ConfigService configService;

    @Value("${nacos.config.data-id}")
    private String dataId;

    @Value("${nacos.config.group}")
    private String group;

    @Override
    public void afterPropertiesSet() throws Exception {
        log.info("nacos ç›‘å¬å™¨å¯åŠ¨");

        String config = configService.getConfigAndSignListener(dataId, group, 3000L, new Listener() {
            final ThreadFactory threadFactory = new ThreadFactory() {
                private final AtomicInteger poolNumber = new AtomicInteger(1);
                @Override
                public Thread newThread(@NotNull Runnable r) {
                    Thread thread = new Thread(r);
                    thread.setName("refresh-ThreadPool" + poolNumber.getAndIncrement());
                    return thread;
                }
            };
            final ExecutorService executorService = Executors.newFixedThreadPool(1, threadFactory);

            // é€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†é»‘åå•å˜åŒ–çš„é€»è¾‘
            @Override
            public Executor getExecutor() {
                return executorService;
            }

            // ç›‘å¬åç»­é»‘åå•å˜åŒ–
            @Override
            public void receiveConfigInfo(String configInfo) {
                log.info("ç›‘å¬åˆ°é…ç½®ä¿¡æ¯å˜åŒ–ï¼š{}", configInfo);
                BlackIpUtils.rebuildBlackIp(configInfo);
            }
        });
        // åˆå§‹åŒ–é»‘åå•
        BlackIpUtils.rebuildBlackIp(config);
    }
}
```

#### 7ã€åˆ›å»ºé»‘åå•è¿‡æ»¤å™¨

é»‘åå•åº”è¯¥å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆï¼ˆä¸æ­¢æ˜¯ Controller çš„æ¥å£ï¼‰ï¼Œæ‰€ä»¥åŸºäº WebFilter å®ç°è€Œä¸æ˜¯ AOP åˆ‡é¢ã€‚WebFilter çš„ä¼˜å…ˆçº§é«˜äº @Aspect åˆ‡é¢ï¼Œå› ä¸ºå®ƒåœ¨æ•´ä¸ª Web è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­æ›´æ—©è¿›è¡Œå¤„ç†ã€‚

è¯·æ±‚è¿›å…¥æ—¶çš„é¡ºåºï¼š

- WebFilterï¼šé¦–å…ˆï¼ŒWebFilter æ‹¦æˆª HTTP è¯·æ±‚ï¼Œå¹¶å¯ä»¥æ ¹æ®é€»è¾‘å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚
- Spring AOP åˆ‡é¢ï¼ˆ@Aspectï¼‰ï¼šå¦‚æœè¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨å¹¶è¿›å…¥ Spring ç®¡ç†çš„ Beanï¼ˆä¾‹å¦‚ Controller å±‚ï¼‰ï¼Œæ­¤æ—¶åˆ‡é¢ç”Ÿæ•ˆï¼Œå¯¹åŒ¹é…çš„ Bean æ–¹æ³•è¿›è¡Œæ‹¦æˆªã€‚
- Controller å±‚ï¼šå¦‚æœ @Aspect æ²¡æœ‰é˜»æ­¢æ‰§è¡Œï¼Œæœ€ç»ˆè¯·æ±‚åˆ°è¾¾ @Controller æˆ– @RestController çš„æ–¹æ³•ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
@WebFilter(urlPatterns = "/*", filterName = "blackIpFilter")
public class BlackIpFilter implements Filter {

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        String ipAddress = NetUtils.getIpAddress((HttpServletRequest) servletRequest);
        if (BlackIpUtils.isBlackIp(ipAddress)) {
            servletResponse.setContentType("text/json;charset=UTF-8");
            servletResponse.getWriter().write("{\"errorCode\":\"-1\",\"errorMsg\":\"é»‘åå•IPï¼Œç¦æ­¢è®¿é—®\"}");
            return;
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

}
```

éœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š `@ServletComponentScan`ï¼Œè¿™æ ·è¿‡æ»¤å™¨æ‰ä¼šè¢«æ‰«æåˆ°ã€‚

```java
@SpringBootApplication(exclude = {RedisAutoConfiguration.class})
@MapperScan("com.yupi.mianshiya.mapper")
@EnableScheduling
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
@ServletComponentScan
public class MainApplication {

    public static void main(String[] args) {
        SpringApplication.run(MainApplication.class, args);
    }

}
```

#### 8ã€æµ‹è¯•æ•ˆæœ

é€šè¿‡ Nacos æ§åˆ¶å°ä¿®æ”¹é…ç½®ï¼Œæœ¬åœ°æµ‹è¯•çš„è¯ç›´æ¥åŠ å…¥æœ¬æœº IP å³å¯ï¼š

```java
blackIpList:
    - "1.1.1.1"
    - "2.2.2.2"
    - "0:0:0:0:0:0:0:1"
```

å¦‚å›¾ï¼š

![img](./assets/Nacos-é±¼çš®/OTMN965Uxuo2JoIr.webp)

Nacos æ§åˆ¶å°èƒ½çœ‹åˆ°æ”¹åŠ¨è®°å½•ï¼š

![img](./assets/Nacos-é±¼çš®/eRco9Sy1QJ95riiE.webp)

åœ¨åº”ç”¨ä¸­å¯ä»¥å®æ—¶æ¥å—åˆ°é…ç½®çš„ä¿®æ”¹ï¼Œä½¿å¾—é»‘åå•å®æ—¶ç”Ÿæ•ˆï¼š

![img](./assets/Nacos-é±¼çš®/sTQateKggsDSeNx2-1737277253095-56.webp)

é€šè¿‡ Swagger æµ‹è¯•é»‘åå•æ•ˆæœï¼š

![img](./assets/Nacos-é±¼çš®/gjTEphdMxzGHOCOl-1737277253095-54.webp)
