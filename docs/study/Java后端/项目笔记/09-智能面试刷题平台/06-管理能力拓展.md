## æœ¬èŠ‚é‡ç‚¹

é¢å‘ç®¡ç†çš„æ‰©å±•åŠŸèƒ½

- é¢˜ç›®æ‰¹é‡ç®¡ç†ï¼šéœ€æ±‚åˆ†æ + æ–¹æ¡ˆè®¾è®¡ + å‰åç«¯å¼€å‘ + åŠŸèƒ½ä¼˜åŒ–
- è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜åº“ï¼šéœ€æ±‚åˆ†æ + æ–¹æ¡ˆè®¾è®¡ + å¼€å‘å®ç°

## ä¸€ã€é¢˜ç›®æ‰¹é‡ç®¡ç†

### éœ€æ±‚åˆ†æ

ä¸ºäº†æé«˜ç®¡ç†æ•ˆç‡ï¼Œç®¡ç†ç«¯éœ€è¦æä¾›æ‰¹é‡æ“ä½œåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

- ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®
- ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®
- ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡åˆ é™¤é¢˜ç›®

### åŸºç¡€æ–¹æ¡ˆè®¾è®¡

ä¸Šè¿°åŠŸèƒ½çš„åŸºæœ¬å®ç°å¹¶ä¸éš¾ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯æ‰¹é‡æ“ä½œã€‚

#### å‰ç«¯è®¾è®¡

å‰ç«¯éœ€è¦å…è®¸ç”¨æˆ·å¤šé€‰å†…å®¹ï¼Œå¹¶ä¸”å‘åç«¯ä¼ é€’è¦æ‰¹é‡æ“ä½œçš„æ•°æ® id åˆ—è¡¨ã€‚

å‰ç«¯å…·ä½“äº¤äº’æµç¨‹ï¼š

1ï¼‰æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®ï¼šåœ¨é¢˜ç›®ç®¡ç†é¡µï¼Œé€‰ä¸­å¤šæ¡é¢˜ç›®åï¼Œç‚¹å‡»æ“ä½œæŒ‰é’®ï¼Œå¼¹çª—è®©ç”¨æˆ·é€‰æ‹©è¦æ·»åŠ çš„é¢˜åº“ã€‚

2ï¼‰æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®ï¼šåœ¨é¢˜ç›®ç®¡ç†é¡µï¼Œé€‰ä¸­å¤šæ¡é¢˜ç›®åï¼Œç‚¹å‡»æ“ä½œæŒ‰é’®ï¼Œå¼¹çª—è®©ç”¨æˆ·é€‰æ‹©è¦ç§»é™¤çš„é¢˜åº“ã€‚

3ï¼‰æ‰¹é‡åˆ é™¤é¢˜ç›®ï¼šåœ¨é¢˜ç›®ç®¡ç†é¡µï¼Œé€‰ä¸­å¤šæ¡é¢˜ç›®åï¼Œç‚¹å‡»æ“ä½œæŒ‰é’®ï¼Œè§¦å‘äºŒæ¬¡ç¡®è®¤ï¼Œå¹¶æ‰§è¡Œåˆ é™¤ã€‚

#### åç«¯è®¾è®¡

åç«¯é€šè¿‡ **å¾ªç¯** ä¾æ¬¡è°ƒç”¨æ•°æ®åº“å®Œæˆæ“ä½œã€‚æ³¨æ„ï¼Œç”±äºæ˜¯æ‰¹é‡æ“ä½œï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡ï¼Œæœ‰ä»»ä½•å¤±è´¥éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶å›æ»šã€‚

### åŸºç¡€åç«¯å¼€å‘

#### 1ã€æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®

æ·»åŠ å‰éœ€è¦æ ¡éªŒé¢˜ç›®å’Œé¢˜åº“æ˜¯å¦å­˜åœ¨ï¼Œåªæ·»åŠ åˆæ³•çš„é¢˜ç›®ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void batchAddQuestionsToBank(List<Long> questionIdList, Long questionBankId, User loginUser) {
    // å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, "é¢˜ç›®åˆ—è¡¨ä¸ºç©º");
    ThrowUtils.throwIf(questionBankId == null || questionBankId <= 0, ErrorCode.PARAMS_ERROR, "é¢˜åº“éæ³•");
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);
    // æ£€æŸ¥é¢˜ç›® id æ˜¯å¦å­˜åœ¨
    List<Question> questionList = questionService.listByIds(questionIdList);
    // åˆæ³•çš„é¢˜ç›® id
    List<Long> validQuestionIdList = questionList.stream()
            .map(Question::getId)
            .collect(Collectors.toList());
    ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, "åˆæ³•çš„é¢˜ç›®åˆ—è¡¨ä¸ºç©º");
    // æ£€æŸ¥é¢˜åº“ id æ˜¯å¦å­˜åœ¨
    QuestionBank questionBank = questionBankService.getById(questionBankId);
    ThrowUtils.throwIf(questionBank == null, ErrorCode.NOT_FOUND_ERROR, "é¢˜åº“ä¸å­˜åœ¨");
    // æ‰§è¡Œæ’å…¥
    for (Long questionId : validQuestionIdList) {
        QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
        questionBankQuestion.setQuestionBankId(questionBankId);
        questionBankQuestion.setQuestionId(questionId);
        questionBankQuestion.setUserId(loginUser.getId());
        boolean result = this.save(questionBankQuestion);
        if (!result) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        }
    }
}
```

è¯·æ±‚å¯¹è±¡ï¼š

```java
@Data
public class QuestionBankQuestionBatchAddRequest implements Serializable {

    /**
     * é¢˜åº“ id
     */
    private Long questionBankId;

    /**
     * é¢˜ç›® id åˆ—è¡¨
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}
```

QuestionController æ–°å¢æ¥å£ï¼š

```java
@PostMapping("/add/batch")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> batchAddQuestionsToBank(
        @RequestBody QuestionBankQuestionBatchAddRequest questionBankQuestionBatchAddRequest,
        HttpServletRequest request
) {
    // å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(questionBankQuestionBatchAddRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    Long questionBankId = questionBankQuestionBatchAddRequest.getQuestionBankId();
    List<Long> questionIdList = questionBankQuestionBatchAddRequest.getQuestionIdList();
    questionBankQuestionService.batchAddQuestionsToBank(questionIdList, questionBankId, loginUser);
    return ResultUtils.success(true);
}
```

#### 2ã€æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®

åˆ é™¤æ—¶çš„æ ¡éªŒå¯ä»¥ç›¸å¯¹å®½æ¾ä¸€äº›ï¼Œç›´æ¥æ‰§è¡Œåˆ é™¤æ“ä½œå³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void batchRemoveQuestionsFromBank(List<Long> questionIdList, Long questionBankId) {
    // å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, "é¢˜ç›®åˆ—è¡¨ä¸ºç©º");
    ThrowUtils.throwIf(questionBankId == null || questionBankId <= 0, ErrorCode.PARAMS_ERROR, "é¢˜åº“éæ³•");
    // æ‰§è¡Œåˆ é™¤å…³è”
    for (Long questionId : questionIdList) {
        // æ„é€ æŸ¥è¯¢
        LambdaQueryWrapper<QuestionBankQuestion> lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)
                .eq(QuestionBankQuestion::getQuestionId, questionId)
                .eq(QuestionBankQuestion::getQuestionBankId, questionBankId);
        boolean result = this.remove(lambdaQueryWrapper);
        if (!result) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "ä»é¢˜åº“ç§»é™¤é¢˜ç›®å¤±è´¥");
        }
    }
}
```

è¯·æ±‚å¯¹è±¡ï¼š

```java
@Data
public class QuestionBankQuestionBatchRemoveRequest implements Serializable {

    /**
     * é¢˜åº“ id
     */
    private Long questionBankId;

    /**
     * é¢˜ç›® id åˆ—è¡¨
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}
```

QuestionBankQuestionController æ–°å¢æ¥å£ï¼š

```java
@PostMapping("/remove/batch")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> batchRemoveQuestionsFromBank(
        @RequestBody QuestionBankQuestionBatchRemoveRequest questionBankQuestionBatchRemoveRequest,
        HttpServletRequest request
) {
    // å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(questionBankQuestionBatchRemoveRequest == null, ErrorCode.PARAMS_ERROR);
    Long questionBankId = questionBankQuestionBatchRemoveRequest.getQuestionBankId();
    List<Long> questionIdList = questionBankQuestionBatchRemoveRequest.getQuestionIdList();
    questionBankQuestionService.batchRemoveQuestionsFromBank(questionIdList, questionBankId);
    return ResultUtils.success(true);
}
```

#### 3ã€æ‰¹é‡åˆ é™¤é¢˜ç›®

å¯¹äºæ‰¹é‡åˆ é™¤é¢˜ç›®åŠŸèƒ½ï¼Œéœ€è¦åœ¨åˆ é™¤é¢˜ç›®æ—¶ï¼Œç§»é™¤é¢˜ç›®é¢˜åº“å…³ç³»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void batchDeleteQuestions(List<Long> questionIdList) {
    if (CollUtil.isEmpty(questionIdList)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è¦åˆ é™¤çš„é¢˜ç›®åˆ—è¡¨ä¸ºç©º");
    }
    for (Long questionId : questionIdList) {
        boolean result = this.removeById(questionId);
        if (!result) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®å¤±è´¥");
        }
        // ç§»é™¤é¢˜ç›®é¢˜åº“å…³ç³»
        LambdaQueryWrapper<QuestionBankQuestion> lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)
                .eq(QuestionBankQuestion::getQuestionId, questionId);
        result = questionBankQuestionService.remove(lambdaQueryWrapper);
        if (!result) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "åˆ é™¤é¢˜ç›®é¢˜åº“å…³è”å¤±è´¥");
        }
    }
}
```

è¯·æ±‚å¯¹è±¡ï¼š

```java
@Data
public class QuestionBatchDeleteRequest implements Serializable {

    /**
     * é¢˜ç›® id åˆ—è¡¨
     */
    private List<Long> questionIdList;

    private static final long serialVersionUID = 1L;
}
```

QuestionBankQuestionController æ–°å¢æ¥å£ï¼š

```java
@PostMapping("/delete/batch")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> batchDeleteQuestions(@RequestBody QuestionBatchDeleteRequest questionBatchDeleteRequest,
                                                  HttpServletRequest request) {
    ThrowUtils.throwIf(questionBatchDeleteRequest == null, ErrorCode.PARAMS_ERROR);
    questionService.batchDeleteQuestions(questionBatchDeleteRequest.getQuestionIdList());
    return ResultUtils.success(true);
}
```

### å‰ç«¯å¼€å‘

ä¸»è¦æ˜¯ä¿®æ”¹é¢˜ç›®ç®¡ç†é¡µé¢ï¼Œå¢åŠ æ‰¹é‡æ“ä½œèƒ½åŠ›ã€‚

#### 1ã€æ‰¹é‡æ“ä½œ

Ant Design ProComponents çš„ ProTable ç»„ä»¶è‡ªå¸¦æ‰¹é‡æ“ä½œåŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://procomponents.ant.design/components/table?tab=api&current=1&pageSize=5#packages-table-src-components-table-tab-api-demo-batchoption) ã€‚

ç»™ ProTable ç»„ä»¶å¢åŠ å¦‚ä¸‹å±æ€§ï¼Œè¦é‡ç‚¹æ³¨æ„ä¿®æ”¹ ProTable ç»„ä»¶çš„ rowKey="id"ï¼Œä½œä¸ºå¤šé€‰è¡Œçš„å”¯ä¸€æ ‡è¯†ã€‚

```tsx
<ProTable<API.Question>
  rowKey="id"
  rowSelection={{
    // è‡ªå®šä¹‰é€‰æ‹©é¡¹å‚è€ƒ: https://ant.design/components/table-cn/#components-table-demo-row-selection-custom
    // æ³¨é‡Šè¯¥è¡Œåˆ™é»˜è®¤ä¸æ˜¾ç¤ºä¸‹æ‹‰é€‰é¡¹
    selections: [Table.SELECTION_ALL, Table.SELECTION_INVERT],
  }}
  tableAlertRender={({
    selectedRowKeys,
    selectedRows,
    onCleanSelected,
  }) => {
    return (
      <Space size={24}>
        <span>
          å·²é€‰ {selectedRowKeys.length} é¡¹
          <a style={{ marginInlineStart: 8 }} onClick={onCleanSelected}>
            å–æ¶ˆé€‰æ‹©
          </a>
        </span>
      </Space>
    );
  }}
  tableAlertOptionRender={({
    selectedRowKeys,
    selectedRows,
    onCleanSelected,
  }) => {
    return (
      <Space size={16}>
        <Button
          onClick={() => {
            // æ‰“å¼€å¼¹çª—
          }}
        >
          æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®
        </Button>
        <Button
          onClick={() => {
            // æ‰“å¼€å¼¹çª—
          }}
        >
          æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®
        </Button>
        <Popconfirm
          title="ç¡®è®¤åˆ é™¤"
          description="ä½ ç¡®å®šè¦åˆ é™¤è¿™äº›é¢˜ç›®ä¹ˆï¼Ÿ"
          onConfirm={() => {
            // æ‰¹é‡åˆ é™¤é¢˜ç›®
          }}
          okText="Yes"
          cancelText="No"
        >
          <Button danger>æ‰¹é‡åˆ é™¤é¢˜ç›®</Button>
        </Popconfirm>
      </Space>
    );
  }}
/>
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œè€ƒè™‘åˆ°æ‰¹é‡åˆ é™¤é¢˜ç›®éœ€è¦äºŒæ¬¡ç¡®è®¤ï¼Œä½¿ç”¨ [Popconfirm ç»„ä»¶](https://ant-design.antgroup.com/components/popconfirm-cn)ã€‚

#### 2ã€æ“ä½œå¼¹çª—

å‚è€ƒæ›´æ–°é¢˜ç›®æ‰€å±é¢˜åº“å¼¹çª—ç»„ä»¶ UpdateBankModalï¼Œç¼–å†™æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¼¹çª—ã€æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®å¼¹çª—ã€‚äºŒè€…å†™æ³•åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ¥å— questionIdList é€‰ä¸­çš„é¢˜ç›® id åˆ—è¡¨å‚æ•°ã€éƒ½éœ€è¦è·å–åˆ°é¢˜åº“åˆ—è¡¨ä¾›é€‰æ‹©ã€‚

1ï¼‰æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¼¹çª—ï¼š

```tsx
import { Button, Form, message, Modal, Select } from "antd";
import React, { useEffect, useState } from "react";
import { batchAddQuestionsToBankUsingPost } from "@/api/questionBankQuestionController";
import { listQuestionBankVoByPageUsingPost } from "@/api/questionBankController";

interface Props {
  questionIdList?: number[];
  visible: boolean;
  onSubmit: () => void;
  onCancel: () => void;
}

/**
 * æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¼¹çª—
 * @param props
 * @constructor
 */
const BatchAddQuestionsToBankModal: React.FC<Props> = (props) => {
  const { questionIdList = [], visible, onSubmit, onCancel } = props;
  const [form] = Form.useForm();
  const [questionBankList, setQuestionBankList] = useState<
    API.QuestionBankVO[]
    >([]);

  // è·å–é¢˜åº“åˆ—è¡¨
  const getQuestionBankList = async () => {
    // é¢˜åº“æ•°é‡ä¸å¤šï¼Œç›´æ¥å…¨é‡è·å–
    const pageSize = 200;

    try {
      const res = await listQuestionBankVoByPageUsingPost({
        pageSize,
        sortField: "createTime",
        sortOrder: "descend",
      });
      setQuestionBankList(res.data?.records ?? []);
    } catch (e) {
      message.error("è·å–é¢˜åº“åˆ—è¡¨å¤±è´¥ï¼Œ" + e.message);
    }
  };

  useEffect(() => {
    getQuestionBankList();
  }, []);

  /**
   * æäº¤
   * @param fields
   */
  const doSubmit = async (fields: API.QuestionBankQuestionBatchAddRequest) => {
    const hide = message.loading("æ­£åœ¨æ“ä½œ");
    const questionBankId = fields.questionBankId;
    try {
      await batchAddQuestionsToBankUsingPost({
        questionIdList,
        questionBankId,
      });
      hide();
      message.success("æ“ä½œæˆåŠŸ");
      onSubmit?.();
    } catch (error: any) {
      hide();
      message.error("æ“ä½œå¤±è´¥ï¼Œ" + error.message);
    }
  };

  return (
    <Modal
      destroyOnClose
      title={"æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®"}
      open={visible}
      footer={null}
      onCancel={() => {
        onCancel?.();
      }}
      >
      <Form
        form={form}
        style={{ marginTop: 24 }}
        onFinish={doSubmit}
        >
        <Form.Item label="é€‰æ‹©é¢˜åº“" name="questionBankId">
          <Select
            style={{ width: "100%" }}
            options={questionBankList.map((questionBank) => {
              return {
                label: questionBank.title,
                value: questionBank.id,
              };
            })}
            />
        </Form.Item>
        <Form.Item>
          <Button type="primary" htmlType="submit">
            æäº¤
          </Button>
        </Form.Item>
      </Form>
    </Modal>
  );
};

export default BatchAddQuestionsToBankModal;
```

2ï¼‰æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®å¼¹çª—ï¼š

```tsx
import { Button, Form, message, Modal, Select } from "antd";
import React, { useEffect, useState } from "react";
import { listQuestionBankVoByPageUsingPost } from "@/api/questionBankController";
import {
  batchRemoveQuestionsFromBankUsingPost,
} from "@/api/questionBankQuestionController";

interface Props {
  questionIdList?: number[];
  visible: boolean;
  onSubmit: () => void;
  onCancel: () => void;
}

/**
 * æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®å¼¹çª—
 * @param props
 * @constructor
 */
const BatchRemoveQuestionsToBankModal: React.FC<Props> = (props) => {
  const { questionIdList = [], visible, onCancel, onSubmit } = props;
  const [form] = Form.useForm();
  const [questionBankList, setQuestionBankList] = useState<
    API.QuestionBankVO[]
  >([]);

  /**
   * æäº¤
   *
   * @param values
   */
  const doSubmit = async (
    values: API.QuestionBankQuestionBatchRemoveRequest,
  ) => {
    const hide = message.loading("æ­£åœ¨æ“ä½œ");
    const questionBankId = values.questionBankId;
    if (!questionBankId) {
      return;
    }
    try {
      await batchRemoveQuestionsFromBankUsingPost({
        questionBankId,
        questionIdList,
      });
      hide();
      message.success("æ“ä½œæˆåŠŸ");
      onSubmit?.();
    } catch (error: any) {
      hide();
      message.error("æ“ä½œå¤±è´¥ï¼Œ" + error.message);
    }
  };

  // è·å–é¢˜åº“åˆ—è¡¨
  const getQuestionBankList = async () => {
    // é¢˜åº“æ•°é‡ä¸å¤šï¼Œç›´æ¥å…¨é‡è·å–
    const pageSize = 200;

    try {
      const res = await listQuestionBankVoByPageUsingPost({
        pageSize,
        sortField: "createTime",
        sortOrder: "descend",
      });
      setQuestionBankList(res.data?.records ?? []);
    } catch (e) {
      message.error("è·å–é¢˜åº“åˆ—è¡¨å¤±è´¥ï¼Œ" + e.message);
    }
  };

  useEffect(() => {
    getQuestionBankList();
  }, []);

  return (
    <Modal
      destroyOnClose
      title={"æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®"}
      open={visible}
      footer={null}
      onCancel={() => {
        onCancel?.();
      }}
    >
      <Form form={form} style={{ marginTop: 24 }} onFinish={doSubmit}>
        <Form.Item label="é€‰æ‹©é¢˜åº“" name="questionBankId">
          <Select
            style={{ width: "100%" }}
            options={questionBankList.map((questionBank) => {
              return {
                label: questionBank.title,
                value: questionBank.id,
              };
            })}
          />
        </Form.Item>
        <Form.Item>
          <Button type="primary" htmlType="submit">
            æäº¤
          </Button>
        </Form.Item>
      </Form>
    </Modal>
  );
};
export default BatchRemoveQuestionsToBankModal;
```

#### 3ã€é¢˜ç›®ç®¡ç†é¡µé¢ä½¿ç”¨å¼¹çª—

1ï¼‰éœ€è¦åœ¨é¢˜ç›®ç®¡ç†é¡µé¢å®šä¹‰ä¸€äº›å˜é‡ï¼ŒåŒ…æ‹¬å¼¹çª—æ˜¯å¦å¯è§ã€é€‰ä¸­çš„é¢˜ç›® id åˆ—è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```tsx
// æ˜¯å¦æ˜¾ç¤ºæ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¼¹çª—
const [
  batchAddQuestionsToBankModalVisible,
  setBatchAddQuestionsToBankModalVisible,
] = useState<boolean>(false);
// æ˜¯å¦æ˜¾ç¤ºæ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®å¼¹çª—
const [
  batchRemoveQuestionsFromBankModalVisible,
  setBatchRemoveQuestionsFromBankModalVisible,
] = useState<boolean>(false);
// å½“å‰é€‰ä¸­çš„é¢˜ç›® id åˆ—è¡¨
const [selectedQuestionIdList, setSelectedQuestionIdList] = useState<
  number[]
>([]);
```

2ï¼‰ç»™æ‰¹é‡æ“ä½œæŒ‰é’®ç»‘å®šäº‹ä»¶ï¼Œç‚¹å‡»æ—¶è§¦å‘å¼¹çª—æ‰“å¼€ï¼š

```tsx
<Button
  onClick={() => {
    // æ‰“å¼€å¼¹çª—
    setSelectedQuestionIdList(selectedRowKeys as number[]);
    setBatchAddQuestionsToBankModalVisible(true);
  }}
  >
  æ‰¹é‡å‘é¢˜åº“æ·»åŠ é¢˜ç›®
</Button>
<Button
onClick={() => {
  // æ‰“å¼€å¼¹çª—
  setSelectedQuestionIdList(selectedRowKeys as number[]);
  setBatchRemoveQuestionsFromBankModalVisible(true);
}}
>
æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®
</Button>
```

3ï¼‰å¼•å…¥å¼¹çª—ç»„ä»¶ï¼Œå¹¶ä¸”ç»‘å®šäº‹ä»¶ï¼Œå¼¹çª—å†…çš„æ“ä½œæˆåŠŸæˆ–å–æ¶ˆæ—¶ï¼Œéƒ½éœ€è¦å…³é—­å¼¹çª—ï¼š

```tsx
<BatchAddQuestionsToBankModal
  visible={batchAddQuestionsToBankModalVisible}
  questionIdList={selectedQuestionIdList}
  onSubmit={() => {
    setBatchAddQuestionsToBankModalVisible(false);
  }}
  onCancel={() => {
    setBatchAddQuestionsToBankModalVisible(false);
  }}
/>
<BatchRemoveQuestionsFromBankModal
  visible={batchRemoveQuestionsFromBankModalVisible}
  questionIdList={selectedQuestionIdList}
  onSubmit={() => {
    setBatchRemoveQuestionsFromBankModalVisible(false);
  }}
  onCancel={() => {
    setBatchRemoveQuestionsFromBankModalVisible(false);
  }}
/>
```

#### 4ã€æ‰¹é‡åˆ é™¤é¢˜ç›®

å…ˆå®šä¹‰æ‰¹é‡åˆ é™¤å‡½æ•°ï¼š

```tsx
/**
 * æ‰¹é‡åˆ é™¤
 * @param questionIdList
 */
const handleBatchDelete = async (questionIdList: number[]) => {
  const hide = message.loading("æ­£åœ¨æ“ä½œ");
  try {
    await batchDeleteQuestionsUsingPost({
      questionIdList,
    });
    hide();
    message.success("æ“ä½œæˆåŠŸ");
    actionRef?.current?.reload();
  } catch (error: any) {
    hide();
    message.error("æ“ä½œå¤±è´¥ï¼Œ" + error.message);
  }
};
```

ç„¶åç»™æ‰¹é‡åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼š

```tsx
<Popconfirm
  title="ç¡®è®¤åˆ é™¤"
  description="ä½ ç¡®å®šè¦åˆ é™¤è¿™äº›é¢˜ç›®ä¹ˆï¼Ÿ"
  onConfirm={() => {
    // æ‰¹é‡åˆ é™¤é¢˜ç›®
    handleBatchDelete(selectedRowKeys as number[]);
  }}
  okText="Yes"
  cancelText="No"
>
  <Button danger>æ‰¹é‡åˆ é™¤é¢˜ç›®</Button>
</Popconfirm>
```

------

å‡ ä¸ªåŠŸèƒ½çš„å¼€å‘å°±å®Œæˆäº†ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/9mXuJDQ24JNX0OA2.webp)![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/56vN9KhOw3sRAZOy.webp)

### æµ‹è¯•éªŒè¯ï¼ˆå‘ç°é—®é¢˜ï¼‰

é€šè¿‡æµ‹è¯•ï¼Œå¯ä»¥å‘ç°ä¸€äº›æ˜æ˜¾çš„åŠŸèƒ½é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

1ï¼‰å·²æ·»åŠ åˆ°é¢˜åº“çš„é¢˜ç›®ï¼Œé‡å¤æ·»åŠ å°±ä¼šæŠ¥é”™

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/jkM3naA6JRc7HkOX.webp)

æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œå› ä¸ºé‡å¤æ·»åŠ äº†è®°å½•ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/eek9PvuUQcglv0MP.webp)

2ï¼‰æœªæ·»åŠ åˆ°é¢˜åº“çš„é¢˜ç›®ï¼Œè§£é™¤ç»‘å®šå…³ç³»å¤±è´¥å°±ä¼šæŠ¥é”™

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/MLfqkbemUCM7QIOd.webp)

å› ä¸ºä¸å­˜åœ¨é¢˜ç›®å…³è”ï¼ŒæŠ›å‡ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/rAgC4AkhzOZtKyhR.webp)

3ï¼‰åˆ é™¤é¢˜ç›®æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…³è”ï¼Œä¹Ÿä¼šæŠ¥é”™ã€‚å› ä¸ºä¸å­˜åœ¨é¢˜ç›®å…³è”ï¼ŒæŠ›å‡ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/4x0t8l7tuOqcLxb0.png)

æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸Šè¿°çš„ä»£ç è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- ç¨³å®šæ€§ä½ï¼Œæœ‰ä¸€é“é¢˜ç›®æŠ¥é”™ï¼Œå°±å…¨éƒ¨å‡ºé”™äº†
- æ€§èƒ½è¾ƒä½ï¼ŒåŒæ—¶æ“ä½œçš„é¢˜ç›®è¾ƒå¤šæ—¶ï¼Œæ‰§è¡Œæ—¶é—´ä¼šå¾ˆé•¿

ä¸‹é¢æˆ‘ä»¬ä»¥è¿™äº›åŠŸèƒ½ä¸ºä¾‹ï¼Œæ¥å­¦ä¹ ä¸€äº›é€šç”¨çš„ **æ‰¹å¤„ç†æ“ä½œ** çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚

## äºŒã€æ‰¹å¤„ç†æ“ä½œä¼˜åŒ–

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å¤šä¸ªè§’åº¦å¯¹æ‰¹å¤„ç†ä»»åŠ¡è¿›è¡Œä¼˜åŒ–ã€‚

- å¥å£®æ€§
- ç¨³å®šæ€§
- æ€§èƒ½
- æ•°æ®ä¸€è‡´æ€§
- å¯è§‚æµ‹æ€§

### å¥å£®æ€§

å¥å£®æ€§æ˜¯æŒ‡ç³»ç»Ÿåœ¨é¢å¯¹ **å¼‚å¸¸æƒ…å†µæˆ–ä¸åˆæ³•è¾“å…¥** æ—¶ä»èƒ½è¡¨ç°å‡ºåˆç†çš„è¡Œä¸ºã€‚ä¸€ä¸ªå¥å£®çš„ç³»ç»Ÿèƒ½å¤Ÿ **é¢„è§å’Œå¤„ç†å¼‚å¸¸**ï¼Œå¹¶ä¸”å³ä½¿å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿä¸ä¼šå´©æºƒæˆ–äº§ç”Ÿä¸å¯é¢„æœŸçš„è¡Œä¸ºã€‚

#### 1ã€å‚æ•°æ ¡éªŒæå‰

å¯ä»¥åœ¨è°ƒç”¨æ•°æ®åº“ä¹‹å‰å°±å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œå¼€é”€ï¼Œä¸ç”¨ç­‰åˆ°æ•°æ®åº“æ“ä½œæ—¶å†æŠ›å‡ºå¼‚å¸¸ã€‚

åœ¨ç°æœ‰çš„æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»æå‰å¯¹å‚æ•°è¿›è¡Œäº†éç©ºæ ¡éªŒï¼Œå¹¶ä¸”ä¼šæå‰æ£€æŸ¥é¢˜ç›®å’Œé¢˜åº“æ˜¯å¦å­˜åœ¨ï¼Œè¿™æ˜¯å¾ˆå¥½çš„ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰æ ¡éªŒå“ªäº›é¢˜ç›®å·²ç»æ·»åŠ åˆ°é¢˜åº“ä¸­ï¼Œå¯¹äºè¿™äº›é¢˜ç›®ï¼Œä¸å¿…å†æ‰§è¡Œæ’å…¥å…³è”è®°å½•çš„æ•°æ®åº“æ“ä½œã€‚

éœ€è¦è¡¥å……çš„ä»£ç å¦‚ä¸‹ï¼š

```java
// æ£€æŸ¥é¢˜åº“ id æ˜¯å¦å­˜åœ¨
// ...

// æ£€æŸ¥å“ªäº›é¢˜ç›®è¿˜ä¸å­˜åœ¨äºé¢˜åº“ä¸­ï¼Œé¿å…é‡å¤æ’å…¥
LambdaQueryWrapper<QuestionBankQuestion> lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)
        .eq(QuestionBankQuestion::getQuestionBankId, questionBankId)
        .in(QuestionBankQuestion::getQuestionId, validQuestionIdList);
List<QuestionBankQuestion> existQuestionList = this.list(lambdaQueryWrapper);
// å·²å­˜åœ¨äºé¢˜åº“ä¸­çš„é¢˜ç›® id
Set<Long> existQuestionIdSet = existQuestionList.stream()
        .map(QuestionBankQuestion::getId)
        .collect(Collectors.toSet());
// å·²å­˜åœ¨äºé¢˜åº“ä¸­çš„é¢˜ç›® idï¼Œä¸éœ€è¦å†æ¬¡æ·»åŠ 
validQuestionIdList = validQuestionIdList.stream().filter(questionId -> {
    return !existQuestionIdSet.contains(questionId);
}).collect(Collectors.toList());
ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, "æ‰€æœ‰é¢˜ç›®éƒ½å·²å­˜åœ¨äºé¢˜åº“ä¸­");

// æ‰§è¡Œæ’å…¥
// ...
```

#### 2ã€å¼‚å¸¸å¤„ç†

ç›®å‰è™½ç„¶å·²ç»å¯¹æ¯ä¸€æ¬¡æ’å…¥æ“ä½œçš„ç»“æœéƒ½è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¹¶ä¸”æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œä½†æ˜¯æœ‰äº›ç‰¹æ®Šçš„å¼‚å¸¸å¹¶æ²¡æœ‰è¢«æ•è·ã€‚

å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼Œè€ƒè™‘æ›´ç»†ç²’åº¦çš„å¼‚å¸¸åˆ†ç±»ï¼Œä¸åŒçš„å¼‚å¸¸ç±»å‹å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼å¤„ç†ï¼Œä¾‹å¦‚ï¼š

- æ•°æ®å”¯ä¸€é”®é‡å¤æ’å…¥é—®é¢˜ï¼Œä¼šæŠ›å‡º `DataIntegrityViolationException`ã€‚
- æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥æ—¶æŠ›å‡º `DataAccessException`ã€‚
- å…¶ä»–çš„å¼‚å¸¸å¯ä»¥é€šè¿‡æ—¥å¿—è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºåæœŸè¿½è¸ªï¼ˆå…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¹Ÿæœ‰è¿™ä¸ªèƒ½åŠ›ï¼‰ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
try {
    boolean result = this.save(questionBankQuestion);
    if (!result) {
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
    }
} catch (DataIntegrityViolationException e) {
    log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
            questionId, questionBankId, e.getMessage());
    throw new BusinessException(ErrorCode.OPERATION_ERROR, "é¢˜ç›®å·²å­˜åœ¨äºè¯¥é¢˜åº“ï¼Œæ— æ³•é‡å¤æ·»åŠ ");
} catch (DataAccessException e) {
    log.error("æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥ï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
            questionId, questionBankId, e.getMessage());
    throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ•°æ®åº“æ“ä½œå¤±è´¥");
} catch (Exception e) {
    // æ•è·å…¶ä»–å¼‚å¸¸ï¼Œåšé€šç”¨å¤„ç†
    log.error("æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
            questionId, questionBankId, e.getMessage());
    throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
}
```

### ç¨³å®šæ€§

#### 1ã€é¿å…é•¿äº‹åŠ¡é—®é¢˜

æ‰¹é‡æ“ä½œä¸­ï¼Œä¸€æ¬¡æ€§å¤„ç†è¿‡å¤šæ•°æ®ä¼šå¯¼è‡´äº‹åŠ¡è¿‡é•¿ï¼Œå½±å“æ•°æ®åº“æ€§èƒ½ã€‚å¯ä»¥é€šè¿‡ åˆ†æ‰¹å¤„ç† æ¥é¿å…é•¿äº‹åŠ¡é—®é¢˜ï¼Œç¡®ä¿éƒ¨åˆ†æ•°æ®å¼‚å¸¸ä¸ä¼šå½±å“æ•´ä¸ªæ‰¹æ¬¡çš„æ•°æ®ä¿å­˜ã€‚

å‡è®¾æ“ä½œ 10w æ¡æ•°æ®ï¼Œå…¶ä¸­æœ‰ 1 æ¡æ•°æ®æ“ä½œå¼‚å¸¸ï¼Œå¦‚æœæ˜¯é•¿äº‹åŠ¡ï¼Œé‚£ä¹ˆä¿®æ”¹çš„ 10w æ¡æ•°æ®éƒ½éœ€è¦å›æ»šï¼Œè€Œåˆ†æ‰¹äº‹åŠ¡ä»…éœ€å›æ»šä¸€æ‰¹æ—¢å¯ï¼Œé™ä½é•¿äº‹åŠ¡å¸¦æ¥çš„èµ„æºæ¶ˆè€—ï¼ŒåŒæ—¶ä¹Ÿæå‡äº†ç¨³å®šæ€§ã€‚

ç¼–å†™ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œç”¨äºå¯¹æŸä¸€æ‰¹æ“ä½œè¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void batchAddQuestionsToBankInner(List<QuestionBankQuestion> questionBankQuestions) {
    for (QuestionBankQuestion questionBankQuestion : questionBankQuestions) {
        long questionId = questionBankQuestion.getQuestionId();
        long questionBankId = questionBankQuestion.getQuestionBankId();
        try {
            boolean result = this.save(questionBankQuestion);
            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        } catch (DataIntegrityViolationException e) {
            log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
                    questionId, questionBankId, e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "é¢˜ç›®å·²å­˜åœ¨äºè¯¥é¢˜åº“ï¼Œæ— æ³•é‡å¤æ·»åŠ ");
        } catch (DataAccessException e) {
            log.error("æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥ï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
                    questionId, questionBankId, e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ•°æ®åº“æ“ä½œå¤±è´¥");
        } catch (Exception e) {
            // æ•è·å…¶ä»–å¼‚å¸¸ï¼Œåšé€šç”¨å¤„ç†
            log.error("æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œé¢˜ç›® id: {}, é¢˜åº“ id: {}, é”™è¯¯ä¿¡æ¯: {}",
                    questionId, questionBankId, e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        }
    }
}
```

åœ¨åŸæ–¹æ³•ä¸­æ‰¹é‡ç”Ÿæˆé¢˜ç›®ï¼Œå¹¶ä¸”è°ƒç”¨ä¸Šè¿°äº‹åŠ¡æ–¹æ³•ï¼š

```java
// åˆ†æ‰¹å¤„ç†é¿å…é•¿äº‹åŠ¡ï¼Œå‡è®¾æ¯æ¬¡å¤„ç† 1000 æ¡æ•°æ®
int batchSize = 1000;
int totalQuestionListSize = validQuestionIdList.size();
for (int i = 0; i < totalQuestionListSize; i += batchSize) {
    // ç”Ÿæˆæ¯æ‰¹æ¬¡çš„æ•°æ®
    List<Long> subList = validQuestionIdList.subList(i, Math.min(i + batchSize, totalQuestionListSize));
    List<QuestionBankQuestion> questionBankQuestions = subList.stream().map(questionId -> {
        QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
        questionBankQuestion.setQuestionBankId(questionBankId);
        questionBankQuestion.setQuestionId(questionId);
        questionBankQuestion.setUserId(loginUser.getId());
        return questionBankQuestion;
    }).collect(Collectors.toList());
    // ä½¿ç”¨äº‹åŠ¡å¤„ç†æ¯æ‰¹æ•°æ®
    QuestionBankQuestionService questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();
    questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `AopContext.currentProxy()` æ–¹æ³•è·å–åˆ°äº†å½“å‰å®ç°ç±»çš„ä»£ç†å¯¹è±¡ï¼Œæ¥è°ƒç”¨äº‹åŠ¡æ–¹æ³•ã€‚

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ å› ä¸º **Spring äº‹åŠ¡ä¾èµ–äºä»£ç†æœºåˆ¶**ï¼Œè€Œå†…éƒ¨è°ƒç”¨é€šè¿‡ `this` ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œä¸ä¼šé€šè¿‡ Spring çš„ä»£ç†ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡ã€‚

æ³¨æ„ï¼Œä½¿ç”¨ `AopContext.currentProxy()` æ–¹æ³•æ—¶å¿…é¡»è¦åœ¨å¯åŠ¨ç±»æ·»åŠ ä¸‹é¢çš„æ³¨è§£å¼€å¯åˆ‡é¢è‡ªåŠ¨ä»£ç†ï¼š

```java
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
```

#### 2ã€é‡è¯•

å¯¹äºå¯èƒ½ç”±äºç½‘ç»œä¸ç¨³å®šç­‰ä¸´æ—¶åŸå› å¶å‘å¤±è´¥çš„æ“ä½œï¼Œå¯ä»¥è®¾è®¡ **é‡è¯•æœºåˆ¶** æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œé€‚ç”¨äºæ‰§è¡Œæ—¶é—´å¾ˆé•¿çš„ä»»åŠ¡ã€‚

æ³¨æ„ï¼Œé‡è¯•çš„è¿‡ç¨‹ä¸­è¦è®°å½•æ—¥å¿—ï¼Œ**å¹¶ä¸”é‡è¯•æ¬¡æ•°è¦æœ‰ä¸€ä¸ªä¸Šé™** ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
int retryCount = 3;
for (int i = 0; i < retryCount; i++) {
    try {
        // æ‰§è¡Œæ’å…¥æ“ä½œ
        // æˆåŠŸåˆ™è·³å‡ºé‡è¯•å¾ªç¯
        break; 
    } catch (Exception e) {
        log.warn("æ’å…¥å¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°: {}", i + 1);
        if (i == retryCount - 1) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å¤šæ¬¡é‡è¯•åæ“ä½œä»ç„¶å¤±è´¥");
        }
    }
}
```

ğŸ’¡å½“ç„¶ï¼Œé™¤äº†æ‰‹åŠ¨ç¼–å†™é‡è¯•ä»£ç å¤–ï¼Œæˆ‘ä¼šæ›´æ¨è Guava Retrying åº“ï¼Œå¯ä»¥çœ‹ [é±¼çš®çš„è¿™ç¯‡æ–‡ç« ](https://cloud.tencent.com/developer/article/1752086) å­¦ä¹ ã€‚

ä½†å¯¹äºæˆ‘ä»¬ç›®å‰çš„é¢˜ç›®ç®¡ç†åŠŸèƒ½ï¼Œæ‰§è¡Œæ—¶é—´ä¸ä¼šç‰¹åˆ«é•¿ï¼Œå¢åŠ é‡è¯•åè€Œä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„ä¸ç¡®å®šæ€§å’Œå¤æ‚åº¦ï¼Œå¯ä»¥ä¸ç”¨æ·»åŠ ã€‚

#### 3ã€ä¸­æ–­æ¢å¤

å¦‚æœåœ¨æ‰¹é‡æ’å…¥è¿‡ç¨‹ä¸­ç”±äºæŸç§åŸå› ï¼ˆå¦‚æ•°æ®åº“å®•æœºã€æœåŠ¡å™¨é‡å¯ï¼‰å¯¼è‡´æ‰¹å¤„ç†ä¸­æ–­ï¼Œå»ºè®®è®¾è®¡ä¸€ç§æœºåˆ¶æ¥è¿›è¡Œ **å¢é‡æ¢å¤**ã€‚æ¯”å¦‚å¯ä»¥ä¸ºæ¯æ¬¡æ“ä½œæ‰“ä¸Šæ‰¹æ¬¡æ ‡è®°ï¼Œåœ¨æ“ä½œæœªå®Œæˆæ—¶è®°å½•æ“ä½œçŠ¶æ€ï¼ˆå¦‚éƒ¨åˆ†é¢˜ç›®æˆåŠŸæ·»åŠ ï¼‰ï¼Œå¹¶åœ¨æ¢å¤æ—¶ç»§ç»­æ‰§è¡Œæœªå®Œæˆçš„æ“ä½œã€‚

å¯ä»¥è®¾è®¡ä¸€ä¸ªæ•°æ®åº“è¡¨å­˜å‚¨æ‰¹æ¬¡çš„çŠ¶æ€ï¼š

```sql
create table question_batch_status (
  batch_id bigint primary key,
  question_bank_id bigint,
  total_questions int,
  processed_questions int,
  status varchar(20) -- running, completed, failed
);
```

é€šè¿‡è¯¥è¡¨å¯ä»¥è·Ÿè¸ªæ¯æ¬¡æ‰¹å¤„ç†çš„è¿›åº¦ï¼Œå¹¶åœ¨å¤±è´¥æ—¶æ ¹æ®æ‰¹æ¬¡ç»§ç»­å¤„ç†ã€‚

ä½†å¯¹äºæˆ‘ä»¬çš„é¢˜ç›®ç®¡ç†åŠŸèƒ½ï¼Œä¸ç”¨é‚£ä¹ˆå¤æ‚ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡åˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»æ»¡è¶³è¦æ±‚æ¥å¯¹è¦æ–°å¤„ç†çš„æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚æ¯”å¦‚æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“å‰ï¼Œå…ˆæŸ¥ä¸€ä¸‹æ˜¯å¦å·²ç»æ·»åŠ åˆ°é¢˜åº“é‡Œäº†ï¼Œå¦‚æœå·²æ·»åŠ å°±ä¸ç”¨é‡å¤æ·»åŠ äº†ã€‚ï¼ˆå‰é¢ `å‚æ•°æ ¡éªŒæå‰` å°±å·²ç»å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼‰

### æ€§èƒ½ä¼˜åŒ–

#### 1ã€æ‰¹é‡æ“ä½œ

å½“å‰ä»£ç ä¸­ï¼Œæ¯ä¸ªé¢˜ç›®æ˜¯å•ç‹¬æ’å…¥æ•°æ®åº“çš„ï¼Œè¿™ä¼šäº§ç”Ÿé¢‘ç¹çš„æ•°æ®åº“äº¤äº’ã€‚

å¤§å¤šæ•° ORM æ¡†æ¶å’Œæ•°æ®åº“é©±åŠ¨éƒ½æ”¯æŒæ‰¹é‡æ’å…¥ï¼Œå¯ä»¥é€šè¿‡æ‰¹é‡æ’å…¥æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œæ¯”å¦‚ MyBatis Plus æä¾›äº† saveBatch æ–¹æ³•ã€‚

ä¼˜åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void batchAddQuestionsToBankInner(List<QuestionBankQuestion> questionBankQuestions) {
    try {
        boolean result = this.saveBatch(questionBankQuestions);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
    } catch (DataIntegrityViolationException e) {
        log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸ, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "é¢˜ç›®å·²å­˜åœ¨äºè¯¥é¢˜åº“ï¼Œæ— æ³•é‡å¤æ·»åŠ ");
    } catch (DataAccessException e) {
        log.error("æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ•°æ®åº“æ“ä½œå¤±è´¥");
    } catch (Exception e) {
        // æ•è·å…¶ä»–å¼‚å¸¸ï¼Œåšé€šç”¨å¤„ç†
        log.error("æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯: {}", e.getMessage());
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
    }
}
```

æ‰¹é‡æ“ä½œçš„å¥½å¤„ï¼š

- é™ä½äº†æ•°æ®åº“è¿æ¥å’Œæäº¤çš„é¢‘ç‡ã€‚
- é¿å…é¢‘ç¹çš„æ•°æ®åº“äº¤äº’ï¼Œå‡å°‘ I/O æ“ä½œï¼Œæ˜¾è‘—æé«˜æ€§èƒ½ã€‚

ğŸ’¡ç±»ä¼¼çš„ï¼ŒRedis ä¹Ÿæä¾›äº†æ‰¹å¤„ç†æ–¹æ³•ï¼Œæ¯”å¦‚ Pipelineã€‚

#### 2ã€SQL ä¼˜åŒ–

æˆ‘ä»¬åœ¨æ“ä½œæ•°æ®åº“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº› SQL ä¼˜åŒ–çš„æŠ€å·§ã€‚

å¦‚ä½•ä¼˜åŒ– SQLï¼Ÿè¿™ä¹Ÿæ˜¯ä¸€é“ç»å…¸çš„é¢è¯•é¢˜ï¼Œå¯ä»¥ [çœ‹æ–‡ç« ](https://www.mianshiya.com/question/1780933295521951745) äº†è§£ã€‚

å…¶ä¸­ï¼Œæœ‰ä¸€ä¸ªæœ€åŸºæœ¬çš„ SQL ä¼˜åŒ–åŸåˆ™ï¼Œä¸è¦ä½¿ç”¨ `select *` æ¥æŸ¥è¯¢æ•°æ®ï¼ŒåªæŸ¥å‡ºéœ€è¦çš„å­—æ®µå³å¯ã€‚ç”±äºæ¡†æ¶å°è£…åœ°å¤ªå¥½äº†ï¼Œå¯èƒ½å¤§å¤šæ•°åŒå­¦éƒ½ä¸ä¼šæ³¨æ„è¿™ç‚¹ï¼Œå…¶å®æˆ‘ä»¬ä¸Šè¿°çš„ä»£ç å°±éœ€è¦å¯¹æ­¤è¿›è¡Œä¼˜åŒ–ï¼Œæ¥å‡å°‘æŸ¥è¯¢çš„æ•°æ®é‡ã€‚

æ¯”å¦‚ï¼š

```java
// æ£€æŸ¥é¢˜ç›® id æ˜¯å¦å­˜åœ¨
LambdaQueryWrapper<Question> questionLambdaQueryWrapper = Wrappers.lambdaQuery(Question.class)
        .select(Question::getId)
        .in(Question::getId, questionIdList);
List<Question> questionList = questionService.list(questionLambdaQueryWrapper);
```

ç”±äºè¿”å›çš„å€¼åªæœ‰ id ä¸€åˆ—ï¼Œè¿˜å¯ä»¥ç›´æ¥è½¬ä¸º Long åˆ—è¡¨ï¼Œä¸éœ€è¦è®©æ¡†æ¶å°è£…ç»“æœä¸º Question å¯¹è±¡äº†ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼š

```java
// åˆæ³•çš„é¢˜ç›® id
List<Long> validQuestionIdList = questionService.listObjs(questionLambdaQueryWrapper, obj -> (Long) obj);
ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, "åˆæ³•çš„é¢˜ç›®åˆ—è¡¨ä¸ºç©º");
```

#### 3ã€å¹¶å‘ç¼–ç¨‹

ç”±äºæˆ‘ä»¬å·²ç»å°†æ“ä½œåˆ†æ‰¹å¤„ç†ï¼Œåœ¨æ“ä½œè¾ƒå¤šã€è¿½æ±‚å¤„ç†æ—¶é—´çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡å¹¶å‘ç¼–ç¨‹è®©æ¯æ‰¹æ“ä½œåŒæ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸€æ‰¹å¤„ç†å®Œå†æ‰§è¡Œä¸‹ä¸€æ‰¹ï¼Œèƒ½å¤Ÿå¤§å¹…æå‡æ€§èƒ½ã€‚

Java ä¸­ï¼Œå¯ä»¥åˆ©ç”¨å¹¶å‘åŒ…ä¸­çš„ **CompletableFuture + çº¿ç¨‹æ± ** æ¥å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚

CompletableFuture æ˜¯ Java 8 ä¸­å¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œç”¨äºè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚å®ƒæ˜¯ Future çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¸ä»…å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥è®¡ç®—ï¼Œè¿˜å¯ä»¥å¯¹å¼‚æ­¥è®¡ç®—çš„ç»“æœè¿›è¡Œç»„åˆã€è½¬æ¢å’Œå¤„ç†ï¼Œ**å®ç°å¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’**ã€‚

æ¯”å¦‚ä¸‹åˆ—ä»£ç ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œå¹¶å‘æ‰§è¡Œï¼Œæœ€åé€šè¿‡ `CompletableFuture.allOf` æ–¹æ³•é˜»å¡ç­‰å¾…ï¼Œåªæœ‰æ‰€æœ‰çš„å­ä»»åŠ¡éƒ½å®Œæˆï¼Œæ‰ä¼šæ‰§è¡Œåç»­ä»£ç ï¼š

```java
List<CompletableFuture<Void>> futures = new ArrayList<>();

for (List<Long> subList : splitList(validQuestionIdList, 1000)) {
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        processBatch(subList, questionBankId, loginUser);
    });
    futures.add(future);
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
```

CompletableFuture é»˜è®¤ä½¿ç”¨ Java 7 å¼•å…¥çš„ ForkJoinPool çº¿ç¨‹æ± æ¥å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚è¯¥çº¿ç¨‹æ± ç‰¹åˆ«é€‚åˆéœ€è¦åˆ†æ²»æ³•æ¥å¤„ç†çš„å¤§é‡å¹¶å‘ä»»åŠ¡ï¼Œæ”¯æŒé€’å½’ä»»åŠ¡æ‹†åˆ†ã€‚Java 8 ä¸­çš„å¹¶è¡Œæµé»˜è®¤ä¹Ÿæ˜¯ä½¿ç”¨äº† ForkJoinPool è¿›è¡Œå¹¶å‘å¤„ç†

ForkJoinPool çš„ä¸»è¦ç‰¹æ€§ï¼š

- å·¥ä½œçªƒå–ç®—æ³•ï¼ˆWork-Stealingï¼‰ï¼šçº¿ç¨‹å¯ä»¥ä»å…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ä¸­â€œçªƒå–â€ä»»åŠ¡ï¼Œä»¥æé«˜ CPU çš„ä½¿ç”¨ç‡å’Œç¨‹åºçš„å¹¶è¡Œæ€§ã€‚
- é€’å½’ä»»åŠ¡å¤„ç†ï¼šæ”¯æŒå°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œç„¶åå†å°†ç»“æœåˆå¹¶ã€‚

ğŸ’¡ ä½†æ˜¯è¦æ³¨æ„ï¼ŒCompletableFuture é»˜è®¤ä½¿ç”¨çš„æ˜¯ `ForkJoinPool.commonPool()` æ–¹æ³•å¾—åˆ°çš„çº¿ç¨‹æ± ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å…±äº«çš„çº¿ç¨‹æ± ï¼Œå¦‚æœæœ‰å¤šç§ä¸åŒçš„ä»»åŠ¡éƒ½ä¾èµ–è¯¥çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºäº‰æŠ¢ã€ä»£ç é˜»å¡ç­‰ä¸ç¡®å®šçš„é—®é¢˜ã€‚**æ‰€ä»¥å»ºè®®é’ˆå¯¹æ¯ç§ä»»åŠ¡ï¼Œè‡ªå®šä¹‰çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œå®ç°çº¿ç¨‹æ± èµ„æºçš„éš”ç¦»ã€‚**

Java å†…ç½®äº†å¾ˆå¤šç§ä¸åŒçš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚å•çº¿ç¨‹çš„çº¿ç¨‹æ± ã€å›ºå®šçº¿ç¨‹çš„çº¿ç¨‹æ± ã€è‡ªå®šä¹‰çº¿ç¨‹æ± ç­‰ç­‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæ ¹æ®ä¸šåŠ¡å’Œèµ„æºæƒ…å†µ **è‡ªå®šä¹‰çº¿ç¨‹æ± **ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```java
// è‡ªå®šä¹‰çº¿ç¨‹æ± 
ThreadPoolExecutor customExecutor = new ThreadPoolExecutor(
        4,                         // æ ¸å¿ƒçº¿ç¨‹æ•°
        10,                        // æœ€å¤§çº¿ç¨‹æ•°
        60L,                       // çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´
        TimeUnit.SECONDS,           // å­˜æ´»æ—¶é—´å•ä½
        new LinkedBlockingQueue<>(1000),  // é˜»å¡é˜Ÿåˆ—å®¹é‡
        new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡
);
```

è‡ªå®šä¹‰çº¿ç¨‹æ± é‡Œæœ‰é‚£ä¹ˆå¤šå‚æ•°ï¼Œåº”è¯¥å¦‚ä½•è®¾ç½®å‘¢ï¼Ÿ

è¿™ä¹Ÿæ˜¯ä¸€é“ç»å…¸çš„é¢è¯•é¢˜ï¼Œå¯ä»¥çœ‹ [è¿™ç¯‡æ–‡ç« ](https://www.mianshiya.com/question/1771004113190924290) å­¦ä¹ ã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/6Vv5OUh5JO9WVJox.webp)

æ­¤å¤„ç”»ä¸ªé‡ç‚¹ï¼Œå¤§å®¶åªè¦è®°ä½ä¸€ä¸ªå…¬å¼ï¼š

1. å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¶ˆè€— CPU èµ„æºï¼‰ï¼Œ è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º `n+1` æˆ–è€… `n`ï¼ˆn æ˜¯ CPU æ ¸å¿ƒæ•°ï¼‰ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨ CPUï¼Œ å¤šä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†å¯ä»¥åœ¨æŸäº›çº¿ç¨‹çŸ­æš‚é˜»å¡æˆ–æ‰§è¡Œè°ƒåº¦æ—¶ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„çº¿ç¨‹ä¿æŒ CPU ç¹å¿™ï¼Œæœ€å¤§åŒ– CPU çš„åˆ©ç”¨ç‡ã€‚
2. å¯¹äº IO å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¶ˆè€— IO èµ„æºï¼‰ï¼Œå¯ä»¥å¢å¤§æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º CPU æ ¸å¿ƒæ•°çš„ 2 - 4 å€ï¼Œå¯ä»¥æå‡å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„æ•°é‡ã€‚

å¯¹äºæ‰¹é‡æ·»åŠ é¢˜ç›®åŠŸèƒ½ï¼Œå’Œæ•°æ®åº“äº¤äº’é¢‘ç¹ï¼Œå±äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥ç»™è‡ªå®šä¹‰çº¿ç¨‹æ± æ›´å¤§çš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å¼•å…¥å¹¶å‘ç¼–ç¨‹åçš„ä»£ç ï¼š

```java
// è‡ªå®šä¹‰çº¿ç¨‹æ± 
ThreadPoolExecutor customExecutor = new ThreadPoolExecutor(
        20,                         // æ ¸å¿ƒçº¿ç¨‹æ•°
        50,                        // æœ€å¤§çº¿ç¨‹æ•°
        60L,                       // çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´
        TimeUnit.SECONDS,           // å­˜æ´»æ—¶é—´å•ä½
        new LinkedBlockingQueue<>(10000),  // é˜»å¡é˜Ÿåˆ—å®¹é‡
        new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡
);

// ç”¨äºä¿å­˜æ‰€æœ‰æ‰¹æ¬¡çš„ CompletableFuture
List<CompletableFuture<Void>> futures = new ArrayList<>();

// åˆ†æ‰¹å¤„ç†é¿å…é•¿äº‹åŠ¡ï¼Œå‡è®¾æ¯æ¬¡å¤„ç† 1000 æ¡æ•°æ®
int batchSize = 1000;
int totalQuestionListSize = validQuestionIdList.size();
for (int i = 0; i < totalQuestionListSize; i += batchSize) {
    // ç”Ÿæˆæ¯æ‰¹æ¬¡çš„æ•°æ®
    List<Long> subList = validQuestionIdList.subList(i, Math.min(i + batchSize, totalQuestionListSize));
    List<QuestionBankQuestion> questionBankQuestions = subList.stream().map(questionId -> {
        QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
        questionBankQuestion.setQuestionBankId(questionBankId);
        questionBankQuestion.setQuestionId(questionId);
        questionBankQuestion.setUserId(loginUser.getId());
        return questionBankQuestion;
    }).collect(Collectors.toList());

    QuestionBankQuestionService questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();
    // å¼‚æ­¥å¤„ç†æ¯æ‰¹æ•°æ®å¹¶æ·»åŠ åˆ° futures åˆ—è¡¨
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
    }, customExecutor);
    futures.add(future);
}

// ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡æ“ä½œå®Œæˆ
CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();

// å…³é—­çº¿ç¨‹æ± 
customExecutor.shutdown();
```

æ³¨æ„ï¼Œè™½ç„¶å¹¶å‘ç¼–ç¨‹èƒ½å¤Ÿæå‡æ€§èƒ½ï¼Œä½†ä¹Ÿä¼šå ç”¨æ›´å¤šçš„èµ„æºï¼Œå¹¶ä¸”ç»™ç³»ç»Ÿå¼•å…¥æ›´å¤šçš„ä¸ç¡®å®šæ€§ã€‚æ¯”å¦‚æŸä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œå…¶ä»–ä»»åŠ¡å¯èƒ½æ­£åœ¨æ‰§è¡Œï¼Œäº§ç”Ÿä¸ç¡®å®šçš„å½±å“ã€‚å¯¹æ­¤ï¼Œå¯ä»¥æ ¹æ®æƒ…å†µç»™å¼‚æ­¥ä»»åŠ¡è¡¥å……å¼‚å¸¸å¤„ç†è¡Œä¸ºï¼Œé€šè¿‡ `exceptionally` æ–¹æ³•å°±èƒ½å®ç°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
    questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
}, customExecutor).exceptionally(ex -> {
    log.error("æ‰¹å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", ex);
    return null;
});
```

#### 4ã€å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–

å°†æ‰¹é‡æ“ä½œçš„å¤„ç†å˜æˆæäº¤ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œæäº¤åå°ä»»åŠ¡åï¼Œæ¥å£å¯ä»¥ç›´æ¥ç»™å‰ç«¯è¿”å›å·²æäº¤çš„ä»»åŠ¡ idã€‚åå°å¯ä»¥æ ¹æ®æƒ…å†µé€‰æ‹©æ—¶æœºå»æ‰§è¡Œä¹‹å‰æäº¤çš„åå°ä»»åŠ¡ï¼ˆæ¯”å¦‚é€šè¿‡å®šæ—¶ä»»åŠ¡æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚

ä¸šåŠ¡æµç¨‹å¯¹åº”çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@PostMapping("/start")
public String startTask() {
    // ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ id
    String taskId = UUID.randomUUID().toString();
    
    // å¼‚æ­¥æäº¤æˆ–æ‰§è¡Œä»»åŠ¡
    executeLongRunningTask(taskId);
    
    // è¿”å›ä»»åŠ¡ id
    return taskId;
}
```

å‰ç«¯å¯ä»¥é€šè¿‡è½®è¯¢è°ƒç”¨æ¥å£ã€WebSocketã€SSE ç­‰æ–¹å¼å¾—çŸ¥ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦ã€‚æ¯”å¦‚åç«¯æä¾›ä¸€ä¸ªæ ¹æ®ä»»åŠ¡ id æŸ¥è¯¢çŠ¶æ€çš„æ¥å£ï¼š

```java
// æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
public TaskStatus queryTaskStatus(String taskId) {
    return taskService.getTaskStatus(taskId);
}
```

æ³¨æ„ï¼Œè¿™ç§æ–¹æ¡ˆç›¸å½“äºæ”¹é€ äº†ä¸šåŠ¡æµç¨‹ï¼Œæˆæœ¬è¾ƒå¤§ï¼Œé€‚åˆéœ€è¦è¾ƒé•¿æ‰§è¡Œæ—¶é—´ã€æˆ–è€…éœ€è¦å¯¹ä»»åŠ¡çŠ¶æ€è¿›è¡Œè®°å½•å¤ç›˜çš„åœºæ™¯ã€‚

**æ€ä¹ˆå®ç°å¼‚æ­¥ä»»åŠ¡å‘¢ï¼Ÿ**

1ï¼‰ç«‹å³æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡

å¯ä»¥ç›´æ¥ç»™è¦å¼‚æ­¥æ‰§è¡Œçš„æ–¹æ³•åŠ ä¸Š Spring æä¾›çš„ `@Async` æ³¨è§£ï¼Œæˆ–è€…æ‰‹åŠ¨ä½¿ç”¨ `CompletableFuture` æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚

```java
@Async
@Override
@Transactional(rollbackFor = Exception.class)
public void batchAddQuestionsToBankInner(List<QuestionBankQuestion> questionBankQuestions) {
    // ...
}
```

2ï¼‰å®šæ—¶æ‰§è¡Œ

å¯ä»¥å°†ä»»åŠ¡ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ Spring Scheduler å®šæ—¶ä»»åŠ¡æŒç»­æ‰«ææ•°æ®åº“ä¸­ **æœªæ‰§è¡Œçš„ä»»åŠ¡** æ¥æ‰§è¡Œã€‚

3ï¼‰é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œä»»åŠ¡åˆ†å‘

å¯¹äºé•¿æ—¶é—´çš„æ‰¹é‡ä»»åŠ¡ï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ **æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆå¦‚ RabbitMQã€Kafkaï¼‰æ¥å¼‚æ­¥å¤„ç†ä»»åŠ¡ã€‚å°†ä»»åŠ¡æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±æ¶ˆè´¹è€…ï¼ˆåå°æœåŠ¡ï¼‰å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚

ç¤ºä¾‹ä»»åŠ¡æäº¤ä»£ç ï¼š

```java
@PostMapping("/start")
public String startTask() {
    // ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ id
    String taskId = UUID.randomUUID().toString();
    
    // å°†ä»»åŠ¡å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    messageQueueService.sendMessage(new TaskMessage(taskId));

    // è¿”å›ä»»åŠ¡ id
    return taskId;
}
```

åå°æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åå¤„ç†ä»»åŠ¡ï¼š

```java
@RabbitListener(queues = "batch-task-queue")
public void processBatchTask(TaskMessage taskMessage) {
    Long taskId = taskMessage.getTaskId();

    // æŸ¥è¯¢æ•°æ®åº“ï¼Œæ ¹æ® taskId è·å–ä»»åŠ¡ä¿¡æ¯
    Task task = getById(taskId);

    // æ‰§è¡Œä»»åŠ¡
    doSomething(task);

    // æ‰§è¡Œå®Œæˆåï¼Œè®°å¾—æ›´æ–°ä»»åŠ¡çš„çŠ¶æ€
}
```

ğŸ’¡[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½ BI é¡¹ç›®](https://www.code-nav.cn/course/1790980531403927553) ä¸­ï¼Œå°±æ˜¯é€šè¿‡ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—å®ç°äº†å¼‚æ­¥ä»»åŠ¡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å­¦ä¹ ã€‚

#### **5ã€æ•°æ®åº“è¿æ¥æ± è°ƒä¼˜**

æ•°æ®åº“è¿æ¥æ± æ˜¯ç”¨äºç®¡ç†ä¸æ•°æ®åº“ä¹‹é—´è¿æ¥çš„èµ„æºæ± ï¼Œå®ƒèƒ½å¤Ÿ **å¤ç”¨** ç°æœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶éƒ½æ–°å»ºå’Œé”€æ¯è¿æ¥ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚

å¸¸è§çš„æ•°æ®åº“è¿æ¥æ± æœ‰ 2 ç§ï¼š

1ï¼‰HikariCPï¼šè¢«è®¤ä¸ºæ˜¯å¸‚åœºä¸Šæœ€å¿«çš„æ•°æ®åº“è¿æ¥æ± ä¹‹ä¸€ï¼Œå…·æœ‰éå¸¸ä½çš„å»¶è¿Ÿå’Œé«˜æ•ˆçš„æ€§èƒ½ã€‚å®ƒä»¥å…¶è½»é‡çº§å’Œç®€æ´çš„è®¾è®¡é—»åï¼Œå ç”¨è¾ƒå°‘çš„å†…å­˜å’Œ CPU èµ„æºã€‚

Spring Boot 2.x ç‰ˆæœ¬åŠä»¥ä¸Šé»˜è®¤ä½¿ç”¨ HikariCP ä½œä¸ºæ•°æ®åº“è¿æ¥æ± ã€‚

2ï¼‰[Druid](https://github.com/alibaba/druid)ï¼šç”±é˜¿é‡Œå·´å·´å¼€å‘çš„å¼€æºæ•°æ®åº“è¿æ¥æ± ï¼Œæä¾›äº†ä¸°å¯Œçš„ç›‘æ§å’Œç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ SQL åˆ†æã€æ€§èƒ½ç›‘æ§å’Œæ…¢æŸ¥è¯¢æ—¥å¿—ç­‰ã€‚é€‚åˆéœ€è¦æ·±åº¦å®šåˆ¶å’Œç›‘æ§çš„ä¼ä¸šçº§åº”ç”¨ã€‚

åœ¨ä½¿ç”¨ Spring Boot 2.x çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ HikariCP è¿æ¥æ± å¤§å°æ˜¯ 10ï¼Œå½“å‰è¯·æ±‚é‡å¤§èµ·æ¥ä¹‹åï¼Œå¦‚æœæ•°æ®åº“æ‰§è¡Œçš„ä¸å¤Ÿå¿«ï¼Œé‚£ä¹ˆè¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ç­‰å¾…è·å–è¿æ¥æ± çš„è¿æ¥ä¸Šã€‚

æ¯”å¦‚é±¼çš®è‡ªå·±ä¸šåŠ¡ä¸­å‡ºç°çš„æƒ…å†µï¼Œè·å–æ•°æ®åº“è¿æ¥ç­‰å¾…æ—¶é—´èŠ±äº† 17.43sï¼Œè¿™å°±æ˜¯å…¸å‹çš„æ•°æ®åº“è¿æ¥ä¸å¤Ÿç”¨ã€‚å¦‚æœé¡¹ç›®çš„æ•°æ®åº“è¿æ¥æ± è¾ƒå°ï¼Œæ­¤æ—¶åº”è¯¥è°ƒå¤§æ•°æ®åº“è¿æ¥æ± çš„å¤§å°ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/iEoC8HmMnYaDGUvy.webp)

å¦‚ä½•è¿›è¡Œæ•°æ®åº“è¿æ¥æ± è°ƒä¼˜å‘¢ï¼Ÿè‚¯å®šä¸æ˜¯å‡­æ„Ÿè§‰çŒœæµ‹ï¼Œè€Œæ˜¯è¦é€šè¿‡ç›‘æ§æˆ–æµ‹è¯•è¿›è¡Œåˆ†æã€‚

æ‰€ä»¥æœ¬é¡¹ç›®ä¼šå¸¦å¤§å®¶ä½¿ç”¨ Druid æ¥åšæ•°æ®åº“è¿æ¥æ± ï¼Œå› ä¸ºå®ƒæä¾›äº†ä¸°å¯Œçš„ç›‘æ§å’Œç®¡ç†åŠŸèƒ½ï¼Œæ›´é€‚åˆå­¦ä¹ ä¸Šæ‰‹æ•°æ®åº“è¿æ¥æ± è°ƒä¼˜ã€‚

##### å¼•å…¥ Druid è¿æ¥æ± 

å¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://github.com/alibaba/druid/wiki) å¼•å…¥ï¼ˆè™½ç„¶ä¹Ÿæ²¡ä»€ä¹ˆå¥½å‚è€ƒçš„ï¼‰ã€‚

1ï¼‰é€šè¿‡ Maven å¼•å…¥ Druidï¼Œå¹¶ä¸”æ’é™¤é»˜è®¤å¼•å…¥çš„ HikariCPï¼š

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.2.23</version>
</dependency>

<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.2</version>
    <exclusions>
        <!-- æ’é™¤é»˜è®¤çš„ HikariCP -->
        <exclusion>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

2ï¼‰ä¿®æ”¹ application.yml æ–‡ä»¶é…ç½®ã€‚

ç”±äºå‚æ•°è¾ƒå¤šï¼Œå»ºè®®ç›´æ¥æ‹·è´ä»¥ä¸‹é…ç½®å³å¯ï¼Œéƒ¨åˆ†å‚æ•°å¯ä»¥æ ¹æ®æ³¨é‡Šè‡ªè¡Œè°ƒæ•´ï¼š

```yaml
spring:
  # æ•°æ®æºé…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mianshiya
    username: root
    password: 123456
    # æŒ‡å®šæ•°æ®æºç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # Druid é…ç½®
    druid:
      # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
      initial-size: 10
      minIdle: 10
      max-active: 10
      # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
      max-wait: 60000
      # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’
      time-between-eviction-runs-millis: 2000
      # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
      min-evictable-idle-time-millis: 600000
      max-evictable-idle-time-millis: 900000
      # ç”¨æ¥æµ‹è¯•è¿æ¥æ˜¯å¦å¯ç”¨çš„SQLè¯­å¥,é»˜è®¤å€¼æ¯ç§æ•°æ®åº“éƒ½ä¸ç›¸åŒ,è¿™æ˜¯mysql
      validationQuery: select 1
      # åº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥ï¼Œå¹¶ä¸”testOnBorrowä¸ºfalseæ—¶ï¼Œè¿æ¥æ± å°†ä¼šåˆ¤æ–­è¿æ¥æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éªŒè¯è¿™æ¡è¿æ¥æ˜¯å¦å¯ç”¨
      testWhileIdle: true
      # å¦‚æœä¸ºtrueï¼Œé»˜è®¤æ˜¯falseï¼Œåº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥æ—¶ï¼Œè¿æ¥æ± ä¼šåˆ¤æ–­è¿™æ¡è¿æ¥æ˜¯å¦æ˜¯å¯ç”¨çš„
      testOnBorrow: false
      # å¦‚æœä¸ºtrueï¼ˆé»˜è®¤falseï¼‰ï¼Œå½“åº”ç”¨ä½¿ç”¨å®Œè¿æ¥ï¼Œè¿æ¥æ± å›æ”¶è¿æ¥çš„æ—¶å€™ä¼šåˆ¤æ–­è¯¥è¿æ¥æ˜¯å¦è¿˜å¯ç”¨
      testOnReturn: false
      # æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheã€‚PSCacheå¯¹æ”¯æŒæ¸¸æ ‡çš„æ•°æ®åº“æ€§èƒ½æå‡å·¨å¤§ï¼Œæ¯”å¦‚è¯´oracle
      poolPreparedStatements: true
      # è¦å¯ç”¨PSCacheï¼Œå¿…é¡»é…ç½®å¤§äº0ï¼Œå½“å¤§äº0æ—¶ï¼Œ poolPreparedStatementsè‡ªåŠ¨è§¦å‘ä¿®æ”¹ä¸ºtrueï¼Œ
      # åœ¨Druidä¸­ï¼Œä¸ä¼šå­˜åœ¨Oracleä¸‹PSCacheå ç”¨å†…å­˜è¿‡å¤šçš„é—®é¢˜ï¼Œ
      # å¯ä»¥æŠŠè¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚è¯´100
      maxOpenPreparedStatements: 20
      # è¿æ¥æ± ä¸­çš„minIdleæ•°é‡ä»¥å†…çš„è¿æ¥ï¼Œç©ºé—²æ—¶é—´è¶…è¿‡minEvictableIdleTimeMillisï¼Œåˆ™ä¼šæ‰§è¡ŒkeepAliveæ“ä½œ
      keepAlive: true
      # Spring ç›‘æ§ï¼Œåˆ©ç”¨aop å¯¹æŒ‡å®šæ¥å£çš„æ‰§è¡Œæ—¶é—´ï¼Œjdbcæ•°è¿›è¡Œè®°å½•
      aop-patterns: "com.springboot.template.dao.*"
      ########### å¯ç”¨å†…ç½®è¿‡æ»¤å™¨ï¼ˆç¬¬ä¸€ä¸ª stat å¿…é¡»ï¼Œå¦åˆ™ç›‘æ§ä¸åˆ°SQLï¼‰##########
      filters: stat,wall,log4j2
      # è‡ªå·±é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filter
      filter:
        # å¼€å¯druiddatasourceçš„çŠ¶æ€ç›‘æ§
        stat:
          enabled: true
          db-type: mysql
          # å¼€å¯æ…¢sqlç›‘æ§ï¼Œè¶…è¿‡2s å°±è®¤ä¸ºæ˜¯æ…¢sqlï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­
          log-slow-sql: true
          slow-sql-millis: 2000
        # æ—¥å¿—ç›‘æ§ï¼Œä½¿ç”¨slf4j è¿›è¡Œæ—¥å¿—è¾“å‡º
        slf4j:
          enabled: true
          statement-log-error-enabled: true
          statement-create-after-log-enabled: false
          statement-close-after-log-enabled: false
          result-set-open-after-log-enabled: false
          result-set-close-after-log-enabled: false
      ########## é…ç½®WebStatFilterï¼Œç”¨äºé‡‡é›†webå…³è”ç›‘æ§çš„æ•°æ® ##########
      web-stat-filter:
        enabled: true                   # å¯åŠ¨ StatFilter
        url-pattern: /* # è¿‡æ»¤æ‰€æœ‰url
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*" # æ’é™¤ä¸€äº›ä¸å¿…è¦çš„url
        session-stat-enable: true       # å¼€å¯sessionç»Ÿè®¡åŠŸèƒ½
        session-stat-max-count: 1000 # sessionçš„æœ€å¤§ä¸ªæ•°,é»˜è®¤100
      ########## é…ç½®StatViewServletï¼ˆç›‘æ§é¡µé¢ï¼‰ï¼Œç”¨äºå±•ç¤ºDruidçš„ç»Ÿè®¡ä¿¡æ¯ ##########
      stat-view-servlet:
        enabled: true                   # å¯ç”¨StatViewServlet
        url-pattern: /druid/* # è®¿é—®å†…ç½®ç›‘æ§é¡µé¢çš„è·¯å¾„ï¼Œå†…ç½®ç›‘æ§é¡µé¢çš„é¦–é¡µæ˜¯/druid/index.html
        reset-enable: false              # ä¸å…è®¸æ¸…ç©ºç»Ÿè®¡æ•°æ®,é‡æ–°è®¡ç®—
        login-username: root # é…ç½®ç›‘æ§é¡µé¢è®¿é—®å¯†ç 
        login-password: 123
        allow: 127.0.0.1 # å…è®¸è®¿é—®çš„åœ°å€ï¼Œå¦‚æœallowæ²¡æœ‰é…ç½®æˆ–è€…ä¸ºç©ºï¼Œåˆ™å…è®¸æ‰€æœ‰è®¿é—®
        deny: # æ‹’ç»è®¿é—®çš„åœ°å€ï¼Œdenyä¼˜å…ˆäºallowï¼Œå¦‚æœåœ¨denyåˆ—è¡¨ä¸­ï¼Œå°±ç®—åœ¨allowåˆ—è¡¨ä¸­ï¼Œä¹Ÿä¼šè¢«æ‹’ç»
```

3ï¼‰å¯åŠ¨åè®¿é—®ç›‘æ§é¢æ¿ï¼šhttp://localhost:8101/api/druid/index.html

è¾“å…¥ä¸Šè¿°é…ç½®ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/Rb6M1NqkkuTK28hr.webp)

ğŸ’¡æ‰©å±•çŸ¥è¯†ï¼šæƒ³å»é™¤åº•éƒ¨å¹¿å‘Šï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¸‹é¢çš„ä»£ç ï¼š

```java
import com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure;
import com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties;
import com.alibaba.druid.util.Utils;
import org.springframework.boot.autoconfigure.AutoConfigureAfter;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.servlet.*;
import java.io.IOException;

@Configuration
@ConditionalOnWebApplication
@AutoConfigureAfter(DruidDataSourceAutoConfigure.class)
@ConditionalOnProperty(name = "spring.datasource.druid.stat-view-servlet.enabled",
        havingValue = "true", matchIfMissing = true)
public class RemoveDruidAdConfig {

    /**
     * æ–¹æ³•å: removeDruidAdFilterRegistrationBean
     * æ–¹æ³•æè¿° é™¤å»é¡µé¢åº•éƒ¨çš„å¹¿å‘Š
     * @param properties com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties
     * @return org.springframework.boot.web.servlet.FilterRegistrationBean
     */
    @Bean
    public FilterRegistrationBean removeDruidAdFilterRegistrationBean(DruidStatProperties properties) {

        // è·å–webç›‘æ§é¡µé¢çš„å‚æ•°
        DruidStatProperties.StatViewServlet config = properties.getStatViewServlet();
        // æå–common.jsçš„é…ç½®è·¯å¾„
        String pattern = config.getUrlPattern() != null ? config.getUrlPattern() : "/druid/*";
        String commonJsPattern = pattern.replaceAll("\\*", "js/common.js");

        final String filePath = "support/http/resources/js/common.js";

        //åˆ›å»ºfilterè¿›è¡Œè¿‡æ»¤
        Filter filter = new Filter() {
            @Override
            public void init(FilterConfig filterConfig) throws ServletException {}

            @Override
            public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
                chain.doFilter(request, response);
                // é‡ç½®ç¼“å†²åŒºï¼Œå“åº”å¤´ä¸ä¼šè¢«é‡ç½®
                response.resetBuffer();
                // è·å–common.js
                String text = Utils.readFromResource(filePath);
                // æ­£åˆ™æ›¿æ¢banner, é™¤å»åº•éƒ¨çš„å¹¿å‘Šä¿¡æ¯
                text = text.replaceAll("<a.*?banner\"></a><br/>", "");
                text = text.replaceAll("powered.*?shrek.wang</a>", "");
                response.getWriter().write(text);
            }

            @Override
            public void destroy() {}
        };

        FilterRegistrationBean registrationBean = new FilterRegistrationBean();
        registrationBean.setFilter(filter);
        registrationBean.addUrlPatterns(commonJsPattern);
        return registrationBean;
    }
}
```

##### ä½¿ç”¨ Druid ç›‘æ§

ä¸‹é¢æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹å› ä¸ºæ•°æ®åº“è¿æ¥æ± ä¸è¶³å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶å€Ÿæ­¤å¸¦å¤§å®¶ç†Ÿæ‚‰ Druid ç›‘æ§çš„ä½¿ç”¨ã€‚

1ï¼‰å°†é…ç½®ä¸­çš„è¿æ¥æ± å¤§å°æ”¹ä¸º 1ï¼Œä¸”è·å–è¿æ¥ç­‰å¾…æ—¶é—´è¶…æ—¶ä¸º 2sï¼š

```yaml
druid:
  # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
  initial-size: 1
  minIdle: 1
  max-active: 1
  # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
  max-wait: 2000
```

ç„¶åä»»æ„æ‰§è¡Œä¸€æ¬¡å¯¹æ•°æ®åº“çš„æ‰¹é‡æ“ä½œï¼Œæ¯”å¦‚æ’å…¥ 20 æ¡æ•°æ®ï¼Œæ¯æ‰¹ 2 æ¡ï¼Œä¸€å…± 10 æ‰¹ï¼Œä¼šéšæœºæŠ¥é”™ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/rAgC4AkhzOZtKyhR.webp)

æŸ¥çœ‹ Druid ç›‘æ§ï¼Œå¯ä»¥çœ‹åˆ°æœ€å¤§å¹¶å‘ä¸º 1ï¼Œå› ä¸ºè¿æ¥æ± çš„è¿æ¥æ•°é‡åªæœ‰ 1ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/yPI7flpqvPZhAjfw.webp)

é™¤äº† SQL çš„ç›‘æ§ï¼Œè¿˜æœ‰ URI çš„ç›‘æ§ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å“ªä¸ªæ¥å£è°ƒç”¨äº†æ•°æ®åº“ï¼Œæ‰§è¡Œäº†å¤šå°‘æ—¶é—´ã€‚ä»¥åå‡ºç°çº¿ä¸Šæ•°æ®åº“å¡æ­»çš„é—®é¢˜æ—¶ï¼Œå¾ˆå¿«å°±èƒ½å®šä½åˆ°æ˜¯å“ªä¸ªæ¥å£ã€å“ªä¸ª SQL å‡ºç°äº†é—®é¢˜ï¼ˆæˆ–è€…è®¿é—®é¢‘ç‡è¿‡é«˜ï¼‰ã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/UGup5aUW2K9NSIvx.webp)

ğŸ’¡ Druid çš„ URI ç›‘æ§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

æ ¸å¿ƒå®ç°æ–¹æ³•å¦‚ä¸‹ï¼š

1. é€šè¿‡åŸºäº Servlet çš„è¿‡æ»¤å™¨ `WebStatFilter` æ¥æ‹¦æˆªè¯·æ±‚ï¼Œè¯¥è¿‡æ»¤å™¨ä¼šæ”¶é›†å…³äºè¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚çš„ URIã€æ‰§è¡Œæ—¶é•¿ã€è¯·æ±‚æœŸé—´æ‰§è¡Œçš„ SQL è¯­å¥æ•°ç­‰ã€‚
2. ç»Ÿè®¡ URI å’Œ SQL æ‰§è¡Œæƒ…å†µæ˜¯æ€ä¹ˆå…³è”èµ·æ¥çš„å‘¢ï¼Ÿ æ¯æ¬¡æ‰§è¡Œ SQL æ—¶ï¼ŒDruid ä¼šåœ¨å†…éƒ¨ç»Ÿè®¡è¯¥ SQL çš„æ‰§è¡Œæƒ…å†µï¼Œè€Œ `WebStatFilter` ä¼šæŠŠ SQL æ‰§è¡Œä¿¡æ¯ä¸å½“å‰çš„ HTTP è¯·æ±‚ URI å…³è”èµ·æ¥ã€‚

2ï¼‰å°†é…ç½®ä¸­çš„è¿æ¥æ± å¤§å°æ”¹ä¸º 10ï¼Œä¸”è·å–è¿æ¥ç­‰å¾…æ—¶é—´è¶…æ—¶ä¸º 2sï¼š

```yaml
druid:
  # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
  initial-size: 10
  minIdle: 10
  max-active: 10
  # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
  max-wait: 2000
```

å¯ä»¥çœ‹åˆ°ï¼ŒSQL çš„å¹¶å‘ç›´æ¥å˜æˆäº† 10ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/X7kU2uKqhVKdPr3F.webp)

URI æ¥å£è°ƒç”¨çš„è€—æ—¶ï¼Œç›´æ¥ç¼©å°çš„ 10 å€ï¼Œç¬¦åˆæˆ‘ä»¬æå‡äº† 10 å€å¹¶å‘çš„ä¼˜åŒ–æƒ…å†µï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/YBZ7qPyH5iPA6QYg.webp)

æœ‰çš„æ—¶å€™ï¼Œå³ä½¿æˆ‘ä»¬æœåŠ¡å™¨ JVM çš„å†…å­˜å’Œ CPU å ç”¨éƒ½éå¸¸ä½ï¼Œå…¶ä»–çš„ä¸­é—´ä»¶æ¯”å¦‚ MySQL å’Œ Redis çš„å ç”¨ä¹Ÿéå¸¸ä½ï¼Œä½†ç³»ç»Ÿä¾ç„¶ä¼šå‡ºç°å“åº”æ…¢ã€å¡æ­»çš„æƒ…å†µã€‚è¿™å¯èƒ½å°±æ˜¯å› ä¸ºä¸€äº›é…ç½®é”™è¯¯ï¼Œæ‰€ä»¥äº†è§£è¿™äº›çŸ¥è¯†è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚

### **æ•°æ®ä¸€è‡´æ€§**

#### 1ã€äº‹åŠ¡ç®¡ç†

æˆ‘ä»¬ç›®å‰å·²ç»ä½¿ç”¨äº† `@Transactional(rollbackFor = Exception.class)` æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚å¦‚æœä»»æ„ä¸€æ­¥æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡ä¼šå›æ»šï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

#### 2ã€å¹¶å‘ç®¡ç†

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœå¤šä¸ªç®¡ç†å‘˜åŒæ—¶å‘åŒä¸€ä¸ªé¢˜åº“æ·»åŠ é¢˜ç›®ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†²çªæˆ–æ€§èƒ½é—®é¢˜ã€‚ä¸ºäº†è§£å†³å¹¶å‘é—®é¢˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œç¨³å®šæ€§ï¼Œå¯ä»¥æœ‰ 2 ç§å¸¸è§çš„ç­–ç•¥ï¼š

1ï¼‰å¢åŠ  **åˆ†å¸ƒå¼é”** æ¥é˜²æ­¢åŒä¸€ä¸ªæ¥å£ï¼ˆæˆ–æ–¹æ³•ï¼‰åœ¨åŒä¸€æ—¶é—´è¢«å¤šä¸ªç®¡ç†å‘˜åŒæ—¶æ“ä½œï¼Œæ¯”å¦‚ä½¿ç”¨ Redis + Redisson å®ç°åˆ†å¸ƒå¼é”ã€‚

2ï¼‰å¦‚æœè¦ç²¾ç»†åœ°å¯¹æŸä¸ªæ•°æ®è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œå¯ä»¥é€‰ç”¨ **ä¹è§‚é”**ã€‚æ¯”å¦‚é€šè¿‡ç»™ `QuestionBank` è¡¨å¢åŠ ä¸€ä¸ª `version` å­—æ®µï¼Œåœ¨æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œç¡®ä¿å¯¹åŒä¸€ä¸ªé¢˜åº“çš„å¹¶å‘æ“ä½œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

ä¼ªä»£ç ç¤ºä¾‹ï¼š

```java
// æ›´æ–°é¢˜åº“å‰ï¼Œå…ˆæŸ¥è¯¢ç‰ˆæœ¬å·
QuestionBank questionBank = questionBankService.getById(questionBankId);
Long currentVersion = questionBank.getVersion();

// æ›´æ–°æ—¶ï¼Œæ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´
int rowsAffected = questionBankService.updateVersionById(questionBankId, currentVersion);
if (rowsAffected == 0) {
    throw new BusinessException(ErrorCode.CONCURRENT_MODIFICATION, "æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹");
}
```

ğŸ’¡ åœ¨ MySQL ä¸­ï¼Œè¿˜å¯ä»¥é‡‡ç”¨ `SELECT ... FOR UPDATE` æ¥å¼ºè¡Œé”å®šæŸä¸€è¡Œæ•°æ®ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤æˆ–å›æ»šä¹‹å‰ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¿™è¡Œæ•°æ®è¿›è¡Œä¿®æ”¹ã€‚

æœ¬é¡¹ç›®ä¸­ï¼Œç”±äºå…³è”è¡¨æœ‰å”¯ä¸€é”®çº¦æŸï¼Œä¿è¯ä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨è¿™ç§æ–¹æ¡ˆã€‚

### å¯è§‚æµ‹æ€§

å¯è§‚æµ‹æ€§çš„å…³é”®åœ¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š

1. å¯è§æ€§ï¼šç³»ç»Ÿéœ€è¦èƒ½å¤ŸæŠ¥å‘Šå®ƒçš„å†…éƒ¨çŠ¶æ€ã€‚è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡è¿”å› `BatchAddResult` æä¾›äº†ä¸°å¯Œçš„çŠ¶æ€åé¦ˆã€‚
2. è¿½è¸ªæ€§ï¼šé€šè¿‡è¯¦ç»†çš„é”™è¯¯åŸå› å’Œå…·ä½“å¤±è´¥é¡¹ï¼Œå¯ä»¥è½»æ¾åœ°è¿½è¸ªé—®é¢˜æºå¤´ã€‚
3. è¯Šæ–­æ€§ï¼šæ˜ç¡®çš„åé¦ˆä¿¡æ¯æœ‰åŠ©äºå¿«é€Ÿè¯Šæ–­é—®é¢˜ï¼Œè€Œä¸ä»…ä»…æ˜¯æä¾›ä¸€ä¸ªç®€å•çš„ "æˆåŠŸ" æˆ– "å¤±è´¥"ã€‚

#### 1ã€æ—¥å¿—è®°å½•

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ‰¹é‡æ“ä½œå¯èƒ½ä¼šå‡ºç°ä¸€äº›éš¾ä»¥é¢„æ–™çš„é—®é¢˜ï¼Œå»ºè®®å¤šè®°å½•æ“ä½œæ—¥å¿—ï¼šåŒ…æ‹¬æˆåŠŸã€å¤±è´¥çš„é¢˜ç›®ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚

æ¯”å¦‚ï¼š

```java
log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸ, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());
```

#### 2ã€ç›‘æ§

ç›‘æ§æ˜¯å®ç°å¯è§‚æµ‹æ€§çš„ä¸»æµæ‰‹æ®µï¼Œä½ å¯ä»¥å¯¹æœåŠ¡å™¨ã€JVMã€è¯·æ±‚ã€ä»¥åŠé¡¹ç›®ä¸­å¼•å…¥çš„å„ç§ç»„ä»¶è¿›è¡Œç›‘æ§ã€‚

å¸¸ç”¨çš„ç›‘æ§å·¥å…·æœ‰ Grafanaï¼Œå¦‚æœä½ ç»™é¡¹ç›®å¼•å…¥äº†æŸä¸ªæŠ€æœ¯ç»„ä»¶ï¼Œä¸€èˆ¬éƒ½ä¼šè‡ªå¸¦ç›‘æ§ï¼Œæ¯”å¦‚é¡¹ç›®è°ƒç”¨æ•°æ®åº“çš„æƒ…å†µå¯ä»¥é€šè¿‡ Druid ç›‘æ§ã€Elasticsearch å¯ä»¥é€šè¿‡ Kibana ç›‘æ§ç­‰ç­‰ã€Spring Boot å†…ç½®äº† Spring Boot Actuator æ¥ç›‘æ§åº”ç”¨è¿è¡ŒçŠ¶æ€ç­‰ã€‚

ğŸ’¡ å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹äº‘æœåŠ¡ï¼Œæ¯”å¦‚ XX äº‘çš„äº‘æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ä¼šè‡ªå¸¦æˆç†Ÿçš„ç›‘æ§é¢æ¿ï¼Œæœ‰æ—¶é—´å»ºè®®å¤§å®¶å¤šå»é€›é€›äº‘æœåŠ¡å¹³å°ï¼Œèƒ½çœ‹åˆ°å¾ˆå¤šä¸šç•Œæˆç†Ÿçš„ç›‘æ§æ–¹æ¡ˆã€‚

#### 3ã€è¿”å›å€¼ä¼˜åŒ–

ç›®å‰æˆ‘ä»¬çš„æ–¹æ³•è¿”å›çš„æ˜¯ `void`ï¼Œè¿™æ„å‘³ç€åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰æ˜ç¡®åé¦ˆæ“ä½œçš„ç»“æœã€‚ä¸ºäº†æå‡å¯è§‚æµ‹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€è¿”å›æ›´åŠ è¯¦ç»†çš„ç»“æœï¼Œå¸®åŠ©è°ƒç”¨è€…äº†è§£ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚

å¯ä»¥å®šä¹‰ä¸€ä¸ªè¿”å›ç»“æœå¯¹è±¡ï¼ŒåŒ…å«æ¯ä¸ªé¢˜ç›®çš„å¤„ç†çŠ¶æ€ã€æˆåŠŸå’Œå¤±è´¥çš„æ•°é‡ï¼Œä»¥åŠå¤±è´¥çš„åŸå› ã€‚

```java
public class BatchAddResult {
    private int total;
    private int successCount;
    private int failureCount;
    private List<String> failureReasons;
}
```

åœ¨æ‰¹é‡æ“ä½œä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ä¸æŠ›å‡ºå¼‚å¸¸å¹¶ä¸­æ–­å…¶ä»–çš„æ“ä½œï¼Œåªæ˜¯è®°å½•éƒ¨åˆ†å¤±è´¥çš„æ“ä½œæƒ…å†µã€‚è¿™æ ·ä¸€æ¥ï¼Œç®¡ç†å‘˜å¯ä»¥çŸ¥é“å“ªäº›é¢˜ç›®æ“ä½œæˆåŠŸã€å“ªäº›å¤±è´¥ï¼Œæ›´å¥½åœ°è¿›è¡Œåç»­å¤„ç†ã€‚

ä»¥ä¸‹ä¸ºç¤ºä¾‹ä»£ç ï¼š

```java
public BatchAddResult batchAddQuestionsToBank(List<Long> questionIdList, Long questionBankId, User loginUser) {
    BatchAddResult result = new BatchAddResult();
    result.setTotal(questionIdList.size());

    // æ‰§è¡Œæ‰¹é‡æ’å…¥é€»è¾‘
    for (Long questionId : questionIdList) {
        try {
            // æ’å…¥æ“ä½œ
            saveQuestionToBank(questionId, questionBankId, loginUser);
            result.setSuccessCount(result.getSuccessCount() + 1);
        } catch (Exception e) {
            result.setFailureCount(result.getFailureCount() + 1);
            result.getFailureReasons().add("é¢˜ç›®ID " + questionId + " æ’å…¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    return result; // è¿”å›æ‰¹é‡å¤„ç†çš„ç»“æœ
}
```

------

OKï¼Œå­¦åˆ°äº†è¿™ä¹ˆå¤šä¼˜åŒ–æ–¹æ³•ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ ¹æ®æƒ…å†µé€‰ç”¨ã€‚

## æ‰©å±•

1ï¼‰æŒ‰ç…§ä¸Šè¿°ä¼˜åŒ–æ–¹æ³•ï¼Œè‡ªä¸»å®Œå–„ç®¡ç†å‘˜æ‰¹å¤„ç†æ“ä½œæ¥å£ã€‚

2ï¼‰å¯ä»¥é€šè¿‡ Apache JMeter å‹æµ‹ä¸€ä¸‹ä½¿ç”¨å¹¶å‘ç¼–ç¨‹åçš„æ€§èƒ½æå‡æ•ˆæœã€‚

## ä¸‰ã€è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜åº“

### éœ€æ±‚åˆ†æ

å¯¹äºçº¿ä¸Šé¡¹ç›®ï¼Œç”¨æˆ·çš„è®¿é—®é‡æ—¥ç›Šå¢é•¿ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§çš„è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚

å¯¹äºæˆ‘ä»¬çš„é¢è¯•åˆ·é¢˜å¹³å°ï¼Œä¸ºäº†å‡å°‘ç”¨æˆ·åŠ è½½ç½‘é¡µå’Œé¢˜ç›®çš„æ—¶é—´ï¼Œå¯ä»¥å¯¹ç»å¸¸è®¿é—®çš„æ•°æ®ï¼ˆæ¯”å¦‚é¦–é¡µæ•°æ®å’Œé¢˜ç›®ï¼‰è¿›è¡Œç¼“å­˜ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä»æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ã€‚

å¸¸ç”¨çš„ç¼“å­˜å°±æ˜¯åˆ†å¸ƒå¼ç¼“å­˜ Redis å’Œæœ¬åœ°ç¼“å­˜ Caffeineï¼ˆé€‚ç”¨äº Java é¡¹ç›®ï¼‰ï¼Œç”±äºå®ƒä»¬å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™æ•ˆç‡éƒ½æ¯”æ•°æ®åº“æ›´é«˜ï¼Œèƒ½å¤Ÿè®©ç³»ç»Ÿæ”¯æŒæ›´å¤§çš„å¹¶å‘ï¼Œå¹¶ä¸”å‡å°æ•°æ®åº“çš„å‹åŠ›ã€‚

ç›¸ä¿¡å¾ˆå¤šåŒå­¦ä¹‹å‰å­¦è¿‡ Redis ç¼“å­˜ï¼Œ[ç¼–ç¨‹å¯¼èˆªçš„ä¼™ä¼´åŒ¹é…ç³»ç»Ÿ](https://www.code-nav.cn/course) ç­‰é¡¹ç›®ä¸­æœ‰è¿‡è®²è§£ã€‚

ä½†æ˜¯ï¼Œæ€ä¹ˆçŸ¥é“å“ªäº›æ•°æ®è¯¥ç¼“å­˜å‘¢ï¼Ÿ

å¯¹äºæˆ‘ä»¬çš„é¢è¯•åˆ·é¢˜å¹³å°ï¼Œé±¼çš®æ¨å¹¿çš„æ—¶å€™å¯èƒ½ä¼šé‡ç‚¹å®£ä¼ æŸä¸€ä¸ªé¢˜åº“æˆ–é¢˜ç›®ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥ç‚¹é“¾æ¥è¿›å…¥ç‰¹å®šçš„å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹å°±ä¼šæˆä¸º **çƒ­ç‚¹æ•°æ®** ã€‚æˆ‘ä»¬å¦‚æœèƒ½å¤Ÿé¢„åˆ¤åˆ°çƒ­ç‚¹æ•°æ®ï¼Œå¯ä»¥æå‰äººå·¥ç»™æ•°æ®åŠ ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ **ç¼“å­˜é¢„çƒ­** ã€‚

ä½†æ˜¯æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬æ— æ³•é¢„æ–™åˆ°å“ªäº›æ•°æ®æ˜¯çƒ­ç‚¹ã€‚å¦‚æœæŸä¸ªæ•°æ®æ²¡æ¥å¾—åŠç¼“å­˜ï¼Œçªç„¶è¢«å¤§é‡è®¿é—®ï¼Œç³»ç»Ÿä¸å°±æ•…éšœäº†ä¹ˆï¼Ÿ

è¿™é‡Œæˆ‘ä»¬å°±è¦å¼•å‡ºä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼šçƒ­ç‚¹é—®é¢˜ã€‚

å¾ˆå¤šä¼ä¸šçº§é¡¹ç›®éƒ½ä¼šæœ‰çƒ­ç‚¹é—®é¢˜ï¼Œä¾‹å¦‚å¾®åšï¼Œä¸€ä¸ªæ˜æ˜Ÿå‡ºäº†æŸäº›èŠ±è¾¹æ–°é—»ï¼Œé‚£ä¹ˆè¿™æ¡å¾®åšå°±ä¼šæˆä¸ºçƒ­ç‚¹ï¼Œæ­¤æ—¶ç³»ç»Ÿéœ€è¦ **è‡ªåŠ¨å‘ç°** è¿™ä¸ªçƒ­ç‚¹ï¼Œå°†å…¶åšå¤šçº§ç¼“å­˜æ¥é¡¶ä½å¤§æµé‡è®¿é—®çš„å‹åŠ›ã€‚

é¢è¯•åˆ·é¢˜å¹³å°åœºæ™¯ä¹Ÿæœ‰çƒ­ç‚¹é—®é¢˜ï¼Œä¾‹å¦‚é»˜è®¤é¢è¯•é¢˜éƒ½æ˜¯ä»æ•°æ®åº“è®¿é—®ï¼Œå¦‚æœä¸€é“é¢è¯•é¢˜è®¿é—®çš„é¢‘ç‡ç‰¹åˆ«é«˜ï¼ˆå¯èƒ½æ˜¯è¢«å…¶ä»–äººæ¨å¹¿ã€ä¹Ÿå¯èƒ½æ˜¯è¢«æ”»å‡»äº†ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥å°†å…¶è‡ªåŠ¨ç¼“å­˜åœ¨æœ¬åœ°æˆ–è€… Redis ä¸­ï¼Œæé«˜è®¿é—®æ€§èƒ½çš„åŒæ—¶ï¼Œé™ä½æ•°æ®åº“çš„å‹åŠ›ï¼Œä¹Ÿå‡è½»åç«¯æœåŠ¡çš„å‹åŠ›ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ **è‡ªåŠ¨å‘ç°** çƒ­ç‚¹ï¼Ÿ

å› ä¸ºçƒ­ç‚¹çš„ç¬æ—¶æµé‡å¤§ï¼Œéœ€è¦åŠæ—¶å‘ç°ä¸ç¼“å­˜ã€‚å¦‚æœé äººä¸ºæ¥æ‰‹åŠ¨è®¾ç½®ï¼Œå¯èƒ½åˆšæ‰“å¼€åå°é¡µé¢ï¼Œç³»ç»Ÿå°±å·²ç»å´©æºƒäº†ï¼Œä¸€èˆ¬è¦æ±‚ç§’çº§å‘ç°çƒ­ç‚¹ä¸”è‡ªåŠ¨ç¼“å­˜ã€‚

------

é‚£ä¹ˆå›å½’åˆ°æœ¬é¡¹ç›®çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›è‡ªåŠ¨ä¸ºé¢‘ç¹è®¿é—®çš„é¢˜åº“å¢åŠ ç¼“å­˜ã€‚

å…·ä½“çš„è§„åˆ™æ˜¯ï¼šå¯¹äºè·å–é¢˜åº“è¯¦æƒ…çš„è¯·æ±‚ï¼Œå¦‚æœ 5 ç§’å†…è®¿é—® >= 10 æ¬¡ï¼Œå°±è¦ä½¿ç”¨æœ¬åœ°ç¼“å­˜å°†é¢˜åº“è¯¦æƒ…ç¼“å­˜ 10 åˆ†é’Ÿï¼Œä¹‹åéƒ½ä»æœ¬åœ°ç¼“å­˜è¯»å–ã€‚

### æ–¹æ¡ˆè®¾è®¡

è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜åº“éœ€è¦ä»¥ä¸‹äº”ä¸ªæ­¥éª¤ï¼š

1ã€è®°å½•è®¿é—®ï¼šç”¨æˆ·æ¯è®¿é—®ä¸€æ¬¡é¢˜åº“ï¼Œç»Ÿè®¡æ¬¡æ•° +1

2ã€è®¿é—®ç»Ÿè®¡ï¼šç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…é¢˜åº“çš„è®¿é—®æ¬¡æ•°ã€‚**è¿™æ˜¯æœ€éš¾å®ç°çš„ä¸€éƒ¨åˆ†ã€‚**

3ã€é˜ˆå€¼åˆ¤æ–­ï¼šè®¿é—®é¢‘ç‡è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼ï¼Œå˜ä¸ºçƒ­ç‚¹æ•°æ®ã€‚

4ã€ç¼“å­˜æ•°æ®ï¼šç¼“å­˜çƒ­ç‚¹æ•°æ®

5ã€è·å–æ•°æ®ï¼šåç»­è®¿é—®æ—¶ï¼Œä»ç¼“å­˜ä¸­è·å–æ•°æ®

å½“ç„¶ï¼Œè¿˜æœ‰å¾ˆå¤šæ³¨æ„äº‹é¡¹ï¼Œæ¯”å¦‚çƒ­ç‚¹æ•°æ®å¦‚ä½•æ›´æ–°ï¼Ÿå¦‚ä½•æ¢å¤ä¸ºæ­£å¸¸æ•°æ®ç­‰ç­‰ã€‚

è®©ä½ è‡ªå·±å®ç°çš„è¯ï¼Œä½ èƒ½æå®šä¹ˆï¼Ÿ

åæ­£æˆ‘æ˜¯ä¸å¤ªè¡Œï¼Œæˆ–è€…è¯´å®Œå…¨æ²¡å¿…è¦è‡ªå·±å®ç°ã€‚æœ¬æœŸæˆ‘ä»¬ä¸è‡ªå·±é‡å¤é€ è½®å­ï¼Œè€Œæ˜¯åŸºäºä¸€ä¸ªä¼ä¸šçº§çƒ­ç‚¹ key æ¢æµ‹æ¡†æ¶ `äº¬ä¸œ hotkey` æ¥å®ç°è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜åº“ã€‚

### hotkey å…¥é—¨

äº¬ä¸œæä¾›äº†ä¸€ä¸ªè½»é‡çº§é€šç”¨çš„çƒ­ key æ¢æµ‹ä¸­é—´ä»¶ [hotkey](https://gitee.com/jd-platform-opensource/hotkey)ã€‚

æ ¹æ®å®˜æ–¹ä»“åº“æè¿°ï¼šhotkey æ˜¯äº¬ä¸œAPPåå°çƒ­æ•°æ®æ¢æµ‹æ¡†æ¶ï¼Œå†ç»å¤šæ¬¡é«˜å‹å‹æµ‹å’Œäº¬ä¸œ 618ã€åŒ 11 å¤§ä¿ƒè€ƒéªŒã€‚

åœ¨ä¸Šçº¿è¿è¡Œçš„è¿™æ®µæ—¶é—´å†…ï¼Œ**æ¯å¤©æ¢æµ‹çš„ key æ•°é‡æ•°åäº¿è®¡**ï¼Œç²¾å‡†æ•è·äº†å¤§é‡çˆ¬è™«ã€åˆ·å­ç”¨æˆ·ï¼Œå¦å‡†ç¡®æ¢æµ‹å¤§é‡çƒ­é—¨å•†å“å¹¶æ¯«ç§’çº§æ¨é€åˆ°å„ä¸ªæœåŠ¡ç«¯å†…å­˜ï¼Œå¤§å¹…é™ä½äº†çƒ­æ•°æ®å¯¹æ•°æ®å±‚çš„æŸ¥è¯¢å‹åŠ›ï¼Œæå‡äº†åº”ç”¨æ€§èƒ½ã€‚**åœ¨å¤§ä¿ƒæœŸé—´ï¼Œhotkey çš„ worker é›†ç¾¤ç§’çº§ååé‡è¾¾åˆ° 1500 ä¸‡çº§åˆ«ã€‚**

æ ¹æ®å®˜æ–¹å‹æµ‹ï¼šä¸€å° 8 æ ¸ 8G çš„æœºå™¨ï¼Œæ¯ç§’å¯ä»¥å¤„ç†æ¥è‡ªäºæ•°åƒå°æœåŠ¡å™¨å‘æ¥çš„é«˜è¾¾ 16 ä¸‡ä¸ªçš„å¾…æµ‹ keyï¼Œ8 æ ¸å•æœºååé‡åœ¨ 16 ä¸‡ï¼Œ16 æ ¸æœºå™¨æ¯ç§’å¯è¾¾ 30 ä¸‡ä»¥ä¸Šæ¢æµ‹é‡ï¼Œæ‰€ä»¥ä»…é‡‡ç”¨ 10 å°æœºå™¨ï¼Œå³å¯å®Œæˆæ¯ç§’è¿‘ 300 ä¸‡æ¬¡çš„ key æ¢æµ‹ä»»åŠ¡ã€‚

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£ç»å†è¿‡å®æˆ˜çš„é«˜æ€§èƒ½çƒ­ç‚¹ key æ¢æµ‹æ¡†æ¶ï¼Œæ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/KuV5KtpSh8LWXFTU.webp)

#### æ ¸å¿ƒç»„ä»¶

å®ƒçš„ä¸»è¦æ ¸å¿ƒç»„ä»¶å¦‚ä¸‹ï¼š

1ï¼‰Etcd é›†ç¾¤

Etcd ä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½çš„é…ç½®ä¸­å¿ƒï¼Œå¯ä»¥ä»¥æå°çš„èµ„æºå ç”¨ï¼Œæä¾›é«˜æ•ˆçš„ç›‘å¬è®¢é˜…æœåŠ¡ã€‚ä¸»è¦ç”¨äºå­˜æ”¾è§„åˆ™é…ç½®ï¼Œå„ worker çš„ ip åœ°å€ï¼Œä»¥åŠæ¢æµ‹å‡ºçš„çƒ­ keyã€æ‰‹å·¥æ·»åŠ çš„çƒ­ key ç­‰ã€‚

Etcd å¸¸ç”¨äºé…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒï¼Œé±¼çš®åœ¨ [ç¼–ç¨‹å¯¼èˆªçš„æ‰‹å†™ RPC é¡¹ç›®](https://www.code-nav.cn/course/1768543954720022530) ä¸­è®²è§£è¿‡ã€‚

2ï¼‰client ç«¯ jar åŒ…

å°±æ˜¯åœ¨æœåŠ¡ä¸­æ·»åŠ çš„å¼•ç”¨ jarï¼Œå¼•å…¥åï¼Œå°±å¯ä»¥ä¾¿æ·åœ°å»åˆ¤æ–­æŸ key æ˜¯å¦çƒ­ keyã€‚åŒæ—¶ï¼Œè¯¥ jar å®Œæˆäº† key ä¸ŠæŠ¥ã€ç›‘å¬ Etcd é‡Œçš„ rule å˜åŒ–ã€worker ä¿¡æ¯å˜åŒ–ã€çƒ­ key å˜åŒ–ï¼Œå¯¹çƒ­ key è¿›è¡Œæœ¬åœ° Caffeine ç¼“å­˜ç­‰ã€‚

3ï¼‰worker ç«¯é›†ç¾¤

worker ç«¯æ˜¯ä¸€ä¸ªç‹¬ç«‹éƒ¨ç½²çš„ Java ç¨‹åºï¼Œå¯åŠ¨åä¼šè¿æ¥ Etcdï¼Œå¹¶å®šæœŸä¸ŠæŠ¥è‡ªå·±çš„ ip ä¿¡æ¯ï¼Œä¾› client ç«¯è·å–åœ°å€å¹¶è¿›è¡Œé•¿è¿æ¥ã€‚ä¹‹åï¼Œä¸»è¦å°±æ˜¯å¯¹å„ä¸ª client å‘æ¥çš„å¾…æµ‹ key è¿›è¡Œ **ç´¯åŠ è®¡ç®—**ï¼Œå½“è¾¾åˆ° Etcd é‡Œè®¾å®šçš„ rule é˜ˆå€¼åï¼Œå°†çƒ­ key æ¨é€åˆ°å„ä¸ª clientã€‚

4ï¼‰dashboard æ§åˆ¶å°

æ§åˆ¶å°æ˜¯ä¸€ä¸ªå¸¦å¯è§†åŒ–ç•Œé¢çš„ Java ç¨‹åºï¼Œä¹Ÿæ˜¯è¿æ¥åˆ° Etcdï¼Œä¹‹ååœ¨æ§åˆ¶å°è®¾ç½®å„ä¸ª APP çš„ key è§„åˆ™ï¼Œè­¬å¦‚ 2 ç§’å‡ºç° 20 æ¬¡ç®—çƒ­ keyã€‚ç„¶åå½“ worker æ¢æµ‹å‡ºæ¥çƒ­ key åï¼Œä¼šå°† key å‘å¾€ etcdï¼Œdashboard ä¹Ÿä¼šç›‘å¬çƒ­ key ä¿¡æ¯ï¼Œè¿›è¡Œå…¥åº“ä¿å­˜è®°å½•ã€‚åŒæ—¶ï¼Œdashboard ä¹Ÿå¯ä»¥æ‰‹å·¥æ·»åŠ ã€åˆ é™¤çƒ­ keyï¼Œä¾›å„ä¸ª client ç«¯ç›‘å¬ã€‚

æ›´è¯¦ç»†çš„å†…å®¹ï¼Œå¯è§äº¬ä¸œæŠ€æœ¯å›¢é˜Ÿ [å®˜æ–¹çš„æ–‡ç« ](https://mp.weixin.qq.com/s/xOzEj5HtCeh_ezHDPHw6Jw)ï¼Œæœ€å…·å¯ä¿¡åº¦ã€‚

### åç«¯å¼€å‘ï¼ˆhotkey å®æˆ˜ï¼‰

hotkey æ­å»ºå¯ä»¥ç›´æ¥å‚è€ƒ [å®˜æ–¹çš„å®‰è£…æ•™ç¨‹](https://gitee.com/jd-platform-opensource/hotkey#å®‰è£…æ•™ç¨‹)ã€‚

#### 1ã€å®‰è£… Etcd

ç›´æ¥ä»[ github](https://github.com/etcd-io/etcd/releases) ä¸Šä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ Etcd å³å¯ï¼Œé€‰æ‹©å¯¹åº”çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/ivCix54V4yMjRlfK.webp)

æˆ–ç›´æ¥é€šè¿‡æœ¬æ•™ç¨‹æä¾›çš„è½¯ä»¶åŒ…ä¸‹è½½ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA

æå–ç ï¼šc2sd

ä¸‹è½½åè§£å‹å‹ç¼©åŒ…ï¼Œä¼šå¾—åˆ° 3 ä¸ªè„šæœ¬ï¼š

- etcdï¼šetcd æœåŠ¡æœ¬èº«
- etcdctlï¼šå®¢æˆ·ç«¯ï¼Œç”¨äºæ“ä½œ etcdï¼Œæ¯”å¦‚è¯»å†™æ•°æ®
- etcdutlï¼šå¤‡ä»½æ¢å¤å·¥å…·

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/4N8Wwi51aOnktcXB.webp)

æ‰§è¡Œ etcd è„šæœ¬åï¼Œå¯ä»¥å¯åŠ¨ etcd æœåŠ¡ï¼ŒæœåŠ¡é»˜è®¤å ç”¨ 2379 å’Œ 2380 ç«¯å£ï¼Œä½œç”¨åˆ†åˆ«å¦‚ä¸‹ï¼š

- 2379ï¼šæä¾› HTTP API æœåŠ¡ï¼Œå’Œ etcdctl äº¤äº’
- 2380ï¼šé›†ç¾¤ä¸­èŠ‚ç‚¹é—´é€šè®¯

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/8yHD097HMZmMT8wC.webp)

#### 2ã€å®‰è£… hotkey worker

ä» [hotkey å®˜æ–¹ä»“åº“](https://gitee.com/jd-platform-opensource/hotkey) ä¸‹è½½æºç ï¼Œæ³¨æ„ï¼Œæœ¬æ•™ç¨‹ä½¿ç”¨çš„æ˜¯ hotkey v0.0.4 ç‰ˆæœ¬ï¼Œ**JDK çš„ç‰ˆæœ¬å¿…é¡»å°äº 17ï¼å¦åˆ™ä¼šæŠ¥æ‰¾ä¸åˆ°ç±»çš„é”™è¯¯ï¼**

é¡¹ç›®å¯¼å…¥ IDEA åï¼Œæ‰“å¼€ worker æ¨¡å—ã€‚worker æ˜¯ä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œå¯åŠ¨å‰éœ€è¦å…ˆä¿®æ”¹ applicaiton.yml ä¸­çš„é…ç½®ã€‚æ¯”å¦‚ç«¯å£é…ç½®ï¼ˆæœ¬æ•™ç¨‹ä½¿ç”¨ 8111ï¼‰ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/uvRh2GfSS1AHjxz7.webp)

ä¿®æ”¹å®Œé…ç½®åï¼Œç›´æ¥ç‚¹å‡» WorkerApplication å¯åŠ¨å³å¯ã€‚

å¦‚ä¸‹å›¾ï¼Œæ­¤æ—¶ worker å°±å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œå¹¶ä¸”è¿æ¥ä¸Š Etcd äº†ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/H593KpG0czmOFHZm.webp)

åç»­å¦‚æœè¦æ‰“åŒ…éƒ¨ç½²ï¼Œå¯ä»¥é€šè¿‡ Maven æ‰“åŒ…å¾—åˆ° worker çš„ jar åŒ…ï¼Œæ¯”å¦‚åœ¨æ•´ä¸ª hotkey é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ mvn packageï¼Œä¼šä¾æ¬¡å¯¹å„æ¨¡å—æ‰“åŒ…ã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/6xLlzaKp9s3YjYPz.webp)

ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½å·²ç»æ‰“åŒ…å¥½çš„ jarï¼Œæœ¬æ•™ç¨‹ä¸ºå¤§å®¶æä¾›äº†è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

ç„¶åå¯ä»¥é€šè¿‡å‘½ä»¤å¯åŠ¨ workerï¼Œå¯ä»¥æºå¸¦å‚æ•°æ¥ä¿®æ”¹é…ç½®ï¼š

```shell
java -jar worker-0.0.4-SNAPSHOT.jar --etcd.server=127.0.0.1:2379
```

#### 3ã€å¯åŠ¨ hotkey æ§åˆ¶å°

æ¥ç€æ‰“å¼€ dashboard é¡¹ç›®ï¼Œæ‰§è¡Œ resource ç›®å½•ä¸‹çš„ db.sql æ–‡ä»¶ï¼Œåˆ›å»º dashboard æ‰€éœ€çš„åº“è¡¨ã€‚hotkey ä¾èµ– MySQL æ¥å­˜å‚¨ç”¨æˆ·è´¦å·ä¿¡æ¯ã€çƒ­ç‚¹é˜ˆå€¼è§„åˆ™ç­‰ã€‚

åœ¨æ‰§è¡Œè„šæœ¬å‰ï¼Œè®°å¾—å…ˆé…ç½®å¥½ MySQL è¿æ¥ï¼Œå¹¶ä¸”åœ¨ SQL è„šæœ¬æ–‡ä»¶ä¸­åˆ›å»ºå’ŒæŒ‡å®šæ•°æ®åº“ï¼š

```sql
create database hotkey_db;
use hotkey_db;
```

æ‰§è¡Œè„šæœ¬è¿‡ç¨‹å¦‚å›¾ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/WAwJSTI41rbCCkEM.webp)

ä» db.sql ä¸­å¯ä»¥çœ‹åˆ°å†…ç½®äº† admin è´¦å·ï¼Œ å¯†ç ä¸º 123456

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/J0j8bMjq2qY3ZaEX.webp)

ç„¶åä¿®æ”¹ä¸‹ application.yml é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ dashboard å ç”¨ç«¯å£å·ï¼ˆæœ¬æ•™ç¨‹ä½¿ç”¨ 8121ï¼‰ã€æ•°æ®åº“é…ç½®å’Œ etcdServer åœ°å€ç­‰ï¼š

```yaml
server:
  port: 8121
spring:
  datasource:
    username: ${MYSQL_USER:root}
    password: ${MYSQL_PASS:123456}
    url: jdbc:mysql://${MYSQL_HOST:localhost}:3306/hotkey_db?useUnicode=true&characterEncoding=utf-8&useSSL=true&serverTimezone=UTC&useTimezone=true&serverTimezone=GMT
    driver-class-name: com.mysql.cj.jdbc.Driver
etcd:
  server: ${etcdServer:http://127.0.0.1:2379}
```

dashboard ä¹Ÿæ˜¯ä¸€ä¸ª SpringBoot é¡¹ç›®ï¼Œç›´æ¥åœ¨ IDEA å†…æ‰§è¡Œ DashboardApplication å¯åŠ¨å³å¯ã€‚

è®¿é—® [http://127.0.0.1:8121ï¼Œå³å¯çœ‹åˆ°ç•Œé¢ï¼š](http://127.0.0.1:8121ï¼Œå³å¯çœ‹åˆ°ç•Œé¢ï¼š/)

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/rDxx5A4t6HapS8YC.webp)

è¾“å…¥ç®¡ç†å‘˜çš„è´¦å·å¯†ç ï¼ˆadminï¼Œ123456ï¼‰åï¼Œå³å¯æˆåŠŸç™»å½•ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/bzXVSN7MbHtmD0CR.webp)

åˆæ¬¡ä½¿ç”¨æ—¶éœ€è¦å…ˆæ·»åŠ  APPã€‚å»ºè®®å…ˆåœ¨ç”¨æˆ·ç®¡ç†èœå•ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œè®¾ç½®æ˜µç§°ä¸º APP åç§°ã€å¹¶å¡«å†™æ‰€å± APPï¼Œå¦‚ mianshiyaï¼Œå¯†ç æ­¤å¤„å°±è®¾ç½®ä¸º 123456ã€‚ä¹‹åå°±å¯ä»¥ç™»å½•è¿™ä¸ªæ–°å»ºçš„ç”¨æˆ·æ¥ç»™åº”ç”¨è®¾ç½®è§„åˆ™äº† (å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ admin è´¦æˆ·æ·»åŠ )ï¼Œè€Œä¸”ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª APPã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/8F85IqnVcGYgPvZG.webp)

éšåï¼Œåœ¨è§„åˆ™é…ç½®ä¸­ï¼Œé€‰æ‹©å¯¹åº”çš„ APPï¼Œæ–°å¢å¯¹åº”çš„çƒ­ç‚¹æ¢æµ‹è§„åˆ™ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/sDgGXthtIqoiQ3o3.webp)

å¦‚ä¸‹å›¾å°±æ˜¯ä¸€ç»„è§„åˆ™ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/3siXuCT2KLlPukgE.webp)

æˆ‘ä»¬è§£æä¸‹å…¶ä¸­çš„ç¬¬äºŒæ¡ ruleï¼š as__ å¼€å¤´çš„çƒ­ key çš„è§„åˆ™å°±æ˜¯ interval-2 ç§’å†…å‡ºç°äº† threshold-10 æ¬¡å°±è®¤ä¸ºå®ƒæ˜¯çƒ­ keyï¼Œå®ƒå°±ä¼šè¢«æ¨é€åˆ° jvm å†…å­˜ä¸­ï¼Œå¹¶ç¼“å­˜ 60 ç§’ï¼Œprefix-true ä»£è¡¨å‰ç¼€åŒ¹é…ã€‚é‚£ä¹ˆåœ¨åº”ç”¨ä¸­ï¼Œå°±å¯ä»¥æŠŠä¸€ç»„ keyï¼Œéƒ½ç”¨ as__ å¼€å¤´ï¼Œç”¨æ¥æ¢æµ‹ã€‚

#### 4ã€å¼•å…¥ hotkey client

æœ‰ 2 ç§å¼•å…¥ hotkey client çš„æ–¹å¼ï¼š

1. æ‰‹åŠ¨æºç æ‰“åŒ…
2. é€šè¿‡ [Maven è¿œç¨‹ä»“åº“](https://mvnrepository.com/artifact/io.github.ck-jesse/jd-hotkey-client) å¼•å…¥

ç”±äº Maven è¿œç¨‹ä»“åº“çš„åŒ…å¼•ç”¨é‡è¿‡å°‘ï¼Œè€Œä¸”ä¸å…·å¤‡å®˜æ–¹æƒå¨æ€§ï¼Œæ‰€ä»¥æ›´æ¨èé€šè¿‡ hotkey æºç æ‰‹åŠ¨æ‰“åŒ…ã€‚ï¼ˆç»è¿‡é±¼çš®è¸©å‘æµ‹è¯•ï¼Œæœç„¶å¼•å…¥è¿œç¨‹ä»“åº“çš„åŒ…åå‡ºç°äº†å®¢æˆ·ç«¯å’Œ worker ä¹‹é—´å¿ƒè·³å¤±è´¥çš„é—®é¢˜ï¼‰

æ‰€ä»¥é€‰æ‹©æ–¹å¼ 1ï¼Œæ‰‹åŠ¨å°† hotkey æºç ä¸­çš„ client æ¨¡å—é€šè¿‡ Maven æ‰“æˆ jar åŒ…ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/x0o1eiCNqSl8556B.webp)

ä»ç”Ÿæˆçš„ target ä¸­æ‰¾åˆ° `with-dependencies` çš„ jar åŒ…ï¼Œå¯ä»¥ä¿®æ”¹åç§°ä¸º `hotkey-client-0.0.4-SNAPSHOT.jar`ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/7cmThW6uXobYpSeO.webp)

ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½å·²ç»æ‰“åŒ…å¥½çš„ jarï¼Œæœ¬æ•™ç¨‹ä¸ºå¤§å®¶æä¾›äº†è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

æ¥ç€åœ¨è¦å¼•å…¥ hotkey client çš„é¡¹ç›®ä¸­åˆ›å»º lib æ–‡ä»¶å¤¹ï¼Œæ”¾å…¥ client çš„ jar åŒ…ã€‚æ³¨æ„è¦æŠŠè¯¥ jar åŒ…æ·»åŠ åˆ° Git ä»“åº“ä¸­ï¼Œå¦åˆ™å…¶ä»–äººæ— æ³•æ­£å¸¸è¿è¡Œä½ çš„é¡¹ç›®ã€‚

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/8tTBIow4QgwYvcPF.webp)

ç„¶åé€šè¿‡ Maven å¼•å…¥å³å¯ï¼š

```xml
<dependency>
  <artifactId>hotkey-client</artifactId>
  <groupId>com.jd.platform.hotkey</groupId>
  <version>0.0.4-SNAPSHOT</version>
  <scope>system</scope>
  <systemPath>${project.basedir}/lib/hotkey-client-0.0.4-SNAPSHOT.jar</systemPath>
</dependency>
```

ä½†æ˜¯åœ¨æœ¬é¡¹ç›®ä¸­å¼•å…¥è¯¥ä¾èµ–åï¼Œé¡¹ç›®æ— æ³•è¿è¡Œï¼Œå› ä¸º Hutool ä¾èµ–åº“ç‰ˆæœ¬å†²çªäº†ã€‚

ğŸ’¡ æ³¨æ„ï¼Œä½¿ç”¨ `system` ä½œç”¨åŸŸå¹¶ä¸æ˜¯æœ€ä½³å®è·µï¼ŒåŸå› æ˜¯ `system` ä½œç”¨åŸŸçš„ä¾èµ–å…·æœ‰ **æœ€é«˜ä¼˜å…ˆçº§**ã€‚å®ƒä¼šè·³è¿‡ Maven çš„ä¾èµ–è§£ææœºåˆ¶ï¼Œç›´æ¥ä½¿ç”¨ä½ æŒ‡å®šçš„æœ¬åœ° JAR æ–‡ä»¶ï¼Œå› æ­¤å®ƒçš„ä¼˜å…ˆçº§ä¼šé«˜äºå…¶ä»–ä»»ä½•æ¥è‡ªä¾èµ–æ ‘ä¸­çš„ä¼ é€’ä¾èµ–æˆ–å¤–å±‚ä¾èµ–å£°æ˜ã€‚

å…·ä½“æ¥è¯´ï¼š

1. è·³è¿‡ä¾èµ–ç®¡ç†ï¼š`system` ä½œç”¨åŸŸä¼šè·³è¿‡ Maven çš„ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬è§£æã€‚ä½ å¿…é¡»æ‰‹åŠ¨ç®¡ç†ä¾èµ–ç‰ˆæœ¬å’Œè·¯å¾„ï¼ŒMaven æ— æ³•å¸®ä½ è§£æå†²çªã€å‡çº§ç‰ˆæœ¬æˆ–ä½¿ç”¨ä¼ é€’ä¾èµ–ã€‚
2. æ— æ³•æ’é™¤ä¾èµ–ï¼šç”±äº `system` ä½œç”¨åŸŸæ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä»»ä½•è¯•å›¾é€šè¿‡ `exclusions` æ’é™¤è¿™ä¸ªä¾èµ–çš„å°è¯•éƒ½ä¼šå¤±è´¥ã€‚å…¶ä»–æ¨¡å—æˆ–ä¾èµ–é¡¹ä¸­çš„å†²çªé—®é¢˜ä¹Ÿæ— æ³•é€šè¿‡æ­£å¸¸çš„ `dependencyManagement` æˆ– `exclusions` æœºåˆ¶æ¥è§£å†³ã€‚
3. ä¸å¯ä¼ é€’ï¼š`system` ä½œç”¨åŸŸçš„ä¾èµ–ä¸ä¼šä¼ é€’ç»™å…¶ä»–æ¨¡å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ çš„é¡¹ç›®è¢«å…¶ä»–é¡¹ç›®ä¾èµ–ï¼Œ`system` ä½œç”¨åŸŸçš„ä¾èµ–ä¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™ä¾èµ–ä½ çš„é¡¹ç›®ã€‚è¿™å¯èƒ½å¯¼è‡´æ„å»ºæˆ–è¿è¡Œæ—¶çš„ä¾èµ–é—®é¢˜ã€‚
4. è·¯å¾„ç¡¬ç¼–ç ï¼š`system` ä½œç”¨åŸŸçš„ä¾èµ–è·¯å¾„æ˜¯ç¡¬ç¼–ç çš„ï¼Œå¹¶ä¸”æŒ‡å®šä¸ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚è¿™ä½¿å¾—é¡¹ç›®åœ¨ä¸åŒå¼€å‘ç¯å¢ƒä¸­å˜å¾—éš¾ä»¥ç§»æ¤ï¼Œä¹Ÿä¸ç¬¦åˆ Maven çš„é€šç”¨ä¾èµ–ç®¡ç†åŸåˆ™ã€‚

æ‰€ä»¥ä¸€èˆ¬å»ºè®®å°†ä¾èµ–åŒ…é€šè¿‡ Maven å®‰è£…ï¼ˆinstallï¼‰åˆ°æœ¬åœ°ä»“åº“ï¼Œæˆ–è€…ä¸Šä¼ åŒ…åˆ° Maven å®˜æ–¹åº“ï¼Œæˆ–è€…åœ¨å›¢é˜Ÿå†…éƒ¨ä½¿ç”¨ Maven ç§æœæ¥ç®¡ç†ä¾èµ–ã€‚

ä½†è¿™é‡Œæˆ‘ä»¬ä¸è¿™ä¹ˆåšï¼Œè€ƒè™‘åˆ°æ•™ç¨‹é¡¹ç›®ï¼Œè¦è®©å¼€å‘è€…æ›´å®¹æ˜“åœ°ä½¿ç”¨é¡¹ç›®ã€‚æ‰€ä»¥è¿˜æ˜¯ç›´æ¥æ‹·è´ jarï¼Œå¼€å‘è€…å°±ä¸ç”¨è‡ªå·± mvn install æ¥å®‰è£…åŒ…äº†ï¼Œå¦åˆ™è¿˜å¯èƒ½å‡ºç°æŠ¥é”™ã€‚

å…¶å®è¿˜æœ‰æ›´ç²—æš´çš„æ–¹æ³•ï¼Œç›´æ¥çˆ†æ”¹æºç ä¸­ä½¿ç”¨çš„ hutool ç‰ˆæœ¬ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸å»ºè®®è¿™ä¹ˆåšï¼Œæ¯•ç«Ÿä½ ä¸äº†è§£åˆ«äººçš„é¡¹ç›®ï¼Œè¿˜æ˜¯è¯¥è‡ªå·±çš„æ–¹ä¾¿ä¸€äº›ã€‚

æ‰€ä»¥æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼Œé™ä½é¡¹ç›®çš„ hutool ç‰ˆæœ¬ï¼Œæ”¹åŠ¨ç‚¹ä¹Ÿä¸å¤šï¼Œæ‰€ä»¥è¿˜å¥½ã€‚

æ¯”å¦‚ï¼š

```java
if (StrUtil.isNotBlank(tagsStr)) {
    questionEsDTO.setTags(JSONUtil.toList(JSONUtil.parseArray(tagsStr), String.class));
}
String fileSuffix = FileNameUtil.getSuffix(multipartFile.getOriginalFilename());
```

å¼•å…¥ä¾èµ–åï¼Œåœ¨ä»£ç ä¸­ç¼–å†™åˆå§‹åŒ– client çš„é…ç½®ç±»ï¼Œä¼šè¯»å–é…ç½®æ–‡ä»¶å¹¶æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "hotkey")
@Data
public class HotKeyConfig {

    /**
     * Etcd æœåŠ¡å™¨å®Œæ•´åœ°å€
     */
    private String etcdServer = "http://127.0.0.1:2379";

    /**
     * åº”ç”¨åç§°
     */
    private String appName = "app";

    /**
     * æœ¬åœ°ç¼“å­˜æœ€å¤§æ•°é‡
     */
    private int caffeineSize = 10000;

    /**
     * æ‰¹é‡æ¨é€ key çš„é—´éš”æ—¶é—´
     */
    private long pushPeriod = 1000L;

    /**
     * åˆå§‹åŒ– hotkey
     */
    @Bean
    public void initHotkey() {
        ClientStarter.Builder builder = new ClientStarter.Builder();
        ClientStarter starter = builder.setAppName(appName)
                .setCaffeineSize(caffeineSize)
                .setPushPeriod(pushPeriod)
                .setEtcdServer(etcdServer)
                .build();
        starter.startPipeline();
    }
}
```

ğŸ’¡ å¦‚ä½•åœ¨ Spring Boot å¯åŠ¨æ—¶æ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼Ÿå¯ä»¥å‚è€ƒè¿™é“é¢è¯•é¢˜ï¼šhttps://www.mianshiya.com/question/1800329866123747329

æ›´æ”¹ application.yml é…ç½®ï¼Œæ³¨æ„åº”ç”¨åç§°å¿…é¡»å’Œæ§åˆ¶å°åˆ›å»ºçš„ä¸€è‡´ï¼š

```yaml
# çƒ­ key æ¢æµ‹
hotkey:
  app-name: mianshiya
  caffeine-size: 10000
  push-period: 1000
  etcd-server: http://localhost:2379
```

å¯åŠ¨ï¼Œèƒ½å¤Ÿçœ‹åˆ° 1 ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/1jz3IE4KOPdkmrZO.webp)

è¿™æ ·åœ¨é¡¹ç›®ä¸­å°±èƒ½æ­£å¸¸ä½¿ç”¨äº†ã€‚

#### 5ã€äº†è§£å¼€å‘æ¨¡å¼

åªè¦ä½¿ç”¨ JdHotKeyStore è¿™ä¸ªç±»å³å¯éå¸¸æ–¹ä¾¿åœ°åˆ¤æ–­ key æ˜¯å¦æˆä¸ºçƒ­ç‚¹å’Œè·å–çƒ­ç‚¹ key å¯¹åº”çš„æœ¬åœ°ç¼“å­˜ã€‚

è¿™ä¸ªç±»ä¸»è¦æœ‰å¦‚ä¸‹ 4 ä¸ªæ–¹æ³•å¯ä¾›ä½¿ç”¨ï¼š

```java
boolean JdHotKeyStore.isHotKey(String key)
Object JdHotKeyStore.get(String key)
void JdHotKeyStore.smartSet(String key, Object value)
Object JdHotKeyStore.getValue(String key)
```

1ï¼‰boolean isHotKey(String key)

è¯¥æ–¹æ³•ä¼šè¿”å›è¯¥ key æ˜¯å¦æ˜¯çƒ­ keyï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦‚æœä¸æ˜¯è¿”å› falseï¼Œå¹¶ä¸”ä¼šå°† key ä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡è®¡ç®—ã€‚è¯¥æ–¹æ³•é€šå¸¸ç”¨äºåˆ¤æ–­åªéœ€è¦åˆ¤æ–­ key æ˜¯å¦çƒ­ã€ä¸éœ€è¦ç¼“å­˜ value çš„åœºæ™¯ï¼Œå¦‚åˆ·å­ç”¨æˆ·ã€æ¥å£è®¿é—®é¢‘ç‡ç­‰ã€‚

2ï¼‰Object get(String key)

è¯¥æ–¹æ³•è¿”å›è¯¥ key æœ¬åœ°ç¼“å­˜çš„ value å€¼ï¼Œå¯ç”¨äºåˆ¤æ–­æ˜¯çƒ­ key åï¼Œå†å»è·å–æœ¬åœ°ç¼“å­˜çš„ value å€¼ï¼Œé€šå¸¸ç”¨äº redis çƒ­ key ç¼“å­˜ã€‚

3ï¼‰void smartSet(String key, Object value)

æ–¹æ³•ç»™çƒ­ key èµ‹å€¼ valueï¼Œå¦‚æœæ˜¯çƒ­ keyï¼Œè¯¥æ–¹æ³•æ‰ä¼šèµ‹å€¼ï¼Œéçƒ­ keyï¼Œä»€ä¹ˆä¹Ÿä¸åš

4ï¼‰Object getValue(String key)

è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ•´åˆæ–¹æ³•ï¼Œç›¸å½“äº isHotKey å’Œ get ä¸¤ä¸ªæ–¹æ³•çš„æ•´åˆï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›æœ¬åœ°ç¼“å­˜çš„ valueã€‚ å¦‚æœæ˜¯çƒ­ keyï¼Œåˆ™å­˜åœ¨ä¸¤ç§æƒ…å†µ

1. æ˜¯è¿”å› value
2. æ˜¯è¿”å› null

è¿”å› null æ˜¯å› ä¸ºå°šæœªç»™å®ƒ set çœŸæ­£çš„ valueï¼Œè¿”å›é null è¯´æ˜å·²ç»è°ƒç”¨è¿‡ set æ–¹æ³•äº†ï¼Œæœ¬åœ°ç¼“å­˜ value æœ‰å€¼äº†ã€‚ å¦‚æœä¸æ˜¯çƒ­ keyï¼Œåˆ™è¿”å› nullï¼Œå¹¶ä¸”å°† key ä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡æ¢æµ‹ã€‚

**å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µ**

1ï¼‰åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯åˆ·å­ï¼š

```java
if (JdHotKeyStore.isHotKey(â€œpin__â€ + thePin)) {
    // è¿›è¡Œé™æµ
}
```

2ï¼‰åˆ¤æ–­å•†å“ id æ˜¯å¦æ˜¯çƒ­ç‚¹ï¼š

```java
Object skuInfo = JdHotKeyStore.getValue("skuId__" + skuId);
if(skuInfo == null) {
    JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
} else {
    // ä½¿ç”¨ç¼“å­˜å¥½çš„ value å³å¯
}
```

ä¸ªäººæ›´æ¨èè¿™ç§å†™æ³•ï¼Œæ›´åŠ æ¸…æ™°ï¼š

```java
if (JdHotKeyStore.isHotKey(key)) {
    //æ³¨æ„æ˜¯getï¼Œä¸æ˜¯getValueã€‚getValueä¼šè·å–å¹¶ä¸ŠæŠ¥ï¼Œgetæ˜¯çº¯ç²¹çš„æœ¬åœ°è·å–
    Object skuInfo = JdHotKeyStore.get("skuId__" + skuId);
    if(skuInfo == null) {
        JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
    } else {
        //ä½¿ç”¨ç¼“å­˜å¥½çš„valueå³å¯
    }
}
```

#### 6ã€é…ç½® hotkey è§„åˆ™

æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ¤æ–­ `bank_detail_` å¼€å¤´çš„ keyï¼Œå¦‚æœ 5 ç§’è®¿é—® 10 æ¬¡ï¼Œå°±ä¼šè¢«æ¨é€åˆ° jvm å†…å­˜ä¸­ï¼Œå°†è¿™ä¸ªçƒ­ key ç¼“å­˜ 10 åˆ†é’Ÿã€‚

å¯¹åº”çš„è§„åˆ™é…ç½®å¦‚ä¸‹ï¼š

```json
[
    {
        "duration": 600,
        "key": "bank_detail_",
        "prefix": true,
        "interval": 5,
        "threshold": 10,
        "desc": "çƒ­é—¨é¢˜åº“ç¼“å­˜"
    }
]
```

åœ¨æ§åˆ¶å°æ–°å¢è§„åˆ™ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/xX87grv8ABrqPjqO.webp)

#### 7ã€é¡¹ç›®åº”ç”¨ hotkey

è·å–é¢˜åº“æ¥å£ getQuestionBankVOByIdï¼Œå…ˆé€šè¿‡ isHotKey åˆ¤æ–­å½“å‰é¢˜ç›®æ˜¯å¦æ˜¯çƒ­ç‚¹é¢˜ç›®ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä»æ•°æ®åº“è·å–åæ”¾å…¥æœ¬åœ°ç¼“å­˜ï¼›ä¹‹åç›´æ¥ä»æœ¬åœ°ç¼“å­˜è·å–å³å¯ã€‚

```java
@GetMapping("/get/vo")
public BaseResponse<QuestionBankVO> getQuestionBankVOById(QuestionBankQueryRequest questionBankQueryRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(questionBankQueryRequest == null, ErrorCode.PARAMS_ERROR);
    Long id = questionBankQueryRequest.getId();
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);

    // ç”Ÿæˆ key
    String key = "bank_detail_" + id;
    // å¦‚æœæ˜¯çƒ­ key
    if (JdHotKeyStore.isHotKey(key)) {
        // ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–ç¼“å­˜å€¼
        Object cachedQuestionBankVO = JdHotKeyStore.get(key);
        if (cachedQuestionBankVO != null) {
            // å¦‚æœç¼“å­˜ä¸­æœ‰å€¼ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„å€¼
            return ResultUtils.success((QuestionBankVO) cachedQuestionBankVO);
        }
    }

    // åŸæœ¬æŸ¥è¯¢æ•°æ®çš„é€»è¾‘ï¼ˆæŸ¥æ•°æ®åº“ï¼‰

    // è®¾ç½®æœ¬åœ°ç¼“å­˜
    JdHotKeyStore.smartSet(key, questionBankVO);
    
    // è·å–å°è£…ç±»
    return ResultUtils.success(questionBankVO);
}
```

#### 8ã€æµ‹è¯•éªŒè¯

ä¸è®¾ç½®è§„åˆ™çš„è¯ï¼Œæ˜¯ä¸ä¼šåˆ¤æ–­ä¸ºçƒ­ key çš„ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/wuHcJnmGaBS6pIeG.webp)

é€šè¿‡æ¥å£æ–‡æ¡£ 5 ç§’å†…å…ˆè®¿é—® 10 æ¬¡ï¼Œèƒ½å¤Ÿçœ‹åˆ°å®æ—¶çƒ­ç‚¹ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/Z6e3qGm8KGliC6B4.webp)![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/ZIyZ16pFqENVlJa7.webp)

debug ç¨‹åºï¼Œç¬¬ 11 æ¬¡è¯·æ±‚çš„æ—¶å€™è™½ç„¶ä¼šåˆ¤æ–­ä¸º hotkeyï¼Œä½†è¿˜æ˜¯ä¸ä¼šèµ°ç¼“å­˜ï¼Œæœ¬æ¬¡è¯·æ±‚ä¼šè®¾ç½®ç¼“å­˜ã€‚åç»­å°±èƒ½æŸ¥è¯¢ç¼“å­˜äº†ã€‚

### æ‰©å±•çŸ¥è¯†

#### 1ã€å¦‚ä½•æ›´æ–°æœ¬åœ°ç¼“å­˜

éœ€è¦æœ‰ä¸€ä¸ªå…¥å£è®©ç¼“å­˜å¤±æ•ˆï¼Œè¿›è¡Œäººå·¥å¹²é¢„ã€‚

hotkey æä¾›äº† `JdHotKeyStore.remove()` æ–¹æ³•ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ é™¤æœ¬åœ°ç¼“å­˜å¹¶ç§»é™¤çƒ­ç‚¹ keyã€‚

è¿˜å¯ä»¥åˆ©ç”¨æ§åˆ¶å°æ‰‹åŠ¨åˆ é™¤ï¼š

![img](./assets/06-ç®¡ç†èƒ½åŠ›æ‹“å±•/T6VqUi0PWj9SCGUE.webp)

ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œçƒ­ç‚¹ä¿¡æ¯ä¸€èˆ¬éƒ½æ˜¯ä¸å¤ªä¼šå˜æ›´çš„æ•°æ®ï¼Œè¿‡æœŸæ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹å³å¯ã€‚

#### 2ã€æ˜¯å¦èƒ½å¤Ÿå’Œ redis åˆ†å¸ƒå¼ç¼“å­˜ç»“åˆï¼Ÿ

å½“ç„¶å¯ä»¥ï¼Œçƒ­ key æ¢æµ‹ = çƒ­ key å‘ç° + æœ¬åœ°ç¼“å­˜ã€‚å¯ä»¥åªåˆ©ç”¨çƒ­ key çš„åˆ¤æ–­æ–¹æ³•ï¼Œä¸åˆ©ç”¨çƒ­ key çš„å­˜å‚¨æ–¹æ³•å³å¯ã€‚

1. ä¸æ˜¯çƒ­ keyï¼Œå°±æŸ¥æ•°æ®åº“ã€‚å¯¹äºçƒ­ keyï¼Œå†™ç¼“å­˜æ—¶ï¼Œå†åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦ä¸ºçƒ­ keyï¼Œæ˜¯çƒ­ key æ‰è®¾ç½® Redis åˆ†å¸ƒå¼ç¼“å­˜ã€‚åç»­çš„çƒ­ key å°±å¯ä»¥ä»åˆ†å¸ƒå¼ç¼“å­˜ä¸­è·å–å€¼ã€‚ï¼ˆç¼“å­˜å­˜å‚¨çš„æŠ€æœ¯æˆ–è€…ä½ç½®å˜äº†ï¼‰
2. åˆ©ç”¨çƒ­ key æ¢æµ‹çš„æœ¬åœ°ç¼“å­˜ï¼Œå°†åŸæœ¬æŸ¥æ•°æ®åº“çš„é€»è¾‘æ”¹ä¸ºæŸ¥ Redisï¼ŒRedis æŸ¥ä¸åˆ°æ‰æŸ¥è¯¢æ•°æ®åº“ï¼Œå½¢æˆå¤šçº§ç¼“å­˜ã€‚ï¼ˆè·å–åŸå§‹æ•°æ®çš„æ–¹æ³•æ”¹å˜äº†ï¼‰

#### 3ã€çƒ­ key ä¼šè‡ªåŠ¨ç»­æœŸä¹ˆï¼Ÿå¦åˆ™å¯èƒ½å‡ºç°ç¼“å­˜é›ªå´©çš„é—®é¢˜ï¼Ÿ

å¯ä»¥å…ˆè‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚æ¯”å¦‚é’ˆå¯¹æŸä¸ªçƒ­ç‚¹ key å†å¤šæ¬¡å‘é€è¯·æ±‚æŸ¥è¯¢ç¼“å­˜ï¼Œå‘ç°åœ¨çƒ­ key ç”Ÿæ•ˆï¼ˆç¼“å­˜ç”Ÿæ•ˆï¼‰æœŸé—´ï¼Œå¦‚æœè¯¥ key ä»ç„¶è¢«ä¸æ–­è®¿é—®ï¼Œå¹¶ä¸ä¼šåˆ·æ–°ç¼“å­˜æ—¶é—´ï¼Œç›´åˆ°è¿‡æœŸã€‚

ç„¶åçœ‹ä¸‹æºç ï¼Œå°±çŸ¥é“ä¸ºä»€ä¹ˆäº†ã€‚æºç ä¸­çš„é€»è¾‘æ˜¯ï¼Œå¦‚æœå·²ç»æ˜¯çƒ­ key åˆ™ä¸ä¼šå† pushï¼Œç¦»è¿‡æœŸè¿˜æœ‰ 2 ç§’å†…çš„æ—¶å€™ï¼Œä¼šå†æ¬¡ pushï¼Œè¿™æ ·è¿™ä¸ª key å¯èƒ½è¢«ç»§ç»­è®¾ç½®ä¸ºçƒ­ keyã€‚

```java
public static boolean isHotKey(String key) {
    try {
        if (!inRule(key)) {
            return false;
        } else {
            boolean isHot = isHot(key);
            if (!isHot) {
                HotKeyPusher.push(key, (KeyType)null);
            } else {
                ValueModel valueModel = getValueSimple(key);
                if (isNearExpire(valueModel)) {
                    HotKeyPusher.push(key, (KeyType)null);
                }
            }

            KeyHandlerFactory.getCounter().collect(new KeyHotModel(key, isHot));
            return isHot;
        }
    } catch (Exception var3) {
        return false;
    }
}

private static boolean isNearExpire(ValueModel valueModel) {
    if (valueModel == null) {
        return true;
    } else {
        return valueModel.getCreateTime() + (long)valueModel.getDuration() - System.currentTimeMillis() <= 2000L;
    }
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ª key æŒç»­è¢«è®¿é—®ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨è¿‡æœŸå‰ä¸€ç›´è¢«è®¾ç½®ä¸ºçƒ­ç‚¹ï¼Œå‡å°‘äº†å‡ºç°é›ªå´©é—®é¢˜çš„å¯èƒ½æ€§ã€‚

### æ‰©å±•

1ï¼‰çƒ­ç‚¹é¢˜ç›®å¢åŠ è‡ªåŠ¨ç¼“å­˜

æ€è·¯ï¼šè·Ÿæœ¬æ•™ç¨‹æ¼”ç¤ºçš„çƒ­ç‚¹é¢˜åº“å®Œå…¨ä¸€è‡´ã€‚

2ï¼‰ç¼–å†™ä¸€ä¸ªæ³¨è§£ï¼Œè‡ªåŠ¨å¯¹è¯¥æ–¹æ³•è¿›è¡Œçƒ­ key æ¢æµ‹ï¼Œå¹¶å°†è¿”å›å€¼ä½œä¸ºæœ¬åœ°ç¼“å­˜

æ€è·¯ï¼šå‚è€ƒ Spring Data Redis æä¾›çš„ @Cacheable æ³¨è§£ï¼Œå¯ä»¥åˆ©ç”¨ AOP æ‰«ææ³¨è§£å®ç°ã€‚