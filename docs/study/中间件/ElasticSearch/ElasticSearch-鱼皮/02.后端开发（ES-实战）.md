### åç«¯å¼€å‘ï¼ˆES å®æˆ˜ï¼‰

#### 1ã€Elasticsearch æ­å»º

ç›®æ ‡ï¼šå®‰è£… Elasticsearch å’Œ Kibanaï¼Œèƒ½å¤Ÿåœ¨ Kibana æŸ¥çœ‹åˆ° Elasticsearch å­˜å‚¨çš„æ•°æ®ã€‚

ğŸ’¡ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨äº‘ Elasticsearch æœåŠ¡ï¼Œçœå»è‡ªä¸»æ­å»ºçš„æ—¶é—´ï¼Œæ¨èä½¿ç”¨ Serverless ç‰ˆæœ¬ï¼Œå­¦å®Œå…³æ‰å°±è¡Œã€‚

**Elasticsearch æ›´æ–°è¿­ä»£éå¸¸å¿«ï¼Œæ‰€ä»¥å®‰è£…æ—¶ï¼Œä¸€å®šè¦æ³¨æ„æ…é‡é€‰æ‹©ç‰ˆæœ¬å·ï¼**

ç”±äºæˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ç”¨çš„ Spring Boot 2.x ç‰ˆæœ¬ï¼Œå¯¹åº”çš„ [Spring Data Elasticsearch](https://spring.io/projects/spring-data-elasticsearch) å®¢æˆ·ç«¯ç‰ˆæœ¬æ˜¯ 4.xï¼Œæ”¯æŒçš„ Elasticsearch æ˜¯ 7.xï¼Œæ‰€ä»¥å»ºè®® Elasticsearch ä½¿ç”¨ 7.x çš„ç‰ˆæœ¬ã€‚

é±¼çš®æ•™ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯ 7.17 ç‰ˆæœ¬ï¼Œè¿™æ˜¯ 7.x ç³»åˆ—çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼ŒåŒ…å«äº†è¯¥ç³»åˆ—æ‰€æœ‰çš„ bug ä¿®å¤å’Œæ”¹è¿›ï¼Œè¢«å¹¿æ³›è®¤ä¸ºæ˜¯æœ€ç¨³å®šçš„ã€‚

ğŸ’¡ å¯ä»¥åœ¨ [å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-data/elasticsearch/reference/elasticsearch/versions.html) äº†è§£åˆ°ç‰ˆæœ¬å…¼å®¹æƒ…å†µï¼šæ¯”å¦‚ Spring 6 æ‰æ”¯æŒ Elasticsearch 8.x

1ï¼‰å®‰è£… Elasticsearch

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html

Windows è§£å‹å®‰è£…ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html

å…¶ä»–æ“ä½œç³»ç»Ÿå®‰è£…ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.17/targz.html

å¦‚æœå®˜ç½‘ä¸‹ä¸åŠ¨ï¼Œå¯ä»¥ç”¨é±¼çš®å·²ç»ä¸‹è½½å¥½çš„ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

**æ³¨æ„ï¼Œå®‰è£…è·¯å¾„ä¸è¦åŒ…å«ä¸­æ–‡ï¼**

å®‰è£…å®Œæˆåè¿›å…¥ es ç›®å½•å¹¶æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š

```plain
.\bin\elasticsearch.bat
```

å¯ä»¥ç”¨ CURL æµ‹è¯•æ˜¯å¦å¯åŠ¨æˆåŠŸï¼š

```shell
curl -X GET "localhost:9200/?pretty"
```

æ­£å¸¸è¾“å‡ºå¦‚å›¾ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/TYOiILfTUAc6tkAu.webp)

åœ¨ Windows ç³»ç»Ÿä¸Šï¼Œä½ è¿˜å¯ä»¥é€‰æ‹©æ˜¯å¦å®‰è£…ä¸ºæœåŠ¡ï¼Œæ–¹ä¾¿å¯åŠ¨å’Œç®¡ç†ã€‚

```plain
.\bin\elasticsearch-service.bat

Usage: elasticsearch-service.bat install|remove|start|stop|manager [SERVICE_ID]
```

2ï¼‰å®‰è£… Kibana

**æ³¨æ„ï¼Œåªè¦æ˜¯åŒä¸€å¥—æŠ€æœ¯ï¼Œæ‰€æœ‰ç‰ˆæœ¬å¿…é¡»ä¸€è‡´ï¼æ­¤å¤„éƒ½ç”¨ 7.17 ç‰ˆæœ¬ï¼**

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/kibana/7.17/introduction.html

å®‰è£… Kibanaï¼šhttps://www.elastic.co/guide/en/kibana/7.17/install.html

å®‰è£…å®Œæˆåè¿›å…¥ kibana ç›®å½•å¹¶æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š

```plain
.\bin\kibana.bat
```

æ­£å¸¸è¾“å‡ºå¦‚å›¾ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/fY6IJD8OHQmQVLQu.webp)

è®¿é—® http://localhost:5601/ï¼Œå³å¯å¼€å§‹ä½¿ç”¨ã€‚

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/XMl98KJ4cdHy8NzP.webp)

ä½† kibana é»˜è®¤æ˜¯è‹±æ–‡ï¼Œä¸å˜é˜…è¯»ï¼Œå¯ä»¥ä¿®æ”¹ `config/kibana.yml` ä¸­çš„å›½é™…åŒ–é…ç½®ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/k7yVkyebF6g7GAjl.webp)

ç„¶åé‡å¯ kibana å³å¯ã€‚

**æ³¨æ„ï¼Œç›®å‰ Kibana é¢æ¿æ²¡æœ‰å¢åŠ æƒé™æ ¡éªŒï¼Œæ‰€æœ‰äººéƒ½èƒ½è®¿é—®ï¼Œæ‰€ä»¥è¯·å‹¿åœ¨çº¿ä¸Šç›´æ¥éƒ¨ç½²ï¼**

3ï¼‰æµ‹è¯•

å°è¯•åˆ©ç”¨ Kibana çš„å¼€å‘å·¥å…·æ¥æ“ä½œ Elasticsearch çš„æ•°æ®ï¼Œæ¯”å¦‚æŸ¥è¯¢ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/vYkyXp4IkXSV79fE.webp)

éªŒè¯ä¸‹åˆ†è¯å™¨çš„æ•ˆæœï¼Œæ¯”å¦‚ä½¿ç”¨æ ‡å‡†åˆ†è¯å™¨ï¼š

```json
POST /_analyze
{
  "analyzer": "standard", 
  "text": "é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œéå¸¸å–œæ¬¢ç¼–ç¨‹"
}
```

æ•ˆæœå¦‚å›¾ï¼Œè‹±æ–‡è¢«è¯†åˆ«ä¸ºäº†ä¸€ä¸ªè¯ï¼Œä½†ä¸­æ–‡æœªè¢«è¯†åˆ«ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/GOIH9rULZ37lsHTY.webp)

é»˜è®¤æ”¯æŒçš„åˆ†è¯å™¨å¦‚ä¸‹ï¼š

- standardï¼šæ ‡å‡†åˆ†è¯å™¨ã€‚
- simpleï¼šç®€å•åˆ†è¯å™¨ã€‚
- whitespaceï¼šæŒ‰ç©ºæ ¼åˆ†è¯ã€‚
- stopï¼šå¸¦åœç”¨è¯çš„åˆ†è¯å™¨ã€‚
- keywordï¼šä¸åˆ†è¯ï¼Œå°†æ•´ä¸ªå­—æ®µä½œä¸ºä¸€ä¸ªè¯æ¡ã€‚
- patternï¼šåŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ†è¯å™¨ã€‚
- ngram å’Œ edge_ngramï¼šn-gram åˆ†è¯å™¨ã€‚

ç”±äºè¿™äº›åˆ†è¯å™¨éƒ½ä¸æ”¯æŒä¸­æ–‡ï¼Œæ‰€ä»¥éœ€è¦å®‰è£… IK ä¸­æ–‡åˆ†è¯å™¨ï¼Œä»¥æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡éœ€è¦ã€‚

4ï¼‰å®‰è£… IK ä¸­æ–‡åˆ†è¯å™¨ï¼ˆES æ’ä»¶ï¼‰

å¼€æºåœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-ik

ç›´æ¥æŒ‰ç…§å®˜æ–¹æŒ‡å¼•å®‰è£…å³å¯ï¼Œæ³¨æ„ä¸‹è½½å’Œæˆ‘ä»¬ Elasticsearch ä¸€è‡´çš„ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å„ç‰ˆæœ¬çš„æ’ä»¶åŒ…ï¼šhttps://release.infinilabs.com/analysis-ik/stable/

åœ¨ ES å®‰è£…ç›®å½•ä¸‹æ‰§è¡Œï¼š

```plain
.\bin\elasticsearch-plugin.bat install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-7.17.23.zip
```

å®‰è£…æˆåŠŸï¼Œéœ€è¦é‡å¯ ESï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/PGGdlXuUHeydHtxl.webp)

IK åˆ†è¯å™¨æ’ä»¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªåˆ†è¯å™¨ï¼š`ik_smart` å’Œ `ik_max_word`ã€‚

- ik_smart æ˜¯æ™ºèƒ½åˆ†è¯ï¼Œå°½é‡é€‰æ‹©æœ€åƒä¸€ä¸ªè¯çš„æ‹†åˆ†æ–¹å¼ï¼Œæ¯”å¦‚â€œå¥½å­¦ç”Ÿâ€ä¼šè¢«è¯†åˆ«ä¸ºä¸€ä¸ªè¯
- ik_max_word å°½å¯èƒ½åœ°åˆ†è¯ï¼Œå¯ä»¥åŒ…æ‹¬ç»„åˆè¯ï¼Œæ¯”å¦‚â€œå¥½å­¦ç”Ÿâ€ä¼šè¢«è¯†åˆ«ä¸º 3 ä¸ªè¯ï¼šå¥½å­¦ç”Ÿã€å¥½å­¦ã€å­¦ç”Ÿ

æµ‹è¯•ä¸€ä¸‹ï¼š

```plain
POST /_analyze
{
  "analyzer": "ik_smart", 
  "text": "é±¼çš®æ˜¯å¥½å­¦ç”Ÿ"
}
```

å¦‚å›¾ï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/qXe9Z4eJo117buEH.webp)![img](./assets/ElasticSearch-é±¼çš®/U1Kw02VcT12BfWB6.webp)

è¿™ä¸¤ç§åˆ†è¯å™¨å¦‚ä½•é€‰ç”¨å‘¢ï¼Ÿå…¶å®å¯ä»¥ç»“åˆï¼š

- `ik_smart`ï¼šé€‚ç”¨äº **æœç´¢åˆ†è¯**ï¼Œå³åœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨ï¼Œä¿è¯æ€§èƒ½çš„åŒæ—¶æä¾›åˆç†çš„åˆ†è¯ç²¾åº¦ã€‚
- `ik_max_word`ï¼šé€‚ç”¨äº **åº•å±‚ç´¢å¼•åˆ†è¯**ï¼Œç¡®ä¿åœ¨å»ºç«‹ç´¢å¼•æ—¶å°½å¯èƒ½å¤šåœ°åˆ†è¯ï¼Œæé«˜æŸ¥è¯¢æ—¶çš„åŒ¹é…åº¦å’Œè¦†ç›–é¢ã€‚

ä¸‹é¢å°±æ¥å®æˆ˜ä¸‹ ES ç´¢å¼•çš„è®¾è®¡å§~

ğŸ’¡ æ€è€ƒï¼šæœ‰äº›æ—¶å€™ IK è¯†åˆ«è¯æ±‡ä¸å‡†ï¼Œæ¯”å¦‚ä¸è®¤è¯†â€œç¨‹åºå‘˜é±¼çš®â€ï¼Œæ€ä¹ˆæ ·è®© IK æŒ‰è‡ªå·±çš„è§„åˆ™åˆ†è¯ï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼šæ’ä»¶æ”¯æŒè‡ªå®šä¹‰è¯å…¸ã€‚å¯ä»¥æŒ‰ç…§ [å®˜æ–¹æ–‡æ¡£](https://github.com/infinilabs/analysis-ik/tree/v7.17.18?tab=readme-ov-file#dictionary-configuration) é…ç½®ã€‚

#### 2ã€è®¾è®¡ ES ç´¢å¼•

ä¸ºäº†å°† MySQL é¢˜ç›®è¡¨æ•°æ®å¯¼å…¥åˆ° Elasticsearch ä¸­å¹¶å®ç°åˆ†è¯æœç´¢ï¼Œéœ€è¦ä¸º ES ç´¢å¼•å®šä¹‰ `mapping`ã€‚ES çš„ `mapping` ç”¨äºå®šä¹‰å­—æ®µçš„ç±»å‹ã€åˆ†è¯å™¨åŠå…¶ç´¢å¼•æ–¹å¼ã€‚

ç›¸å½“äºæ•°æ®åº“çš„å»ºè¡¨ï¼Œæ•°æ®åº“å»ºè¡¨æ—¶æˆ‘ä»¬è¦è€ƒè™‘ç´¢å¼•ï¼ŒåŒæ · Elasticsearch å»ºç«‹ç´¢å¼•æ—¶ï¼Œè¦è€ƒè™‘åˆ°å­—æ®µé€‰å–ã€åˆ†è¯å™¨ã€å­—æ®µæ ¼å¼ç­‰é—®é¢˜ã€‚

åŸºäºæˆ‘ä»¬æ•°æ®åº“çš„è¡¨ç»“æ„å’Œéœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ titleã€contentã€answer ç­‰å­—æ®µä½¿ç”¨åˆ†è¯æœç´¢ï¼ŒåŒæ—¶ä¸ºå…¶ä»–å­—æ®µæŒ‡å®šé€‚å½“çš„ç±»å‹ã€‚ä»¥ä¸‹æ˜¯æœ¬é¡¹ç›®çš„ `mapping` å®šä¹‰ï¼š

```json
{
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "tags": {
        "type": "keyword"
      },
      "answer": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "userId": {
        "type": "long"
      },
      "editTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "createTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "updateTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "isDelete": {
        "type": "keyword"
      }
    }
  }
}
```

**å„å­—æ®µçš„ç±»å‹é€‰æ‹©å’Œè€ƒè™‘ï¼š**

1ï¼‰titleã€contentã€answerï¼š

è¿™äº›å­—æ®µè¢«å®šä¹‰ä¸º `text` ç±»å‹ï¼Œé€‚åˆå­˜å‚¨è¾ƒé•¿çš„ã€éœ€è¦å…¨æ–‡æœç´¢çš„å†…å®¹ã€‚ç”±äºä¼šæœ‰ä¸­æ–‡å†…å®¹ï¼Œæ‰€ä»¥ä½¿ç”¨äº† IK ä¸­æ–‡åˆ†è¯å™¨è¿›è¡Œåˆ†è¯å¤„ç†ï¼Œä»¥æé«˜æŸ¥è¯¢çš„çµæ´»æ€§å’ŒåŒ¹é…åº¦ã€‚

- `analyzer: ik_max_word`ï¼šç”¨äºç´¢å¼•æ—¶è¿›è¡Œæœ€å¤§ç²’åº¦çš„åˆ†è¯ï¼Œç”Ÿæˆè¾ƒå¤šè¯è¯­ï¼Œé€‚åˆåœ¨æŸ¥è¯¢æ—¶æé«˜å¬å›ç‡ã€‚
- `search_analyzer: ik_smart`ï¼šç”¨äºæœç´¢æ—¶è¿›è¡Œè¾ƒæ™ºèƒ½çš„åˆ†è¯ï¼Œç”Ÿæˆè¾ƒå°‘çš„è¯è¯­ï¼Œé€šå¸¸ç”¨äºæé«˜æœç´¢ç²¾åº¦ã€‚

2ï¼‰title.keywordï¼šä¸º `title` å­—æ®µå¢åŠ äº†ä¸€ä¸ªå­å­—æ®µ `keyword`ï¼Œç”¨äºå­˜å‚¨æœªåˆ†è¯çš„æ ‡é¢˜ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…ã€‚å®ƒè¿˜é…ç½®äº† `ignore_above: 256`ï¼Œè¡¨ç¤ºå¦‚æœ title å­—æ®µçš„é•¿åº¦è¶…è¿‡ 256 ä¸ªå­—ç¬¦ï¼Œå°†ä¸ä¼šä¸º keyword å­—æ®µè¿›è¡Œç´¢å¼•ã€‚å› ä¸ºé¢˜ç›®çš„æ ‡é¢˜ä¸€èˆ¬ä¸ä¼šå¾ˆé•¿ï¼Œå¾ˆå°‘ä¼šå¯¹è¿‡é•¿çš„æ ‡é¢˜è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œæ‰€ä»¥ç”¨è¿™ä¸€è®¾ç½®æ¥é¿å…è¿‡é•¿æ–‡æœ¬å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚

3ï¼‰tagsï¼šæ ‡ç­¾é€šå¸¸æ˜¯é¢„å®šä¹‰çš„ã€ç”¨äºåˆ†ç±»æˆ–æ ‡ç­¾ç­›é€‰çš„å…³é”®å­—ï¼Œé€šå¸¸ä¸éœ€è¦åˆ†è¯ã€‚è®¾ç½®ä¸º `keyword` ç±»å‹ä»¥ä¾¿æ”¯æŒç²¾ç¡®åŒ¹é…å’Œèšåˆæ“ä½œï¼ˆä¾‹å¦‚ç»Ÿè®¡æŸæ ‡ç­¾çš„å‡ºç°é¢‘æ¬¡ï¼‰ã€‚`keyword` ä¸è¿›è¡Œåˆ†è¯ï¼Œå› æ­¤é€‚åˆå­˜å‚¨ä¸å˜çš„ã€ç»“æ„åŒ–çš„æ•°æ®ã€‚

4ï¼‰userIdï¼šç”¨æ¥å”¯ä¸€æ ‡è¯†ç”¨æˆ·çš„æ•°å€¼å­—æ®µã€‚åœ¨ Elasticsearch ä¸­ï¼Œæ•°å€¼ç±»å‹ï¼ˆå¦‚ `long`ï¼‰éå¸¸é€‚åˆç”¨äºç²¾ç¡®æŸ¥è¯¢ã€æ’åºå’ŒèŒƒå›´è¿‡æ»¤ã€‚ä¸å­—ç¬¦ä¸²ç›¸æ¯”ï¼Œæ•°å€¼ç±»å‹çš„æŸ¥è¯¢å’Œå­˜å‚¨æ•ˆç‡æ›´é«˜ï¼Œå°¤å…¶æ˜¯å¯¹äºå¤§é‡ç”¨æˆ·æ•°æ®çš„æŸ¥è¯¢ã€‚

5ï¼‰editTimeã€createTimeã€updateTimeï¼šæ—¶é—´å­—æ®µè¢«å®šä¹‰ä¸º `date` ç±»å‹ï¼Œå¹¶æŒ‡å®šäº†æ ¼å¼ `"yyyy-MM-dd HH:mm:ss"`ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ Elasticsearch å¯ä»¥åŸºäºè¿™äº›å­—æ®µè¿›è¡Œæ—¶é—´èŒƒå›´æŸ¥è¯¢ã€æ’åºå’Œèšåˆæ“ä½œï¼Œå¦‚æŒ‰æ—¶é—´è¿‡æ»¤æˆ–ç»Ÿè®¡æŸæ—¶é—´æ®µçš„æ•°æ®ã€‚

6ï¼‰isDeleteï¼šä½¿ç”¨ keyword ç±»å‹ï¼Œè¡¨ç¤ºæ˜¯å¦è¢«åˆ é™¤ã€‚ å› ä¸º keyword æ˜¯ä¸ºç²¾ç¡®åŒ¹é…è®¾è®¡çš„ï¼Œé€‚ç”¨äºæšä¸¾å€¼ç²¾ç¡®æŸ¥è¯¢çš„åœºæ™¯ï¼Œæ€§èƒ½å¥½ä¸”æ¸…æ™°ã€‚

ä¸ºä»€ä¹ˆä¸ç”¨ boolean ç±»å‹å‘¢ï¼Ÿå› ä¸º MySQL æ•°æ®åº“å­˜å‚¨çš„æ˜¯ 0 å’Œ 1ï¼Œå†™å…¥ ES æ—¶éœ€è¦è½¬æ¢ç±»å‹ã€‚

**ä¸ºä»€ä¹ˆä¸æ˜¾ç¤ºæŒ‡å®š id å­—æ®µï¼Ÿ**

åœ¨ Elasticsearch ä¸­ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ `_id` å­—æ®µæ¥æ ‡è¯†æ–‡æ¡£ï¼Œè¯¥å­—æ®µç”¨äºæ–‡æ¡£çš„ä¸»é”®ç´¢å¼•å’Œå”¯ä¸€æ ‡è¯†ã€‚é€šå¸¸ï¼Œå¼€å‘è€…å¹¶ä¸éœ€è¦æ˜¾å¼å®šä¹‰ `id` å­—æ®µï¼Œå› ä¸º Elasticsearch ä¼šè‡ªåŠ¨ç”Ÿæˆ `_id`ï¼Œæˆ–è€…åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æŒ‡å®š `_id`ã€‚

ç”±äº `_id` æ˜¯ Elasticsearch å†…éƒ¨çš„ç³»ç»Ÿå­—æ®µï¼Œå®ƒé»˜è®¤å­˜åœ¨å¹¶ä½œä¸ºä¸»é”®ä½¿ç”¨ï¼Œå› æ­¤åœ¨ mappings ä¸­é€šå¸¸ä¸éœ€è¦æ˜¾å¼å®šä¹‰ã€‚å¦‚æœä½ æƒ³è®©æŸä¸ªå­—æ®µï¼ˆå¦‚ userId æˆ–å…¶ä»–å”¯ä¸€æ ‡è¯†ï¼‰ä½œä¸º `_id`ï¼Œå¯ä»¥åœ¨æ’å…¥æ–‡æ¡£æ—¶æŒ‡å®šè¯¥å­—æ®µçš„å€¼ä½œä¸º `_id`ã€‚æ¯”å¦‚ï¼š

```bash
PUT /index/_doc/<custom_id>
{
  "userId": 1001,
  "title": "Example"
}
```

**æ—¥æœŸå­—æ®µä¸ºä»€ä¹ˆè¦æ ¼å¼åŒ–ï¼Ÿ**

æ—¥æœŸå­—æ®µçš„æ ¼å¼åŒ–ï¼ˆ`format: "yyyy-MM-dd HH:mm:ss"`ï¼‰æœ‰ä»¥ä¸‹å‡ ä¸ªè€ƒè™‘ï¼š

1. ä¸€è‡´æ€§ï¼šå®šä¹‰æ—¥æœŸå­—æ®µçš„æ ¼å¼å¯ä»¥ç¡®ä¿æ‰€æœ‰æ’å…¥çš„æ—¥æœŸæ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ï¼Œé¿å…å› ä¸åŒçš„æ—¥æœŸæ ¼å¼å¯¼è‡´è§£æé”™è¯¯ã€‚ä¾‹å¦‚ï¼ŒElasticsearch é»˜è®¤å¯ä»¥æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼ï¼Œä½†å¦‚æœä¸å®šä¹‰æ˜ç¡®çš„æ ¼å¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸ä¸€è‡´çš„æ—¥æœŸè§£æã€‚
2. ä¼˜åŒ–æŸ¥è¯¢ï¼šæ ¼å¼åŒ–æ—¥æœŸåï¼ŒElasticsearch çŸ¥é“è¯¥å¦‚ä½•å­˜å‚¨å’Œç´¢å¼•è¿™äº›æ—¶é—´æ•°æ®ï¼Œä»è€Œå¯ä»¥é«˜æ•ˆåœ°æ‰§è¡ŒåŸºäºæ—¥æœŸçš„èŒƒå›´æŸ¥è¯¢ã€è¿‡æ»¤å’Œæ’åºæ“ä½œã€‚æ˜ç¡®çš„æ ¼å¼å®šä¹‰è¿˜å¯ä»¥å¸®åŠ© Elasticsearch è¿›è¡Œæ›´ä¼˜åŒ–çš„å­˜å‚¨å’Œå‹ç¼©ã€‚
3. é¿å…æ­§ä¹‰ï¼šæ²¡æœ‰æ˜ç¡®æ ¼å¼çš„æ—¥æœŸå¯èƒ½å¯¼è‡´æ­§ä¹‰ï¼Œæ¯”å¦‚ `"2023-09-03"` æ˜¯æ—¥æœŸï¼Œè¿˜æ˜¯å¹´ä»½ï¼ŸåŠ ä¸Šæ—¶é—´éƒ¨åˆ†ï¼ˆå¦‚ `"yyyy-MM-dd HH:mm:ss"`ï¼‰å¯ä»¥æ›´æ˜ç¡®åœ°è¡¨æ˜æ—¶é—´çš„ç²¾åº¦ï¼Œä¾¿äºè¿›è¡Œæ›´ç²¾ç¡®çš„æŸ¥è¯¢ã€‚

**tags æ”¯æŒæ•°ç»„ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ**

åœ¨ Elasticsearch ä¸­ï¼Œæ‰€æœ‰çš„å­—æ®µç±»å‹ï¼ˆåŒ…æ‹¬ `keyword` å’Œ `text`ï¼‰é»˜è®¤éƒ½æ”¯æŒæ•°ç»„ã€‚ä½ å¯ä»¥ç›´æ¥æ’å…¥ä¸€ä¸ªåŒ…å«å¤šä¸ªå€¼çš„æ•°ç»„ï¼ŒElasticsearch ä¼šè‡ªåŠ¨å°†å…¶è§†ä¸ºå¤šä¸ªå€¼çš„é›†åˆã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ–‡æ¡£ä¸­ï¼Œtags å­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼š

```json
{
  "title": "How to learn Elasticsearch",
  "tags": ["Elasticsearch", "Search", "Database"]
}
```

åœ¨æŸ¥è¯¢æ—¶ï¼ŒElasticsearch ä¼šå°†æ•°ç»„ä¸­çš„æ¯ä¸ªå€¼è§†ä¸ºç‹¬ç«‹çš„ `keyword`ï¼Œå¯ä»¥è¿›è¡Œç²¾ç¡®åŒ¹é…ã€‚

#### 3ã€æ–°å»º ES ç´¢å¼•

å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ›å»ºç´¢å¼•ï¼Œåœ¨ Kibana å¼€å‘è€…å·¥å…·ä¸­æ‰§è¡Œã€æˆ–è€…ç”¨ CURL è°ƒç”¨ Elasticsearch æ‰§è¡Œå‡å¯ï¼š

```bash
PUT /question_v1
{
  "mappings": {
    "properties": {
      ...
    }
  }
}
```

ä½†æ˜¯æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ¨èåœ¨åˆ›å»ºç´¢å¼•æ—¶æ·»åŠ  aliasï¼ˆåˆ«åï¼‰ ï¼Œå› ä¸ºå®ƒæä¾›äº†çµæ´»æ€§å’Œç®€åŒ–ç´¢å¼•ç®¡ç†çš„èƒ½åŠ›ã€‚å…·ä½“åŸå› å¦‚ä¸‹ï¼š

1. é›¶åœæœºåˆ‡æ¢ç´¢å¼•ï¼šåœ¨æ›´æ–°ç´¢å¼•æˆ–é‡æ–°ç´¢å¼•æ•°æ®æ—¶ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°ç´¢å¼•å¹¶ä½¿ç”¨ alias åˆ‡æ¢åˆ°æ–°ç´¢å¼•ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯æŸ¥è¯¢ä»£ç ï¼Œé¿å…åœæœºæˆ–ä¸­æ–­æœåŠ¡ã€‚
2. ç®€åŒ–æŸ¥è¯¢ï¼šé€šè¿‡ aliasï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„åç§°è¿›è¡ŒæŸ¥è¯¢ï¼Œè€Œä¸éœ€è¦è®°ä½å…·ä½“çš„ç´¢å¼•åç§°ï¼ˆå°¤å…¶å½“ç´¢å¼•æœ‰ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³æ—¶ï¼‰ã€‚
3. ç´¢å¼•åˆ†ç»„ï¼šalias å¯ä»¥æŒ‡å‘å¤šä¸ªç´¢å¼•ï¼Œæ–¹ä¾¿å¯¹å¤šä¸ªç´¢å¼•è¿›è¡Œè”åˆæŸ¥è¯¢ï¼Œä¾‹å¦‚ç”¨äºè·¨æ—¶é—´æ®µçš„æ—¥å¿—æŸ¥è¯¢æˆ–æ•°æ®å½’æ¡£ã€‚

å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯é‡ç‚¹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œåœ¨åˆ›å»ºç´¢å¼•æ—¶æ·»åŠ  aliasï¼š

```json
PUT /my_index_v1
{
  "aliases": {
    "my_index": {}
  }
}
```

è¿™ä¸ª alias å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­æŒ‡å‘æ–°çš„ç´¢å¼•ï¼ˆå¦‚ my_index_v2ï¼‰ï¼Œæ— éœ€æ›´æ”¹æŸ¥è¯¢é€»è¾‘ï¼ŒæŸ¥è¯¢æ—¶ä»ç„¶ä½¿ç”¨ my_indexã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œçš„å®Œæ•´å‘½ä»¤å¦‚ä¸‹ï¼Œå¯ä»¥æ”¾åˆ°åç«¯é¡¹ç›®ç›®å½•ä¸­è¿›è¡Œå¤‡ä»½ï¼š

```json
PUT /question_v1
{
  "aliases": {
    "question": {}
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "tags": {
        "type": "keyword"
      },
      "answer": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "userId": {
        "type": "long"
      },
      "editTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "createTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "updateTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "isDelete": {
        "type": "keyword"
      }
    }
  }
}
```

åˆ›å»ºç´¢å¼•æˆåŠŸï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/2deVcvEzgrOWVR0M.webp)

#### 4ã€å¼•å…¥ ES å®¢æˆ·ç«¯

åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œå¯ä»¥é€šè¿‡ Starter å¿«é€Ÿå¼•å…¥ Elasticsearchï¼Œéå¸¸æ–¹ä¾¿ï¼š

1ï¼‰åœ¨ pom.xml ä¸­å¼•å…¥ï¼š

```xml
<!-- elasticsearch-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

2ï¼‰ä¿®æ”¹é¡¹ç›® yml é…ç½®ï¼š

```yaml
spring:
  elasticsearch:
    uris: http://xxx:9200
    username: elastic
    password: coder_yupi_swag
```

3ï¼‰ä½¿ç”¨ Spring Data Elasticsearch æä¾›çš„ Bean å³å¯æ“ä½œ Elasticsearchï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ @Resource æ³¨è§£å¼•å…¥ï¼š

```java
@Resource
private ElasticsearchRestTemplate elasticsearchRestTemplate;
```

4ï¼‰ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–‡ä»¶ï¼ŒéªŒè¯å¯¹äº Elasticsearch çš„å¢åˆ æ”¹æŸ¥åŸºæœ¬æ“ä½œã€‚åƒé±¼çš®æ˜¯ä½¿ç”¨äº† AI å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆäº†å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼š

```java
package com.yupi.mianshiya.es;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.data.elasticsearch.core.IndexOperations;
import org.springframework.data.elasticsearch.core.document.Document;
import org.springframework.data.elasticsearch.core.query.*;
import org.springframework.data.elasticsearch.core.mapping.IndexCoordinates;

import java.util.HashMap;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class ElasticsearchRestTemplateTest {

    @Autowired
    private ElasticsearchRestTemplate elasticsearchRestTemplate;

    private final String INDEX_NAME = "test_index";

    // Index (Create) a document
    @Test
    public void indexDocument() {
        Map<String, Object> doc = new HashMap<>();
        doc.put("title", "Elasticsearch Introduction");
        doc.put("content", "Learn Elasticsearch basics and advanced usage.");
        doc.put("tags", "elasticsearch,search");
        doc.put("answer", "Yes");
        doc.put("userId", 1L);
        doc.put("editTime", "2023-09-01 10:00:00");
        doc.put("createTime", "2023-09-01 09:00:00");
        doc.put("updateTime", "2023-09-01 09:10:00");
        doc.put("isDelete", false);

        IndexQuery indexQuery = new IndexQueryBuilder().withId("1").withObject(doc).build();
        String documentId = elasticsearchRestTemplate.index(indexQuery, IndexCoordinates.of(INDEX_NAME));

        assertThat(documentId).isNotNull();
    }

    // Get (Retrieve) a document by ID
    @Test
    public void getDocument() {
        String documentId = "1";  // Replace with the actual ID of an indexed document

        Map<String, Object> document = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));

        assertThat(document).isNotNull();
        assertThat(document.get("title")).isEqualTo("Elasticsearch Introduction");
    }

    // Update a document
    @Test
    public void updateDocument() {
        String documentId = "1";  // Replace with the actual ID of an indexed document

        Map<String, Object> updates = new HashMap<>();
        updates.put("title", "Updated Elasticsearch Title");
        updates.put("updateTime", "2023-09-01 10:30:00");

        UpdateQuery updateQuery = UpdateQuery.builder(documentId)
                .withDocument(Document.from(updates))
                .build();

        elasticsearchRestTemplate.update(updateQuery, IndexCoordinates.of(INDEX_NAME));

        Map<String, Object> updatedDocument = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));
        assertThat(updatedDocument.get("title")).isEqualTo("Updated Elasticsearch Title");
    }

    // Delete a document
    @Test
    public void deleteDocument() {
        String documentId = "1";  // Replace with the actual ID of an indexed document

        String result = elasticsearchRestTemplate.delete(documentId, IndexCoordinates.of(INDEX_NAME));
        assertThat(result).isNotNull();
    }

    // Delete the entire index
    @Test
    public void deleteIndex() {
        IndexOperations indexOps = elasticsearchRestTemplate.indexOps(IndexCoordinates.of(INDEX_NAME));
        boolean deleted = indexOps.delete();
        assertThat(deleted).isTrue();
    }
}
```

ç”±äºå•å…ƒæµ‹è¯•çš„æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œæ‰¹é‡æ‰§è¡Œæ—¶ï¼Œå¯èƒ½ä¼šæœ‰éƒ¨åˆ†æŠ¥é”™ï¼Œæ˜¯æ­£å¸¸ç°è±¡ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨æ‰§è¡Œæµ‹è¯•ã€‚

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/IcAdo2bsLyjmg5RJ.webp)

å¯ä»¥ä½¿ç”¨ Kibana å¼€å‘è€…å·¥å…·æ¥æŸ¥çœ‹æ•°æ®æƒ…å†µï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/m6WXARP0iKnwAfhK.webp)

å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1. å½“ä½ å‘ä¸€ä¸ªä¸å­˜åœ¨çš„ç´¢å¼•ä¸­æ’å…¥æ•°æ®æ—¶ï¼ŒElasticsearch ä¼šæ ¹æ®æ–‡æ¡£å†…å®¹è‡ªåŠ¨æ¨æ–­å­—æ®µç±»å‹ï¼Œå¹¶ä¸ºè¿™äº›å­—æ®µåˆ›å»ºæ˜ å°„ã€‚è¿™å°±æ˜¯ ES çš„ **åŠ¨æ€æ˜ å°„**ï¼ˆDynamic Mappingï¼‰åŠŸèƒ½ã€‚ç„¶è€Œï¼Œè¿™ç§è‡ªåŠ¨ç”Ÿæˆçš„æ˜ å°„æœ‰ä¸€äº›å±€é™æ€§ï¼Œå¯èƒ½å¯¼è‡´å­—æ®µç±»å‹ä¸å¤Ÿè§„èŒƒã€‚
2. ES ä¸­ï¼Œ_å¼€å¤´çš„å­—æ®µè¡¨ç¤ºç³»ç»Ÿé»˜è®¤å­—æ®µï¼Œæ¯”å¦‚ _idï¼Œå¦‚æœç³»ç»Ÿä¸æŒ‡å®šï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆã€‚ä½†æ˜¯ä¸ä¼šåœ¨ _source å­—æ®µä¸­è¡¥å…… id çš„å€¼ï¼Œæ‰€ä»¥å»ºè®®å¤§å®¶æ‰‹åŠ¨æŒ‡å®šï¼Œè®©æ•°æ®æ›´å®Œæ•´ã€‚
3. ES æ’å…¥å’Œæ›´æ–°æ•°æ®æ²¡æœ‰ MySQL é‚£ä¹ˆä¸¥æ ¼ï¼Œå°¤å…¶æ˜¯åœ¨åŠ¨æ€ Mapping æ¨¡å¼ä¸‹ï¼Œåªè¦æŒ‡å®šäº†ç›¸åŒçš„æ–‡æ¡£ idï¼ŒES å…è®¸åŠ¨æ€æ·»åŠ å­—æ®µå’Œæ›´æ–°æ–‡æ¡£ã€‚

------

é€šè¿‡è¿™ä¸ªå•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½åŸºæœ¬äº†è§£ Spring Data Elasticsearch æ“ä½œ ES çš„æ–¹æ³•ï¼š

1. æ„é€ ä¸€ä¸ª Query å¯¹è±¡ï¼Œæ¯”å¦‚æ’å…¥æ•°æ®ä½¿ç”¨ IndexQueryï¼Œæ›´æ–°æ•°æ®ä½¿ç”¨ UpdateQuery
2. è°ƒç”¨ elasticsearchRestTemplate çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ï¼Œä¼ å…¥ Query å¯¹è±¡å’Œè¦æ“ä½œçš„ç´¢å¼•ä½œä¸ºå‚æ•°
3. å¯¹è¿”å›å€¼è¿›è¡Œå¤„ç†

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
Map<String, Object> updates = new HashMap<>();
updates.put("title", "Updated Elasticsearch Title");
updates.put("updateTime", "2023-09-01 10:30:00");

UpdateQuery updateQuery = UpdateQuery.builder(documentId)
        .withDocument(Document.from(updates))
        .build();

elasticsearchRestTemplate.update(updateQuery, IndexCoordinates.of(INDEX_NAME));

Map<String, Object> updatedDocument = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));
```

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸Šè¿°ä»£ç éƒ½æ˜¯ç”¨ Map æ¥ä¼ é€’æ•°æ®ã€‚è®°å¾—ä¹‹å‰ä½¿ç”¨ MyBatis æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œéƒ½è¦å®šä¹‰ä¸€ä¸ªæ•°æ®åº“å®ä½“ç±»ï¼Œç„¶åæŠŠå‚æ•°ä¼ ç»™è¿™ä¸ªå®ä½“ç±»çš„å¯¹è±¡å°±å¯ä»¥äº†ï¼Œä¼šæ›´æ–¹ä¾¿å’Œè§„èŒƒã€‚

æ²¡é”™ï¼ŒSpring Data Elasticsearch ä¹Ÿæ˜¯æ”¯æŒè¿™ç§æ ‡å‡† Dao å±‚å¼€å‘æ–¹å¼çš„ï¼Œä¸‹é¢å°±æ¥ä½¿ç”¨ä¸€ä¸‹ã€‚

#### 5ã€ç¼–å†™ ES Dao å±‚

1ï¼‰åœ¨ `model.dto.question` åŒ…ä¸­å®šä¹‰å’Œ ES å¯¹åº”çš„å®ä½“ç±»ï¼š

```java
@Document(indexName = "question")
@Data
public class QuestionEsDTO implements Serializable {

    private static final String DATE_TIME_PATTERN = "yyyy-MM-dd HH:mm:ss";

    /**
     * id
     */
    @Id
    private Long id;

    /**
     * æ ‡é¢˜
     */
    private String title;

    /**
     * å†…å®¹
     */
    private String content;

    /**
     * ç­”æ¡ˆ
     */
    private String answer;

    /**
     * æ ‡ç­¾åˆ—è¡¨
     */
    private List<String> tags;

    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)
    private Date updateTime;

    /**
     * æ˜¯å¦åˆ é™¤
     */
    private Integer isDelete;

    private static final long serialVersionUID = 1L;

    /**
     * å¯¹è±¡è½¬åŒ…è£…ç±»
     *
     * @param question
     * @return
     */
    public static QuestionEsDTO objToDto(Question question) {
        if (question == null) {
            return null;
        }
        QuestionEsDTO questionEsDTO = new QuestionEsDTO();
        BeanUtils.copyProperties(question, questionEsDTO);
        String tagsStr = question.getTags();
        if (StringUtils.isNotBlank(tagsStr)) {
            questionEsDTO.setTags(JSONUtil.toList(tagsStr, String.class));
        }
        return questionEsDTO;
    }

    /**
     * åŒ…è£…ç±»è½¬å¯¹è±¡
     *
     * @param questionEsDTO
     * @return
     */
    public static Question dtoToObj(QuestionEsDTO questionEsDTO) {
        if (questionEsDTO == null) {
            return null;
        }
        Question question = new Question();
        BeanUtils.copyProperties(questionEsDTO, question);
        List<String> tagList = questionEsDTO.getTags();
        if (CollUtil.isNotEmpty(tagList)) {
            question.setTags(JSONUtil.toJsonStr(tagList));
        }
        return question;
    }
}
```

2ï¼‰å®šä¹‰ Dao å±‚

å¯ä»¥åœ¨ esdao åŒ…ä¸­ç»Ÿä¸€å­˜æ”¾å¯¹ Elasticsearch çš„æ“ä½œï¼Œåªéœ€è¦ç»§æ‰¿ ElasticsearchRepository ç±»å³å¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * é¢˜ç›® ES æ“ä½œ
 */
public interface QuestionEsDao 
    extends ElasticsearchRepository<QuestionEsDTO, Long> {

}
```

ElasticsearchRepository ç±»ä¸ºæˆ‘ä»¬æä¾›äº†å¤§é‡ç°æˆçš„ CRUD æ“ä½œï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/81ezMd62xlGIuqZc.webp)

è€Œä¸”è¿˜æ”¯æŒæ ¹æ®æ–¹æ³•åè‡ªåŠ¨æ˜ å°„ä¸ºæŸ¥è¯¢æ“ä½œï¼Œæ¯”å¦‚åœ¨ QuestionEsDao ä¸­å®šä¹‰ä¸‹åˆ—æ–¹æ³•ï¼Œå°±ä¼šè‡ªåŠ¨æ ¹æ® userId æŸ¥è¯¢æ•°æ®ã€‚

```java
/**
 * æ ¹æ®ç”¨æˆ· id æŸ¥è¯¢
 * @param userId
 * @return
 */
List<QuestionEsDTO> findByUserId(Long userId);
```

å¯ä»¥ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ¥éªŒè¯ï¼š

```java
@SpringBootTest
class QuestionEsDaoTest {

    @Resource
    private QuestionEsDao questionEsDao;

    @Test
    void findByUserId() {
        questionEsDao.findByUserId(1L);
    }
}
```

å…·ä½“çš„æ–¹æ³•åå’ŒæŸ¥è¯¢æ¡ä»¶çš„æ˜ å°„è§„åˆ™è§ [å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-data/elasticsearch/docs/4.4.2/reference/html/#repositories)ã€‚

------

ç›®å‰æˆ‘ä»¬å­¦åˆ°äº† 2 ç§ Spring Data Elasticsearch çš„ä½¿ç”¨æ–¹æ³•ï¼Œåº”è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ

- ç¬¬ 1 ç§æ–¹å¼ï¼šSpring é»˜è®¤ç»™æˆ‘ä»¬æä¾›çš„æ“ä½œ es çš„å®¢æˆ·ç«¯å¯¹è±¡ ElasticsearchRestTemplateï¼Œä¹Ÿæä¾›äº†å¢åˆ æ”¹æŸ¥ï¼Œå®ƒçš„å¢åˆ æ”¹æŸ¥æ›´çµæ´»ï¼Œ**é€‚ç”¨äºæ›´å¤æ‚çš„æ“ä½œ**ï¼Œè¿”å›ç»“æœæ›´å®Œæ•´ï¼Œä½†éœ€è¦è‡ªå·±è§£æã€‚
- ç¬¬ 2 ç§æ–¹å¼ï¼šElasticsearchRepository<Entity, IdType>ï¼Œé»˜è®¤æä¾›äº†æ›´ç®€å•æ˜“ç”¨çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿”å›ç»“æœä¹Ÿæ›´ç›´æ¥ã€‚**é€‚ç”¨äºå¯é¢„æœŸçš„ã€ç›¸å¯¹ç®€å•çš„æ“ä½œ** ã€‚

#### 6ã€å‘ ES å…¨é‡å†™å…¥æ•°æ®

å¯ä»¥é€šè¿‡ç¼–å†™å•æ¬¡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå°† MySQL ä¸­é¢˜ç›®è¡¨çš„æ•°æ®ï¼Œå…¨é‡å†™å…¥åˆ° Elasticsearchã€‚

å¯ä»¥é€šè¿‡å®ç° CommandLineRunner æ¥å£å®šä¹‰å•æ¬¡ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ç¼–å†™ä¸€ä¸ªä»…ç®¡ç†å‘˜å¯ç”¨çš„æ¥å£ï¼Œæ ¹æ®éœ€è¦é€‰æ‹©å°±å¥½ã€‚

åœ¨ `job/once` ç›®å½•ä¸‹ç¼–å†™ä»»åŠ¡ï¼š

```java
// todo å–æ¶ˆæ³¨é‡Šå¼€å¯ä»»åŠ¡
@Component
@Slf4j
public class FullSyncQuestionToEs implements CommandLineRunner {

    @Resource
    private QuestionService questionService;

    @Resource
    private QuestionEsDao questionEsDao;

    @Override
    public void run(String... args) {
        // å…¨é‡è·å–é¢˜ç›®ï¼ˆæ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼‰
        List<Question> questionList = questionService.list();
        if (CollUtil.isEmpty(questionList)) {
            return;
        }
        // è½¬ä¸º ES å®ä½“ç±»
        List<QuestionEsDTO> questionEsDTOList = questionList.stream()
                .map(QuestionEsDTO::objToDto)
                .collect(Collectors.toList());
        // åˆ†é¡µæ‰¹é‡æ’å…¥åˆ° ES
        final int pageSize = 500;
        int total = questionEsDTOList.size();
        log.info("FullSyncQuestionToEs start, total {}", total);
        for (int i = 0; i < total; i += pageSize) {
            // æ³¨æ„åŒæ­¥çš„æ•°æ®ä¸‹æ ‡ä¸èƒ½è¶…è¿‡æ€»æ•°æ®é‡
            int end = Math.min(i + pageSize, total);
            log.info("sync from {} to {}", i, end);
            questionEsDao.saveAll(questionEsDTOList.subList(i, end));
        }
        log.info("FullSyncQuestionToEs end, total {}", total);
    }
}
```

å¯åŠ¨é¡¹ç›®ï¼Œç„¶åç”¨ Kibana å¼€å‘å·¥å…·æŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼Œå‘ç°å†™å…¥æˆåŠŸï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/td7FDTrVmtmuW715.webp)

#### 7ã€å¼€å‘ ES æœç´¢

1ï¼‰QuestionService æ–°å¢æŸ¥è¯¢æ¥å£ï¼š

```java
/**
 * ä» ES æŸ¥è¯¢é¢˜ç›®
 *
 * @param questionQueryRequest
 * @return
 */
Page<Question> searchFromEs(QuestionQueryRequest questionQueryRequest);
```

2ï¼‰ç¼–å†™å®ç°æ–¹æ³•

ç”±äºæŸ¥è¯¢é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œä¸ºäº†ä¿è¯çµæ´»æ€§ï¼Œé€‰ç”¨ ElasticsearchRestTemplate å¼€å‘ã€‚

éœ€è¦æ”¯æŒç°æœ‰çš„é¢˜ç›®æŸ¥è¯¢æ¡ä»¶ï¼Œæœç´¢æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public Page<Question> searchFromEs(QuestionQueryRequest questionQueryRequest) {
    // è·å–å‚æ•°
    Long id = questionQueryRequest.getId();
    Long notId = questionQueryRequest.getNotId();
    String searchText = questionQueryRequest.getSearchText();
    List<String> tags = questionQueryRequest.getTags();
    Long questionBankId = questionQueryRequest.getQuestionBankId();
    Long userId = questionQueryRequest.getUserId();
    // æ³¨æ„ï¼ŒES çš„èµ·å§‹é¡µä¸º 0
    int current = questionQueryRequest.getCurrent() - 1;
    int pageSize = questionQueryRequest.getPageSize();
    String sortField = questionQueryRequest.getSortField();
    String sortOrder = questionQueryRequest.getSortOrder();

    // æ„é€ æŸ¥è¯¢æ¡ä»¶
    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
    // è¿‡æ»¤
    boolQueryBuilder.filter(QueryBuilders.termQuery("isDelete", 0));
    if (id != null) {
        boolQueryBuilder.filter(QueryBuilders.termQuery("id", id));
    }
    if (notId != null) {
        boolQueryBuilder.mustNot(QueryBuilders.termQuery("id", notId));
    }
    if (userId != null) {
        boolQueryBuilder.filter(QueryBuilders.termQuery("userId", userId));
    }
    if (questionBankId != null) {
        boolQueryBuilder.filter(QueryBuilders.termQuery("questionBankId", questionBankId));
    }
    // å¿…é¡»åŒ…å«æ‰€æœ‰æ ‡ç­¾
    if (CollUtil.isNotEmpty(tags)) {
        for (String tag : tags) {
            boolQueryBuilder.filter(QueryBuilders.termQuery("tags", tag));
        }
    }
    // æŒ‰å…³é”®è¯æ£€ç´¢
    if (StringUtils.isNotBlank(searchText)) {
        boolQueryBuilder.should(QueryBuilders.matchQuery("title", searchText));
        boolQueryBuilder.should(QueryBuilders.matchQuery("content", searchText));
        boolQueryBuilder.should(QueryBuilders.matchQuery("answer", searchText));
        boolQueryBuilder.minimumShouldMatch(1);
    }
    // æ’åº
    SortBuilder<?> sortBuilder = SortBuilders.scoreSort();
    if (StringUtils.isNotBlank(sortField)) {
        sortBuilder = SortBuilders.fieldSort(sortField);
        sortBuilder.order(CommonConstant.SORT_ORDER_ASC.equals(sortOrder) ? SortOrder.ASC : SortOrder.DESC);
    }
    // åˆ†é¡µ
    PageRequest pageRequest = PageRequest.of(current, pageSize);
    // æ„é€ æŸ¥è¯¢
    NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(boolQueryBuilder)
            .withPageable(pageRequest)
            .withSorts(sortBuilder)
            .build();
    SearchHits<QuestionEsDTO> searchHits = elasticsearchRestTemplate.search(searchQuery, QuestionEsDTO.class);
    // å¤ç”¨ MySQL çš„åˆ†é¡µå¯¹è±¡ï¼Œå°è£…è¿”å›ç»“æœ
    Page<Question> page = new Page<>();
    page.setTotal(searchHits.getTotalHits());
    List<Question> resourceList = new ArrayList<>();
    if (searchHits.hasSearchHits()) {
        List<SearchHit<QuestionEsDTO>> searchHitList = searchHits.getSearchHits();
        for (SearchHit<QuestionEsDTO> questionEsDTOSearchHit : searchHitList) {
            resourceList.add(QuestionEsDTO.dtoToObj(questionEsDTOSearchHit.getContent()));
        }
    }
    page.setRecords(resourceList);
    return page;
}
```

è™½ç„¶çœ‹ä¸Šå»å¤æ‚ï¼Œä½†ä¸æ¶‰åŠä»€ä¹ˆé€»è¾‘ï¼Œæ ¹æ®æŸ¥è¯¢éœ€æ±‚é€‰æ‹©åˆé€‚çš„æœç´¢æ–¹æ³•ï¼Œä¸æ–­æ„é€ æœç´¢æ¡ä»¶å³å¯ã€‚

3ï¼‰åœ¨ QuestionController ç¼–å†™æ–°çš„æœç´¢æ¥å£ï¼š

```java
@PostMapping("/search/page/vo")
public BaseResponse<Page<QuestionVO>> searchQuestionVOByPage(@RequestBody QuestionQueryRequest questionQueryRequest,
                                                     HttpServletRequest request) {
    long size = questionQueryRequest.getPageSize();
    // é™åˆ¶çˆ¬è™«
    ThrowUtils.throwIf(size > 200, ErrorCode.PARAMS_ERROR);
    Page<Question> questionPage = questionService.searchFromEs(questionQueryRequest);
    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));
}
```

4ï¼‰ç„¶åå¯ä»¥é€šè¿‡ Swagger æ¥å£æ–‡æ¡£è¿›è¡Œæµ‹è¯•ã€‚

#### 8ã€æ•°æ®åŒæ­¥

æ ¹æ®ä¹‹å‰çš„æ–¹æ¡ˆè®¾è®¡ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡è¿›è¡Œå¢é‡åŒæ­¥ï¼Œæ¯åˆ†é’ŸåŒæ­¥è¿‡å» 5 åˆ†é’Ÿå†…æ•°æ®åº“å‘ç”Ÿä¿®æ”¹çš„é¢˜ç›®æ•°æ®ã€‚

æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨ MyBatis Plus æä¾›çš„ mapper æ–¹æ³•ï¼ŒæŸ¥è¯¢æ—¶ä¼šé»˜è®¤è¿‡æ»¤æ‰ isDelete = 1ï¼ˆé€»è¾‘å·²åˆ é™¤ï¼‰çš„æ•°æ®ï¼Œè€Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯è®© ES å’Œ MySQL å®Œå…¨åŒæ­¥ï¼Œæ‰€ä»¥éœ€è¦åœ¨ QuestionMapper ä¸­ç¼–å†™ä¸€ä¸ªèƒ½æŸ¥è¯¢å‡º isDelete = 1 æ•°æ®çš„æ–¹æ³•ã€‚

1ï¼‰ç¼–å†™æŸ¥è¯¢æŸä¸ªæ—¶é—´åæ›´æ–°çš„æ‰€æœ‰é¢˜ç›®çš„æ–¹æ³•ï¼š

```java
public interface QuestionMapper extends BaseMapper<Question> {

    /**
     * æŸ¥è¯¢é¢˜ç›®åˆ—è¡¨ï¼ˆåŒ…æ‹¬å·²è¢«åˆ é™¤çš„æ•°æ®ï¼‰
     */
    @Select("select * from question where updateTime >= #{minUpdateTime}")
    List<Question> listQuestionWithDelete(Date minUpdateTime);
}
```

2ï¼‰åœ¨ `job/cycle` ä¸‹ç¼–å†™å¢é‡åŒæ­¥åˆ° ES çš„å®šæ—¶ä»»åŠ¡ï¼š

```java
// todo å–æ¶ˆæ³¨é‡Šå¼€å¯ä»»åŠ¡
//@Component
@Slf4j
public class IncSyncQuestionToEs {

    @Resource
    private QuestionMapper questionMapper;

    @Resource
    private QuestionEsDao questionEsDao;

    /**
     * æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedRate = 60 * 1000)
    public void run() {
        // æŸ¥è¯¢è¿‘ 5 åˆ†é’Ÿå†…çš„æ•°æ®
        long FIVE_MINUTES = 5 * 60 * 1000L;
        Date fiveMinutesAgoDate = new Date(new Date().getTime() - FIVE_MINUTES);
        List<Question> questionList = questionMapper.listQuestionWithDelete(fiveMinutesAgoDate);
        if (CollUtil.isEmpty(questionList)) {
            log.info("no inc question");
            return;
        }
        List<QuestionEsDTO> questionEsDTOList = questionList.stream()
                .map(QuestionEsDTO::objToDto)
                .collect(Collectors.toList());
        final int pageSize = 500;
        int total = questionEsDTOList.size();
        log.info("IncSyncQuestionToEs start, total {}", total);
        for (int i = 0; i < total; i += pageSize) {
            int end = Math.min(i + pageSize, total);
            log.info("sync from {} to {}", i, end);
            questionEsDao.saveAll(questionEsDTOList.subList(i, end));
        }
        log.info("IncSyncQuestionToEs end, total {}", total);
    }
}
```

3ï¼‰å°è¯•ä¿®æ”¹éƒ¨åˆ†æ•°æ®ï¼Œé€šè¿‡æ—¥å¿—æŸ¥çœ‹å®šæ—¶ä»»åŠ¡åŒæ­¥æ˜¯å¦ç”Ÿæ•ˆï¼š

![img](./assets/02.åç«¯å¼€å‘ï¼ˆES-å®æˆ˜ï¼‰/aePPkO89PAfF7Pfs-1740010573217-21.webp)

