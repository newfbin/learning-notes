## æœ¬èŠ‚é‡ç‚¹

æµé‡å®‰å…¨æ€§ä¼˜åŒ–

- ç½‘ç«™æµé‡æ§åˆ¶å’Œç†”æ–­ï¼ˆåŸºäº Sentinelï¼‰
- åŠ¨æ€ IP é»‘ç™½åå•è¿‡æ»¤ï¼ˆåŸºäº Nacosï¼‰

## ä¸€ã€ç½‘ç«™æµé‡æ§åˆ¶å’Œç†”æ–­

æµé‡å®‰å…¨ä¼˜åŒ–çš„ç›®æ ‡å¯ä»¥ç®€å•æ¦‚æ‹¬ä¸ºï¼šç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼Œé˜²æ­¢æœªç»æˆæƒçš„è®¿é—®ã€ç¯¡æ”¹ã€æ³„éœ²å’Œæ”»å‡»ï¼ŒåŒæ—¶æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ä¸æ€§èƒ½ã€‚

è€Œä»æµé‡æ§åˆ¶å’Œç†”æ–­çš„è§’åº¦æ¥çœ‹ï¼Œæµé‡å®‰å…¨ä¼˜åŒ–çš„ç›®æ ‡åˆå¯ä»¥æ¦‚æ‹¬ä¸ºï¼šé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€ä¿éšœæœåŠ¡å¯ç”¨æ€§ã€æŠµå¾¡æ¶æ„æµé‡ï¼Œå¹¶ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿå¿«é€Ÿä»æ•…éšœä¸­æ¢å¤ã€‚è¿™ä¹Ÿæ˜¯æœ¬æœŸæ•™ç¨‹ä¸­æˆ‘ä»¬è¿½æ±‚çš„ç›®æ ‡ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

éšç€ç½‘ç«™çš„å‘å±•ï¼Œç”¨æˆ·é‡é€æ¸å¢å¤§ï¼Œç‰¹åˆ«æ˜¯äº’è”ç½‘å…¬å¸ï¼Œç”¨æˆ·é‡æ›´æ˜¯å‘ˆæŒ‡æ•°å‹å¢é•¿ï¼Œæ­¤æ—¶ä¸€æ—¦å‡ºç°ä¿ƒé”€æ´»åŠ¨ï¼Œç½‘ç«™çš„æµé‡ä¼šå¤§å¤§è¶…è¶Šå¹³å‡æ°´å¹³ï¼Œåœ¨é«˜å¹¶å‘è¯·æ±‚ä¸‹ç³»ç»Ÿå¾ˆå¯èƒ½ä¼šå´©æºƒã€‚

å¯¹åº”åˆ°æˆ‘ä»¬çš„é¢è¯•åˆ·é¢˜å¹³å°ï¼Œåœ¨é‡‘ä¸‰é“¶å››æˆ–é‡‘ä¹é“¶åé¢è¯•é«˜å³°æœŸï¼Œç½‘ç«™æµé‡ä¼šå˜å¤§ï¼Œè¿˜å¯èƒ½ä¼šæœ‰å„ç§çˆ¬è™«å’Œæ¶æ„æ”»å‡»ã€‚ä¸ºäº†é¿å…ç³»ç»Ÿå´©æºƒå’Œä¿æŠ¤æœåŠ¡ç¨³å®šæ€§ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç½‘ç«™åšä¸€å®šçš„é˜²æŠ¤æªæ–½ã€‚

å¸¸è§çš„é˜²æŠ¤æªæ–½å°±æ˜¯ **æµé‡æ§åˆ¶**ï¼šé™åˆ¶ç³»ç»Ÿè¿›å…¥çš„è¯·æ±‚æ•°é‡ï¼Œé˜²æ­¢è¿‡è½½ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†è¿›ä¸€æ­¥éš”ç¦»å’Œä¿æŠ¤ç³»ç»Ÿï¼Œé˜²æ­¢æŸäº›ç»„ä»¶å¼‚å¸¸æ—¶å½±å“ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œè¿˜ä¼šé‡‡ç”¨ **ç†”æ–­æœºåˆ¶ + é™çº§ç­–ç•¥** è¿›è¡Œå…œåº•å¤„ç†ï¼Œæå‡ç³»ç»Ÿçš„å¥å£®æ€§å’Œå¯ç”¨æ€§ã€‚

ä¸‹é¢åˆ†åˆ«å¯¹æµé‡æ§åˆ¶ã€ç†”æ–­å’Œé™çº§è¿›è¡Œè§£é‡Šï¼š

#### 1ã€æµé‡æ§åˆ¶

æµé‡æ§åˆ¶æ˜¯ä¸ºäº† **é˜²æ­¢ç³»ç»Ÿè¢«è¿‡å¤šçš„è¯·æ±‚å‹å®**ï¼Œç¡®ä¿èµ„æºåˆç†åˆ†é…å¹¶ä¿æŒæœåŠ¡çš„å¯ç”¨æ€§ï¼Œæ¯”å¦‚å¯¹è¯·æ±‚æ•°é‡çš„é™åˆ¶ã€‚

æµé‡æ§åˆ¶çš„ 3 ä¸ªä¸»è¦ä¼˜åŠ¿ï¼š

1. é˜²æ­¢è¿‡è½½ï¼šå½“ç¬é—´æ¶Œå…¥çš„è¯·æ±‚é‡è¶…å‡ºç³»ç»Ÿå¤„ç†èƒ½åŠ›æ—¶ï¼Œä¼šå¯¼è‡´èµ„æºæ¯ç«­ï¼Œå¦‚ CPU å’Œå†…å­˜è€—å°½ã€‚æµé‡æ§åˆ¶é€šè¿‡é™åˆ¶ç³»ç»Ÿèƒ½å¤„ç†çš„è¯·æ±‚æ•°ï¼Œç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿‡è½½ã€‚
2. é¿å…é›ªå´©æ•ˆåº”ï¼šé«˜è´Ÿè½½ä¸‹æŸä¸ªæœåŠ¡å´©æºƒå¯èƒ½å¼•å‘å…¶ä»–ä¾èµ–æœåŠ¡çš„å´©æºƒï¼Œå½¢æˆè¿é”ååº”ã€‚æµé‡æ§åˆ¶å¯ä»¥æœ‰æ•ˆé¢„é˜²è¿™ç§è¿é”æ•…éšœï¼Œé¿å…ç³»ç»Ÿé›ªå´©ã€‚
3. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼šå³ä¾¿éƒ¨åˆ†è¯·æ±‚è¢«æ‹’ç»æˆ–å»¶è¿Ÿå¤„ç†ï¼Œæµé‡æ§åˆ¶ä¹Ÿèƒ½ç¡®ä¿å¤§éƒ¨åˆ†ç”¨æˆ·çš„è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å“åº”ï¼Œé¿å…å…¨å±€å“åº”æ—¶é—´è¿‡é•¿çš„æƒ…å†µã€‚

å¸¸è§çš„å®ç°æµé‡æ§åˆ¶æ–¹æ³•æœ‰ 2 ç§ï¼š

- é™æµï¼šé€šè¿‡å›ºå®šçª—å£ã€ä»¤ç‰Œæ¡¶æˆ–æ¼æ¡¶ç­‰ç®—æ³•é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡ã€‚
- æ’é˜Ÿï¼šå½“è¯·æ±‚é‡è¶…å‡ºå¤„ç†èƒ½åŠ›æ—¶ï¼Œéƒ¨åˆ†è¯·æ±‚è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé˜²æ­¢ç«‹å³è¶…è½½ã€‚

å¦‚æœå¤§å®¶ä½¿ç”¨è¿‡ä¸€äº›äº‘æœåŠ¡ï¼Œä¼šæ›´å®¹æ˜“ç†è§£æµé‡æ§åˆ¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å¸¸è§çš„æµé‡æ§åˆ¶ç±»å‹ï¼š

1ï¼‰è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼šé™åˆ¶å•ä½æ—¶é—´å†…å•ç”¨æˆ·ã€å• IP çš„è¯·æ±‚æ•°ï¼ˆå¦‚æ¯ç§’æœ€å¤š 100 æ¬¡è¯·æ±‚ï¼‰ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/pGTO1ix81cjkYQEc.webp)

2ï¼‰å¸¦å®½é™åˆ¶ï¼šæ§åˆ¶è®¿é—®ç³»ç»Ÿæ—¶æ¶ˆè€—çš„å¸¦å®½é‡æˆ–è€…ä¸‹è½½é€Ÿåº¦ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/M0eDM3YEr7uMZsP2.webp)

3ï¼‰æ€»æµé‡é™åˆ¶ï¼šé™åˆ¶ç”¨æˆ·æˆ–ç³»ç»Ÿæ•´ä½“çš„æ•°æ®ä¼ è¾“é‡ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/QJDV49tg9EajWgop.webp)

4ï¼‰ç»†ç²’åº¦æ§åˆ¶ï¼šæ ¹æ®æ¥å£ã€ç”¨æˆ·ç­‰ç‰¹å®šç»´åº¦è¿›è¡Œç»„åˆé™æµã€‚æ¯”å¦‚é™åˆ¶è®¿é—®ç‰¹å®šæ¥å£æ—¶ï¼Œæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿåªèƒ½è®¿é—® 60 æ¬¡ã€‚

#### 2ã€ç†”æ–­æœºåˆ¶

å¯ä»¥å‚è€ƒï¼šhttps://sentinelguard.io/zh-cn/docs/circuit-breaking.html

ç†”æ–­æœºåˆ¶çš„ç›®çš„æ˜¯ **é¿å…å½“ä¸‹æ¸¸æœåŠ¡å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿç»§ç»­è€—è´¹èµ„æºé‡å¤å‘èµ·å¤±è´¥è¯·æ±‚**ï¼Œä»è€Œé˜²æ­¢è¿é”æ•…éšœã€‚

è¿™ç±»ä¼¼äºç”µè·¯ä¸­çš„æ–­è·¯å™¨ï¼Œå½“æ£€æµ‹åˆ°å¼‚å¸¸æƒ…å†µæ—¶ï¼Œç†”æ–­å™¨ä¼šè‡ªåŠ¨åˆ‡æ–­å¯¹æ•…éšœæœåŠ¡çš„è°ƒç”¨ï¼Œé˜²æ­¢é—®é¢˜æ‰©å¤§ã€‚

å·¥ä½œæœºåˆ¶ï¼š

1. ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€ï¼šç³»ç»Ÿä¼šå®æ—¶ç›‘æ§æœåŠ¡çš„è°ƒç”¨æƒ…å†µï¼Œä¾‹å¦‚è¯·æ±‚æˆåŠŸç‡ã€å“åº”æ—¶é—´ç­‰ï¼Œåˆ¤æ–­æœåŠ¡çš„å¥åº·çŠ¶å†µã€‚
2. è¿›å…¥ç†”æ–­çŠ¶æ€ï¼šå½“æŸä¸ªæœåŠ¡çš„é”™è¯¯ç‡è¾¾åˆ°è®¾å®šé˜ˆå€¼ï¼ˆå¦‚å“åº”æ—¶é—´è¿‡é•¿æˆ–å‡ºé”™ç‡è¿‡é«˜ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼š **æ¿€æ´»ç†”æ–­å™¨**ï¼Œæš‚æ—¶åœæ­¢å¯¹è¯¥æœåŠ¡çš„è°ƒç”¨ï¼Œé¿å…æ¶ˆè€—ä¸å¿…è¦çš„èµ„æºå’Œè®©é”™è¯¯è¿›ä¸€æ­¥æ‰©æ•£ã€‚
3. å¿«é€Ÿå¤±è´¥ï¼šåœ¨ç†”æ–­çŠ¶æ€ä¸‹ï¼Œç³»ç»Ÿä¸ä¼šå†ç­‰å¾…è¶…æ—¶ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å¤±è´¥å“åº”ï¼Œå‡å°‘ç³»ç»Ÿèµ„æºå ç”¨ï¼Œå¹¶é¿å…å› é•¿æ—¶é—´ç­‰å¾…å¯¼è‡´ç”¨æˆ·ä½“éªŒçš„æ¶åŒ–ã€‚ï¼ˆä¹Ÿå¯ä»¥é™çº§å¤„ç†ï¼‰
4. ç†”æ–­æ¢å¤æœºåˆ¶ï¼šç†”æ–­å¹¶éæ°¸ä¹…çŠ¶æ€ã€‚åœ¨ä¸€æ®µæ—¶é—´åï¼Œç†”æ–­å™¨ä¼šè¿›å…¥ **åŠå¼€çŠ¶æ€**ï¼Œå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æœåŠ¡çš„å¥åº·æƒ…å†µã€‚å¦‚æœæ¢å¤æ­£å¸¸ï¼Œç†”æ–­å™¨å°†å…³é—­ï¼Œæ¢å¤æ­£å¸¸æœåŠ¡è°ƒç”¨ï¼›å¦‚æœä»æœ‰é—®é¢˜ï¼Œåˆ™ç»§ç»­ä¿æŒç†”æ–­ã€‚

ç†”æ–­æµç¨‹ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/JBqqdVprOaFISEvR.webp)

ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªæ”¯ä»˜æœåŠ¡ç”±äºé«˜è´Ÿè½½é¢‘ç¹è¶…æ—¶ï¼Œæ­¤æ—¶ç†”æ–­å™¨ä¼šæ£€æµ‹åˆ°æ”¯ä»˜æœåŠ¡çš„å¥åº·çŠ¶å†µæ¶åŒ–ï¼Œæš‚æ—¶åˆ‡æ–­å¯¹å®ƒçš„è°ƒç”¨ï¼Œé˜²æ­¢å‰ç«¯ç³»ç»Ÿç»§ç»­å‘å‡ºè¯·æ±‚ã€‚å¦‚æœä¸é‡‡å–ç†”æ–­æªæ–½ï¼Œæ”¯ä»˜æœåŠ¡çš„å¼‚å¸¸å¯èƒ½ä¼šæ‹–å®æ•´ä¸ªç³»ç»Ÿï¼Œç”šè‡³å½±å“å…¶ä»–ä¾èµ–çš„æœåŠ¡æ¨¡å—æˆ–ç³»ç»Ÿèµ„æºï¼ˆæ¯”å¦‚è¯·æ±‚è¿æ¥ï¼‰ã€‚

#### 3ã€é™çº§æœºåˆ¶

é™çº§çš„ç›®çš„æ˜¯åœ¨æŸä¸ªæœåŠ¡çš„å“åº”èƒ½åŠ›ä¸‹é™ã€æˆ–è¯¥æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œæä¾›ç®€åŒ–ç‰ˆçš„åŠŸèƒ½æˆ–è¿”å›é»˜è®¤å€¼ä½œä¸º **å…œåº•**ï¼Œä¿æŒç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½å¯ç”¨ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒçš„è¿ç»­æ€§ï¼Œé¿å…ç³»ç»Ÿé¢‘ç¹æŠ¥é”™ã€‚

é™çº§å¯ä»¥æ˜¯æ‰‹åŠ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥æ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨è§¦å‘ã€‚ç³»ç»Ÿå¯èƒ½ç”±äºå¤šç§åŸå› ï¼ˆå¦‚é«˜è´Ÿè½½ã€å¤–éƒ¨ä¾èµ–ä¸å¯ç”¨ç­‰ï¼‰è§¦å‘é™çº§ï¼Œè¿”å›ç®€åŒ–çš„å“åº”æˆ–é»˜è®¤å€¼ã€‚

é™çº§æœºåˆ¶çš„å¥½å¤„ï¼š

1. ä¼˜é›…åœ°å¤„ç†æ•…éšœï¼šåœ¨é™çº§çŠ¶æ€ä¸‹ï¼Œç³»ç»Ÿä¸ä¼šç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªæ•°æ®æŸ¥è¯¢æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿå¯ä»¥è¿”å›ç¼“å­˜æ•°æ®ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°çš„æ˜¯æœ‰æ•ˆä¿¡æ¯ï¼Œè€Œéé”™è¯¯é¡µé¢ã€‚
2. é™ä½æœåŠ¡å‹åŠ›ï¼šé™çº§æœ‰åŠ©äºå‡è½»ç³»ç»Ÿå¯¹éæ ¸å¿ƒæœåŠ¡çš„ä¾èµ–ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„ç¨³å®šè¿è¡Œã€‚ä¾‹å¦‚ï¼Œå½“æ¨èç³»ç»Ÿæˆ–å¹¿å‘ŠæœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œé™çº§å¯ä»¥å‡å°‘å¯¹è¿™äº›æœåŠ¡çš„è°ƒç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªç”µå•†ç½‘ç«™ä¸Šï¼Œå¦‚æœå•†å“æ¨èç³»ç»Ÿç”±äºå¤–éƒ¨æœåŠ¡æ•…éšœæ— æ³•æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥è§¦å‘é™çº§æœºåˆ¶ï¼Œæ˜¾ç¤ºä¸€ç»„é™æ€çš„æ¨èå•†å“åˆ—è¡¨ã€‚è¿™ç¡®ä¿ç”¨æˆ·ä»ç„¶èƒ½å¤Ÿé¡ºåˆ©æµè§ˆå•†å“é¡µé¢ï¼Œè€Œä¸æ˜¯ç›´æ¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯ã€‚

æ˜¯ä¸æ˜¯æœ‰ç‚¹ try...catch... çš„æ„Ÿè§‰ï¼Ÿä½†é™çº§è¿™ä¸ªæ¦‚å¿µæ˜¾ç„¶æ¯”å¼‚å¸¸å¤„ç†è¦æ›´â€œé«˜å¤§ä¸Šâ€ä¸€äº›ï¼Œä¸ä¸€å®šæ˜¯å‡ºäº†å¼‚å¸¸æ‰é™çº§ï¼Œå“åº”è¾ƒæ…¢æˆ–è€…å—åˆ°å…¶ä»–æœåŠ¡å½±å“å¯èƒ½ä¹Ÿä¼šè§¦å‘é™çº§ã€‚

#### 4ã€ç†”æ–­å’Œé™çº§çš„åŒºåˆ«

åˆå­¦è€…å¾ˆå®¹æ˜“æŠŠè¿™ä¸¤ä¸ªæ¦‚å¿µææ··ï¼ŒäºŒè€…æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µï¼Œåªä¸è¿‡ç»å¸¸ç»“åˆä½¿ç”¨ç½¢äº†ã€‚

ç†”æ–­ä¸ä¸€å®šè¦é™çº§ï¼Œåªæ˜¯åˆ‡æ–­è°ƒç”¨ï¼›é™çº§ä¹Ÿä¸ä¸€å®šéœ€è¦ç†”æ–­ï¼Œå•æ¬¡è°ƒç”¨å¤±è´¥ä¹Ÿå¯ä»¥é™çº§ï¼ˆæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å¤±è´¥è¿”å›å†…å­˜çš„æ•°æ®ï¼‰ã€‚

å…·ä½“æ¥è¯´ï¼š

- ç†”æ–­æ˜¯å½“æœåŠ¡å¥åº·çŠ¶å†µæ¶åŒ–æ—¶ï¼Œé€šè¿‡ **åˆ‡æ–­è°ƒç”¨** é¿å…ç³»ç»Ÿèµ„æºæµªè´¹æˆ–æœåŠ¡é—´æ•…éšœæ‰©æ•£ã€‚
- é™çº§æ˜¯åœ¨ç³»ç»Ÿå‹åŠ›è¿‡å¤§æˆ–æŸä¸ªæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œé€šè¿‡ **æä¾›ç®€åŒ–çš„æ›¿ä»£æ–¹æ¡ˆ** ï¼Œä¿æŒç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

ä¸¤è€…ç»å¸¸ç»“åˆä½¿ç”¨ï¼Œå…ˆè§¦å‘ç†”æ–­åå†è¿›è¡Œé™çº§ã€‚

#### æ‰©å±•çŸ¥è¯† - æœ‰æŸæœåŠ¡

æœ‰æŸæœåŠ¡æŒ‡çš„æ˜¯åœ¨ç³»ç»Ÿèµ„æºæœ‰é™æˆ–è´Ÿè½½è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿ **æœ‰æ„è¯†åœ°** èˆå¼ƒéƒ¨åˆ†éæ ¸å¿ƒæœåŠ¡æˆ–æ•°æ®ï¼Œæ¥ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§å’Œæ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯â€œä¸¢è½¦ä¿å¸…â€ã€‚

ä¸¾äº›ä¾‹å­ï¼š

- è§†é¢‘æµåª’ä½“ï¼šåœ¨ç½‘ç»œå¸¦å®½ä¸è¶³æ—¶ï¼Œæµåª’ä½“å¹³å°ä¼šåŠ¨æ€é™ä½è§†é¢‘è´¨é‡ï¼ˆå¦‚ä»é«˜æ¸…é™åˆ°æ ‡æ¸…ï¼‰ï¼Œä»¥é¿å…ä¸­æ–­è§†é¢‘æ’­æ”¾ã€‚è¿™å°±æ˜¯å…¸å‹çš„â€œæœ‰æŸâ€ç­–ç•¥ï¼Œç‰ºç‰²ç”»è´¨æ¥ä¿è¯è§†é¢‘çš„æµç•…æ’­æ”¾ã€‚
- å®æ—¶æ•°æ®é‡‡é›†ï¼šåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡ä¸¢å¼ƒéƒ¨åˆ†éé‡è¦çš„æ—¥å¿—æˆ–ç›‘æ§æ•°æ®ï¼Œå‡å°‘æ•°æ®å¤„ç†å‹åŠ›ï¼Œä¼˜å…ˆä¿è¯æ ¸å¿ƒä¸šåŠ¡æµç¨‹ã€‚

ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æœ‰æŸæœåŠ¡å’Œé™çº§ï¼Ÿ

- æœ‰æŸæœåŠ¡ï¼šé€‚ç”¨äºéœ€è¦åœ¨æ€§èƒ½å’Œè´¨é‡ä¹‹é—´åšå‡ºå¹³è¡¡çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯ **å½“ç³»ç»Ÿèµ„æºä¸è¶³** æ—¶ï¼Œé€‰æ‹©ç‰ºç‰²æŸäº›æœåŠ¡çš„è´¨é‡æ¥ä¿è¯æ•´ä½“ç¨³å®šã€‚
- é™çº§ï¼šé€‚ç”¨äºéœ€è¦ä¿è¯ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½åœ¨é«˜è´Ÿè½½æˆ–éƒ¨åˆ†æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µä¸‹ä»èƒ½ç»§ç»­æä¾›çš„åœºæ™¯ã€‚é™çº§æ›´å¤šæ˜¯ **åœ¨åŠŸèƒ½å±‚é¢è¿›è¡Œç®€åŒ–** ï¼Œè€Œéç›´æ¥ä¸¢å¼ƒæ•°æ®æˆ–æœåŠ¡ã€‚

å¯ä»¥è¿™ä¹ˆç†è§£ï¼šæœ‰æŸæœåŠ¡æ›´å€¾å‘äº **æ•´ä½“è§†è§’** ä¸Šèµ„æºçš„å–èˆï¼Œé™çº§æ›´å€¾å‘äºä¿è¯ **æŸä¸ªåŠŸèƒ½** çš„å¯ç”¨ã€‚

### éœ€æ±‚åˆ†æï¼ˆé™æµç†”æ–­è§„åˆ™ï¼‰

å›å½’åˆ°æœ¬é¡¹ç›®çš„å…·ä½“éœ€æ±‚ï¼šè¦å¯¹ä»€ä¹ˆèµ„æºè¿›è¡Œé™æµç†”æ–­ï¼Ÿè§„åˆ™æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

æˆ‘ä»¬æ¥å®Œæˆä¸¤ä¸ªæœ‰ä»£è¡¨æ€§çš„éœ€æ±‚ï¼š

1. å¯¹å•ä¸ªæ¥å£æ•´ä½“é™æµ
2. å¯¹å•ä¸ª IP è®¿é—®å•ä¸ªæ¥å£é™æµ

#### 1ã€æŸ¥çœ‹é¢˜åº“åˆ—è¡¨æ¥å£é™æµç†”æ–­

èµ„æºï¼šlistQuestionBankVOByPage æ¥å£

ç›®çš„ï¼šæ§åˆ¶å¯¹è€—æ—¶è¾ƒé•¿çš„ã€ç»å¸¸è®¿é—®çš„æ¥å£çš„è¯·æ±‚é¢‘ç‡ï¼Œé˜²æ­¢è¿‡å¤šè¯·æ±‚å¯¼è‡´ç³»ç»Ÿè¿‡è½½ã€‚

é™æµè§„åˆ™ï¼š

- ç­–ç•¥ï¼šæ•´ä¸ªæ¥å£æ¯ç§’é’Ÿä¸è¶…è¿‡ 10 æ¬¡è¯·æ±‚
- é˜»å¡æ“ä½œï¼šæç¤ºâ€œç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…â€

ç†”æ–­è§„åˆ™ï¼š

- ç†”æ–­æ¡ä»¶ï¼šå¦‚æœæ¥å£å¼‚å¸¸ç‡è¶…è¿‡ 10%ï¼Œæˆ–è€…æ…¢è°ƒç”¨ï¼ˆå“åº”æ—¶é•¿ > 3 ç§’ï¼‰çš„æ¯”ä¾‹å¤§äº 20%ï¼Œè§¦å‘ 60 ç§’ç†”æ–­ã€‚
- ç†”æ–­æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®ï¼ˆç¼“å­˜æˆ–ç©ºæ•°æ®ï¼‰

#### **2ã€å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨é™æµç†”æ–­**

èµ„æºï¼šlistQuestionVoByPage æ¥å£

é™æµè§„åˆ™ï¼š

- ç­–ç•¥ï¼šæ¯ä¸ª IP åœ°å€æ¯åˆ†é’Ÿå…è®¸æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨çš„æ¬¡æ•°ä¸èƒ½è¶…è¿‡ 60 æ¬¡ã€‚
- é˜»å¡æ“ä½œï¼šæç¤ºâ€œè®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•â€

ç†”æ–­è§„åˆ™ï¼š

- ç†”æ–­æ¡ä»¶ï¼šå¦‚æœæ¥å£å¼‚å¸¸ç‡è¶…è¿‡ 10%ï¼Œæˆ–è€…æ…¢è°ƒç”¨ï¼ˆå“åº”æ—¶é•¿ > 3 ç§’ï¼‰çš„æ¯”ä¾‹å¤§äº 20%ï¼Œè§¦å‘ 60 ç§’ç†”æ–­ã€‚
- ç†”æ–­æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®ï¼ˆç¼“å­˜æˆ–ç©ºæ•°æ®ï¼‰

#### æ‰©å±•çŸ¥è¯† - æ›´å¤šè§„åˆ™

ä»¥ä¸‹è§„åˆ™æ„Ÿå…´è¶£çš„åŒå­¦å¯è‡ªä¸»å®ç°ï¼š

1ï¼‰é¢˜ç›®æœç´¢

é™æµè§„åˆ™ï¼šæ¯ä¸ª IP åœ°å€æ¯åˆ†é’Ÿå…è®¸è¿›è¡Œçš„é¢˜ç›®æœç´¢æ¬¡æ•°ï¼Œä¾‹å¦‚ 100 æ¬¡ã€‚

ç†”æ–­æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®ï¼ˆç¼“å­˜æˆ–ç©ºæ•°æ®ï¼‰

2ï¼‰ç”¨æˆ·æ³¨å†Œ

é™æµè§„åˆ™ï¼šæ¯ä¸ª IP åœ°å€æ¯åˆ†é’Ÿå…è®¸æ³¨å†Œçš„æ¬¡æ•°ï¼Œä¾‹å¦‚ 5 æ¬¡ã€‚è¶…è¿‡é˜ˆå€¼åˆ™è¿”å›ç”¨æˆ·æ³¨å†Œé¢‘ç¹çš„é”™è¯¯æç¤ºï¼Œé˜²æ­¢æ¶æ„æ³¨å†Œã€‚

ç†”æ–­è§„åˆ™ï¼šå¦‚æœç”¨æˆ·æ³¨å†ŒæœåŠ¡å‡ºç°å¼‚å¸¸ç‡é«˜äº 5%ï¼ˆä¾‹å¦‚è¿ç»­ 5 åˆ†é’Ÿå†…çš„å¤±è´¥è¯·æ±‚å æ€»è¯·æ±‚çš„æ¯”ä¾‹ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½çš„é”™è¯¯æç¤ºã€‚

3ï¼‰ç”¨æˆ·ç™»å½•

é™æµè§„åˆ™ï¼šæ¯ä¸ª IP åœ°å€æ¯åˆ†é’Ÿå…è®¸å°è¯•ç™»å½•çš„æ¬¡æ•°ï¼Œä¾‹å¦‚ 10 æ¬¡ã€‚å¯¹äºé¢‘ç¹çš„å¤±è´¥ç™»å½•å°è¯•ï¼Œå¯ä»¥é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£æ”»å‡»ã€‚

ç†”æ–­è§„åˆ™ï¼šå¦‚æœç™»å½•æœåŠ¡çš„å¤±è´¥ç‡è¶…è¿‡ 10% æˆ–ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼ˆä¾‹å¦‚æ¯åˆ†é’Ÿè¶…è¿‡ 1000 æ¬¡ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½çš„é”™è¯¯æç¤ºã€‚

### å®ç°æ–¹æ¡ˆï¼ˆæŠ€æœ¯é€‰å‹ï¼‰

é™¤äº†ç½‘å…³å±‚ï¼ˆNginx ç­‰ï¼‰å®ç°çš„é™æµï¼Œåœ¨ Java é¡¹ç›®ä¸­å¸¸ç”¨æ¥å®ç°é™æµç†”æ–­ç›¸å…³çš„æŠ€æœ¯ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š

#### 1ã€Sentinel

[Sentinel](https://sentinelguard.io/zh-cn/index.html) æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„é™æµã€ç†”æ–­ã€é™çº§ç»„ä»¶ï¼Œæ—¨åœ¨ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›å¯é çš„ä¿æŠ¤æœºåˆ¶ã€‚å®ƒè®¾è®¡ç”¨äºè§£å†³é«˜å¹¶å‘æµé‡ä¸‹çš„ç¨³å®šæ€§é—®é¢˜ï¼Œå¹¶ä¸”æ”¯æŒä¸ Dubboã€Spring Cloud ç­‰å¤šç§æ¡†æ¶é›†æˆã€‚

å®ƒçš„åŠŸèƒ½ï¼š

- é™æµï¼šæ”¯æŒåŸºäº QPSã€å¹¶å‘æ•°é‡ç­‰æ¡ä»¶çš„é™æµï¼Œæ”¯æŒæ»‘åŠ¨çª—å£ã€é¢„çƒ­ã€æ¼æ¡¶ç­‰ç®—æ³•ã€‚
- ç†”æ–­é™çº§ï¼šæ”¯æŒå¤±è´¥ç‡ã€æ…¢è°ƒç”¨æ¯”ä¾‹ç­‰æŒ‡æ ‡è§¦å‘ç†”æ–­ï¼Œå¹¶æä¾›è‡ªåŠ¨æ¢å¤æœºåˆ¶ã€‚
- çƒ­ç‚¹å‚æ•°é™æµï¼šå¯ä»¥åŸºäºç‰¹å®šçš„å‚æ•°è¿›è¡Œé™æµï¼Œå¦‚é™åˆ¶ç‰¹å®šç”¨æˆ· ID çš„è¯·æ±‚é¢‘ç‡ã€‚
- ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ï¼šå¯ä»¥æ ¹æ®ç³»ç»Ÿçš„å®é™…è´Ÿè½½ï¼ˆå¦‚ CPUã€å†…å­˜ï¼‰åŠ¨æ€è°ƒæ•´æµé‡ã€‚
- ä¸°å¯Œçš„è§„åˆ™é…ç½®ï¼šé€šè¿‡é…ç½®ä¸­å¿ƒæˆ–æ§åˆ¶å°åŠ¨æ€è°ƒæ•´é™æµå’Œç†”æ–­è§„åˆ™ã€‚

ä¼˜åŠ¿ï¼šåŠŸèƒ½ä¸°å¯Œã€æä¾›æ§åˆ¶å°ã€æ›´æ–°è¾ƒé¢‘ç¹ã€ç¤¾åŒºæ´»è·ƒã€æ–‡æ¡£æ¸…æ™°ï¼Œèƒ½å¤Ÿå¿«é€Ÿå…¥é—¨ä¸Šæ‰‹ã€‚

#### 2ã€Hystrix

[Hystrix](https://github.com/Netflix/Hystrix) æ˜¯ Netflix å¼€æºçš„ä¸€ä¸ªé™æµã€ç†”æ–­å’Œé™çº§åº“ã€‚å®ƒé€šè¿‡ç†”æ–­å™¨æ¨¡å¼åœ¨æ£€æµ‹åˆ°ä¸‹æ¸¸æœåŠ¡å¤±è´¥ç‡è¿‡é«˜æ—¶ä¸­æ–­è¯·æ±‚ï¼Œä»¥é˜²æ­¢ç³»ç»Ÿèµ„æºè€—å°½ã€‚

å®ƒçš„åŠŸèƒ½ï¼š

- ç†”æ–­ï¼šå½“è°ƒç”¨å¤±è´¥æˆ–å“åº”è¶…æ—¶æ—¶ï¼Œè§¦å‘ç†”æ–­ï¼Œåœæ­¢è°ƒç”¨å¤±è´¥çš„æœåŠ¡ã€‚
- é™çº§ï¼šåœ¨è§¦å‘ç†”æ–­åï¼Œè°ƒç”¨å¤‡ç”¨é€»è¾‘æˆ–é»˜è®¤è¿”å›å€¼ã€‚
- éš”ç¦»ï¼šHystrix ä½¿ç”¨çº¿ç¨‹æ± æˆ–ä¿¡å·é‡æ¥éš”ç¦»æœåŠ¡è°ƒç”¨ï¼Œé˜²æ­¢å•ä¸ªæœåŠ¡çš„èµ„æºæ¶ˆè€—å½±å“å…¨å±€ã€‚
- ç†”æ–­æ¢å¤ï¼šå½“ä¸‹æ¸¸æœåŠ¡æ¢å¤æ—¶ï¼Œé€æ­¥æ¢å¤è°ƒç”¨ã€‚

è¿˜æä¾›äº†ä¸°å¯Œçš„ç›‘æ§å’Œå‘Šè­¦åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ Hystrix Dashboard è¿›è¡Œå®æ—¶ç›‘æ§ã€‚

ä½†æ˜¯ **å®ƒç›®å‰å·²ç»è¿›å…¥ç»´æŠ¤çŠ¶æ€ï¼Œä¸å†è¿›è¡Œæ–°çš„åŠŸèƒ½æ›´æ–°**ï¼Œæ‰€ä»¥æ–°é¡¹ç›®å°±æ²¡å¿…è¦ä½¿ç”¨äº†ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/tSqeyZINI11irRBd.webp)

#### 3ã€Resilience4j

[Resilience4j](https://github.com/resilience4j/resilience4j) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç†”æ–­ã€é™æµã€éš”ç¦»ã€é‡è¯•åº“ï¼Œå®ƒè®¾è®¡çµæ„Ÿæ¥æºäº Netflix çš„ Hystrix æ¡†æ¶ï¼Œä¸“é—¨è®¾è®¡ä¸ºå“åº”å¼ç¼–ç¨‹å’Œ Java 8+ é£æ ¼ä¸‹çš„ç†”æ–­åº“ã€‚

ä¼˜ç‚¹ï¼šå®ƒå¾ˆè½»é‡çº§ï¼Œæ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼Œç‰¹åˆ«é€‚åˆå“åº”å¼ç¼–ç¨‹é£æ ¼ã€‚

ç¼ºç‚¹ï¼šç›¸æ¯” Sentinelï¼ŒåŠŸèƒ½ç›¸å¯¹è¾ƒå°‘ï¼Œå°¤å…¶åœ¨é™æµåŠŸèƒ½ä¸Šä¸å¤Ÿä¸°å¯Œã€‚

#### 4ã€Guava RateLimiter

RateLimiter æ˜¯ [Guava](https://github.com/google/guava) æä¾›çš„ä¸€ä¸ªé™æµå·¥å…·ï¼ŒåŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼Œä¸»è¦ç”¨äºå¯¹ç³»ç»Ÿçš„æµé‡è¿›è¡Œæ§åˆ¶ã€‚

ç¼ºç‚¹ï¼šå®ƒä»…æ”¯æŒé™æµï¼Œä¸”åŠŸèƒ½ç›¸å¯¹å•ä¸€ï¼Œä¸èƒ½å¤„ç†ç†”æ–­ç­‰å¤æ‚åœºæ™¯ã€‚é€‚åˆä¸éœ€è¦å¤æ‚ç†”æ–­æˆ–éš”ç¦»åŠŸèƒ½çš„å°å‹é¡¹ç›®ï¼Œä¸»è¦ç”¨äº **å•æœºç³»ç»Ÿ** çš„æµé‡æ§åˆ¶ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
// æ¯ç§’å…è®¸ 2 ä¸ªè¯·æ±‚
RateLimiter rateLimiter = RateLimiter.create(2.0);

for (int i = 0; i < 10; i++) {
    // é˜»å¡ç›´åˆ°å¯ä»¥è·å–åˆ°è®¸å¯
    rateLimiter.acquire();
    System.out.println("è¯·æ±‚ " + i + " åœ¨ " + System.currentTimeMillis() + " æ‰§è¡Œ");
}
```

#### 5ã€Redisson RRateLimiter

Redisson æ˜¯ä¸€ä¸ªåŸºäº Redis çš„ Java é©±åŠ¨ç¨‹åºï¼Œå®ƒæä¾›äº†ä¸°å¯Œçš„åˆ†å¸ƒå¼å·¥å…·å’Œæ•°æ®ç»“æ„ï¼Œå…¶ä¸­åŒ…æ‹¬åˆ†å¸ƒå¼é”ã€è®¡æ•°å™¨ã€é˜Ÿåˆ—ã€ä¿¡å·é‡ï¼Œä»¥åŠé™æµï¼ˆRate Limiterï¼‰ç­‰åŠŸèƒ½ã€‚

Redisson æä¾›äº† `RRateLimiter` æ¥å£æ¥æ”¯æŒé™æµæ“ä½œã€‚ä½ å¯ä»¥å®šä¹‰æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œè¶…å‡ºé™åˆ¶çš„è¯·æ±‚å°†è¢«é˜»å¡æˆ–æ‹’ç»ã€‚å®ƒçš„é™æµåŸºäº Redis çš„è®¡æ•°å™¨æ¥æ§åˆ¶è®¿é—®é¢‘ç‡ï¼Œç¡®ä¿å³ä½¿åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´ï¼Œä¹Ÿèƒ½æœ‰æ•ˆåœ°é™åˆ¶è¯·æ±‚é€Ÿç‡ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
// åˆå§‹åŒ–Redissonå®¢æˆ·ç«¯
RedissonClient redisson = Redisson.create(config);

// è·å–é™æµå™¨å¯¹è±¡
RRateLimiter rateLimiter = redisson.getRateLimiter("myRateLimiter");

// åˆå§‹åŒ–é™æµå™¨ï¼Œè®¾ç½®é€Ÿç‡ï¼šæ¯1ç§’é’Ÿæœ€å¤š3ä¸ªè¯·æ±‚
rateLimiter.trySetRate(RRateLimiter.RateType.OVERALL, 3, 1, RRateLimiter.IntervalUnit.SECONDS);

// è¯·æ±‚é™æµå™¨è·å–è®¸å¯
for (int i = 0; i < 10; i++) {
    boolean acquired = rateLimiter.tryAcquire(1);
    System.out.println("Request " + (i + 1) + " is allowed: " + acquired);
}
```

ğŸ’¡[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½ BI é¡¹ç›®](https://www.code-nav.cn/course/1790980531403927553) ä¸­ï¼Œå°±æ˜¯é€šè¿‡ Redisson RRateLimiter å®ç°äº†é™æµï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å­¦ä¹ ã€‚

#### é€‰å‹ç­–ç•¥

1ï¼‰ä»åŠŸèƒ½å…¨é¢ã€ç”Ÿæ€æˆç†Ÿè§’åº¦ï¼šå¦‚æœéœ€è¦å…¨é¢çš„ç†”æ–­ã€é™æµã€é™çº§ã€ç›‘æ§åŠŸèƒ½ï¼ŒåŒæ—¶å…¼å®¹ Spring Cloudã€Spring Bootã€Dubbo ç­‰å¾®æœåŠ¡æ¶æ„ï¼ŒSentinel æ˜¯æœ€ä½³é€‰æ‹©ï¼Œåœ¨æˆ‘ä»¬å›½å†…å…¬å¸ä¸­æœ‰è¾ƒå¹¿æ³›åº”ç”¨ã€‚

2ï¼‰ä»è½»é‡çº§ã€å“åº”å¼ç¼–ç¨‹è§’åº¦ï¼šå¦‚æœé¡¹ç›®é‡‡ç”¨å“åº”å¼ç¼–ç¨‹æ¨¡å‹ï¼Œæˆ–å¸Œæœ›ä½¿ç”¨è½»é‡çº§çš„ç†”æ–­é™æµç»„ä»¶ï¼ŒResilience4j æ˜¯éå¸¸å¥½çš„é€‰æ‹©ã€‚

3ï¼‰å·²æœ‰ Hystrix é›†æˆçš„ç³»ç»Ÿï¼šå¦‚æœç°æœ‰ç³»ç»Ÿå·²ç»é›†æˆäº† Hystrixï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œä½†éœ€è¦è€ƒè™‘æœªæ¥çš„æŠ€æœ¯æ›´æ–°ï¼Œæ¨èé€æ¸è¿‡æ¸¡åˆ° Sentinelã€‚

4ï¼‰å•æœºé™æµéœ€æ±‚ï¼šå¯¹äºä¸éœ€è¦å¤æ‚ç†”æ–­åŠŸèƒ½çš„å°å‹åº”ç”¨ï¼ŒGuava RateLimiter å¯ä»¥å¿«é€Ÿå®ç°ç®€å•çš„é™æµã€‚

5ï¼‰åˆ†å¸ƒå¼é™æµéœ€æ±‚ï¼šå¯¹äºä¸éœ€è¦å¤æ‚ç†”æ–­åŠŸèƒ½çš„åˆ†å¸ƒå¼åº”ç”¨ï¼ŒRedisson çš„ RRateLimiter å¯ä»¥å¿«é€Ÿå®ç°ç®€å•çš„é™æµã€‚

**æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ Sentinel**ï¼Œå¸¦å¤§å®¶å­¦ä¹ ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§é™æµã€ç†”æ–­ç­–ç•¥ï¼Œæ”¯æŒå¤šç§æ¡†æ¶é›†æˆçš„ç½‘ç«™æµé‡æ§åˆ¶å’Œç†”æ–­ç»„ä»¶ã€‚

Sentinel å®˜æ–¹ç»™å‡ºçš„ç»„ä»¶å¯¹æ¯”ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/RKIMHCI3PTq2B419.webp)

### Sentinel å…¥é—¨

https://sentinelguard.io/zh-cn/index.html

#### 1ã€æ ¸å¿ƒæ¦‚å¿µ

1ï¼‰èµ„æºï¼šè¡¨ç¤ºè¦ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘æˆ–ä»£ç å—ã€‚æˆ‘ä»¬è¯´çš„èµ„æºï¼Œå¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼ŒæœåŠ¡ã€æœåŠ¡é‡Œçš„æ–¹æ³•ã€ç”šè‡³æ˜¯ä¸€æ®µä»£ç ã€‚

ä½¿ç”¨ Sentinel æ¥è¿›è¡Œèµ„æºä¿æŠ¤ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤:

1. å®šä¹‰èµ„æº
2. å®šä¹‰è§„åˆ™
3. æ£€éªŒè§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ

**å…ˆæŠŠå¯èƒ½éœ€è¦ä¿æŠ¤çš„èµ„æºå®šä¹‰å¥½ï¼Œä¹‹åå†é…ç½®è§„åˆ™ã€‚**ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼Œåªè¦æœ‰äº†èµ„æºï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»»ä½•æ—¶å€™çµæ´»åœ°å®šä¹‰å„ç§æµé‡æ§åˆ¶è§„åˆ™ã€‚åœ¨ç¼–ç çš„æ—¶å€™ï¼Œåªéœ€è¦è€ƒè™‘è¿™ä¸ªä»£ç æ˜¯å¦éœ€è¦ä¿æŠ¤ï¼Œå¦‚æœéœ€è¦ä¿æŠ¤ï¼Œå°±å°†ä¹‹å®šä¹‰ä¸ºä¸€ä¸ªèµ„æºã€‚

æœ‰å¤šç§å®šä¹‰èµ„æºçš„æ–¹æ³•ï¼Œæ¯”å¦‚ç¼–ç¨‹å¼å’Œæ³¨è§£å¼ï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html) ã€‚

2ï¼‰è§„åˆ™ï¼šSentinel ä½¿ç”¨è§„åˆ™æ¥å®šä¹‰å¯¹èµ„æºçš„ä¿æŠ¤ç­–ç•¥ã€‚

å¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html) æ¥äº†è§£è§„åˆ™ï¼Œæ¯”å¦‚ï¼š

- é™æµè§„åˆ™ï¼šç”¨äºæ§åˆ¶æµé‡çš„è§„åˆ™ï¼Œè®¾ç½® QPSï¼ˆæ¯ç§’æŸ¥è¯¢é‡ï¼‰ç­‰å‚æ•°ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚
- ç†”æ–­è§„åˆ™ï¼šç”¨äºå®ç°ç†”æ–­é™çº§çš„è§„åˆ™ï¼Œå½“æŸä¸ªèµ„æºçš„å¼‚å¸¸æ¯”ä¾‹æˆ–å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè§¦å‘ç†”æ–­ï¼ŒçŸ­æ—¶é—´å†…ä¸å†è®¿é—®è¯¥èµ„æºã€‚
- ç³»ç»Ÿè§„åˆ™ï¼šæ ¹æ®ç³»ç»Ÿçš„æ•´ä½“è´Ÿè½½ï¼ˆå¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ç­‰ï¼‰è¿›è¡Œä¿æŠ¤ï¼Œé€‚åˆåœ¨ç³»ç»Ÿçº§åˆ«è¿›è¡Œæµé‡æ§åˆ¶ã€‚
- çƒ­ç‚¹å‚æ•°è§„åˆ™ï¼šç”¨äºé™åˆ¶æŸä¸ªæ–¹æ³•çš„æŸäº›çƒ­ç‚¹å‚æ•°çš„è®¿é—®é¢‘ç‡ï¼Œé¿å…æŸäº›å‚æ•°å¯¼è‡´æµé‡è¿‡å¤§ã€‚
- æˆæƒè§„åˆ™ï¼šç”¨äºå®šä¹‰é»‘ç™½åå•çš„æˆæƒè§„åˆ™ï¼Œæ§åˆ¶èµ„æºè®¿é—®çš„æƒé™ã€‚

3ï¼‰æ§åˆ¶å°ï¼š Sentinel æ§åˆ¶å°æ˜¯ä¸€ä¸ªå¯è§†åŒ–çš„ç®¡ç†å·¥å…·ï¼Œä¸»è¦ç”¨äºç›‘æ§ã€ç®¡ç†å’Œé…ç½® Sentinel çš„æµæ§è§„åˆ™ã€ç†”æ–­è§„åˆ™ç­‰ã€‚å®ƒæä¾›äº†ä¸€ä¸ªå‹å¥½çš„ç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥è½»æ¾åœ°æ“ä½œã€‚è¿™æ˜¯ Sentinel çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Œå¯ä»¥æå‡å¯è§‚æµ‹æ€§ï¼Œæ²¡æœ‰ Sentinel æ§åˆ¶å°ï¼Œæ„Ÿè§‰å°±å¤±å»äº†ä½¿ç”¨å®ƒçš„çµé­‚ã€‚

4ï¼‰å®¢æˆ·ç«¯ï¼šæ˜¯æŒ‡é›†æˆäº† Sentinel çš„åº”ç”¨ç¨‹åºï¼Œé€šå¸¸æ˜¯é€šè¿‡å¼•å…¥ Sentinel çš„ä¾èµ–æ¥æ¥å…¥ã€‚å®¢æˆ·ç«¯è´Ÿè´£åœ¨æœ¬åœ°å¯¹èµ„æºè¿›è¡Œç›‘æ§ã€é™æµã€ç†”æ–­ï¼Œå¹¶å°† **æ•°æ®ä¸ŠæŠ¥** ç»™æ§åˆ¶å°ã€‚

#### 2ã€æ¶æ„è®¾è®¡

[å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„åŸºæœ¬åŸç†](https://sentinelguard.io/zh-cn/docs/basic-implementation.html)ï¼Œæ€»ä½“æ¶æ„è®¾è®¡å¦‚ä¸‹ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/cJesgoNNkkEzj98w.webp)

Sentinel å°† `ProcessorSlot` ä½œä¸º SPI æ¥å£è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾— Slot Chain å…·å¤‡äº†æ‰©å±•çš„èƒ½åŠ›ã€‚æ‚¨å¯ä»¥è‡ªè¡ŒåŠ å…¥è‡ªå®šä¹‰çš„ slot å¹¶ç¼–æ’ slot é—´çš„é¡ºåºï¼Œä»è€Œå¯ä»¥ç»™ Sentinel æ·»åŠ è‡ªå®šä¹‰çš„åŠŸèƒ½ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/vCuXJwtZ7gPzikeS.webp)

å¯¹äºé™æµç³»ç»Ÿï¼ŒæŒ‡æ ‡çš„ç»Ÿè®¡ä¾ç„¶æ˜¯å®ç°å…³é”®ï¼ŒSentinel ä¸­ä½¿ç”¨é«˜æ€§èƒ½çš„ç¯å½¢è®¡æ•°å™¨ï¼ˆæ»‘åŠ¨çª—å£ï¼‰æ¥å®ç°ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/MdonS7mokcJvUqGm.webp)

ä¸‹é¢æˆ‘ä»¬æ¥å®‰è£…å’Œä½¿ç”¨ Sentinelã€‚

#### 3ã€Sentinel å…¥é—¨ Demo

å¯ä»¥ [å‚è€ƒå®˜ç½‘ç¼–å†™å…¥é—¨ Demo](https://sentinelguard.io/zh-cn/docs/quick-start.html)ï¼Œåœ¨æœ¬åœ°é€šè¿‡ Main æ–¹æ³•è¿è¡Œä¸€ä¸ª Sentinel å®¢æˆ·ç«¯ç¨‹åºã€‚

è¿è¡ŒæˆåŠŸåï¼Œå¯ä»¥åœ¨å½“å‰ç”¨æˆ·æ ¹ç›®å½•ä¸‹ï¼ˆ~/logs/csp/${appName}-metrics.log.xxxï¼‰çœ‹åˆ°è¾“å‡ºï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/mGi4iVBzqyk3Bppz.webp)

#### 4ã€ä¸‹è½½å¹¶å¯åŠ¨ Sentinel æ§åˆ¶å°

å¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/dashboard.html) è¿›è¡Œå®‰è£…ã€‚

1ï¼‰ä¸‹è½½æ§åˆ¶å° jar åŒ…å¹¶åœ¨æœ¬åœ°å¯åŠ¨ï¼Œå¯ä»¥è®¿é—®ä» [github](https://github.com/alibaba/Sentinel/releases) ä¸Šä¸‹è½½ releaseçš„ jar åŒ…ã€‚

æœ¬æ•™ç¨‹ä¸ºå¤§å®¶æä¾›äº†è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

2ï¼‰ç›´æ¥åœ¨å‘½ä»¤è¡Œçª—å£å¯åŠ¨ Sentinel æ§åˆ¶å°ï¼š

æ³¨æ„ï¼šå¯åŠ¨ Sentinel æ§åˆ¶å°éœ€è¦ JDK ç‰ˆæœ¬ä¸º 1.8 åŠä»¥ä¸Šç‰ˆæœ¬ã€‚

å‘½ä»¤ï¼š

```java
java -Dserver.port=8131 -jar sentinel-dashboard-1.8.6.jar	
```

å¯åŠ¨æˆåŠŸï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/O9RjoEE8eA331lQA.webp)

æœ¬åœ°è®¿é—® http://localhost:8131/ï¼ˆä½ å¡«çš„ç«¯å£ï¼‰ï¼Œå³å¯è®¿é—®æ§åˆ¶å°ï¼Œ**é»˜è®¤è´¦å·å’Œå¯†ç éƒ½æ˜¯ sentinel**

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/quEUDJ42WSQGJoP9.webp)

4ï¼‰å®¢æˆ·ç«¯æ¥å…¥æ§åˆ¶å°

å¼•å…¥ Maven ä¾èµ–ï¼Œç”¨äºå’Œ Sentinel æ§åˆ¶å°é€šè®¯ï¼š

```xml
<dependency>
  <groupId>com.alibaba.csp</groupId>
  <artifactId>sentinel-transport-simple-http</artifactId>
  <version>1.8.6</version>
</dependency>
```

ç¨‹åºå¯åŠ¨æ—¶éœ€è¦åŠ å…¥ JVM å‚æ•° `-Dcsp.sentinel.dashboard.server=consoleIp:port` æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚è‹¥å¯åŠ¨å¤šä¸ªåº”ç”¨ï¼Œåˆ™éœ€è¦é€šè¿‡ `-Dcsp.sentinel.api.port=xxxx` æŒ‡å®šå®¢æˆ·ç«¯ç›‘æ§ API çš„ç«¯å£ï¼ˆé»˜è®¤æ˜¯ 8719ï¼‰ã€‚

Sentinel éå¸¸è´´å¿ƒï¼Œæä¾›äº†å¾ˆå¤šæ¡†æ¶æ•´åˆçš„ä¾èµ–ï¼Œä¾¿äºå¼€å‘ï¼Œæ¯”å¦‚ Spring Web é¡¹ç›®æ”¯æŒå°†æ‰€æœ‰çš„æ¥å£è‡ªåŠ¨è¯†åˆ«ä¸ºèµ„æºï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/lJqF9NCxNkICeOGt.webp)

å¯ä»¥æ ¹æ®ä½¿ç”¨çš„æ¡†æ¶å¼•å…¥é€‚é…ä¾èµ–ï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/open-source-framework-integrations.html)ã€‚

æ­¤å¤„ç›´æ¥è¿è¡Œ Main æ–¹æ³•æ¥æ¼”ç¤ºæ•ˆæœï¼ŒJVM å‚æ•°ä¸ºï¼š`-Dcsp.sentinel.dashboard.server=localhost:8131`

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/TlkE2He3jihoi9ov.webp)

è¿˜æœ‰æ›´å¤šçš„é…ç½®ï¼Œæ¯”å¦‚æ›´æ”¹æ—¥å¿—ç›®å½•ç­‰ï¼Œå¯ä»¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/startup-configuration.html) äº†è§£ã€‚

**ç¡®ä¿å®¢æˆ·ç«¯æœ‰è®¿é—®é‡**ï¼ŒSentinel ä¼šåœ¨ **å®¢æˆ·ç«¯é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™** è¿›è¡Œåˆå§‹åŒ–ï¼Œå¼€å§‹å‘æ§åˆ¶å°å‘é€å¿ƒè·³åŒ…ã€‚é€šè¿‡æ§åˆ¶å°å¯ä»¥æŸ¥çœ‹åˆ°å®æ—¶è®¿é—®æƒ…å†µï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/NAwAxcOiQxQ1bPwQ.webp)

æŸ¥çœ‹æœºå™¨åˆ—è¡¨å’Œå¥åº·æƒ…å†µï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/0I1LuX29pXXCO5Pm.webp)

ç°‡ç‚¹é“¾è·¯ï¼ˆå•æœºè°ƒç”¨é“¾è·¯ï¼‰é¡µé¢å®æ—¶çš„å»æ‹‰å–æŒ‡å®šå®¢æˆ·ç«¯èµ„æºçš„è¿è¡Œæƒ…å†µã€‚å®ƒä¸€å…±æä¾›ä¸¤ç§å±•ç¤ºæ¨¡å¼ï¼šä¸€ç§ç”¨æ ‘çŠ¶ç»“æ„å±•ç¤ºèµ„æºçš„è°ƒç”¨é“¾è·¯ï¼Œå¦å¤–ä¸€ç§åˆ™ä¸åŒºåˆ†è°ƒç”¨é“¾è·¯å±•ç¤ºèµ„æºçš„è¿è¡Œæƒ…å†µã€‚å¦‚å›¾ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/wVBKDJsinGWtXlZ7.webp)

#### 5ã€è§„åˆ™ç®¡ç†å’Œæ¨é€

é—®é¢˜ï¼šSentinel çš„è§„åˆ™å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•é€šè¿‡æ§åˆ¶å°ä¿®æ”¹è§„åˆ™ä¹‹åï¼Œå°†è§„åˆ™åŒæ­¥ç»™å®¢æˆ·ç«¯è¿›è¡Œé™æµç†”æ–­çš„å‘¢ï¼Ÿ

[å®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/dashboard.html) æœ‰è¯¦ç»†åœ°ä»‹ç»ï¼šSentinel æ§åˆ¶å°åŒæ—¶æä¾›ç®€å•çš„è§„åˆ™ç®¡ç†ä»¥åŠæ¨é€çš„åŠŸèƒ½ã€‚è§„åˆ™æ¨é€åˆ†ä¸º 3 ç§æ¨¡å¼ï¼ŒåŒ…æ‹¬ "åŸå§‹æ¨¡å¼"ã€"Pull æ¨¡å¼" å’Œ "Push æ¨¡å¼"ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/r4UBlzLz9fSor7Mq.webp)

ç›®å‰æ§åˆ¶å°çš„è§„åˆ™æ¨é€ä¹Ÿæ˜¯é€šè¿‡ [è§„åˆ™æŸ¥è¯¢æ›´æ”¹ HTTP API](https://github.com/alibaba/Sentinel/wiki/å¦‚ä½•ä½¿ç”¨#æŸ¥è¯¢æ›´æ”¹è§„åˆ™) æ¥æ›´æ”¹è§„åˆ™ã€‚**è¿™ä¹Ÿæ„å‘³ç€è¿™äº›è§„åˆ™ä»…åœ¨å†…å­˜æ€ç”Ÿæ•ˆï¼Œåº”ç”¨é‡å¯ä¹‹åï¼Œè¯¥è§„åˆ™ä¼šä¸¢å¤±ã€‚**

ä»¥ä¸Šæ˜¯åŸå§‹æ¨¡å¼ã€‚å½“äº†è§£äº†åŸå§‹æ¨¡å¼ä¹‹åï¼Œå®˜æ–¹å»ºè®®é€šè¿‡ [åŠ¨æ€è§„åˆ™](https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html) å¹¶ç»“åˆå„ç§å¤–éƒ¨å­˜å‚¨æ¥å®šåˆ¶è‡ªå·±çš„è§„åˆ™æºã€‚æˆ‘ä»¬æ¨èé€šè¿‡åŠ¨æ€é…ç½®æºçš„æ§åˆ¶å°æ¥è¿›è¡Œè§„åˆ™å†™å…¥å’Œæ¨é€ï¼Œè€Œä¸æ˜¯é€šè¿‡ Sentinel å®¢æˆ·ç«¯ç›´æ¥å†™å…¥åˆ°åŠ¨æ€é…ç½®æºä¸­ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå®˜æ–¹æ¨è push æ¨¡å¼ï¼Œæ”¯æŒè‡ªå®šä¹‰å­˜å‚¨è§„åˆ™çš„é…ç½®ä¸­å¿ƒï¼Œæ§åˆ¶å°æ”¹å˜è§„åˆ™åï¼Œä¼š push åˆ°é…ç½®ä¸­å¿ƒã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/9aKc3ZqRK2SHHOTY.webp)

æ›´å¤šè§„åˆ™ç®¡ç†å’Œæ¨é€è§„åˆ™å¯ä»¥é˜…è¯»ï¼š[åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Sentinel](https://github.com/alibaba/Sentinel/wiki/åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨-Sentinel)ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/Vs0gWqfyY6l0tQsv.webp)

#### 6ã€æ•´åˆ Spring Boot

åŸºäº Spring Boot Starter + æ³¨è§£æ¨¡å¼å¼€å‘ + åŸå§‹è§„åˆ™æ¨é€æ¨¡å¼å¼€å‘

Spring Boot é¡¹ç›®å¯ä»¥è½»æ¾å’Œ Sentinel é›†æˆï¼Œç›´æ¥å¼•å…¥ä¸€ä¸ª starterï¼Œä½¿ç”¨ [Spring Cloud Alibaba Sentinel](https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel) å³å¯ã€‚

**åœ¨å¼•å…¥æ•´åˆä¾èµ–æ—¶ï¼Œä¸€å®šè¦æ³¨æ„ç‰ˆæœ¬å·ï¼**

å»ºè®® [å‚è€ƒå®˜æ–¹æ–‡æ¡£é€‰æ‹©ç‰ˆæœ¬](https://github.com/alibaba/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)ã€‚ç”±äº Spring Boot 3.0ï¼ŒSpring Boot 2.7~2.4 å’Œ 2.4 ä»¥ä¸‹ç‰ˆæœ¬ä¹‹é—´å˜åŒ–è¾ƒå¤§ï¼Œç›®å‰ä¼ä¸šçº§å®¢æˆ·è€é¡¹ç›®ç›¸å…³ Spring Boot ç‰ˆæœ¬ä»åœç•™åœ¨ Spring Boot 2.4 ä»¥ä¸‹ï¼Œä¸ºäº†åŒæ—¶æ»¡è¶³å­˜é‡ç”¨æˆ·å’Œæ–°ç”¨æˆ·ä¸åŒéœ€æ±‚ï¼Œç¤¾åŒºä»¥ Spring Boot 3.0 å’Œ 2.4 åˆ†åˆ«ä¸ºåˆ†ç•Œçº¿ï¼ŒåŒæ—¶ç»´æŠ¤ 2022.xã€2021.xã€2.2.x ä¸‰ä¸ªåˆ†æ”¯è¿­ä»£ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/Xggn6dT88LlQk5ek.webp)

æœ¬é¡¹ç›® Spring Boot ç”¨çš„æ˜¯ 2.7ï¼Œå› æ­¤ä½¿ç”¨ Sentinel Starter çš„ç‰ˆæœ¬ 2021.0.5.0ã€‚åœ¨é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
<!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-sentinel -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    <version>2021.0.5.0</version>
</dependency>
```

å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ä¾èµ–è‡ªåŠ¨æ•´åˆäº† Sentinel çš„ core åŒ…ã€å®¢æˆ·ç«¯é€šè®¯åŒ…ã€æ³¨è§£å¼€å‘åŒ…ã€webmvc é€‚é…åŒ…ã€çƒ­ç‚¹å‚æ•°é™æµåŒ…ç­‰ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/kvj73edhVkUxxvbA.webp)

æ•´åˆåŒ…æ”¯æŒè‡ªåŠ¨å°†æ‰€æœ‰çš„æ¥å£æ ¹æ® url è·¯å¾„è¯†åˆ«ä¸ºèµ„æºã€‚å¯åŠ¨é¡¹ç›®åï¼Œé€šè¿‡æ¥å£æ–‡æ¡£æµ‹è¯•å°±èƒ½çœ‹åˆ°ç›‘æ§æ•ˆæœï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/u4Pzn9enw8suoGpV.webp)

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/hqKSYEWN4tiTBIwY.webp)

#### 7ã€å¼€å‘æ¨¡å¼

Sentinel çš„å¼€å‘ä¸»è¦åŒ…æ‹¬å®šä¹‰èµ„æºå’Œå®šä¹‰è§„åˆ™ã€‚

**1ï¼‰å®šä¹‰èµ„æº**ï¼šæ”¯æŒé€šè¿‡ä»£ç ã€å¼•å…¥æ¡†æ¶é€‚é…ã€[æ³¨è§£æ–¹å¼](https://sentinelguard.io/zh-cn/docs/annotation-support.html) å®šä¹‰èµ„æºã€‚

é€šè¿‡ä»£ç å®šä¹‰èµ„æºï¼Œæ›´çµæ´»ï¼š

```java
Entry entry = null;
// åŠ¡å¿…ä¿è¯finallyä¼šè¢«æ‰§è¡Œ
try {
  // èµ„æºåå¯ä½¿ç”¨ä»»æ„æœ‰ä¸šåŠ¡è¯­ä¹‰çš„å­—ç¬¦ä¸²
  entry = SphU.entry("è‡ªå®šä¹‰èµ„æºå");
  // è¢«ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘
  // do something...
} catch (BlockException e1) {
  // èµ„æºè®¿é—®é˜»æ­¢ï¼Œè¢«é™æµæˆ–è¢«é™çº§
  // è¿›è¡Œç›¸åº”çš„å¤„ç†æ“ä½œ
} finally {
  if (entry != null) {
    entry.exit();
  }
}
```

é€šè¿‡æ³¨è§£å®šä¹‰èµ„æºï¼Œæ›´å¿«æ·å¯è¯»ï¼š

```java
public class TestService {

    // å¯¹åº”çš„ `handleException` å‡½æ•°éœ€è¦ä½äº `ExceptionUtil` ç±»ä¸­ï¼Œå¹¶ä¸”å¿…é¡»ä¸º static å‡½æ•°.
    @SentinelResource(value = "test", blockHandler = "handleException", blockHandlerClass = {ExceptionUtil.class})
    public void test() {
        System.out.println("Test");
    }

    // åŸå‡½æ•°
    @SentinelResource(value = "hello", blockHandler = "exceptionHandler", fallback = "helloFallback")
    public String hello(long s) {
        return String.format("Hello at %d", s);
    }
    
    // Fallback å‡½æ•°ï¼Œå‡½æ•°ç­¾åä¸åŸå‡½æ•°ä¸€è‡´æˆ–åŠ ä¸€ä¸ª Throwable ç±»å‹çš„å‚æ•°.
    public String helloFallback(long s) {
        return String.format("Halooooo %d", s);
    }

    // Block å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå‚æ•°æœ€åå¤šä¸€ä¸ª BlockExceptionï¼Œå…¶ä½™ä¸åŸå‡½æ•°ä¸€è‡´.
    public String exceptionHandler(long s, BlockException ex) {
        // Do some log here.
        ex.printStackTrace();
        return "Oops, error occurred at " + s;
    }
}
```

`@SentinelResource` æ³¨è§£çš„é…ç½®ä¼˜å…ˆäºè‡ªåŠ¨è¯†åˆ«çš„é…ç½®ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ³¨è§£ä¸­å®šä¹‰äº†ç‰¹å®šçš„é™æµæˆ–ç†”æ–­ç­–ç•¥ï¼Œè¿™äº›ç­–ç•¥å°†è¦†ç›–é»˜è®¤çš„æˆ–è‡ªåŠ¨è¯†åˆ«çš„é…ç½®ã€‚

æ¨èå¼€å‘æ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨é€‚é…åŒ…æ¥è‡ªåŠ¨è¯†åˆ«èµ„æºï¼Œç„¶åèƒ½è¿ç”¨æ³¨è§£å°½é‡è¿ç”¨æ³¨è§£ï¼Œæœ€åå†é€‰æ‹©ä¸»åŠ¨ç¼–ç å®šä¹‰èµ„æºã€‚

**2ï¼‰å®šä¹‰è§„åˆ™ï¼š**æ”¯æŒé€šè¿‡ä»£ç ã€æ§åˆ¶å°ï¼ˆæ¨èï¼‰ã€é…ç½®æ–‡ä»¶æ¥å®šä¹‰è§„åˆ™ã€‚

æ¯”å¦‚é€šè¿‡ä»£ç å®šä¹‰ä¸€ä¸ªé™æµè§„åˆ™ï¼Œæ›´çµæ´»ï¼š

```java
private static void initFlowQpsRule() {
    List<FlowRule> rules = new ArrayList<>();
    FlowRule rule1 = new FlowRule();
    rule1.setResource(resource);
    // Set max qps to 20
    rule1.setCount(20);
    rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rule1.setLimitApp("default");
    rules.add(rule1);
    FlowRuleManager.loadRules(rules);
}
```

é€šè¿‡æ§åˆ¶å°é…ç½®ï¼Œæ›´é«˜æ•ˆï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/cB0SWortho6g4MVe.webp)

ä¸€èˆ¬æ¨èä½¿ç”¨æ§åˆ¶å°æ¥é…ç½®è§„åˆ™ï¼Œä½†å¦‚æœå¸Œæœ›å¼€å‘è€…æ›´å¿«å¯åŠ¨å’Œå­¦ä¹ é¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ç¼–ç å®šä¹‰è§„åˆ™ï¼Œè¿™æ ·ä¸ç”¨æ­å»ºæ§åˆ¶å°ã€è€Œä¸”æ¯æ¬¡å¯åŠ¨é¡¹ç›®éƒ½ä¼šç¡®ä¿è§„åˆ™è¢«åˆ›å»ºã€‚

#### 8ã€å…¶ä»–ç‰¹æ€§

é™¤äº†é™æµå¤–ï¼ŒSentinel è¿˜æä¾›äº†å¤šç§è§„åˆ™ï¼Œéƒ½å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£æ¥äº†è§£ã€‚

1. [ç†”æ–­é™çº§](https://sentinelguard.io/zh-cn/docs/circuit-breaking.html)ï¼šç”¨äºå®ç°ç†”æ–­é™çº§çš„è§„åˆ™ï¼Œå½“æŸä¸ªèµ„æºçš„å¼‚å¸¸æ¯”ä¾‹æˆ–å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè§¦å‘ç†”æ–­ï¼ŒçŸ­æ—¶é—´å†…ä¸å†è®¿é—®è¯¥èµ„æºã€‚
2. [ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤](https://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html)ï¼šæ ¹æ®ç³»ç»Ÿçš„æ•´ä½“è´Ÿè½½ï¼ˆå¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ç­‰ï¼‰è¿›è¡Œä¿æŠ¤ï¼Œé€‚åˆåœ¨ç³»ç»Ÿçº§åˆ«è¿›è¡Œæµé‡æ§åˆ¶ã€‚
3. [çƒ­ç‚¹å‚æ•°é™æµ](https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html)ï¼šç”¨äºé™åˆ¶æŸä¸ªæ–¹æ³•çš„æŸäº›çƒ­ç‚¹å‚æ•°çš„è®¿é—®é¢‘ç‡ï¼Œé¿å…æŸäº›å‚æ•°å¯¼è‡´æµé‡è¿‡å¤§ã€‚
4. [æ¥æºè®¿é—®æ§åˆ¶](https://sentinelguard.io/zh-cn/docs/origin-authority-control.html)ï¼šç”¨äºå®šä¹‰é»‘ç™½åå•çš„æˆæƒè§„åˆ™ï¼Œæ§åˆ¶èµ„æºè®¿é—®çš„æƒé™ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡æœ¬é¡¹ç›®çš„éœ€æ±‚å®ç°ï¼Œå¸¦å¤§å®¶å®æˆ˜ Sentinel å¼€å‘ã€‚

### åç«¯å¼€å‘ï¼ˆSentinel å®æˆ˜ï¼‰

#### 1ã€æŸ¥çœ‹é¢˜åº“åˆ—è¡¨æ¥å£é™æµç†”æ–­

èµ„æºï¼šlistQuestionBankVOByPage æ¥å£

ç›®çš„ï¼šæ§åˆ¶å¯¹è€—æ—¶è¾ƒé•¿çš„ã€ç»å¸¸è®¿é—®çš„æ¥å£çš„è¯·æ±‚é¢‘ç‡ï¼Œé˜²æ­¢è¿‡å¤šè¯·æ±‚å¯¼è‡´ç³»ç»Ÿè¿‡è½½ã€‚

é™æµè§„åˆ™ï¼š

- ç­–ç•¥ï¼šæ•´ä¸ªæ¥å£æ¯ç§’é’Ÿä¸è¶…è¿‡ 10 æ¬¡è¯·æ±‚
- é˜»å¡æ“ä½œï¼šæç¤ºâ€œç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…â€

ç†”æ–­è§„åˆ™ï¼š

- ç†”æ–­æ¡ä»¶ï¼šå¦‚æœæ¥å£å¼‚å¸¸ç‡è¶…è¿‡ 10%ï¼Œæˆ–è€…æ…¢è°ƒç”¨ï¼ˆå“åº”æ—¶é•¿ > 3 ç§’ï¼‰çš„æ¯”ä¾‹å¤§äº 20%ï¼Œè§¦å‘ 60 ç§’ç†”æ–­ã€‚
- ç†”æ–­æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®ï¼ˆç¼“å­˜æˆ–ç©ºæ•°æ®ï¼‰

**å¼€å‘æ¨¡å¼ï¼šç”¨æ³¨è§£å®šä¹‰èµ„æº + åŸºäºæ§åˆ¶å°å®šä¹‰è§„åˆ™**

1ï¼‰å®šä¹‰èµ„æºã€‚ç»™éœ€è¦é™æµçš„æ¥å£æ·»åŠ  @SentinelResource æ³¨è§£ï¼š

```java
@PostMapping("/list/page/vo")
@SentinelResource(value = "listQuestionBankVOByPage",
        blockHandler = "handleBlockException",
        fallback = "handleFallback")
public BaseResponse<Page<QuestionBankVO>> listQuestionBankVOByPage(
    @RequestBody QuestionBankQueryRequest questionBankQueryRequest,
    HttpServletRequest request) {
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œå‚è€ƒ [æ³¨è§£ä½¿ç”¨å®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/annotation-support.html) æŒ‡å®šäº†èµ„æºåç§°ã€é˜»å¡å¤„ç†å™¨å’Œé™çº§å¤„ç†å™¨ã€‚

å¯åŠ¨é¡¹ç›®ï¼Œæ³¨æ„éœ€åŠ å…¥ JVM å‚æ•° `-Dcsp.sentinel.dashboard.server=consoleIp:port` æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/FSt8uJpxK2TQP2HZ.webp)

å¯åŠ¨é¡¹ç›®æˆåŠŸå¹¶ä¸”è®¿é—®æ¥å£åï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°åˆšå®šä¹‰çš„èµ„æºï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/igm1dO6wGtRr4f20.webp)

2ï¼‰å®ç°é™æµé˜»å¡å’Œç†”æ–­é™çº§æ–¹æ³•ã€‚æ³¨æ„éµå¾ª [å®˜æ–¹æ–‡æ¡£çš„æ–¹æ³•å®šä¹‰è§„åˆ™](https://sentinelguard.io/zh-cn/docs/annotation-support.html)ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/jVa23HsnqNl6X6sv.webp)

ä¸ºäº†å®ç°æ–¹ä¾¿ï¼Œå°½å¿«éªŒè¯æ•ˆæœï¼Œæˆ‘ä»¬å…ˆåœ¨æ¥å£ç›¸åŒçš„ Controller ä¸­ç¼–å†™é™æµé˜»å¡å’Œé™çº§æ–¹æ³•ï¼š

```java
/**
 * listQuestionBankVOByPage é™çº§æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®
 */
public BaseResponse<Page<QuestionBankVO>> handleFallback(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,
                                                         HttpServletRequest request, Throwable ex) {
    // å¯ä»¥è¿”å›æœ¬åœ°æ•°æ®æˆ–ç©ºæ•°æ®
    return ResultUtils.success(null);
}

/**
 * listQuestionBankVOByPage æµæ§æ“ä½œ
 * é™æµï¼šæç¤ºâ€œç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…â€
 */
public BaseResponse<Page<QuestionBankVO>> handleBlockException(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,
                                                               HttpServletRequest request, BlockException ex) {
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…");
}
```

3ï¼‰é€šè¿‡æ§åˆ¶å°å®šä¹‰è§„åˆ™

é™æµè§„åˆ™ï¼šæ ¹æ®éœ€æ±‚é…ç½®å³å¯

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/8XVvI4rabV99RYh5.webp)

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/X2aOE40rX1nhwV1Z.webp)

ç†”æ–­è§„åˆ™ï¼šæ–°å¢ä¸¤æ¡ç†”æ–­è§„åˆ™ï¼Œæ³¨æ„è®¾ç½®æœ€å°è¯·æ±‚æ•°ã€ç»Ÿè®¡æ—¶é•¿

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/mLKbGY1FkBaQEV8s.webp)

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/RTU9YP5sizazpMJI.webp)

4ï¼‰æµ‹è¯•

ä¸ºä¾¿äºæµ‹è¯•ï¼Œå¯ä»¥å…ˆå°†é™æµç†”æ–­è§„åˆ™è°ƒæ•´åˆ°å®¹æ˜“è§¦å‘çš„å€¼ï¼Œç„¶åé€šè¿‡æ¥å£æ–‡æ¡£æµ‹è¯•è°ƒç”¨ï¼ŒæŸ¥çœ‹æ•ˆæœã€‚

è¿ç»­å¿«é€Ÿå‘é€å¤šæ¬¡è¯·æ±‚ï¼Œè§¦å‘é™æµï¼Œæ‰§è¡Œäº† `blockHandler` å¤„ç†å™¨çš„é€»è¾‘ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/YWcfQyuFYoYBk8FP.webp)

æ³¨æ„ï¼Œåªæœ‰ä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¯”å¦‚è¯·æ±‚å‚æ•°é”™è¯¯ã€æˆ–è€…æ•°æ®åº“æ“ä½œå¤±è´¥ç­‰é—®é¢˜ï¼‰ï¼Œæ‰ä¼šç®—åˆ°ç†”æ–­æ¡ä»¶ä¸­ï¼Œé™æµç†”æ–­æœ¬èº«çš„å¼‚å¸¸ BlockException æ˜¯ä¸è®¡ç®—çš„ã€‚

æµ‹è¯•ç†”æ–­çš„æ—¶å€™ï¼Œå¯ä»¥æ•…æ„ç»™ sortField è¯·æ±‚å‚æ•°ä¼ ä¸€ä¸ªä¸å­˜åœ¨çš„å­—æ®µï¼Œè§¦å‘ä¸šåŠ¡å¼‚å¸¸ã€‚å¯ä»¥å°è¯•ä¸‹ç†”æ–­çš„è§¦å‘å’Œæ¢å¤ï¼š

1. å…ˆé€šè¿‡ä¼ é”™ä¸šåŠ¡å‚æ•°è§¦å‘å¼‚å¸¸ï¼Œå¯¼è‡´ç†”æ–­
2. ç­‰å¾…ç†”æ–­ç»“æŸåï¼Œå†è§¦å‘ä¸€æ¬¡å¼‚å¸¸ï¼Œè¿˜ä¼šç»§ç»­ç†”æ–­
3. è¿‡ä¸€æ®µæ—¶é—´ï¼Œå†è§¦å‘ä¸€æ¬¡æ­£å¸¸è¯·æ±‚ï¼Œåˆ™ç†”æ–­è§£é™¤

æµ‹è¯•å‘ç°ï¼Œä»»ä½•ä¸šåŠ¡å¼‚å¸¸ï¼ˆä¸ä»…ä»…æ˜¯è¢«ç†”æ–­äº†ï¼‰ï¼Œéƒ½ä¼šè§¦å‘ `fallbackHandler`ï¼Œè¯¥æ–¹æ³•å¯ä½œä¸ºä¸€ä¸ªé€šç”¨çš„é™çº§é€»è¾‘å¤„ç†å™¨ã€‚

æµ‹è¯•å‘ç°ï¼Œå¦‚æœ `blockHandler` å’Œ `fallbackHandler` åŒæ—¶é…ç½®ï¼Œå½“ç†”æ–­å™¨æ‰“å¼€åï¼Œä»ç„¶ä¼šè¿›å…¥ `blockHandler` è¿›è¡Œå¤„ç†ï¼Œå› æ­¤éœ€è¦åœ¨è¯¥æ–¹æ³•ä¸­å¤„ç†å› ä¸ºç†”æ–­è§¦å‘çš„é™çº§é€»è¾‘ï¼š

```java
/**
 * listQuestionBankVOByPage æµæ§æ“ä½œ
 * é™æµï¼šæç¤ºâ€œç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…â€
 * ç†”æ–­ï¼šæ‰§è¡Œé™çº§æ“ä½œ
 */
public BaseResponse<Page<QuestionBankVO>> handleBlockException(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,
                                                               HttpServletRequest request, BlockException ex) {
    // é™çº§æ“ä½œ
    if (ex instanceof DegradeException) {
        return handleFallback(questionBankQueryRequest, request, ex);
    }
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œè¯·è€å¿ƒç­‰å¾…");
}
```

Sentinel çš„ `blockHandler` å¤„ç†çš„æ˜¯`BlockException`ï¼Œè¯¥å¼‚å¸¸è¡¨ç¤ºç³»ç»Ÿå—åˆ°æµé‡æ§åˆ¶é™åˆ¶ï¼ˆå¦‚é™æµæˆ–ç†”æ–­ï¼‰ï¼Œè¿™äº›ä¸æ˜¯ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸ï¼Œå› æ­¤ `fallback` ä¸ä¼šå¤„ç†è¿™äº›å¼‚å¸¸ã€‚å¦‚æœä¸é…ç½® `blockHandler`ï¼Œæ‰ä¼šåœ¨ç†”æ–­æ—¶ï¼Œè¿›å…¥åˆ° `fallbackHandler` ä¸­è¿›è¡Œå…œåº•ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/XVsXb02kRDMUlAzw.webp)

æ€»ç»“ä¸€ä¸‹ï¼š

- `blockHandler` å¤„ç† Sentinel æµé‡æ§åˆ¶å¼‚å¸¸ï¼Œå¦‚ `BlockException`ã€‚
- `fallback` å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸ï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå·±çš„ `BusinessException`ã€‚

å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µé…ç½®ã€‚

#### **2ã€å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨é™æµç†”æ–­**

èµ„æºï¼šlistQuestionVoByPage æ¥å£

é™æµè§„åˆ™ï¼š

- ç­–ç•¥ï¼šæ¯ä¸ª IP åœ°å€æ¯åˆ†é’Ÿå…è®¸æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨çš„æ¬¡æ•°ä¸èƒ½è¶…è¿‡ 60 æ¬¡ã€‚
- é˜»å¡æ“ä½œï¼šæç¤ºâ€œè®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•â€

ç†”æ–­è§„åˆ™ï¼š

- ç†”æ–­æ¡ä»¶ï¼šå¦‚æœæ¥å£å¼‚å¸¸ç‡è¶…è¿‡ 10%ï¼Œæˆ–è€…æ…¢è°ƒç”¨ï¼ˆå“åº”æ—¶é•¿ > 3 ç§’ï¼‰çš„æ¯”ä¾‹å¤§äº 20%ï¼Œè§¦å‘ 60 ç§’ç†”æ–­ã€‚
- ç†”æ–­æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®ï¼ˆç¼“å­˜æˆ–ç©ºæ•°æ®ï¼‰

ç”±äºéœ€è¦é’ˆå¯¹æ¯ä¸ªç”¨æˆ·è¿›ä¸€æ­¥ç²¾ç»†åŒ–é™æµï¼Œè€Œä¸æ˜¯æ•´ä½“æ¥å£é™æµï¼Œå¯ä»¥é‡‡ç”¨ [çƒ­ç‚¹å‚æ•°é™æµæœºåˆ¶](https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html)ï¼Œå…è®¸æ ¹æ®å‚æ•°æ§åˆ¶é™æµè§¦å‘æ¡ä»¶ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/5uHbtdBNScXIBtW8.webp)

å¯¹äºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¯ä»¥å°† IP åœ°å€ä½œä¸ºçƒ­ç‚¹å‚æ•°ã€‚

1ï¼‰å®šä¹‰èµ„æº

å¯¹äº `@SentinelResource` æ³¨è§£æ–¹å¼å®šä¹‰çš„èµ„æºï¼Œè‹¥æ³¨è§£ä½œç”¨çš„æ–¹æ³•ä¸Šæœ‰å‚æ•°ï¼ŒSentinel ä¼šå°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ å…¥ `SphU.entry(res, args)`ã€‚æ¯”å¦‚ä»¥ä¸‹çš„æ–¹æ³•é‡Œé¢ `uid` å’Œ `type` ä¼šåˆ†åˆ«ä½œä¸ºç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ Sentinel APIï¼Œä»è€Œå¯ä»¥ç”¨äºçƒ­ç‚¹è§„åˆ™åˆ¤æ–­ï¼š

```java
@SentinelResource("myMethod")
public Result doSomething(String uid, int type) {
  // some logic here...
}
```

ç”±äº Controller æ¥å£å‚æ•°è¾ƒæ‚ä¹±ï¼Œä½¿ç”¨ç¼–ç¨‹å¼å®šä¹‰èµ„æºçš„æ–¹æ³•ã€‚

ğŸ’¡ è¿™é‡Œå»ºè®®æ–°å†™ä¸€ä¸ªæ¥å£ï¼Œä¸è¦æ±¡æŸ“åŸæœ‰æ¥å£ï¼Œç­‰æµ‹è¯•ç¨³å®šåï¼Œå†è¿›è¡Œåˆ‡æ¢ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
// åŸºäº IP é™æµ
String remoteAddr = request.getRemoteAddr();
Entry entry = null;
try  {
    entry = SphU.entry("listQuestionVOByPage", EntryType.IN, 1, remoteAddr);
    // è¢«ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘
    // æŸ¥è¯¢æ•°æ®åº“
    Page<Question> questionPage = questionService.listQuestionByPage(questionQueryRequest);
    // è·å–å°è£…ç±»
    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));
} catch (BlockException ex) {
    // èµ„æºè®¿é—®é˜»æ­¢ï¼Œè¢«é™æµæˆ–è¢«é™çº§
    if (ex instanceof DegradeException) {
        return handleFallback(questionQueryRequest, request, ex);
    }
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
} finally {
    if (entry != null) {
        entry.exit(1, remoteAddr);
    }
}
```

ğŸ’¡éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼

1. è‹¥ entry çš„æ—¶å€™ä¼ å…¥äº†çƒ­ç‚¹å‚æ•°ï¼Œé‚£ä¹ˆ exit çš„æ—¶å€™ä¹Ÿä¸€å®šè¦å¸¦ä¸Šå¯¹åº”çš„å‚æ•°ï¼ˆ`exit(count, args)`ï¼‰ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰ç»Ÿè®¡é”™è¯¯ã€‚**è¿™ä¸ªæ—¶å€™ä¸èƒ½ä½¿ç”¨ try-with-resources çš„æ–¹å¼ã€‚**
2. `SphU.entry(xxx)` éœ€è¦ä¸ `entry.exit()` æ–¹æ³•æˆå¯¹å‡ºç°ï¼ŒåŒ¹é…è°ƒç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´è°ƒç”¨é“¾è®°å½•å¼‚å¸¸ï¼ŒæŠ›å‡º `ErrorEntryFreeException` å¼‚å¸¸ã€‚

æ³¨æ„ Sentinel çš„é™çº§ä»…é’ˆå¯¹ä¸šåŠ¡å¼‚å¸¸ï¼Œå¯¹ Sentinel é™æµé™çº§æœ¬èº«çš„å¼‚å¸¸ `BlockException` ä¸ç”Ÿæ•ˆã€‚ä¸ºäº†ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°ï¼Œéœ€è¦æ‰‹åŠ¨é€šè¿‡ `Tracer.trace(ex)` è®°å½•ä¸šåŠ¡å¼‚å¸¸ã€‚ç¤ºä¾‹ï¼š

```java
Entry entry = null;
try {
  entry = SphU.entry(resource);

  // Write your biz code here.
  // <<BIZ CODE>>
} catch (Throwable t) {
  if (!BlockException.isBlockException(t)) {
    Tracer.trace(t);
  }
} finally {
  if (entry != null) {
    entry.exit();
  }
}
```

æ³¨æ„ï¼Œé€šè¿‡ `Tracer.trace(ex)` æ¥ç»Ÿè®¡å¼‚å¸¸ä¿¡æ¯æ—¶ï¼Œç”±äº try-with-resources è¯­æ³•ä¸­ catch è°ƒç”¨é¡ºåºçš„é—®é¢˜ï¼Œä¼šå¯¼è‡´æ— æ³•æ­£ç¡®ç»Ÿè®¡å¼‚å¸¸æ•°ï¼Œå› æ­¤ç»Ÿè®¡å¼‚å¸¸ä¿¡æ¯æ—¶ä¹Ÿä¸èƒ½åœ¨ try-with-resources çš„ catch å—ä¸­è°ƒç”¨ `Tracer.trace(ex)`ã€‚

ğŸ’¡ ä¸ºä»€ä¹ˆä¸Šä¸€ä¸ªéœ€æ±‚ä¸­ï¼Œæˆ‘ä»¬ä¸ç”¨æ‰‹åŠ¨è°ƒç”¨ Tracer ä¸ŠæŠ¥å¼‚å¸¸å‘¢ï¼Ÿå› ä¸ºä½¿ç”¨ Sentinel çš„å¼€æºæ•´åˆæ¨¡å—ï¼Œå¦‚ Sentinel Dubbo Adapter, Sentinel Web Servlet Filter æˆ– `@SentinelResource` æ³¨è§£ä¼šè‡ªåŠ¨ç»Ÿè®¡ä¸šåŠ¡å¼‚å¸¸ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ã€‚

éœ€è¦ç»™æˆ‘ä»¬çš„èµ„æºå®šä¹‰å¢åŠ å¼‚å¸¸ç»Ÿè®¡ä»£ç ï¼š

```java
catch (Throwable ex) {
    // ä¸šåŠ¡å¼‚å¸¸
    if (!BlockException.isBlockException(ex)) {
        Tracer.trace(ex);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
    // é™çº§æ“ä½œ
    if (ex instanceof DegradeException) {
        return handleFallback(questionQueryRequest, request, ex);
    }
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
}
```

2ï¼‰ç¼–å†™é˜»å¡å’Œé™çº§æ“ä½œä»£ç 

```java
try {
    entry = SphU.entry("listQuestionVOByPage", EntryType.IN, 1, remoteAddr);
    // è¢«ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘
    // æŸ¥è¯¢æ•°æ®åº“
    Page<Question> questionPage = questionService.listQuestionByPage(questionQueryRequest);
    // è·å–å°è£…ç±»
    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));
} catch (Throwable ex) {
    // ä¸šåŠ¡å¼‚å¸¸
    if (!BlockException.isBlockException(ex)) {
        Tracer.trace(ex);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
    // é™çº§æ“ä½œ
    if (ex instanceof DegradeException) {
        return handleFallback(questionQueryRequest, request, ex);
    }
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
} finally {
    if (entry != null) {
        entry.exit(1, remoteAddr);
    }
}

/**
 * listQuestionVOByPage é™çº§æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®
 */
public BaseResponse<Page<QuestionVO>> handleFallback(QuestionQueryRequest questionQueryRequest,
                                                         HttpServletRequest request, Throwable ex) {
    // å¯ä»¥è¿”å›æœ¬åœ°æ•°æ®æˆ–ç©ºæ•°æ®
    return ResultUtils.success(null);
}
```

3ï¼‰é€šè¿‡ç¼–ç æ–¹å¼å®šä¹‰è§„åˆ™ã€‚å¯ä»¥æ–°å»º `sentinel` åŒ…å¹¶å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„ Manager ä½œä¸º Beanï¼Œåˆ©ç”¨ @PostConstruct æ³¨è§£ï¼Œåœ¨ Bean åŠ è½½ååˆ›å»ºè§„åˆ™ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Component
public class SentinelRulesManager {

    @PostConstruct
    public void initRules() {
        initFlowRules();
        initDegradeRules();
    }

    // é™æµè§„åˆ™
    public void initFlowRules() {
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨é™æµè§„åˆ™
        ParamFlowRule rule = new ParamFlowRule("listQuestionVOByPage")
                .setParamIdx(0) // å¯¹ç¬¬ 0 ä¸ªå‚æ•°é™æµï¼Œå³ IP åœ°å€
                .setCount(60) // æ¯åˆ†é’Ÿæœ€å¤š 60 æ¬¡
                .setDurationInSec(60); // è§„åˆ™çš„ç»Ÿè®¡å‘¨æœŸä¸º 60 ç§’
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }

    // é™çº§è§„åˆ™
    public void initDegradeRules() {
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨ç†”æ–­è§„åˆ™
        DegradeRule slowCallRule = new DegradeRule("listQuestionVOByPage")
                .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType())
                .setCount(0.2) // æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äº 20%
                .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’
                .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’
                .setMinRequestAmount(10) // æœ€å°è¯·æ±‚æ•°
                .setSlowRatioThreshold(3); // å“åº”æ—¶é—´è¶…è¿‡ 3 ç§’

        DegradeRule errorRateRule = new DegradeRule("listQuestionVOByPage")
                .setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType())
                .setCount(0.1) // å¼‚å¸¸ç‡å¤§äº 10%
                .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’
                .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’
                .setMinRequestAmount(10); // æœ€å°è¯·æ±‚æ•°

        // åŠ è½½è§„åˆ™
        DegradeRuleManager.loadRules(Arrays.asList(slowCallRule, errorRateRule));
    }
}
```

4ï¼‰æµ‹è¯•

å¯åŠ¨é¡¹ç›®å°±èƒ½çœ‹åˆ°è§„åˆ™ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/h7RcI0M3GyfrEHjG.webp)

ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œå¯ä»¥å…ˆå°†è§„åˆ™çš„é˜ˆå€¼è°ƒæ•´å°ä¸€ç‚¹ï¼Œç„¶åé€šè¿‡æ¥å£æ–‡æ¡£éªŒè¯æ•ˆæœã€‚

é™æµæ•ˆæœï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/fpzesO4uBuDgFCT2.webp)

æµ‹è¯•é™çº§æ•ˆæœçš„æ—¶å€™ï¼Œå¯ä»¥æ•…æ„å°† sortField ä¼ ä¸€ä¸ªä¸å­˜åœ¨çš„å­—æ®µã€‚æ•ˆæœå¦‚å›¾ï¼Œè§¦å‘äº† DegradeExceptionï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/XM9oxMNhMfMjtXN3.webp)

### æ‰©å±•çŸ¥è¯†

#### 1ã€ä»…å¯¹éƒ¨åˆ† URL è¿›è¡Œç»Ÿè®¡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

å‚è€ƒï¼š[https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#%E9%85%8D%E7%BD%AE](https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#é…ç½®)â€˜

å¯ä»¥ä¿®æ”¹ç›‘å¬çš„ URL è§„åˆ™é…ç½®ï¼š

```xml
spring.cloud.sentinel.filter.url-patterns=/*
```

#### 2ã€è§„åˆ™é…ç½®æœ¬åœ°æŒä¹…åŒ–

å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„é…ç½®ï¼šhttps://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html

å®˜æ–¹æä¾›äº† Demoï¼Œå¯ä»¥ç”¨æ–‡ä»¶æ¥æœ¬åœ°æŒä¹…åŒ–é…ç½®ï¼Œè¿™æ ·é‡å¯é¡¹ç›®åé…ç½®å°±ä¸ä¼šä¸¢å¤±äº†ã€‚

- [è¯»å†™æœ¬åœ°æ–‡ä»¶ Demo](https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-dynamic-file-rule/src/main/java/com/alibaba/csp/sentinel/demo/file/rule/FileDataSourceInit.java)ï¼ˆå…ˆçœ‹è¿™ä¸ªï¼‰
- [è¯»æœ¬åœ°æ–‡ä»¶ Demo](https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-dynamic-file-rule/src/main/java/com/alibaba/csp/sentinel/demo/file/rule/FileDataSourceDemo.java)

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/xcINe23tQitIGB75.webp)

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥åœ¨ SentinelManager çš„åˆå§‹åŒ–é€»è¾‘ä¸­è°ƒç”¨ï¼š

```java
/**
 * æŒä¹…åŒ–é…ç½®ä¸ºæœ¬åœ°æ–‡ä»¶
 */
public void listenRules() throws Exception {
    // è·å–é¡¹ç›®æ ¹ç›®å½•
    String rootPath = System.getProperty("user.dir");
    // sentinel ç›®å½•è·¯å¾„
    File sentinelDir = new File(rootPath, "sentinel");
    // ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
    if (!FileUtil.exist(sentinelDir)) {
        FileUtil.mkdir(sentinelDir);
    }
    // è§„åˆ™æ–‡ä»¶è·¯å¾„
    String flowRulePath = new File(sentinelDir, "FlowRule.json").getAbsolutePath();
    String degradeRulePath = new File(sentinelDir, "DegradeRule.json").getAbsolutePath();

    // Data source for FlowRule
    ReadableDataSource<String, List<FlowRule>> flowRuleDataSource = new FileRefreshableDataSource<>(flowRulePath, flowRuleListParser);
    // Register to flow rule manager.
    FlowRuleManager.register2Property(flowRuleDataSource.getProperty());
    WritableDataSource<List<FlowRule>> flowWds = new FileWritableDataSource<>(flowRulePath, this::encodeJson);
    // Register to writable data source registry so that rules can be updated to file
    WritableDataSourceRegistry.registerFlowDataSource(flowWds);

    // Data source for DegradeRule
    FileRefreshableDataSource<List<DegradeRule>> degradeRuleDataSource
            = new FileRefreshableDataSource<>(
            degradeRulePath, degradeRuleListParser);
    DegradeRuleManager.register2Property(degradeRuleDataSource.getProperty());
    WritableDataSource<List<DegradeRule>> degradeWds = new FileWritableDataSource<>(degradeRulePath, this::encodeJson);
    // Register to writable data source registry so that rules can be updated to file
    WritableDataSourceRegistry.registerDegradeDataSource(degradeWds);
}

private Converter<String, List<FlowRule>> flowRuleListParser = source -> JSON.parseObject(source,
        new TypeReference<List<FlowRule>>() {
        });
private Converter<String, List<DegradeRule>> degradeRuleListParser = source -> JSON.parseObject(source,
        new TypeReference<List<DegradeRule>>() {
        });

private <T> String encodeJson(T t) {
    return JSON.toJSONString(t);
}
```

ç„¶åå¯ä»¥æµ‹è¯•è¯»å†™æ•ˆæœã€‚

#### 3ã€ä»£ç ç»„ç»‡ç»“æ„ä¼˜åŒ–

é™æµé˜»å¡å’Œé™çº§æ–¹æ³•å¯ä»¥å•ç‹¬æŠ½æˆç‹¬ç«‹çš„ç±»ï¼ŒSentinel çš„èµ„æºåç§°ä¹Ÿå¯ä»¥å•ç‹¬å®šä¹‰ä¸ºå¸¸é‡ï¼Œç»Ÿä¸€æ”¾åˆ° sentinel åŒ…ä¸­ï¼Œæ›´æ¨¡å—åŒ–ã€‚

å¸¸é‡ç±»ï¼š

```java
/**
 * Sentinel é™æµç†”æ–­å¸¸é‡
 */
public interface SentinelConstant {

    /**
     * åˆ†é¡µè·å–é¢˜åº“åˆ—è¡¨æ¥å£é™æµ
     */
    String listQuestionBankVOByPage = "listQuestionBankVOByPage";

    /**
     * åˆ†é¡µè·å–é¢˜ç›®åˆ—è¡¨æ¥å£é™æµ
     */
    String listQuestionVOByPage = "listQuestionVOByPage";
}
```

#### 4ã€å°è£…é™æµç»„ä»¶ä¸º Spring Boot Starter

ä¸ºäº†ç®€åŒ–é¡¹ç›®çš„é…ç½®å’Œä¾èµ–ç®¡ç†ï¼Œå‡å°‘é™æµç»„ä»¶çš„æ¥å…¥æˆæœ¬ï¼Œæˆ‘ä»¬é€šè¿‡ Starter å°è£…é™æµç»„ä»¶ï¼Œå°†å¤šä¸ªç›¸å…³çš„ä¾èµ–æ‰“åŒ…æˆä¸€ä¸ª Maven ä¾èµ–ï¼Œç”¨æˆ·åªéœ€å¼•å…¥ä¸€ä¸ªä¾èµ–å³å¯å®Œæˆé…ç½®ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨å¼•å…¥æ¯ä¸ªæ¨¡å—çš„ä¾èµ–ã€‚

1ï¼‰åˆ›å»ºä¸€ä¸ª spring boot é¡¹ç›®

å°†æ— ç”¨çš„é»˜è®¤ä¾èµ–éƒ½ç§»é™¤ï¼Œä¾‹å¦‚é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€å¯åŠ¨æ–‡ä»¶ã€test ç›¸å…³ç­‰ã€‚

2ï¼‰å¼•å…¥éœ€è¦çš„ä¾èµ–ã€‚å®Œæ•´ pom æ–‡ä»¶å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.2</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.yupi</groupId>
    <artifactId>limit-spring-boot-starter</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>limit-spring-boot-starter</name>
    <description>limit-spring-boot-starter</description>
    <properties>
        <java.version>1.8</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-core</artifactId>
            <version>1.8.6</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-transport-simple-http</artifactId>
            <version>1.8.6</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-annotation-aspectj</artifactId>
            <version>1.8.6</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-parameter-flow-control</artifactId>
            <version>1.8.6</version>
        </dependency>
    </dependencies>


</project>
```

3ï¼‰åˆ›å»ºé…ç½®æ–‡ä»¶

```java
@ConfigurationProperties(prefix = "spring")
public class LimitProperties {
    private String sentinelDashboard;
    private List<LimitRule> limitRules;

    public List<LimitRule> getLimitRules() {
        return limitRules;
    }

    public void setLimitRules(List<LimitRule> limitRules) {
        this.limitRules = limitRules;
    }

    public String getSentinelDashboard() {
        return sentinelDashboard;
    }

    public void setSentinelDashboard(String sentinelDashboard) {
        this.sentinelDashboard = sentinelDashboard;
    }

    public static class LimitRule {
        private String resource;
        private int grade;
        private int count;

        public String getResource() {
            return resource;
        }

        public void setResource(String resource) {
            this.resource = resource;
        }

        public int getGrade() {
            return grade;
        }

        public void setGrade(int grade) {
            this.grade = grade;
        }

        public int getCount() {
            return count;
        }

        public void setCount(int count) {
            this.count = count;
        }
    }

}
```

4ï¼‰åˆ›å»ºè‡ªåŠ¨é…ç½®ç±»

```java
@Configuration
@EnableConfigurationProperties(LimitProperties.class)
public class LimitAutoConfiguration {

    @Resource
    private LimitProperties properties;

    @Bean
    @ConditionalOnMissingBean
    public SentinelResourceAspect sentinelResourceAspect() {
        return new SentinelResourceAspect();
    }

    @PostConstruct
    public void initLimit() {
        initDefaultRule();
        initDashboard();
    }


    private void initDefaultRule() {
        List<LimitProperties.LimitRule> limitRules = properties.getLimitRules();
        if (CollectionUtils.isEmpty(limitRules)) {
            return;
        }

        List<FlowRule> rules = new ArrayList<>();
        for (LimitProperties.LimitRule limitRule : limitRules) {
            FlowRule rule = new FlowRule();
            rule.setResource(limitRule.getResource());
            rule.setGrade(limitRule.getGrade());
            rule.setCount(limitRule.getCount());
            rules.add(rule);
        }
        FlowRuleManager.loadRules(rules);
    }

    private void initDashboard() {
        SentinelConfig.setConfig("csp.sentinel.dashboard.server", properties.getSentinelDashboard());
    }
}
```

5ï¼‰åˆ›å»º spring.factories æ–‡ä»¶ã€‚

åœ¨ src/main/resources/META-INF ç›®å½•ä¸‹åˆ›å»º spring.factories æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰è‡ªåŠ¨é…ç½®ç±»ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/EWwFulpgl9NAgNrO.webp)

æ–‡ä»¶å†…å®¹ï¼š

```plain
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.yupi.limitspringbootstarter.LimitAutoConfiguration
```

6ï¼‰æœ¬åœ° install

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/X1DOrcZk8dQsaovc.webp)

è¿™æ ·æœ¬åœ°ä»“åº“å°±æœ‰äº†å½“å‰çš„ starterã€‚

7ï¼‰ä½¿ç”¨ã€‚åç«¯é¡¹ç›®å¼•å…¥æ­¤ starterï¼š

```xml
  <dependency>
      <artifactId>limit-spring-boot-starter</artifactId>
      <groupId>com.yupi</groupId>
      <version>0.0.1-SNAPSHOT</version>
  </dependency>
```

application.yml æ–‡ä»¶ä¸­å¡«å†™å¯¹åº”é™æµé…ç½®ï¼š

```yaml
spring:
  # sentinel æ§åˆ¶å°åœ°å€
  sentinelDashboard: localhost:7878 
  # é™æµè§„åˆ™
  limitRules:
    - resource: "QuestionBank"
      count: 5
      grade: 1
```

é¡¹ç›®ä¸­åŒæ ·è¿˜æ˜¯ä½¿ç”¨ `@SentinelResource`æ³¨è§£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ§åˆ¶å°åŠ¨æ€é…ç½®é™æµã€‚

### è‡ªä¸»æ‰©å±•

1ï¼‰è‡ªä¸»å®ç° push è§„åˆ™æ¨é€æ¨¡å¼ï¼Œå®šä¹‰è‡ªå·±çš„æŒä¹…åŒ–è§„åˆ™

å‚è€ƒæ–‡æ¡£ï¼š

- https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.htmlï¼ˆç»“å°¾æåˆ°ï¼‰
- https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/Ow5D4oD0fytemFc0.webp)

2ï¼‰è‡ªä¸»å®ç°æ›´å¤šé™æµåŠŸèƒ½ï¼Œæ¯”å¦‚æœ¬æ–‡éœ€æ±‚åˆ†æéƒ¨åˆ†æåˆ°çš„ç”¨æˆ·ç™»å½•å’Œç”¨æˆ·æ³¨å†Œçš„ä¿æŠ¤

## äºŒã€åŠ¨æ€ IP é»‘åå•è¿‡æ»¤

### éœ€æ±‚åˆ†æ

ä¸€äº›æ¶æ„ç”¨æˆ·ï¼ˆå¯èƒ½æ˜¯é»‘å®¢ã€çˆ¬è™«ã€DDoS æ”»å‡»è€…ï¼‰å¯èƒ½é¢‘ç¹è¯·æ±‚æœåŠ¡å™¨èµ„æºï¼Œå¯¼è‡´èµ„æºå ç”¨è¿‡é«˜ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€å®šçš„æ‰‹æ®µå®æ—¶é˜»æ­¢å¯ç–‘æˆ–æ¶æ„çš„ç”¨æˆ·ï¼Œå‡å°‘æ”»å‡»é£é™©ã€‚

é€šè¿‡ IP å°ç¦ï¼Œå¯ä»¥æœ‰æ•ˆæ‹‰é»‘æ”»å‡»è€…ï¼Œé˜²æ­¢èµ„æºè¢«æ»¥ç”¨ï¼Œä¿éšœåˆæ³•ç”¨æˆ·çš„æ­£å¸¸è®¿é—®ã€‚

å¯¹äºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œä¸è®©æ‹‰è¿›é»‘åå•çš„ IP è®¿é—®ä»»ä½•æ¥å£ã€‚

### æ–¹æ¡ˆè®¾è®¡

#### 1ã€è®¾è®¡è¿‡ç¨‹

å…¶å®å‰é¢è®²åˆ°çš„ Sentinel æœ¬èº«å°±æ”¯æŒè¯·æ±‚æ¥æºçš„ [é»‘ç™½åå•åˆ¤æ–­](https://github.com/alibaba/Sentinel/wiki/é»‘ç™½åå•æ§åˆ¶)ï¼Œä½†é»˜è®¤æ˜¯å¯¹åº”ç”¨çº§åˆ«è¿›è¡Œåˆ¤æ–­ï¼Œéœ€è¦æ”¹é€ æ¥æºçš„è·å–æ–¹å¼ä¸ºè·å–è¯·æ±‚å®¢æˆ·ç«¯çš„ IPï¼Œå¯å‚è€ƒ [è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/qq_37128815/article/details/131942363) è‡ªå®šä¹‰æ¥æºã€‚

ä½†å…¶å®å¼•å…¥ Sentinel æ˜¯éœ€è¦ä¸€å®šæˆæœ¬çš„ï¼Œæœ¬èŠ‚ä¸»è¦åˆ†äº«æ›´è½»é‡çš„åŠ¨æ€ IP é»‘ç™½åå•è¿‡æ»¤çš„å¸¸ç”¨è®¾è®¡å’Œå®ç°æ–¹æ³•ã€‚

æƒ³è¦è‡ªä¸»å®ç°åŠ¨æ€ IP é»‘åå•ï¼Œä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

1. IP é»‘åå•å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
2. å¦‚ä½•ä¾¿æ·åœ°åŠ¨æ€ä¿®æ”¹ IP é»‘åå•ï¼Ÿ
3. é»‘ç™½åå•çš„åˆ¤æ–­é€»è¾‘åº”åœ¨å“ªé‡Œå¤„ç†ï¼Ÿ
4. ä½¿ç”¨ä½•ç§æ•°æ®ç»“æ„ä¿å­˜é»‘åå•ï¼Ÿå¦‚ä½•å¿«é€ŸåŒ¹é…ç”¨æˆ·è¯·æ±‚çš„ IP æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Ÿ

ä¸‹é¢åˆ†åˆ«è®¾è®¡ï¼š

1ï¼‰IP é»‘åå•å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä¸€èˆ¬ IP é»‘åå•æ˜¯åŠ¨æ€å¢åŠ çš„ã€éœ€è¦æŒä¹…åŒ–ä¿å­˜ã€‚å¸¸è§çš„æŒä¹…åŒ–æ–¹å¼åŒ…æ‹¬æ•°æ®åº“ã€é…ç½®æ–‡ä»¶æˆ–åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼ˆå¦‚ Redisï¼‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ã€‚

2ï¼‰å¦‚ä½•ä¾¿æ·åœ°åŠ¨æ€ä¿®æ”¹ IP é»‘åå•ï¼Ÿ

ä¸ºäº†æ–¹ä¾¿åŠ¨æ€ä¿®æ”¹ IP é»‘åå•ï¼Œé€šå¸¸ä¼šæä¾›ä¸€ä¸ªç®¡ç†é¡µé¢ï¼Œä¾›ç®¡ç†å‘˜è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚

è®¸å¤šä¼ä¸šä¼šå°†é…ç½®ç»Ÿä¸€æ”¾å…¥ **é…ç½®ä¸­å¿ƒ**ï¼Œé€šè¿‡é…ç½®ä¸­å¿ƒçš„ç®¡ç†é¡µé¢ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä¾¿æ·åœ°åŠ¨æ€ä¿®æ”¹é»‘åå•è§„åˆ™ã€‚Java é¡¹ç›®ä¸­ï¼Œå¸¸ç”¨çš„é…ç½®ä¸­å¿ƒæ˜¯ Nacosã€‚

3ï¼‰é»‘ç™½åå•çš„åˆ¤æ–­é€»è¾‘åº”åœ¨å“ªé‡Œå¤„ç†ï¼Ÿ

é»‘ç™½åå•é€»è¾‘é€šå¸¸éƒ¨ç½²åœ¨é«˜æ€§èƒ½çš„ç½‘å…³æˆ– CDN ä¸Šï¼Œ**èƒ½å¤Ÿæ›´æ—©åœ°æ‹¦æˆªéæ³•è¯·æ±‚**ï¼Œå‡è½»åç«¯å‹åŠ›ã€‚åœ¨å°å‹é¡¹ç›®ä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨åº”ç”¨ç¨‹åºçš„è¿‡æ»¤å™¨ä¸­å¤„ç†ã€‚

4ï¼‰ä½¿ç”¨ä½•ç§ç»“æ„ä¿å­˜é»‘åå•ï¼Ÿå¦‚ä½•å¿«é€ŸåŒ¹é…ï¼Ÿ

ä¸ºäº†é«˜æ•ˆåˆ¤æ–­æ¯ä¸ªç”¨æˆ·è¯·æ±‚çš„ IP æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œé¦–å…ˆå»ºè®®å°† IP é»‘åå•ä»æŒä¹…åŒ–å­˜å‚¨åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢è¿œç¨‹æ•°æ®æºã€‚å¯¹äºé»‘åå•æ•°æ®è¾ƒå°çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„ `Set` æ•°æ®ç»“æ„å­˜å‚¨ã€‚è€Œå¯¹äºå¤§è§„æ¨¡é»‘åå•ï¼Œæ¨èä½¿ç”¨ **å¸ƒéš†è¿‡æ»¤å™¨æˆ– DFA** æ¥å­˜å‚¨å’Œè¿‡æ»¤é»‘åå•ï¼Œå¯ä»¥èŠ‚çº¦å†…å­˜ç©ºé—´ã€æé«˜æ£€æµ‹æ•ˆç‡ã€‚

#### 2ã€æœ€ç»ˆæ–¹æ¡ˆ

æ€»ç»“ä¸€ä¸‹æœ€ç»ˆæ–¹æ¡ˆï¼š

1ï¼‰ä½¿ç”¨ Nacos é…ç½®ä¸­å¿ƒå­˜å‚¨å’Œç®¡ç† IP é»‘åå•

2ï¼‰åç«¯æœåŠ¡åˆ©ç”¨ Web è¿‡æ»¤å™¨åˆ¤æ–­æ¯ä¸ªç”¨æˆ·è¯·æ±‚çš„ IP

3ï¼‰åç«¯æœåŠ¡åˆ©ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤ IP é»‘åå•

#### 3ã€æ‰©å±•çŸ¥è¯† - å¸ƒéš†è¿‡æ»¤å™¨

Bloom Filter æ˜¯ä¸€ç§é«˜æ•ˆçš„ã€åŸºäºæ¦‚ç‡çš„æ•°æ®ç»“æ„ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ã€‚

åŸç†æ˜¯åˆ©ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å°†å…ƒç´ æ˜ å°„åˆ°å›ºå®šçš„ç‚¹ä½ä¸Šï¼ˆä½æ•°ç»„ä¸­ï¼‰ï¼Œå› æ­¤é¢å¯¹æµ·é‡æ•°æ®å®ƒå æ®çš„ç©ºé—´ä¹Ÿéå¸¸å°ã€‚

ä¾‹å¦‚æŸä¸ª key é€šè¿‡ hash-1 å’Œ hash-2 ä¸¤ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå®šä½åˆ°æ•°ç»„ä¸­çš„å€¼éƒ½ä¸º 1ï¼Œåˆ™è¯´æ˜å®ƒå­˜åœ¨ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/dVbAGYhPzbChtTTn.webp)

å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ä¸€ä¸ªå…ƒç´ ä¸å­˜åœ¨é›†åˆä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨é›†åˆä¸­ï¼Œå¦‚æœåˆ¤æ–­å…ƒç´ å­˜åœ¨é›†åˆä¸­åˆ™ä¸ä¸€å®šæ˜¯çœŸçš„ï¼Œå› ä¸ºå“ˆå¸Œå¯èƒ½ä¼šå­˜åœ¨å†²çªã€‚å› æ­¤å¸ƒéš†è¿‡æ»¤å™¨ **æœ‰è¯¯åˆ¤çš„æ¦‚ç‡** ã€‚

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/8EVswNW7ueogOwZn.webp)

è€Œä¸”å®ƒä¸å¥½åˆ é™¤å…ƒç´ ï¼Œåªèƒ½æ–°å¢ï¼Œå¦‚æœæƒ³è¦åˆ é™¤ï¼Œåªèƒ½é‡å»ºã€‚

æ˜¾ç„¶ï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

1. ç©ºé—´æ•ˆç‡é«˜ï¼šç›¸æ¯”äºä¼ ç»Ÿçš„æ•°æ®ç»“æ„ï¼ˆå¦‚å“ˆå¸Œè¡¨ï¼‰ï¼ŒBloom Filter èƒ½ç”¨è¾ƒå°‘çš„ç©ºé—´å­˜å‚¨å¤§é‡çš„æ•°æ®ã€‚
2. æ—¶é—´å¤æ‚åº¦ä½ï¼šæŸ¥è¯¢æ“ä½œéå¸¸å¿«é€Ÿï¼Œé€šå¸¸æ˜¯å¸¸æ•°æ—¶é—´å¤æ‚åº¦ `O(1)`ã€‚
3. å…è®¸è¯¯åˆ¤ï¼šBloom Filter å…è®¸å‡é˜³æ€§ï¼Œå³æœ‰æ—¶å€™ä¼šé”™è¯¯åœ°åˆ¤æ–­æŸä¸ªå…ƒç´ åœ¨é›†åˆä¸­ï¼Œè€Œå®é™…è¯¥å…ƒç´ å¹¶ä¸åœ¨é›†åˆä¸­ã€‚ä¸è¿‡ï¼Œå®ƒä¸å…è®¸å‡é˜´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ Bloom Filter åˆ¤æ–­æŸä¸ªå…ƒç´ ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå®ƒä¸€å®šæ˜¯ä¸å­˜åœ¨çš„ã€‚æ¯”å¦‚å¯¹äºæˆ‘ä»¬çš„éœ€æ±‚ï¼ŒBloom Filter **å¯èƒ½é”™è¯¯åœ°åˆ¤æ–­ä¸€ä¸ªä¸åœ¨é»‘åå•ä¸­çš„å…ƒç´ ä¸ºåœ¨é»‘åå•ä¸­**ï¼Œå¯¼è‡´è¯¯å°ã€‚

Bloom Filter çš„è¯¯åˆ¤ç‡ä¸ä»¥ä¸‹å› ç´ æœ‰å…³ï¼š

- ä½æ•°ç»„çš„å¤§å°ï¼šä½æ•°ç»„è¶Šå¤§ï¼Œè¯¯åˆ¤ç‡è¶Šä½ï¼Œä½†ç©ºé—´å¼€é”€ä¼šå¢å¤§ã€‚ï¼ˆå€¼ä¼šæ›´ç¦»æ•£ï¼‰
- å“ˆå¸Œå‡½æ•°çš„ä¸ªæ•°ï¼šå“ˆå¸Œå‡½æ•°è¶Šå¤šï¼Œè¯¯åˆ¤ç‡è¶Šä½ï¼Œä½†è®¡ç®—æˆæœ¬ä¼šå¢åŠ ã€‚ï¼ˆHash ä¸€æ¬¡å†²çªï¼Œé‚£æˆ‘å°±å¤š Hash å‡ æ¬¡ï¼Œå‡å°‘å†²çªæ¦‚ç‡ï¼‰
- å…ƒç´ æ•°é‡ï¼šå­˜å…¥çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯åˆ¤ç‡ä¼šå¢åŠ ã€‚

é€šè¿‡ **åˆç†è®¾è®¡ä½æ•°ç»„çš„å¤§å°å’Œå“ˆå¸Œå‡½æ•°çš„ä¸ªæ•°**ï¼Œå¯ä»¥æ§åˆ¶ Bloom Filter çš„è¯¯åˆ¤ç‡åœ¨ä¸€ä¸ªå¯æ¥å—çš„èŒƒå›´å†…ã€‚ä¾‹å¦‚ï¼Œåœ¨å¾ˆå¤šå®é™…åœºæ™¯ä¸­ï¼Œå¯ä»¥å°†è¯¯åˆ¤ç‡æ§åˆ¶åœ¨ **1%** æˆ–æ›´ä½ã€‚

- å‡è®¾åœºæ™¯ 1ï¼šå­˜å‚¨ 1000 ä¸ªå…ƒç´ ï¼Œä½æ•°ç»„å¤§å°ä¸º 10000 ä½ï¼Œå“ˆå¸Œå‡½æ•°æ•°é‡ä¸º 7ã€‚è¯¯åˆ¤ç‡å¤§çº¦ä¸º 0.8%ã€‚
- å‡è®¾åœºæ™¯ 2ï¼šå­˜å‚¨ 100000 ä¸ªå…ƒç´ ï¼Œä½æ•°ç»„å¤§å°ä¸º 1,000,000 ä½ï¼Œå“ˆå¸Œå‡½æ•°æ•°é‡ä¸º 7ã€‚è¯¯åˆ¤ç‡å¤§çº¦ä¸º 1%ã€‚
- å‡è®¾åœºæ™¯ 3ï¼šå­˜å‚¨ 1,000,000 ä¸ªå…ƒç´ ï¼Œä½æ•°ç»„å¤§å°ä¸º 10,000,000 ä½ï¼Œå“ˆå¸Œå‡½æ•°æ•°é‡ä¸º 7ã€‚è¯¯åˆ¤ç‡å¤§çº¦ä¸º 1%ã€‚

å¦‚æœè¯¯åˆ¤çš„ä»£ä»·è¾ƒé«˜ï¼Œä½†ä»æƒ³ä½¿ç”¨ Bloom Filterï¼Œå¯ä»¥é‡‡å–ä¸€äº›è¡¥æ•‘æªæ–½ï¼š

- åŒå±‚éªŒè¯ï¼šåœ¨ Bloom Filter åˆ¤æ–­å…ƒç´ åœ¨é»‘åå•ä¸­åï¼Œè¿›ä¸€æ­¥æŸ¥éªŒå®é™…çš„é»‘åå•ï¼ˆä¾‹å¦‚ï¼ŒæŸ¥æ•°æ®åº“ä¸­çš„é»‘åå•è¯¦ç»†è®°å½•ï¼‰ã€‚
- ç»“åˆå…¶ä»–æ•°æ®ç»“æ„ï¼šå¯ä»¥ä½¿ç”¨ Bloom Filter è¿›è¡Œåˆæ­¥ç­›é€‰ï¼Œå¦‚æœ Bloom Filter åˆ¤æ–­ä¸ºåœ¨é»‘åå•ä¸­ï¼Œå†ç”¨å“ˆå¸Œè¡¨ç­‰ç²¾ç¡®çš„æ•°æ®ç»“æ„è¿›è¡Œæœ€ç»ˆç¡®è®¤ã€‚

ä½†è¿™ä¸¤ç§æ–¹å¼éƒ½æ— æ³•å¤„ç†æ”»å‡» IP çš„å¤§é‡è¯·æ±‚ï¼Œä¸ªäººä¹Ÿä¸å»ºè®®é‡‡ç”¨ã€‚

å› æ­¤ï¼Œå¸ƒéš†è¿‡æ»¤å™¨é€‚ç”¨äºå¯¹å‡†ç¡®æ€§è¦æ±‚ä¸é«˜çš„ã€å¤§è§„æ¨¡æ•°æ®é‡åŒ¹é…çš„åœºæ™¯ï¼Œæ¯”å¦‚åƒåœ¾é‚®ä»¶è¿‡æ»¤ã€çˆ¬è™« URL å»é‡ã€ç¼“å­˜ç©¿é€é˜²æŠ¤ç­‰ã€‚

### é…ç½®ä¸­å¿ƒ

#### ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œåº”ç”¨çš„é…ç½®ç®¡ç†å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œç‰¹åˆ«æ˜¯å½“ç³»ç»Ÿè§„æ¨¡å’Œç»„ä»¶æ•°é‡å¢åŠ æ—¶ã€‚ä¼ ç»Ÿçš„æ‰‹åŠ¨é…ç½®ï¼ˆå†™å›ºå®šé…ç½®æ–‡ä»¶ï¼‰å¾€å¾€éš¾ä»¥åº”å¯¹è¿™äº›å¤æ‚çš„éœ€æ±‚ã€‚

è€Œé…ç½®ä¸­å¿ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é…ç½®çš„ **é›†ä¸­åŒ–ç®¡ç†ï¼Œ**è¿˜æä¾›åŠ¨æ€æ›´æ–°ã€é…ç½®åˆ†ç»„ã€ç‰ˆæœ¬æ§åˆ¶ã€ç°åº¦å‘å¸ƒã€å®‰å…¨ç®¡ç†ï¼Œç®€åŒ–äº†å¤šç¯å¢ƒå’Œå¤šå®ä¾‹çš„é…ç½®è¿ç»´ï¼Œç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§å’Œç¨³å®šæ€§ã€‚

ä¸€å¥è¯ï¼Œä¸“ä¸šçš„æŠ€æœ¯åšä¸“ä¸šçš„äº‹ã€‚

#### é…ç½®ä¸­å¿ƒæ”¯æŒçš„åŠŸèƒ½

1ï¼‰é›†ä¸­åŒ–é…ç½®ç®¡ç†ï¼šæ‰€æœ‰æœåŠ¡çš„é…ç½®å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­ç®¡ç†ï¼Œè¿ç»´äººå‘˜å’Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„æ¥å£ä¿®æ”¹å’Œè·å–é…ç½®ï¼Œé¿å…äº†åœ¨æ¯ä¸ªå®ä¾‹ä¸­é‡å¤é…ç½®ã€‚

2ï¼‰åŠ¨æ€é…ç½®ï¼šé…ç½®ä¸­å¿ƒå…è®¸åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹åŠ¨æ€æ›´æ–°é…ç½®ï¼Œåº”ç”¨å¯ä»¥å®æ—¶æ”¶åˆ°é…ç½®çš„ä¿®æ”¹ï¼Œè¿›è¡Œè¿è¡Œæ—¶çš„è°ƒæ•´ã€‚

3ï¼‰å¤šç¯å¢ƒé…ç½®ç®¡ç†ï¼šé…ç½®ä¸­å¿ƒï¼Œå¯ä»¥ä¸ºä¸åŒçš„ç¯å¢ƒé…ç½®ä¸åŒçš„é…ç½®é›†ï¼ŒæŒ‰éœ€åŠ è½½ç›¸åº”çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œé¿å…äº†ç¯å¢ƒé—´é…ç½®çš„æ··æ·†å’Œå‡ºé”™ã€‚

4ï¼‰é…ç½®çš„ç‰ˆæœ¬æ§åˆ¶ï¼šé…ç½®ä¸­å¿ƒä¸€èˆ¬éƒ½ä¼šæä¾›ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹å’Œå›æ»šåˆ°ä¹‹å‰çš„é…ç½®ç‰ˆæœ¬ï¼Œè¿™æé«˜äº†ç³»ç»Ÿçš„å®¹é”™æ€§å’Œå¯æ¢å¤æ€§ã€‚

5ï¼‰é…ç½®çš„å®‰å…¨ç®¡ç†ï¼šé…ç½®ä¸­å¿ƒä¸€èˆ¬ä¼šæä¾›åŠ å¯†å­˜å‚¨å’Œæƒé™æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥å¯¹æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç ã€API å¯†é’¥ç­‰ï¼‰è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œå¹¶é™åˆ¶è®¿é—®æƒé™ï¼Œç¡®ä¿æ•æ„Ÿé…ç½®ä¿¡æ¯çš„å®‰å…¨æ€§ã€‚

#### å¸¸è§çš„é…ç½®ä¸­å¿ƒ

1ï¼‰Spring Cloud Configï¼šSpring Cloud æä¾›çš„é…ç½®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒ Git ç­‰ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿå­˜å‚¨é…ç½®ï¼Œé€‚åˆä¸ Spring Cloud ç³»ç»Ÿé›†æˆä½¿ç”¨ã€‚

2ï¼‰Nacosï¼šé˜¿é‡Œå·´å·´å¼€æºçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œæ”¯æŒåŠ¨æ€é…ç½®ã€æœåŠ¡æ²»ç†ï¼Œé€‚åˆå¾®æœåŠ¡æ¶æ„å’Œ Dubboã€Spring Cloud çš„æ·±åº¦é›†æˆã€‚

3ï¼‰Apolloï¼šç”±æºç¨‹å¼€æºçš„é…ç½®ä¸­å¿ƒï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šé›†ç¾¤çš„é…ç½®ç®¡ç†ï¼Œé…ç½®å®æ—¶ç”Ÿæ•ˆä¸”å…·æœ‰æƒé™æ§åˆ¶ï¼Œé€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

4ï¼‰Consulï¼šç”± HashiCorp æä¾›çš„æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒï¼Œå…·æœ‰å¼ºä¸€è‡´æ€§å’Œå¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œé€‚ç”¨äºæœåŠ¡ç½‘æ ¼å’Œå®¹å™¨åŒ–åº”ç”¨ã€‚

ä¸€èˆ¬ä¸šåŠ¡ä¸Šï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©ä½¿ç”¨ Nacos æˆ– Apollo æ¥ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæä¾›äº†æ¯”è¾ƒä¸°å¯Œçš„æ§åˆ¶å°ç®¡ç†é¡µé¢ï¼Œä¾¿äºæˆ‘ä»¬ä¿®æ”¹ç»´æŠ¤é…ç½®ã€‚

**æœ¬é¡¹ç›®ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒçš„å®ç°ã€‚**

### Nacos å…¥é—¨

#### ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ

[Nacos](https://nacos.io/) æ˜¯ Dynamic Naming and Configuration Service çš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

å®ƒæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚

å®é™…ä¸Šï¼ŒNacos ä¸ä»…æ”¯æŒé…ç½®ç®¡ç†ï¼Œå®ƒè¿˜æ”¯æŒæœåŠ¡å‘ç°ï¼ˆä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼‰ï¼Œä»¥ä¸‹æ˜¯å®˜ç½‘æ€»ç»“çš„ Nacos åœ°å›¾ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/NVwGzUD9yp1DcdcU.webp)

æˆ‘ä»¬å½“å‰çš„é¡¹ç›®ä¸»è¦ä½¿ç”¨å®ƒçš„é…ç½®ç®¡ç†åŠŸèƒ½ã€‚

#### Nacos é…ç½®ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µ

1ã€Namespaceï¼ˆå‘½åç©ºé—´ï¼‰

å‘½åç©ºé—´ç”¨äºéš”ç¦»ä¸åŒçš„é…ç½®é›†ã€‚å®ƒå…è®¸åœ¨åŒä¸€ä¸ª Nacos é›†ç¾¤ä¸­å°†ä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰æˆ–è€…ä¸åŒçš„ä¸šåŠ¡çº¿çš„é…ç½®è¿›è¡Œéš”ç¦»ã€‚ï¼ˆé»˜è®¤æä¾›äº†ä¸€ä¸ª public å‘½åç©ºé—´ï¼‰ ä½¿ç”¨åœºæ™¯ï¼šåœ¨å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­ï¼Œæˆ–è€…éœ€è¦åŒºåˆ†ä¸åŒçš„ç¯å¢ƒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®å’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®å®Œå…¨éš”ç¦»ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„å‘½åç©ºé—´æ¥ç®¡ç†ã€‚

2ã€Groupï¼ˆç»„ï¼‰

é…ç½®ç»„æ˜¯ç”¨äºå°†å¤šä¸ªç›¸å…³çš„é…ç½®é¡¹è¿›è¡Œåˆ†ç±»ç®¡ç†çš„é€»è¾‘åˆ†ç»„æœºåˆ¶ã€‚æ¯ä¸ªé…ç½®é¡¹å¯ä»¥å±äºä¸åŒçš„ç»„ï¼Œä»¥ä¾¿äºé…ç½®ç®¡ç†ã€‚ ä½¿ç”¨åœºæ™¯ï¼šå½“ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªæ¨¡å—ï¼Œä¸”ä¸åŒæ¨¡å—ä¹‹é—´å…±äº«éƒ¨åˆ†é…ç½®æ—¶ï¼Œå¯ä»¥ç”¨ç»„æ¥å¯¹è¿™äº›æ¨¡å—çš„é…ç½®è¿›è¡Œåˆ†ç±»å’Œç®¡ç†ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿä¸­çš„â€œæ”¯ä»˜æœåŠ¡â€å’Œâ€œè®¢å•æœåŠ¡â€å¯èƒ½éœ€è¦ç”¨ä¸åŒçš„ç»„æ¥å­˜å‚¨å„è‡ªçš„é…ç½®ã€‚

3ã€Data ID

Data ID æ˜¯ä¸€ä¸ªå”¯ä¸€çš„é…ç½®æ ‡è¯†ç¬¦ï¼Œé€šå¸¸ä¸å…·ä½“çš„åº”ç”¨ç¨‹åºç›¸å…³ã€‚é€šè¿‡ Data IDï¼ŒNacos çŸ¥é“å¦‚ä½•è·å–ç‰¹å®šåº”ç”¨çš„æŸä¸ªå…·ä½“é…ç½®ã€‚ ä½¿ç”¨åœºæ™¯ï¼šæ¯ä¸ªåº”ç”¨çš„é…ç½®éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ Data IDã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ”¯ä»˜ç³»ç»Ÿå¯èƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶å« `com.payment.pay-service.yaml`ï¼Œè¿™å°±æ˜¯å®ƒçš„ Data IDã€‚

4ã€Config Listenerï¼ˆé…ç½®ç›‘å¬å™¨ï¼‰

é…ç½®ç›‘å¬å™¨ç”¨äºè®©å®¢æˆ·ç«¯å®æ—¶ç›‘å¬ Nacos é…ç½®ä¸­å¿ƒä¸­çš„é…ç½®å˜åŒ–ï¼Œå¯ä»¥è‡ªåŠ¨æ„ŸçŸ¥é…ç½®çš„æ›´æ–°å¹¶åšå‡ºç›¸åº”çš„å¤„ç†ã€‚ ä½¿ç”¨åœºæ™¯ï¼šåœ¨éœ€è¦åŠ¨æ€è°ƒæ•´é…ç½®çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚è°ƒæ•´ç¼“å­˜å¤§å°ã€åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç«¯ç‚¹ç­‰ï¼Œåº”ç”¨å¯ä»¥é€šè¿‡ç›‘å¬å™¨åŠæ—¶æ„ŸçŸ¥è¿™äº›å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½®ã€‚

#### æ¨é€å’Œç›‘å¬

æ¨é€æ–¹æ³•ï¼š

1. Nacos æ§åˆ¶å°ï¼ˆæ¨èï¼‰
2. åº”ç”¨ç¨‹åº SDKã€‚Nacos æ”¯æŒå’Œ Spring Boot å¿«é€Ÿæ•´åˆï¼Œå¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/quick-start-spring-boot.html)
3. [Open API](https://nacos.io/zh-cn/docs/open-api.html)

ç›‘å¬æ–¹æ³•ï¼šä½¿ç”¨ SDK é…ç½® Config Listenerï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/sdk.html) ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
String serverAddr = "{serverAddr}";
String dataId = "{dataId}";
String group = "{group}";
Properties properties = new Properties();
properties.put("serverAddr", serverAddr);
ConfigService configService = NacosFactory.createConfigService(properties);
String content = configService.getConfig(dataId, group, 5000);
System.out.println(content);
configService.addListener(dataId, group, new Listener() {
	@Override
	public void receiveConfigInfo(String configInfo) {
		System.out.println("recieve1:" + configInfo);
	}
	@Override
	public Executor getExecutor() {
		return null;
	}
});

// æµ‹è¯•è®©ä¸»çº¿ç¨‹ä¸é€€å‡ºï¼Œå› ä¸ºè®¢é˜…é…ç½®æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹é€€å‡ºå®ˆæŠ¤çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚ æ­£å¼ä»£ç ä¸­æ— éœ€ä¸‹é¢ä»£ç 
while (true) {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

æˆ–è€…ç›´æ¥é€šè¿‡æ³¨è§£è¯»å– valueï¼Œèƒ½å¤Ÿå®æ—¶è·å–åˆ°æœ€æ–°çš„é…ç½®å€¼ï¼š

```java
@Controller
@RequestMapping("config")
public class ConfigController {

    @NacosValue(value = "${useLocalCache:false}", autoRefreshed = true)
    private boolean useLocalCache;

    @RequestMapping(value = "/get", method = GET)
    @ResponseBody
    public boolean get() {
        return useLocalCache;
    }
}
```

#### æ‰©å±•çŸ¥è¯† - Nacos æ€§èƒ½

åœ¨ä¼ä¸šä¸­ï¼ŒåšæŠ€æœ¯é€‰å‹æ—¶ï¼Œæ€§èƒ½æ˜¯å¿…ä¸å¯å°‘çš„è€ƒè™‘å› ç´ ã€‚

å¯ä»¥å‚è€ƒ Nacos çš„ [å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/nacos-config-benchmark.html) äº†è§£ã€‚

å†™æ€§èƒ½ï¼š

BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak=NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk=19lREw9lV3H3I+rK7vjxERQeWUOy0kwqtJjqK+R58cE=BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak=

| **å•æœº**wt4tVNmXm8QgLQdra6I0fKvSrV47aw99prVO/cGe5fU= | **3èŠ‚ç‚¹**NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk= | **10èŠ‚ç‚¹**Zd4vN1X+Mu+cpkGy31rZ96a82qN0fwdgpTBxAm0Vg+g=zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk= | **100èŠ‚ç‚¹**BsIfCdbcOxfxcrAyHoNumjhUY27lclYvZBP3TWJ21Ak= |
| ---------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------- |
| 1400                                                 | 4214                                                  | 6863Ob+rrfxihs8C6cKC1R8DHHHNAFb3lGV+4N1WAXF+guU=             | 8626                                                    |

è¯»æ€§èƒ½ï¼š

bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk=Zd4vN1X+Mu+cpkGy31rZ96a82qN0fwdgpTBxAm0Vg+g=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0=

| **å•æœº**yXZ+wplD/Z/TIlcCXWQJ7meUSnldS+OOOCauQaPvvSE= | **3èŠ‚ç‚¹**NlM19jOpdzoohJcm/GrGw+nMEUUssmqVWxgqzhb7Yyk= | **10èŠ‚ç‚¹**zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk=bn5Rnq7vBWxb4thvZrORiI5bvPL2bO1+RwjSlYEQ2h0= | **100èŠ‚ç‚¹**19lREw9lV3H3I+rK7vjxERQeWUOy0kwqtJjqK+R58cE= |
| ---------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------- |
| 15000                                                | 23013                                                 | 45000zMgxcF7XAuB3MSprAFa9ecyIqm65CrajO2ECbq0kShk=            | 161099                                                  |

å¯¹ Nacos æœ‰åˆæ­¥äº†è§£åï¼Œä¸‹é¢æˆ‘ä»¬åŸºäº Nacos å®ç° IP é»‘åå•éœ€æ±‚ã€‚

### åç«¯å¼€å‘

#### 1ã€ä¸‹è½½ Nacos Server

å¯ä»¥åœ¨ Nacos å®˜ç½‘ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ Nacos åº”ç”¨åŒ…ï¼Œ**æ­¤å¤„ä½¿ç”¨å’Œ Sentinel å…¼å®¹çš„ 2.2.0 ç‰ˆæœ¬ï¼Œä¸€å®šä¸è¦ä½¿ç”¨å…¶ä»–ç‰ˆæœ¬ï¼å¦åˆ™é™¤äº†é—®é¢˜ä¸å¥½è§£å†³ï¼**

å¯ä»¥åœ¨å®˜æ–¹ä¸‹è½½ï¼šhttps://nacos.io/download/release-history/

æœ¬æ•™ç¨‹ä¸ºå¤§å®¶æä¾›äº†è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA ï¼Œæå–ç ï¼šc2sd

#### 2ã€å¯åŠ¨ Nacos Server

è§£å‹ä¸‹è½½å¥½çš„å‹ç¼©åŒ…ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/fy7GrQm3ZZRjMarT.webp)

Linux/Unix/Mac å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼ˆstandalone ä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼ï¼‰ï¼š

```bash
sh startup.sh -m standalone
```

Windows å¯åŠ¨å‘½ä»¤ï¼š

```bash
startup.cmd -m standalone
```

å¯åŠ¨æˆåŠŸï¼Œå¦‚å›¾ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/3dmbtledduayOuhT.webp)

å¦‚æœæŠ¥æ‰¾ä¸åˆ° Javaï¼Œé‚£å°±é…ç½® JAVA_HOMEã€ç¯å¢ƒå˜é‡æˆ–è€…å®‰è£… Javaï¼šhttps://www.oracle.com/java/technologies/downloads/#java8

å¦‚ä½•ä½¿ç”¨ Nacos å‘¢ï¼Ÿå…¶å®æ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹æ•™ç¨‹å’Œç¤ºä¾‹ä»£ç ï¼Œæ‹¿æ¥å°±èƒ½ç”¨ï¼

- æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/quick-start.html
- æ•™ç¨‹ï¼šhttps://sca.aliyun.com/zh-cn/docs/2021.0.5.0/user-guide/nacos/quick-start
- ç¤ºä¾‹ä»£ç ï¼šhttps://github.com/alibaba/spring-cloud-alibaba/tree/2022.x/spring-cloud-alibaba-examples/nacos-example

#### 3ã€é€šè¿‡ Nacos æ§åˆ¶å°æ·»åŠ é…ç½®

1ï¼‰è®¿é—®ï¼šhttp://127.0.0.1:8848/nacos ï¼Œé»˜è®¤ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯ nacos

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/Bgvt2pvaV1YXAZxs.webp)

2ï¼‰ç‚¹å‡»åˆ›å»ºé…ç½®ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/D6ZyREkDH6zKul78.webp)

å¡«å†™é…ç½®ï¼Œæ¨è yaml æ ¼å¼ï¼š

```yaml
blackIpList:
    - "1.1.1.1"
    - "2.2.2.2"
```

å¦‚å›¾ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/rrgSNP2oj3Uh1Fob.webp)

#### 4ã€é¡¹ç›®å¼•å…¥ Nacos ä¾èµ–

å¯ä»¥ç›´æ¥ä½¿ç”¨ Spring Boot Starter å¿«é€Ÿå¼•å…¥ Nacosï¼Œ[å‚è€ƒæ–‡æ¡£](https://nacos.io/zh-cn/docs/quick-start-spring-boot.html)ã€‚

1ï¼‰åœ¨é¡¹ç›® pom.xml æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä»¥ä¸‹ä¾èµ–é…ç½®ï¼š

```xml
<dependency>
    <groupId>com.alibaba.boot</groupId>
    <artifactId>nacos-config-spring-boot-starter</artifactId>
    <version>0.2.12</version>
</dependency>
```

æ³¨æ„ï¼šç‰ˆæœ¬ 0.2.x.RELEASE å¯¹åº”çš„æ˜¯ Spring Boot 2.x ç‰ˆæœ¬ï¼Œç‰ˆæœ¬ 0.1.x.RELEASE å¯¹åº”çš„æ˜¯ Spring Boot 1.x ç‰ˆæœ¬ã€‚ï¼ˆç»æµ‹è¯•ï¼Œæœ¬é¡¹ç›®å¯ä½¿ç”¨ 0.2.12 ç‰ˆæœ¬ï¼‰

2ï¼‰ä¿®æ”¹ application.yml é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  Nacos Server åœ°å€ç­‰é…ç½®ï¼š

```yaml
# é…ç½®ä¸­å¿ƒ
nacos:
  config:
    server-addr: 127.0.0.1:8848  # nacos åœ°å€
    bootstrap:
      enable: true  # é¢„åŠ è½½
    data-id: mianshiya # æ§åˆ¶å°å¡«å†™çš„ Data ID
    group: DEFAULT_GROUP # æ§åˆ¶å°å¡«å†™çš„ group
    type: yaml  # é€‰æ‹©çš„æ–‡ä»¶æ ¼å¼
    auto-refresh: true # å¼€å¯è‡ªåŠ¨åˆ·æ–°
```

#### 5ã€åˆ›å»ºé»‘åå•è¿‡æ»¤å·¥å…·ç±»

æ–°å»º blackfilter åŒ…ï¼Œé»‘åå•è¿‡æ»¤ç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ°è¯¥åŒ…ä¸‹ï¼Œæ¨¡å—åŒ–ã€‚

å¯ä»¥ç”¨ Hutool æˆ– Guava åº“è‡ªå¸¦çš„ bloomfilterï¼Œ[å‚è€ƒæ–‡ç« ](https://blog.csdn.net/asd051377305/article/details/139684962)ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼ï¼Œè¿˜å¯ä»¥è€ƒè™‘ Redissonã€‚

æ­¤å¤„ç”±äºé¡¹ç›®å·²ç»ä½¿ç”¨äº† Hutool å·¥å…·åº“ï¼Œå°±ç”¨å…¶è‡ªå¸¦çš„ BitMapBloomFilter å³å¯ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class BlackIpUtils {

    private static BitMapBloomFilter bloomFilter;

    // åˆ¤æ–­ ip æ˜¯å¦åœ¨é»‘åå•å†…
    public static boolean isBlackIp(String ip) {
        return bloomFilter.contains(ip);
    }

    // é‡å»º ip é»‘åå•
    public static void rebuildBlackIp(String configInfo) {
        if (StrUtil.isBlank(configInfo)) {
            configInfo = "{}";
        }
        // è§£æ yaml æ–‡ä»¶
        Yaml yaml = new Yaml();
        Map map = yaml.loadAs(configInfo, Map.class);
        // è·å– ip é»‘åå•
        List<String> blackIpList = (List<String>) map.get("blackIpList");
        // åŠ é”é˜²æ­¢å¹¶å‘
        synchronized (BlackIpUtils.class) {
            if (CollectionUtil.isNotEmpty(blackIpList)) {
                // æ³¨æ„æ„é€ å‚æ•°çš„è®¾ç½®
                BitMapBloomFilter bitMapBloomFilter = new BitMapBloomFilter(958506);
                for (String ip : blackIpList) {
                    bitMapBloomFilter.add(ip);
                }
                bloomFilter = bitMapBloomFilter;
            } else {
                bloomFilter = new BitMapBloomFilter(100);
            }
        }
    }
}
```

æ³¨æ„ï¼ŒBitMapBloomFilter æ¥å—çš„å‚æ•°æ¯”è¾ƒç‰¹æ®Šï¼Œå…³äºå¦‚ä½•è®¡ç®— BloomFilter å‚æ•°å€¼ï¼Œé±¼çš®åœ¨ GitHub æ‰¾åˆ°äº†ä¸€ä¸ªè¯´æ³•ï¼Œå¯ä»¥è‡ªè¡Œæµ‹è¯•ï¼šhttps://github.com/dromara/hutool/issues/3356ã€‚

ğŸ’¡ æ³¨æ„ï¼Œå› ä¸º Nacos é…ç½®æ–‡ä»¶çš„ç›‘å¬çš„ç²’åº¦æ¯”è¾ƒç²—ï¼Œåªèƒ½çŸ¥æ™“é…ç½®æœ‰å˜æ›´ï¼Œæ— æ³•çŸ¥æ™“æ˜¯æ–°å¢ã€åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ï¼Œå› æ­¤ä¸è®ºæ˜¯é€‰æ‹©å¸ƒéš†è¿‡æ»¤å™¨è¿˜æ˜¯ HashSet æœ€æ–¹ä¾¿çš„å¤„ç†é€»è¾‘å°±æ˜¯é‡å»ºã€‚

#### 6ã€åˆ›å»º Nacos é…ç½®ç›‘å¬ç±»

å¯ä»¥ç›´æ¥é€šè¿‡ Nacos æ§åˆ¶å°è·å–ç¤ºä¾‹ä»£ç ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/Klw11YF8zKoCSS02.webp)

åœ¨ blackfilter åŒ…ä¸­æ–°å¢ç›‘å¬å™¨ä»£ç ï¼Œè¿½æ±‚æ€§èƒ½çš„è¯å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š

```java
@Slf4j
@Component
public class NacosListener implements InitializingBean {

    @NacosInjected
    private ConfigService configService;

    @Value("${nacos.config.data-id}")
    private String dataId;

    @Value("${nacos.config.group}")
    private String group;

    @Override
    public void afterPropertiesSet() throws Exception {
        log.info("nacos ç›‘å¬å™¨å¯åŠ¨");

        String config = configService.getConfigAndSignListener(dataId, group, 3000L, new Listener() {
            final ThreadFactory threadFactory = new ThreadFactory() {
                private final AtomicInteger poolNumber = new AtomicInteger(1);
                @Override
                public Thread newThread(@NotNull Runnable r) {
                    Thread thread = new Thread(r);
                    thread.setName("refresh-ThreadPool" + poolNumber.getAndIncrement());
                    return thread;
                }
            };
            final ExecutorService executorService = Executors.newFixedThreadPool(1, threadFactory);

            // é€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†é»‘åå•å˜åŒ–çš„é€»è¾‘
            @Override
            public Executor getExecutor() {
                return executorService;
            }

            // ç›‘å¬åç»­é»‘åå•å˜åŒ–
            @Override
            public void receiveConfigInfo(String configInfo) {
                log.info("ç›‘å¬åˆ°é…ç½®ä¿¡æ¯å˜åŒ–ï¼š{}", configInfo);
                BlackIpUtils.rebuildBlackIp(configInfo);
            }
        });
        // åˆå§‹åŒ–é»‘åå•
        BlackIpUtils.rebuildBlackIp(config);
    }
}
```

#### 7ã€åˆ›å»ºé»‘åå•è¿‡æ»¤å™¨

é»‘åå•åº”è¯¥å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆï¼ˆä¸æ­¢æ˜¯ Controller çš„æ¥å£ï¼‰ï¼Œæ‰€ä»¥åŸºäº WebFilter å®ç°è€Œä¸æ˜¯ AOP åˆ‡é¢ã€‚WebFilter çš„ä¼˜å…ˆçº§é«˜äº @Aspect åˆ‡é¢ï¼Œå› ä¸ºå®ƒåœ¨æ•´ä¸ª Web è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­æ›´æ—©è¿›è¡Œå¤„ç†ã€‚

è¯·æ±‚è¿›å…¥æ—¶çš„é¡ºåºï¼š

- WebFilterï¼šé¦–å…ˆï¼ŒWebFilter æ‹¦æˆª HTTP è¯·æ±‚ï¼Œå¹¶å¯ä»¥æ ¹æ®é€»è¾‘å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚
- Spring AOP åˆ‡é¢ï¼ˆ@Aspectï¼‰ï¼šå¦‚æœè¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨å¹¶è¿›å…¥ Spring ç®¡ç†çš„ Beanï¼ˆä¾‹å¦‚ Controller å±‚ï¼‰ï¼Œæ­¤æ—¶åˆ‡é¢ç”Ÿæ•ˆï¼Œå¯¹åŒ¹é…çš„ Bean æ–¹æ³•è¿›è¡Œæ‹¦æˆªã€‚
- Controller å±‚ï¼šå¦‚æœ @Aspect æ²¡æœ‰é˜»æ­¢æ‰§è¡Œï¼Œæœ€ç»ˆè¯·æ±‚åˆ°è¾¾ @Controller æˆ– @RestController çš„æ–¹æ³•ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
@WebFilter(urlPatterns = "/*", filterName = "blackIpFilter")
public class BlackIpFilter implements Filter {

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        String ipAddress = NetUtils.getIpAddress((HttpServletRequest) servletRequest);
        if (BlackIpUtils.isBlackIp(ipAddress)) {
            servletResponse.setContentType("text/json;charset=UTF-8");
            servletResponse.getWriter().write("{\"errorCode\":\"-1\",\"errorMsg\":\"é»‘åå•IPï¼Œç¦æ­¢è®¿é—®\"}");
            return;
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

}
```

éœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š `@ServletComponentScan`ï¼Œè¿™æ ·è¿‡æ»¤å™¨æ‰ä¼šè¢«æ‰«æåˆ°ã€‚

```java
@SpringBootApplication(exclude = {RedisAutoConfiguration.class})
@MapperScan("com.yupi.mianshiya.mapper")
@EnableScheduling
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
@ServletComponentScan
public class MainApplication {

    public static void main(String[] args) {
        SpringApplication.run(MainApplication.class, args);
    }

}
```

#### 8ã€æµ‹è¯•æ•ˆæœ

é€šè¿‡ Nacos æ§åˆ¶å°ä¿®æ”¹é…ç½®ï¼Œæœ¬åœ°æµ‹è¯•çš„è¯ç›´æ¥åŠ å…¥æœ¬æœº IP å³å¯ï¼š

```java
blackIpList:
    - "1.1.1.1"
    - "2.2.2.2"
    - "0:0:0:0:0:0:0:1"
```

å¦‚å›¾ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/OTMN965Uxuo2JoIr.webp)

Nacos æ§åˆ¶å°èƒ½çœ‹åˆ°æ”¹åŠ¨è®°å½•ï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/eRco9Sy1QJ95riiE.webp)

åœ¨åº”ç”¨ä¸­å¯ä»¥å®æ—¶æ¥å—åˆ°é…ç½®çš„ä¿®æ”¹ï¼Œä½¿å¾—é»‘åå•å®æ—¶ç”Ÿæ•ˆï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/sTQateKggsDSeNx2-1737277253095-56.webp)

é€šè¿‡ Swagger æµ‹è¯•é»‘åå•æ•ˆæœï¼š

![img](./assets/07-æµé‡å®‰å…¨ä¼˜åŒ–/gjTEphdMxzGHOCOl-1737277253095-54.webp)

### æ‰©å±•

1ï¼‰åŸºäº DFA å®ç°é»‘åå•è¿‡æ»¤

æ€è·¯ï¼šå¯ä»¥è‡ªä¸»äº†è§£ DFA ç®—æ³•ï¼Œé€šè¿‡ Hutool å·¥å…·ç±»ç­‰ç°æˆçš„åº“è½»æ¾å®ç°ï¼Œä¸å»ºè®®è‡ªå·±å†™ç®—æ³•ã€‚ç”±äºæœ‰å¤šç§é»‘åå•è¿‡æ»¤ç®—æ³•ï¼Œè¿˜å¯ä»¥åŸºäºç­–ç•¥æ¨¡å¼ä¼˜åŒ–ä»£ç ã€‚

2ï¼‰é…ç½®é™çº§

æ€è·¯ï¼šéªŒè¯å¦‚æœä» Nacos è·å–é…ç½®å¤±è´¥åï¼Œåº”ç”¨ç¨‹åºä¼šæœ‰ä»€ä¹ˆè¡¨ç°ï¼Ÿæ€è€ƒå¦‚ä½•é˜²æ­¢é…ç½®æ‹‰å–å¤±è´¥çš„æƒ…å†µï¼Œæå‡åº”ç”¨çš„ç¨³å®šæ€§ã€‚